<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Nova Atriz</title>
    <style>
        /* === CSS STYLES === */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            position: relative;
        }

        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        /* Estilos do Menu */
        .main-nav { background-color: #1f1f1f; padding: 0.8em 30px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); text-align: right; }
        .main-nav ul { list-style: none; margin: 0; padding: 0; }
        .main-nav li { display: inline-block; margin-left: 20px; }
        .main-nav a { color: #e0e0e0; text-decoration: none; font-size: 1.1em; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease; }
        .main-nav a:hover { background-color: #bb86fc; color: #121212; }

        /* Estilos do Header */
        header { background-color: #1e1e1e; color: #fff; padding: 2em 0; text-align: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        header h1 { margin: 0; font-size: 2.5em; font-weight: 700; letter-spacing: 0.5px; }

        /* Estilos para o Container de Conteúdo */
        .content-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 30px 40px;
            background-color: #242424;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .content-container h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px;
            color: #fff;
            font-weight: normal;
        }

        /* --- ESTILOS DO FORMULÁRIO COM CARDS --- */
        #create-actress-form {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 30px;
        }

        .form-card {
            background-color: #333;
            padding: 18px;
            border-radius: 8px;
            border: 1px solid #444;
            flex-basis: calc(50% - 8px);
            flex-grow: 1;
            box-sizing: border-box;
            min-width: 250px;
        }

        .form-card.full-width {
            flex-basis: 100%;
        }

        .content-container label {
             display: block;
             margin-bottom: 10px;
             color: #b0b0b0;
             font-size: 0.9em;
             font-weight: bold;
         }

         .content-container input[type="text"],
         .content-container input[type="url"],
         .content-container input[type="number"],
         .content-container textarea {
             width: 100%;
             padding: 10px 12px;
             background-color: #404040;
             border: 1px solid #555;
             border-radius: 5px;
             color: #e0e0e0;
             box-sizing: border-box;
             font-size: 1em;
             transition: border-color 0.2s ease, box-shadow 0.2s ease;
             margin-bottom: 0;
         }

         .content-container textarea {
             min-height: 120px;
             resize: vertical;
         }

         .content-container input:focus,
         .content-container textarea:focus {
            outline: none;
            border-color: #bb86fc;
            box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.3);
         }

        /* Style for error messages */
        .error-message {
            color: #f44336; /* Material Design Red */
            font-size: 0.85em;
            display: block; /* Ensure it appears on its own line */
            margin-top: 5px; /* Add a little space above */
            font-weight: bold;
        }

         /* Botão de Submit */
         .submit-button-container {
             text-align: center;
         }
         .content-container button[type="submit"] {
             min-width: 200px;
             margin-top: 10px;
             background-color: #bb86fc;
             color: #121212;
             padding: 14px 35px;
             border: none;
             border-radius: 6px;
             font-size: 1.2em;
             font-weight: bold;
             cursor: pointer;
             transition: background-color 0.2s ease, transform 0.1s ease;
         }
         .content-container button[type="submit"]:hover {
             background-color: #a772e3;
         }
         .content-container button[type="submit"]:active {
             transform: scale(0.98);
         }
          /* Style for disabled button */
         .content-container button[type="submit"]:disabled {
            background-color: #555; /* Darker, less prominent background */
            color: #999; /* Greyed-out text */
            cursor: not-allowed; /* Indicate it's not clickable */
            transform: none; /* Prevent active state transform */
        }

        /* --- FIM DOS ESTILOS DO FORMULÁRIO COM CARDS --- */
    </style>
</head>
<body>

    <!-- MENU DE NAVEGAÇÃO -->
    <nav class="main-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="criar.html">Criar</a></li>
        </ul>
    </nav>
    <!-- FIM MENU -->

    <header>
        <h1>Criar Nova Atriz</h1>
    </header>

    <!-- ÁREA DE CONTEÚDO PRINCIPAL -->
    <main>
        <div class="content-container">
            <h2>Adicionar Nova Atriz</h2>

            <!-- FORMULÁRIO DE CRIAÇÃO -->
            <form id="create-actress-form">

                <!-- Card para Nome -->
                <div class="form-card">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>
                    <!-- !!! IMPORTANT: Make sure this span exists and has the correct ID !!! -->
                    <span id="name-error-message" class="error-message" style="display: none;"></span>
                </div>

                <!-- Card para Foto -->
                <div class="form-card">
                    <label for="foto">Foto (URL):</label>
                    <input type="url" id="foto" name="foto" placeholder="https://exemplo.com/imagem.jpg" required>
                </div>

                 <!-- Card para Texto/Biografia (Largura Total) -->
                <div class="form-card full-width">
                    <label for="texto">Texto (Biografia/Descrição):</label>
                    <textarea id="texto" name="texto" rows="5" placeholder="Cole ou digite a biografia e informações aqui..." required></textarea>
                </div>

                <!-- Card para Born -->
                <div class="form-card">
                    <label for="born">Born (Ex: 1990/05/15):</label> <!-- Adjusted placeholder -->
                    <input type="text" id="born" name="born" placeholder="YYYY/MM/DD">
                </div>

                <!-- Card para Birthplace -->
                <div class="form-card">
                    <label for="birthplace">Birthplace:</label>
                    <input type="text" id="birthplace" name="birthplace">
                </div>

                <!-- Card para Ethnicity -->
                <div class="form-card">
                    <label for="ethnicity">Ethnicity:</label>
                    <input type="text" id="ethnicity" name="ethnicity">
                </div>

                <!-- Card para Hair color -->
                <div class="form-card">
                    <label for="hair_color">Hair color:</label>
                    <input type="text" id="hair_color" name="hair_color">
                </div>

                <!-- Card para Eye color -->
                <div class="form-card">
                    <label for="eye_color">Eye color:</label>
                    <input type="text" id="eye_color" name="eye_color">
                </div>

                <!-- Card para Height -->
                <div class="form-card">
                    <label for="height">Height (cm):</label> <!-- Adjusted label -->
                    <input type="text" id="height" name="height" placeholder="Ex: 170">
                </div>

                <!-- Card para Weight -->
                <div class="form-card">
                    <label for="weight">Weight (kg):</label> <!-- Adjusted label -->
                    <input type="text" id="weight" name="weight" placeholder="Ex: 59">
                </div>

                <!-- Card para Body type -->
                <div class="form-card">
                    <label for="body_type">Body type:</label>
                    <input type="text" id="body_type" name="body_type">
                </div>

                <!-- Card para Measurements -->
                <div class="form-card">
                    <label for="measurements">Measurements (Ex: 34-24-35):</label>
                    <input type="text" id="measurements" name="measurements">
                </div>

                <!-- Card para Years active -->
                <div class="form-card">
                    <label for="years_active">Years active (Start Year):</label> <!-- Adjusted label -->
                    <input type="text" id="years_active" name="years_active" placeholder="Ex: 2010">
                </div>

                <!-- Card para Nota -->
                 <div class="form-card">
                    <label for="nota">Nota (0 a 10):</label>
                    <input type="number" id="nota" name="nota" min="0" max="10" step="0.1" placeholder="Ex: 8.5">
                </div>

            </form>
            <!-- FIM DO FORMULÁRIO -->

            <!-- CONTAINER PARA O BOTÃO -->
            <div class="submit-button-container">
                <button type="submit" form="create-actress-form">Criar</button>
            </div>

        </div>
    </main>
    <!-- FIM ÁREA DE CONTEÚDO -->

<!-- ========================== JAVASCRIPT ========================== -->
<script type="module">
    // Import Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBZEffPMXgbSHYUUrNdIS5duAVGlKlmSq0", // IMPORTANT: Consider securing this key
      authDomain: "babes-392fd.firebaseapp.com",
      projectId: "babes-392fd",
      storageBucket: "babes-392fd.appspot.com",
      messagingSenderId: "376795361631",
      appId: "1:376795361631:web:d662f2b2f2cd23b115c6ea"
    };

    // Initialize Firebase
    console.log("DEBUG: Initializing Firebase app..."); // DEBUG
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log("DEBUG: Firebase initialized."); // DEBUG

    // --- ELEMENTOS DO DOM ---
    const form = document.getElementById('create-actress-form');
    const submitButton = document.querySelector('button[form="create-actress-form"]');
    const sourceTextArea = document.getElementById('texto');
    const nameInput = document.getElementById('name');
    const nameErrorMessage = document.getElementById('name-error-message'); // Make sure this ID matches HTML
    console.log("DEBUG: DOM elements obtained:", { // DEBUG
        form: !!form,
        submitButton: !!submitButton,
        sourceTextArea: !!sourceTextArea,
        nameInput: !!nameInput,
        nameErrorMessage: !!nameErrorMessage // Check if this is true
    });


    // --- MAPEAMENTO: ID do Formulário -> Nome do Campo no Firestore ---
    const firestoreFieldMap = {
        'name': 'nome', 'texto': 'texto', 'foto': 'foto', 'born': 'dataNascimento',
        'birthplace': 'pais', 'ethnicity': 'etnia', 'hair_color': 'corCabelo',
        'eye_color': 'corOlhos', 'height': 'altura', 'weight': 'peso',
        'body_type': 'tipoCorpo', 'measurements': 'medidas', 'years_active': 'AnosAtiva',
        'nota': 'nota'
    };

    // --- FUNÇÕES HELPER PARA FORMATAÇÃO ---
    function formatBornDate(dateString) {
        const dateRegex = /(\d{1,2})(?:st|nd|rd|th)?\s+(?:of\s+)?([a-zA-Z]+)\s+(\d{4})/;
        const match = dateString.match(dateRegex);
        if (match) {
            const day = match[1].padStart(2, '0');
            const monthName = match[2];
            const year = match[3];
            const monthMap = {'january': '01', 'february': '02', 'march': '03', 'april': '04', 'may': '05', 'june': '06', 'july': '07', 'august': '08', 'september': '09', 'october': '10', 'november': '11', 'december': '12'};
            const monthNumber = monthMap[monthName.toLowerCase()];
            if (monthNumber) return `${year}/${monthNumber}/${day}`; // Format YYYY/MM/DD
            else console.warn(`Mês não reconhecido: "${monthName}"`);
        } else {
             // Try YYYY/MM/DD directly
             const simpleDateRegex = /^(\d{4})[/-](\d{1,2})[/-](\d{1,2})$/;
             const simpleMatch = dateString.match(simpleDateRegex);
             if (simpleMatch) {
                 return `${simpleMatch[1]}/${simpleMatch[2].padStart(2, '0')}/${simpleMatch[3].padStart(2, '0')}`;
             }
            // console.warn(`Formato de data não reconhecido: "${dateString}"`);
        }
        return dateString; // Return original if no format matches
    }
    function extractCmValue(heightString) {
        const cmRegex = /(\d+)\s*cm/i; // Simpler regex looking for number followed by cm
        const match = heightString.match(cmRegex);
        if (match) return match[1];

        // Also check for pattern like "5' 6" (168 cm)"
        const parenCmRegex = /\(\s*(\d+)\s*cm\s*\)/i;
        const parenMatch = heightString.match(parenCmRegex);
        if (parenMatch) return parenMatch[1];

        return ''; // Return empty if no cm value found
    }
    function extractKgValue(weightString) {
         const kgRegex = /(\d+)\s*kg/i; // Simpler regex
        const match = weightString.match(kgRegex);
         if (match) return match[1];

        // Also check for pattern like "110 lbs (50 kg)"
        const parenKgRegex = /\(\s*(\d+)\s*kg\s*\)/i;
        const parenMatch = weightString.match(parenKgRegex);
         if (parenMatch) return parenMatch[1];

        return ''; // Return empty if no kg value found
    }
    function extractStartYear(yearsString) {
        // Look for the first 4-digit number, assuming it's the start year
        const yearRegex = /(\d{4})/;
        const match = yearsString.match(yearRegex);
        return match ? match[1] : ''; // Return the first year found or empty
    }


    // --- Debounce function ---
    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        // console.log(`DEBUG: Debounce called for ${func.name}. Clearing previous timeout.`); // DEBUG
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          // console.log(`DEBUG: Debounce executing ${func.name} after ${delay}ms delay.`); // DEBUG
          func.apply(this, args);
        }, delay);
      };
    }

    // --- Function to check if name exists in Firestore ---
    async function checkNameExists() {
        // DEBUG: Log when the function starts and the name it's checking
        console.log("DEBUG: checkNameExists running for name:", nameInput ? `"${nameInput.value}"` : 'N/A');

        // DEBUG: Check variables before the main IF block
        console.log("DEBUG: checkNameExists - Checking variables before main IF:");
        console.log(`DEBUG:   - nameInput valid? : ${!!nameInput}`);
        console.log(`DEBUG:   - nameErrorMessage valid? : ${!!nameErrorMessage}`); // THIS IS THE KEY CHECK
        console.log(`DEBUG:   - db valid? : ${!!db}`);

        if (!nameInput || !nameErrorMessage || !db) {
            // This log indicates one of the above was false (likely nameErrorMessage)
            console.warn("DEBUG: checkNameExists - PROBLEM: One or more required variables are invalid. Aborting check.");
            return; // Stop execution if essential elements/connections are missing
        }

        const enteredName = nameInput.value.trim();
        // Hide error message initially for every check
        nameErrorMessage.style.display = 'none';
        nameErrorMessage.textContent = '';
        let shouldBeDisabled = false; // Assume button should be enabled

        // If name is empty after trimming, no need to check Firestore
        if (enteredName === '') {
            console.log("DEBUG: checkNameExists - Name is empty, skipping Firestore check.");
            if (submitButton) submitButton.disabled = false; // Ensure button is enabled if name is cleared
            return;
        }

        // Log the actual query being performed
        console.log(`DEBUG: checkNameExists - Querying Firestore for name: "${enteredName}"`);

        try {
            // Perform the Firestore query
            const checkQuery = query(collection(db, "atores"), where("nome", "==", enteredName), limit(1));
            const querySnapshot = await getDocs(checkQuery);

            // Log the result of the query
            console.log(`DEBUG: checkNameExists - Firestore query executed for "${enteredName}". Snapshot empty: ${querySnapshot.empty}, Docs found: ${querySnapshot.size}`);

            if (!querySnapshot.empty) {
                // Name was found in Firestore
                console.log(`DEBUG: checkNameExists - Name "${enteredName}" FOUND in Firestore. Displaying error.`);
                nameErrorMessage.textContent = `O nome "${enteredName}" já existe.`;
                nameErrorMessage.style.display = 'block'; // Show the error message
                shouldBeDisabled = true; // Mark button to be disabled
            } else {
                // Name was not found in Firestore
                 console.log(`DEBUG: checkNameExists - Name "${enteredName}" NOT found in Firestore.`);
                // Error message is already hidden, button should be enabled
                shouldBeDisabled = false;
            }
        } catch (error) {
            // An error occurred during the Firestore query
            console.error("DEBUG: checkNameExists - Firestore query failed:", error);
            nameErrorMessage.textContent = 'Erro ao verificar o nome.'; // Display a generic error
            nameErrorMessage.style.display = 'block';
            shouldBeDisabled = true; // Disable button on error
        } finally {
             // Set the final state of the submit button based on the check outcome
             if (submitButton) {
                 console.log(`DEBUG: checkNameExists - Setting submit button disabled state to: ${shouldBeDisabled}`); // Log final state
                 submitButton.disabled = shouldBeDisabled;
             }
        }
    }


    // --- Declare debouncedCheck OUTSIDE autoFillForm so it's accessible ---
    let debouncedCheck; // Will hold the debounced version of checkNameExists

    // --- FUNÇÃO PRINCIPAL DE AUTO-PREENCHIMENTO ---
    function autoFillForm() {
        console.log("DEBUG: autoFillForm started."); // DEBUG

        if (!sourceTextArea) {
            console.warn("DEBUG: autoFillForm - Source text area not found.");
            return;
        }
        const textContent = sourceTextArea.value;
        const lines = textContent.split('\n');
        let nameWasSetByAutofill = false;

        // Attempt to clear fields only if they are empty
        Object.keys(firestoreFieldMap).forEach(formId => {
             if(formId === 'texto' || formId === 'name' || formId === 'foto' || formId === 'nota') return;
             const inputElement = document.getElementById(formId);
             if (inputElement && !inputElement.value) { // Only clear if empty
                 inputElement.value = '';
             }
         });

        // Fill Name field only if it's currently empty
        if (lines.length > 0 && nameInput && !nameInput.value) {
            const potentialName = lines[0].trim();
            console.log("DEBUG: autoFillForm - Potential name from text area:", `"${potentialName}"`); // DEBUG
            if (potentialName) {
                 nameInput.value = potentialName;
                 console.log("DEBUG: autoFillForm - Name input value set to:", `"${nameInput.value}"`); // DEBUG
                 nameWasSetByAutofill = true;
            }
        } else if (nameInput && nameInput.value) {
             console.log("DEBUG: autoFillForm - Name input already had a value:", `"${nameInput.value}"`); // DEBUG
        }

        // Mappings for parsing text content
        const fieldMappingsForAutofill = {
            'Born': 'dataNascimento', 'Birthplace': 'pais', 'Ethnicity': 'etnia',
            'Hair color': 'corCabelo', 'Eye color': 'corOlhos', 'Height': 'altura',
            'Weight': 'peso', 'Body type': 'tipoCorpo', 'Measurements': 'medidas',
            'Years active': 'AnosAtiva'
         };

        // Fill other fields if they are currently empty
         Object.entries(fieldMappingsForAutofill).forEach(([label, firestoreKey]) => {
             const formId = Object.keys(firestoreFieldMap).find(key => firestoreFieldMap[key] === firestoreKey);
             if(!formId) return;

             const regex = new RegExp(`^${label}:\\s*(.*)$`, 'im');
             const match = textContent.match(regex);
             if (match) {
                 let value = match[1].trim();
                 // Apply formatting helpers
                 if (firestoreKey === 'dataNascimento') value = formatBornDate(value);
                 else if (firestoreKey === 'altura') value = extractCmValue(value);
                 else if (firestoreKey === 'peso') value = extractKgValue(value);
                 else if (firestoreKey === 'AnosAtiva') value = extractStartYear(value);

                 const inputElement = document.getElementById(formId);
                 // Only fill if the element exists AND is currently empty
                 if (inputElement && !inputElement.value) {
                      inputElement.value = value;
                 }
                 else if (!inputElement) console.warn(`DEBUG: autoFillForm - Elemento de formulário com ID "${formId}" não encontrado para ${firestoreKey}`);
             }
         });

         // Trigger name check only if autofill set the name
         console.log(`DEBUG: autoFillForm - Checking conditions to trigger name check. nameWasSetByAutofill: ${nameWasSetByAutofill}, typeof debouncedCheck: ${typeof debouncedCheck}`); // DEBUG
         if (nameWasSetByAutofill && typeof debouncedCheck === 'function') {
             console.log("DEBUG: autoFillForm - Autofill set name, triggering debouncedCheck for name:", `"${nameInput.value}"`); // DEBUG
             debouncedCheck(); // Execute the debounced check
         } else {
              console.log("DEBUG: autoFillForm - Did NOT trigger debouncedCheck. Conditions unmet."); // DEBUG
         }
         console.log("DEBUG: autoFillForm finished."); // DEBUG
    }


    // --- EVENT LISTENERS ---
    console.log("DEBUG: Setting up event listeners..."); // DEBUG

    // Listener for the Name input field
    if (nameInput) {
        console.log("DEBUG: Defining and attaching listeners to Name input."); // DEBUG
        debouncedCheck = debounce(checkNameExists, 500); // Define the debounced check function (500ms delay)
        nameInput.addEventListener('input', debouncedCheck); // Trigger on typing (debounced)
        nameInput.addEventListener('blur', checkNameExists); // Trigger on losing focus (immediate check)
    } else {
        console.warn("DEBUG: Name input element not found, listeners not attached."); // DEBUG
    }

    // Listener for the Text Area input
    if (sourceTextArea) {
        console.log("DEBUG: Attaching listener to Text Area input."); // DEBUG
        sourceTextArea.addEventListener('input', autoFillForm); // Trigger autofill when text area changes
    } else {
        console.warn("DEBUG: Source text area element not found, listener not attached."); // DEBUG
    }


    // Listener for form submission
    if (form && submitButton) {
        console.log("DEBUG: Attaching listener to Form submit."); // DEBUG
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission
            console.log("DEBUG: Form submitted."); // DEBUG

            // Prevent submission if button is already disabled (e.g., due to name check)
            if (submitButton.disabled) {
                 if (nameErrorMessage && nameErrorMessage.style.display === 'block') {
                    alert('Não é possível criar: ' + nameErrorMessage.textContent);
                 } else {
                    alert('Aguarde a verificação do nome ou corrija o erro. Botão está desabilitado.');
                 }
                 console.log("DEBUG: Submit prevented - button is disabled."); // DEBUG
                 return;
            }

            const initialButtonText = 'Criar';
            submitButton.disabled = true; // Disable button during processing
            submitButton.textContent = 'Verificando...';
            console.log("DEBUG: Submit - Button disabled, text set to 'Verificando...'"); // DEBUG

            const formData = new FormData(form);
            const enteredName = formData.get('name')?.trim();

            // Check if name is provided
            if (!enteredName) {
                alert('O campo "Nome" é obrigatório.');
                submitButton.disabled = false; // Re-enable button
                submitButton.textContent = initialButtonText;
                console.log("DEBUG: Submit prevented - Name field is empty."); // DEBUG
                return;
            }

            // --- Perform a final name check right before saving ---
            console.log(`DEBUG: Submit - Performing FINAL check for name: "${enteredName}"`); // DEBUG
            try {
                const finalCheckQuery = query(collection(db, "atores"), where("nome", "==", enteredName), limit(1));
                const finalSnapshot = await getDocs(finalCheckQuery);
                console.log(`DEBUG: Submit - FINAL check query executed. Snapshot empty: ${finalSnapshot.empty}`); // DEBUG

                if (!finalSnapshot.empty) {
                    // Duplicate found during final check
                    if(nameErrorMessage) { // Ensure error message element exists
                        nameErrorMessage.textContent = `O nome "${enteredName}" já existe (verificação final).`;
                        nameErrorMessage.style.display = 'block';
                    }
                    alert(`Já existe uma atriz com o nome "${enteredName}". Não é possível criar duplicados.`);
                    // Keep button disabled
                    submitButton.textContent = initialButtonText; // Reset text but keep disabled
                    console.log(`DEBUG: Submit prevented - FINAL check found duplicate name: "${enteredName}"`); // DEBUG
                    return; // Stop submission
                }
                // --- End of Final Check ---

                // If final check passed, proceed to save
                submitButton.textContent = 'Salvando...';
                console.log("DEBUG: Submit - FINAL check passed. Proceeding to save. Button text: 'Salvando...'"); // DEBUG

                const firestoreData = {};
                // Build the data object for Firestore
                 for (const [formId, firestoreKey] of Object.entries(firestoreFieldMap)) {
                    const rawValue = formData.get(formId);
                     if (rawValue !== null && rawValue !== undefined) {
                        const trimmedValue = typeof rawValue === 'string' ? rawValue.trim() : rawValue;

                        // Skip empty fields unless it's 'nota' (which might be 0)
                        if (trimmedValue === '' && firestoreKey !== 'nota') continue;

                        if (formId === 'nota') {
                            const numValue = parseFloat(trimmedValue);
                            // Store nota only if it's a valid number
                            if (!isNaN(numValue)) {
                                firestoreData[firestoreKey] = numValue;
                            } else if (trimmedValue !== '') {
                                // Log if nota is provided but not a valid number
                                console.warn(`DEBUG: Nota "${trimmedValue}" inválida, não será salva.`);
                            }
                             // If trimmedValue is empty, 'nota' field is simply omitted
                        } else if (formId === 'measurements') {
                            firestoreData[firestoreKey] = trimmedValue; // Save the full string
                            const parts = trimmedValue.split('-');
                            if (parts.length === 3) { // If it looks like B-W-H
                                firestoreData['Boobs'] = parts[0].trim();
                                firestoreData['Waist'] = parts[1].trim();
                                firestoreData['Ass'] = parts[2].trim();
                            } else if (trimmedValue !== '') {
                                 console.warn(`Medidas "${trimmedValue}" não estão no formato B-W-H.`);
                            }
                        } else {
                            // For all other fields
                            firestoreData[firestoreKey] = trimmedValue;
                        }
                    }
                }
                // Add a timestamp for creation
                firestoreData.createdAt = serverTimestamp();

                console.log('DEBUG: Submit - Dados a serem enviados para Firestore:', firestoreData); // Log data before sending

                // Add the document to Firestore
                const docRef = await addDoc(collection(db, "atores"), firestoreData);
                console.log("DEBUG: Submit - Documento escrito com ID: ", docRef.id); // Log success
                alert('Atriz criada com sucesso!');
                form.reset(); // Clear the form
                // Ensure error message is hidden after successful creation
                if (nameErrorMessage) {
                    nameErrorMessage.style.display = 'none';
                    nameErrorMessage.textContent = '';
                }
                 submitButton.disabled = false; // Re-enable button
                 submitButton.textContent = initialButtonText; // Reset button text
                 console.log("DEBUG: Submit - Success. Form reset, button enabled."); // DEBUG

            } catch (error) {
                // Handle errors during the save process
                console.error("DEBUG: Submit - Erro durante o processo de criação: ", error);
                alert(`Erro ao salvar: ${error.message}. Verifique o console.`);
                 submitButton.disabled = false; // Re-enable button on error
                 submitButton.textContent = initialButtonText; // Reset button text
                 console.log("DEBUG: Submit - Error occurred during save. Button enabled."); // DEBUG

            } finally {
                 // This block executes regardless of success or error in the try block
                 // Could add final cleanup or checks if needed, but specific enabling/disabling is handled above.
            }
        });
    } else {
         console.warn("DEBUG: Form or Submit Button not found, submit listener not attached."); // DEBUG
    }
    console.log("DEBUG: Script setup complete."); // DEBUG

</script>

</body>
</html>
