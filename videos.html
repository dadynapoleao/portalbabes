<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site de Atrizes - Videos & Filmes</title>
    <!-- ADD FONT AWESOME FOR ICONS (ADDED FOR THE GEAR ICON) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Estilos Globais e Reset Básico */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
        }
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        /* Estilos para o Menu de Navegação */
        .main-nav {
            background-color: #1f1f1f;
            padding: 0.8em 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            text-align: right;
        }
        .main-nav ul { list-style: none; margin: 0; padding: 0; }
        .main-nav li { display: inline-block; margin-left: 20px; }
        .main-nav a { color: #e0e0e0; text-decoration: none; font-size: 1.1em; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease; }
        .main-nav a:hover { background-color: #bb86fc; color: #121212; }

        /* Estilos do Cabeçalho */
        header { background-color: #1e1e1e; color: #fff; padding: 2em 0; text-align: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        header h1 { margin: 0; font-size: 2.5em; font-weight: 700; letter-spacing: 0.5px; }

        /* --- ESTILOS EXISTENTES DA PÁGINA DE LISTAGEM --- */
        .suggestion-title { padding: 8px 15px; color: #aaa; font-size: 0.9em; font-weight: bold; border-bottom: 1px solid #444; cursor: default; }
        .add-costar-btn { margin-left: auto; padding: 4px 8px; font-size: 0.85em; background-color: #bb86fc; color: #121212; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease; }
        .add-costar-btn:hover { background-color: #a774e6; }
        .filters-container { display: flex; flex-direction: column; padding: 15px 30px; max-width: 1200px; margin: 20px auto 0; background-color: #1f1f1f; border-radius: 8px; gap: 15px; }
        .top-filter-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .filter-buttons { display: flex; gap: 10px; }
        .filter-btn { padding: 8px 15px; border: 1px solid #555; background-color: #333; color: #e0e0e0; border-radius: 6px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .filter-btn:hover { background-color: #444; }
        .filter-btn.active { background-color: #bb86fc; color: #121212; border-color: #bb86fc; font-weight: bold; }
        .actress-search-area { position: relative; width: 100%; }
        .search-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 5px; padding: 5px 10px; border: 1px solid #555; border-radius: 6px; background-color: #2e2e2e; cursor: text; }
        .search-input-wrapper:focus-within { border-color: #bb86fc; box-shadow: 0 0 5px rgba(187, 134, 252, 0.5); }
        #selected-actresses-container { display: contents; }
        .actress-pill { display: inline-flex; align-items: center; background-color: #bb86fc; color: #121212; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; margin: 2px; white-space: nowrap; }
        .actress-pill span { margin-right: 5px; }
        .remove-actress-btn { background: none; border: none; color: #121212; cursor: pointer; font-weight: bold; font-size: 1.1em; padding: 0 2px; line-height: 1; }
        .remove-actress-btn:hover { opacity: 0.7; }
        .search-input { flex-grow: 1; padding: 6px 5px; border: none; background-color: transparent; color: #e0e0e0; font-size: 1em; min-width: 150px; outline: none; }
        #suggestions-list { display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 10; background-color: #2e2e2e; border: 1px solid #555; border-top: none; border-radius: 0 0 6px 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-height: 200px; overflow-y: auto; visibility: visible; opacity: 1; height: auto; }
        .costar-suggestion-item { /* Specific styles if needed */ }
        .suggestion-item { display: flex; padding: 8px 15px; color: #e0e0e0; cursor: pointer; align-items: center; gap: 10px; }
        .suggestion-item:hover { background-color: #444; }
        .suggestion-item.no-results { cursor: default; color: #aaa; justify-content: center; }
        .suggestion-item img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .suggestion-item.related-suggestion { background-color: #3a3a3a; }
        .suggestion-item.related-suggestion:hover { background-color: #505050; }
        .content-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; padding: 30px; max-width: 1200px; margin: 10px auto 20px; }
        .content-card-link { text-decoration: none; color: inherit; display: block; height: 100%; }
        .content-card { background-color: #242424; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); transition: transform 0.3s ease, box-shadow 0.3s ease; height: 100%; display: flex; flex-direction: column; position: relative; }
        .content-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4); }
        .content-card img { width: 100%; height: 250px; object-fit: cover; display: block; }
        .content-info { padding: 15px 20px 20px; text-align: center; margin-top: auto; }
        .content-info h3 { margin: 0 0 8px 0; font-size: 1.3em; font-weight: normal; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .content-info .year { font-size: 0.9em; color: #aaa; margin-top: -5px; }
        .video-number-badge { position: absolute; top: 10px; left: 10px; background-color: rgba(187, 134, 252, 0.85); color: #121212; font-size: 0.9em; font-weight: bold; padding: 4px 8px; border-radius: 4px; z-index: 1; }
        .message { color: #aaa; font-size: 1.1em; text-align: center; padding: 40px; grid-column: 1 / -1; }

        /* --- ESTILOS PARA O POPUP DE CRIAÇÃO --- */
        #open-create-popup-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background-color: #bb86fc;
            color: #121212;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            font-size: 1.5em;
            line-height: 55px; /* Centraliza ícone verticalmente */
            text-align: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            z-index: 999; /* Fica acima de outros conteúdos */
        }
        #open-create-popup-btn:hover {
            background-color: #a774e6;
            transform: scale(1.1);
        }

        .create-popup-overlay {
            display: none; /* Escondido por padrão */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Mais escuro */
            z-index: 1050; /* Acima do botão */
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; /* Permite scroll se conteúdo for maior */
        }

        .create-popup-content {
            background-color: #2a2a2a; /* Fundo do popup */
            padding: 25px 35px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            max-width: 700px; /* Largura */
            width: 100%;
            position: relative;
             max-height: 90vh; /* Altura máxima */
             display: flex;
             flex-direction: column;
        }

        .create-popup-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.8em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: none;
            padding: 5px;
            line-height: 1;
        }
        .create-popup-close-btn:hover { color: #fff; }

        .create-popup-content h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            color: #fff;
            font-weight: normal;
        }

        /* Estilos do Formulário dentro do Popup */
        #create-form-container {
             flex-grow: 1; /* Ocupa espaço vertical */
             overflow-y: auto; /* Scroll interno se necessário */
             padding-right: 10px; /* Espaço para scrollbar */
        }
        .create-form-group {
            margin-bottom: 20px;
        }
        .create-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-size: 0.9em;
            font-weight: bold;
        }
        .create-form-group input[type="text"],
        .create-form-group input[type="number"],
        .create-form-group input[type="url"],
        .create-form-group select {
            width: 100%;
            padding: 10px 12px;
            background-color: #404040;
            border: 1px solid #555;
            border-radius: 5px;
            color: #e0e0e0;
            box-sizing: border-box;
            font-size: 1em;
        }
        /* Removed min-height for multi-select as it's gone */

        .create-form-group input:focus,
        .create-form-group select:focus {
           outline: none;
           border-color: #bb86fc;
           box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.3);
        }

        /* Esconder formulários específicos por padrão */
        #video-form, #scene-form, #movie-form {
            display: none;
        }

        /* Botão Salvar e Mensagem de Status */
        #create-status-message {
            margin-top: 15px;
            text-align: center;
            min-height: 1.2em; /* Evita pulo de layout */
            font-size: 0.9em;
        }
        #create-status-message.success { color: #4CAF50; }
        #create-status-message.error { color: #f44336; }

        #save-content-button {
            display: block;
            width: 100%;
            margin-top: 25px;
            background-color: #bb86fc;
            color: #121212;
            padding: 14px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #save-content-button:hover { background-color: #a774e6; }
        #save-content-button:disabled { background-color: #555; color: #999; cursor: not-allowed; }

        /* --- NOVOS ESTILOS PARA POPUP ACTRESS SEARCH --- */
        /* Style for the container holding selected pills inside the popup */
        .selected-actresses-container-popup {
            display: contents; /* Behaves like the main page one */
        }

        /* Style for the suggestions list specifically within the popup */
        .suggestions-list-popup {
            /* Copy styles from #suggestions-list */
            display: none;
            position: absolute;
            top: 100%; /* Position below the input wrapper */
            left: 0;
            right: 0;
            z-index: 1060; /* Ensure it's above popup content but below modals if any */
            background-color: #2e2e2e;
            border: 1px solid #555;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-height: 180px; /* Slightly smaller max-height maybe */
            overflow-y: auto;
        }

        /* Ensure popup search wrappers behave correctly */
        .popup-search-wrapper {
            /* Re-apply relevant styles if needed, but defaults should work */
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #404040; /* Match popup input background */
            cursor: text;
            margin-top: 5px; /* Add some space below the label */
        }
        .popup-search-wrapper:focus-within {
           border-color: #bb86fc;
           box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.3); /* Match popup focus */
        }

        .popup-search-input {
            /* Re-apply relevant styles if needed */
            flex-grow: 1;
            padding: 6px 5px;
            border: none;
            background-color: transparent;
            color: #e0e0e0;
            font-size: 1em;
            min-width: 150px;
            outline: none;
        }

        /* Reuse suggestion item styles - ensure they work with the new parent */
        .suggestions-list-popup .suggestion-item {
            display: flex;
            padding: 8px 15px;
            color: #e0e0e0;
            cursor: pointer;
            align-items: center;
            gap: 10px;
        }
        .suggestions-list-popup .suggestion-item:hover {
            background-color: #444;
        }
        .suggestions-list-popup .suggestion-item.no-results {
            cursor: default;
            color: #aaa;
            justify-content: center;
        }
        .suggestions-list-popup .suggestion-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* Ensure pills look the same */
        .popup-search-wrapper .actress-pill {
            display: inline-flex;
            align-items: center;
            background-color: #bb86fc;
            color: #121212;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin: 2px;
            white-space: nowrap;
        }
        .popup-search-wrapper .actress-pill span { margin-right: 5px; }
        .popup-search-wrapper .remove-actress-btn {
            background: none; border: none; color: #121212; cursor: pointer;
            font-weight: bold; font-size: 1.1em; padding: 0 2px; line-height: 1;
        }
        .popup-search-wrapper .remove-actress-btn:hover { opacity: 0.7; }

        /* --- FIM DOS ESTILOS DO POPUP --- */
    </style>
</head>
<body>

    <!-- MENU DE NAVEGAÇÃO -->
    <nav class="main-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="criar.html">Criar</a></li>
            <li><a href="videos.html">Videos</a></li>
        </ul>
    </nav>
    <!-- FIM MENU -->

    <header>
        <h1>Vídeos & Filmes</h1>
    </header>

    <!-- FILTERS AND SEARCH AREA -->
    <div class="filters-container">
        <div class="top-filter-row">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="video">Só Vídeos</button>
                <button class="filter-btn" data-filter="film">Só Filmes</button>
            </div>
        </div>
        <div class="actress-search-area">
            <div class="search-input-wrapper" onclick="document.getElementById('search-input').focus()">
                <div id="selected-actresses-container"></div>
                <input type="text" id="search-input" class="search-input" placeholder="Pesquisar por atriz...">
            </div>
            <div id="suggestions-list"></div>
        </div>
    </div>
    <!-- END FILTERS AND SEARCH AREA -->

    <!-- CONTAINER PRINCIPAL PARA VÍDEOS E FILMES -->
    <div class="content-grid-container" id="videos-filmes-container">
        <p class="message">Carregando conteúdo...</p>
        <!-- Cards de vídeos e filmes serão inseridos aqui -->
    </div>
    <!-- FIM CONTAINER -->

    <!-- BOTÃO DE ENGRENAGEM PARA ABRIR POPUP -->
    <button id="open-create-popup-btn" title="Criar Novo Conteúdo">
        <i class="fa-solid fa-gear"></i>
    </button>

    <!-- POPUP DE CRIAÇÃO (Escondido Inicialmente) -->
    <div class="create-popup-overlay" id="create-popup-overlay">
        <div class="create-popup-content">
            <button class="create-popup-close-btn" id="close-create-popup-btn">×</button>
            <h2>Criar Novo Conteúdo</h2>
            <div class="create-form-group">
                <label for="content-type-selector">Tipo de Conteúdo:</label>
                <select id="content-type-selector">
                    <option value="">-- Selecione --</option>
                    <option value="video">Vídeo</option>
                    <option value="scene">Cena</option>
                    <option value="movie">Filme</option>
                </select>
            </div>
            <div id="create-form-container">
                <!-- === Video Form === -->
                <div id="video-form">
                     <div class="create-form-group"> <label for="video-nome">Nome:</label> <input type="text" id="video-nome" required> </div>
                    <div class="create-form-group"> <label for="video-ano">Ano:</label> <input type="number" id="video-ano" placeholder="Ex: 2023"> </div>
                     <div class="create-form-group"> <label for="video-imagem">Imagem (URL):</label> <input type="url" id="video-imagem" placeholder="https://..."> </div>
                    <div class="create-form-group"> <label for="video-pagina">Página (URL Externa):</label> <input type="url" id="video-pagina" placeholder="https://..."> </div>
                    <!-- *** NEW ACTRESS SEARCH FOR VIDEO *** -->
                    <div class="create-form-group">
                        <label for="popup-video-search-input">Atrizes:</label>
                        <div class="actress-search-area" id="popup-video-actress-search">
                            <div class="search-input-wrapper popup-search-wrapper" onclick="document.getElementById('popup-video-search-input').focus()">
                                <!-- Selected actress pills will go here -->
                                <div id="popup-video-selected-actresses" class="selected-actresses-container-popup"></div>
                                <input type="text" id="popup-video-search-input" class="search-input popup-search-input" placeholder="Pesquisar e adicionar atriz...">
                            </div>
                            <!-- Suggestions list for this input -->
                            <div id="popup-video-suggestions" class="suggestions-list-popup"></div>
                        </div>
                    </div>
                    <!-- *** END NEW ACTRESS SEARCH FOR VIDEO *** -->
                </div>
                <!-- === Scene Form === -->
                <div id="scene-form">
                     <div class="create-form-group"> <label for="scene-nome">Nome da Cena:</label> <input type="text" id="scene-nome" required> </div>
                     <div class="create-form-group"> <label for="scene-filme">Filme:</label> <select id="scene-filme" required> <option value="">Carregando filmes...</option> </select> </div>
                    <div class="create-form-group"> <label for="scene-numero">Número da Cena:</label> <select id="scene-numero" required> <option value="">--</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> </select> </div>
                    <div class="create-form-group"> <label for="scene-ano">Ano:</label> <input type="number" id="scene-ano" placeholder="Ex: 2023"> </div>
                    <div class="create-form-group"> <label for="scene-imagem">Imagem (URL):</label> <input type="url" id="scene-imagem" placeholder="https://..."> </div>
                    <div class="create-form-group"> <label for="scene-pagina">Página (URL Externa):</label> <input type="url" id="scene-pagina" placeholder="https://..."> </div>
                    <!-- *** NEW ACTRESS SEARCH FOR SCENE *** -->
                     <div class="create-form-group">
                        <label for="popup-scene-search-input">Atrizes:</label>
                        <div class="actress-search-area" id="popup-scene-actress-search">
                            <div class="search-input-wrapper popup-search-wrapper" onclick="document.getElementById('popup-scene-search-input').focus()">
                                <!-- Selected actress pills will go here -->
                                <div id="popup-scene-selected-actresses" class="selected-actresses-container-popup"></div>
                                <input type="text" id="popup-scene-search-input" class="search-input popup-search-input" placeholder="Pesquisar e adicionar atriz...">
                            </div>
                            <!-- Suggestions list for this input -->
                            <div id="popup-scene-suggestions" class="suggestions-list-popup"></div>
                        </div>
                    </div>
                    <!-- *** END NEW ACTRESS SEARCH FOR SCENE *** -->
                </div>
                <!-- === Movie Form === -->
                <div id="movie-form">
                     <div class="create-form-group"> <label for="movie-nome">Nome do Filme:</label> <input type="text" id="movie-nome" required> </div>
                    <div class="create-form-group"> <label for="movie-ano">Ano:</label> <input type="number" id="movie-ano" placeholder="Ex: 2023"> </div>
                    <div class="create-form-group"> <label for="movie-imagem">Imagem (URL):</label> <input type="url" id="movie-imagem" placeholder="https://..."> </div>
                    <div class="create-form-group"> <label for="movie-pagina">Página (URL Externa):</label> <input type="url" id="movie-pagina" placeholder="https://..."> </div>
                     <!-- Movies don't have actresses directly attached in this form -->
                </div>
            </div>
            <div id="create-status-message"></div>
            <button id="save-content-button" disabled>Salvar</button>
        </div>
    </div>
    <!-- FIM POPUP DE CRIAÇÃO -->

    <!-- Firebase Modular SDKs via CDN -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Config (igual)
        const firebaseConfig = {
            apiKey: "AIzaSyBZEffPMXgbSHYUUrNdIS5duAVGlKlmSq0",
            authDomain: "babes-392fd.firebaseapp.com",
            projectId: "babes-392fd",
            storageBucket: "babes-392fd.appspot.com",
            messagingSenderId: "376795361631",
            appId: "1:376795361631:web:d662f2b2f2cd23b115c6ea"
        };

        // Initialize Firebase (igual)
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM References (Existing Page) ---
        const contentContainer = document.getElementById('videos-filmes-container');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const searchInput = document.getElementById('search-input');
        const suggestionsList = document.getElementById('suggestions-list');
        const selectedActressesContainer = document.getElementById('selected-actresses-container');
        const searchInputWrapper = document.querySelector('.search-input-wrapper');


        // --- DOM References (Popup - UPDATED) ---
        const openCreatePopupBtn = document.getElementById('open-create-popup-btn');
        const createPopupOverlay = document.getElementById('create-popup-overlay');
        const closeCreatePopupBtn = document.getElementById('close-create-popup-btn');
        const contentTypeSelector = document.getElementById('content-type-selector');
        const formContainer = document.getElementById('create-form-container');
        const videoForm = document.getElementById('video-form');
        const sceneForm = document.getElementById('scene-form');
        const movieForm = document.getElementById('movie-form');
        const saveContentButton = document.getElementById('save-content-button');
        const createStatusMessage = document.getElementById('create-status-message');
        // REMOVED: videoActoresSelect, sceneActoresSelect
        const sceneFilmeSelect = document.getElementById('scene-filme');

        // ADDED: References for new popup actress search elements
        const popupVideoSearchInput = document.getElementById('popup-video-search-input');
        const popupVideoSuggestions = document.getElementById('popup-video-suggestions');
        const popupVideoSelectedContainer = document.getElementById('popup-video-selected-actresses');

        const popupSceneSearchInput = document.getElementById('popup-scene-search-input');
        const popupSceneSuggestions = document.getElementById('popup-scene-suggestions');
        const popupSceneSelectedContainer = document.getElementById('popup-scene-selected-actresses');


        // --- Global Data Storage (Existing Page) ---
        let allContent = [];
        let allActresses = []; // Used by BOTH main page and popup searches
        let selectedActresses = []; // For main page filter
        let activeTypeFilter = 'all';

        // --- Popup State Variables (UPDATED) ---
        // REMOVED: actorsLoaded
        let moviesLoaded = false;
        let popupSelectedVideoActresses = []; // NEW: Holds selected actresses for the video form
        let popupSelectedSceneActresses = []; // NEW: Holds selected actresses for the scene form


        // --- FUNCTION TO RENDER CONTENT BASED ON FILTERS (Existing Page - UNCHANGED) ---
        function renderContent() {
            if (!contentContainer) return;
            let contentHTML = '';
            const filteredContent = allContent.filter(item => {
                const typeMatch = activeTypeFilter === 'all' || item.type === activeTypeFilter;
                if (!typeMatch) return false;
                if (selectedActresses.length > 0) {
                    if (!item.atores || !Array.isArray(item.atores) || item.atores.length === 0) return false;
                    const itemActressIds = item.atores;
                    const selectedActressIds = selectedActresses.map(a => a.id);
                    const allSelectedArePresent = selectedActressIds.every(selectedId => itemActressIds.includes(selectedId));
                    if (!allSelectedArePresent) return false;
                }
                return true;
            });
            if (filteredContent.length === 0) {
                contentHTML = '<p class="message">Nenhum resultado encontrado para os filtros selecionados.</p>';
            } else {
                 // Ordenar: Vídeos primeiro pelo número (se existir), depois filmes pelo nome
                filteredContent.sort((a, b) => {
                    if (a.type === 'video' && b.type === 'film') return -1; // Vídeos antes de filmes
                    if (a.type === 'film' && b.type === 'video') return 1;  // Filmes depois de vídeos
                    if (a.type === 'video' && b.type === 'video') {
                        // Ordena vídeos por número (maior primeiro), ou nome se não tiver número
                        const noA = typeof a.no === 'number' ? a.no : -Infinity;
                        const noB = typeof b.no === 'number' ? b.no : -Infinity;
                        if (noB !== noA) return noB - noA; // Decrescente por número
                        return (a.nome || '').localeCompare(b.nome || ''); // Desempate por nome
                    }
                    // Se ambos são filmes ou nenhum tem tipo definido, ordena por nome
                    return (a.nome || '').localeCompare(b.nome || '');
                });
                filteredContent.forEach(item => { contentHTML += generateCardHTML(item); });
            }
            contentContainer.innerHTML = contentHTML;
        }
        function generateCardHTML(item) {
            const nome = item.nome || (item.type === 'video' ? 'Vídeo sem nome' : 'Filme sem nome');
            const imagem = item.imagem || 'path/to/default/placeholder.png'; // Use a real path
            const ano = item.ano || 'N/A';
            const videoNo = item.no !== undefined ? item.no : '?';
            let cardLink = '#';
            // Determine link based on type - Make sure these target pages exist
            if (item.type === 'video') { cardLink = `vid.html?id=${item.id}`; } // Assumes vid.html
            else if (item.type === 'film') { cardLink = `film_detail.html?id=${item.id}`; } // Assumes film_detail.html
            else if (item.type === 'scene') { cardLink = `scene_detail.html?id=${item.id}`; } // Assumes scene_detail.html (If scenes have detail pages)

            let cardHTML = `<a href="${cardLink}" class="content-card-link">`;
            if (item.type === 'video') {
                cardHTML += `<div class="content-card video-card" data-id="${item.id}">`;
                if (videoNo !== '?') {
                    cardHTML += `<span class="video-number-badge">#${videoNo}</span>`;
                }
                 cardHTML += `<img src="${imagem}" alt="${nome}"><div class="content-info"><h3>${nome}</h3></div></div>`;
            } else if (item.type === 'film') { // Film Card
                cardHTML += `<div class="content-card film-card" data-id="${item.id}"><img src="${imagem}" alt="${nome}"><div class="content-info"><h3>${nome}</h3><p class="year">(${ano})</p></div></div>`;
            } else if (item.type === 'scene') { // Scene Card (Example - Adjust as needed)
                 cardHTML += `<div class="content-card scene-card" data-id="${item.id}">`;
                 // Maybe display scene number or related movie name?
                 cardHTML += `<img src="${imagem}" alt="${nome}"><div class="content-info"><h3>${nome}</h3><p class="year">(Cena ${item.numeroCena || ''})</p></div></div>`;
             }
             else { // Fallback for unknown type
                 cardHTML += `<div class="content-card unknown-card" data-id="${item.id}"><img src="${imagem}" alt="${nome}"><div class="content-info"><h3>${nome}</h3></div></div>`;
             }
            cardHTML += `</a>`;
            return cardHTML;
        }

        // --- FUNCTIONS FOR MAIN PAGE ACTRESS SEARCH & SELECTION (Existing Page - UNCHANGED) ---
        // These functions ONLY affect the main filter bar
        function updateCoStarsList() {
             suggestionsList.innerHTML = '';
             suggestionsList.style.display = 'none';
             if (selectedActresses.length === 0 || !allActresses.length) return; // Check if actresses loaded

             const selectedActressIds = selectedActresses.map(a => a.id);

             // Find content items that contain ALL selected actresses
             let commonContentItems = allContent.filter(item => {
                 if (!item.atores || !Array.isArray(item.atores) || item.atores.length < selectedActresses.length) return false;
                 return selectedActressIds.every(selectedId => item.atores.includes(selectedId));
             });

             if (commonContentItems.length === 0 && selectedActresses.length > 0) { // Changed condition slightly
                 const noCommonItem = document.createElement('div');
                 noCommonItem.classList.add('suggestion-item', 'no-results');
                 noCommonItem.textContent = 'Nenhum conteúdo encontrado com todas as atrizes selecionadas.';
                 suggestionsList.appendChild(noCommonItem);
                 suggestionsList.style.display = 'block';
                 return;
             }

             // Collect all actress IDs from these common items
             let potentialCoStarIds = new Set();
             commonContentItems.forEach(item => {
                 item.atores.forEach(actressId => {
                     potentialCoStarIds.add(actressId);
                 });
             });

             // Remove the already selected actresses from the potential co-stars
             selectedActressIds.forEach(idToRemove => {
                 potentialCoStarIds.delete(idToRemove);
             });

             // Filter the main actress list to get the actual co-star objects
             const validCoStars = allActresses.filter(actress => potentialCoStarIds.has(actress.id));

              // Sort co-stars alphabetically by name
             validCoStars.sort((a, b) => a.nome.localeCompare(b.nome));

             if (validCoStars.length > 0) {
                 const titleItem = document.createElement('div');
                 titleItem.classList.add('suggestion-title');
                 const titlePrefix = selectedActresses.length === 1 ? `Co-estrelas de ${selectedActresses[0].nome}` : 'Co-estrelas Comuns';
                 titleItem.textContent = `${titlePrefix}:`;
                 suggestionsList.appendChild(titleItem);

                 validCoStars.forEach(coStar => {
                     const item = document.createElement('div');
                     item.classList.add('suggestion-item', 'costar-suggestion-item');
                     item.innerHTML = `
                         <img src="${coStar.foto || 'path/to/default/avatar.png'}" alt="${coStar.nome}">
                         <span>${coStar.nome}</span>
                         <button class="add-costar-btn" data-id="${coStar.id}" data-name="${coStar.nome}">Adicionar</button>
                     `;
                     suggestionsList.appendChild(item);
                 });
                 suggestionsList.style.display = 'block';
             } else if (selectedActresses.length > 0) { // Only show "no results" if actresses ARE selected
                 const noResultsItem = document.createElement('div');
                 noResultsItem.classList.add('suggestion-item', 'no-results');
                 const reasonText = selectedActresses.length === 1 ? `Nenhuma co-estrela adicional encontrada para ${selectedActresses[0].nome}` : 'Nenhuma co-estrela comum adicional encontrada';
                 noResultsItem.textContent = reasonText;
                 suggestionsList.appendChild(noResultsItem);
                 suggestionsList.style.display = 'block';
             }
         }
        function handleAddCoStarClick(event) {
            const button = event.target;
            const actressId = button.dataset.id;
            const actressName = button.dataset.name;
            if (!actressId || !actressName) return;

            // Check if already selected
            if (!selectedActresses.some(a => a.id === actressId)) {
                selectedActresses.push({ id: actressId, nome: actressName });
                renderSelectedActressesPills(); // Update main pills
                renderContent(); // Re-filter main content
                updateCoStarsList(); // Update suggestions based on new selection
            }
         }
        function displayStandardSuggestions(searchTerm) {
             suggestionsList.innerHTML = '';
             if (!searchTerm) {
                 // If input is empty BUT actresses are selected, show co-stars
                 if(selectedActresses.length > 0) {
                     updateCoStarsList();
                 } else {
                     suggestionsList.style.display = 'none';
                 }
                 return;
             }

             const lowerSearchTerm = searchTerm.toLowerCase();
             const matchedActresses = allActresses.filter(actress =>
                 actress.nome.toLowerCase().includes(lowerSearchTerm) &&
                 !selectedActresses.some(sa => sa.id === actress.id) // Exclude already selected
             );

             if (matchedActresses.length > 0) {
                 // Optional: Add a title for standard suggestions?
                 // const titleItem = document.createElement('div'); titleItem.classList.add('suggestion-title'); titleItem.textContent = 'Adicionar Atriz:'; suggestionsList.appendChild(titleItem);

                 matchedActresses.slice(0, 10).forEach(actress => {
                     const item = document.createElement('div');
                     item.classList.add('suggestion-item');
                     item.dataset.id = actress.id;
                     item.dataset.nome = actress.nome;
                     item.innerHTML = `<img src="${actress.foto || 'path/to/default/avatar.png'}" alt=""><span>${actress.nome}</span>`;
                     item.addEventListener('click', handleSelectActressClick); // Main page select handler
                     suggestionsList.appendChild(item);
                 });
                 suggestionsList.style.display = 'block';
             } else {
                 suggestionsList.innerHTML = '<div class="suggestion-item no-results">Nenhuma atriz encontrada</div>';
                 suggestionsList.style.display = 'block';
             }
        }
        function handleSelectActressClick(event) {
            const target = event.currentTarget;
            const actressId = target.dataset.id;
            const actressName = target.dataset.nome;
            if (!actressId || !actressName) { console.error("Data missing!"); return; }

            if (!selectedActresses.some(a => a.id === actressId)) {
                selectedActresses.push({ id: actressId, nome: actressName });
                renderSelectedActressesPills(); // Update main pills
                renderContent(); // Re-filter main content
                // Use setTimeout to ensure DOM updates before CoStar list calculation
                setTimeout(() => { updateCoStarsList(); }, 0);
            } else {
                // If already selected, just hide suggestions
                 suggestionsList.innerHTML = '';
                 suggestionsList.style.display = 'none';
            }
            searchInput.value = ''; // Clear main search input after selection
        }
        function renderSelectedActressesPills() {
            if (!selectedActressesContainer) return;
             selectedActressesContainer.innerHTML = '';
             selectedActresses.forEach(actress => {
                 const pill = document.createElement('div');
                 pill.classList.add('actress-pill');
                 pill.dataset.id = actress.id; // Store ID on the pill
                 pill.innerHTML = `
                     <span>${actress.nome}</span>
                     <button class="remove-actress-btn" title="Remover">×</button>
                 `;
                 // Add event listener SPECIFIC to the MAIN PAGE remove handler
                 pill.querySelector('.remove-actress-btn').addEventListener('click', handleRemoveActress);
                 selectedActressesContainer.appendChild(pill);
             });
        }
        function handleRemoveActress(event) {
             event.stopPropagation(); // Prevent clicks bubbling up (e.g., to wrapper)
             const pill = event.target.closest('.actress-pill');
             if (!pill) return;
             const actressIdToRemove = pill.dataset.id;

             // Remove from the main selected array
             selectedActresses = selectedActresses.filter(a => a.id !== actressIdToRemove);

             // Re-render the main pills, content, and suggestions
             renderSelectedActressesPills();
             renderContent();
             // Update suggestions based on remaining selection (or clear if none left)
             if (searchInput.value) {
                displayStandardSuggestions(searchInput.value);
             } else {
                updateCoStarsList();
             }
        }


        // --- NEW/ADAPTED FUNCTIONS FOR POPUP ACTRESS SEARCH & SELECTION ---

        /**
         * Renders actress pills inside the specified popup container.
         * @param {Array} selectedArray - The array holding selected actresses (e.g., popupSelectedVideoActresses).
         * @param {HTMLElement} pillsContainerElement - The container element for the pills.
         */
        function renderPopupActressPills(selectedArray, pillsContainerElement) {
            if (!pillsContainerElement) return;
            pillsContainerElement.innerHTML = '';
            selectedArray.forEach(actress => {
                const pill = document.createElement('div');
                pill.classList.add('actress-pill');
                pill.dataset.id = actress.id; // Store ID on the pill
                pill.innerHTML = `
                    <span>${actress.nome}</span>
                    <button class="remove-actress-btn" title="Remover">×</button>
                `;
                // Add event listener SPECIFIC to the popup remove handler
                pill.querySelector('.remove-actress-btn').addEventListener('click', (e) => handlePopupRemoveActress(e, selectedArray, pillsContainerElement));
                pillsContainerElement.appendChild(pill);
            });
        }

        /**
         * Handles removing an actress pill from a popup form.
         * @param {Event} event - The click event.
         * @param {Array} selectedArray - The array holding selected actresses (e.g., popupSelectedVideoActresses).
         * @param {HTMLElement} pillsContainerElement - The container element for the pills.
         */
        function handlePopupRemoveActress(event, selectedArray, pillsContainerElement) {
            event.stopPropagation(); // Prevent clicks bubbling up (e.g., to wrapper)
            const pill = event.target.closest('.actress-pill');
            if (!pill) return;
            const actressIdToRemove = pill.dataset.id;

            // Find the index and remove from the specific array
            const indexToRemove = selectedArray.findIndex(a => a.id === actressIdToRemove);
            if (indexToRemove > -1) {
                selectedArray.splice(indexToRemove, 1);
            }

            // Re-render the pills for that specific container
            renderPopupActressPills(selectedArray, pillsContainerElement);
        }

        /**
         * Displays actress suggestions within the specified popup suggestion list.
         * @param {string} searchTerm - The text typed by the user.
         * @param {HTMLElement} suggestionsListElement - The suggestions list element (e.g., popupVideoSuggestions).
         * @param {Array} selectedArray - The array holding already selected actresses for THIS form.
         * @param {HTMLElement} inputElement - The input element being typed into.
         * @param {HTMLElement} pillsContainerElement - The pill container for THIS form.
         */
        function displayPopupSuggestions(searchTerm, suggestionsListElement, selectedArray, inputElement, pillsContainerElement) {
            if (!suggestionsListElement) return;
            suggestionsListElement.innerHTML = '';
            if (!searchTerm) {
                suggestionsListElement.style.display = 'none';
                return;
            }

            const lowerSearchTerm = searchTerm.toLowerCase();
            // Filter from all available actresses, excluding those already selected IN THIS POPUP FORM
            const matchedActresses = allActresses.filter(actress =>
                actress.nome.toLowerCase().includes(lowerSearchTerm) &&
                !selectedArray.some(sa => sa.id === actress.id) // Check against the specific popup array
            );

             // Sort matched actresses alphabetically
             matchedActresses.sort((a, b) => a.nome.localeCompare(b.nome));

            if (matchedActresses.length > 0) {
                matchedActresses.slice(0, 7).forEach(actress => { // Limit suggestions
                    const item = document.createElement('div');
                    item.classList.add('suggestion-item');
                    // Add necessary data attributes for selection
                    item.dataset.id = actress.id;
                    item.dataset.nome = actress.nome;
                    item.innerHTML = `
                        <img src="${actress.foto || 'path/to/default/avatar.png'}" alt="">
                        <span>${actress.nome}</span>
                    `;
                    // Add event listener SPECIFIC to the popup select handler
                    item.addEventListener('click', (e) => handlePopupSelectActress(e, inputElement, suggestionsListElement, selectedArray, pillsContainerElement));
                    suggestionsListElement.appendChild(item);
                });
                suggestionsListElement.style.display = 'block';
            } else {
                suggestionsListElement.innerHTML = '<div class="suggestion-item no-results">Nenhuma atriz encontrada</div>';
                suggestionsListElement.style.display = 'block';
            }
        }

        /**
         * Handles selecting an actress from the popup suggestions list.
         * @param {Event} event - The click event.
         * @param {HTMLElement} inputElement - The input element associated with this selection.
         * @param {HTMLElement} suggestionsListElement - The suggestions list element.
         * @param {Array} selectedArray - The array to add the selected actress to.
         * @param {HTMLElement} pillsContainerElement - The container for rendering the pills.
         */
        function handlePopupSelectActress(event, inputElement, suggestionsListElement, selectedArray, pillsContainerElement) {
            const target = event.currentTarget;
            const actressId = target.dataset.id;
            const actressName = target.dataset.nome;

            if (!actressId || !actressName) {
                console.error("Data missing on suggestion item!");
                return;
            }

            // Add to the specific popup's selected array if not already present
            if (!selectedArray.some(a => a.id === actressId)) {
                selectedArray.push({ id: actressId, nome: actressName });
                // Render the pills for the specific container
                renderPopupActressPills(selectedArray, pillsContainerElement);
            }

            // Clear input and hide suggestions
            if (inputElement) inputElement.value = '';
            if (suggestionsListElement) suggestionsListElement.style.display = 'none';
            if (inputElement) inputElement.focus(); // Keep focus in the input area
        }


        // --- FUNCTIONS FOR POPUP (Main Logic - UPDATED) ---

        // REMOVED loadActorsForSelect()

        // Load movies for scene form (UNCHANGED)
        async function loadMoviesForSelect() {
            if (moviesLoaded || !sceneFilmeSelect) return;
            console.log("Loading movies for popup select...");
            sceneFilmeSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                const moviesQuery = query(collection(db, "filmes"), orderBy("nome", "asc"));
                const querySnapshot = await getDocs(moviesQuery);
                let optionsHTML = '<option value="">-- Selecione um Filme --</option>';
                if (querySnapshot.empty) {
                     optionsHTML += '<option value="" disabled>Nenhum filme encontrado</option>';
                } else {
                    querySnapshot.forEach(doc => {
                        const movie = doc.data();
                         if (movie.nome) { // Only add movies with names
                            optionsHTML += `<option value="${doc.id}">${movie.nome}</option>`;
                        }
                    });
                }
                sceneFilmeSelect.innerHTML = optionsHTML;
                moviesLoaded = true; // Mark as loaded for this popup session
                console.log("Movies loaded successfully for popup.");
            } catch (error) {
                console.error("Erro ao carregar filmes para select popup:", error);
                 sceneFilmeSelect.innerHTML = '<option value="" disabled>Erro ao carregar</option>';
            }
        }

        // Show/hide forms (UPDATED to clear new fields)
        function showCorrectForm() {
            const selectedType = contentTypeSelector.value;
            videoForm.style.display = 'none'; sceneForm.style.display = 'none'; movieForm.style.display = 'none';
            saveContentButton.disabled = true; createStatusMessage.textContent = ''; createStatusMessage.className = '';

            // Clear previous selections when switching forms
            popupSelectedVideoActresses = [];
            popupSelectedSceneActresses = [];
            if(popupVideoSelectedContainer) popupVideoSelectedContainer.innerHTML = ''; // Clear pills visually
            if(popupSceneSelectedContainer) popupSceneSelectedContainer.innerHTML = ''; // Clear pills visually
            if(popupVideoSearchInput) popupVideoSearchInput.value = ''; // Clear search input
            if(popupSceneSearchInput) popupSceneSearchInput.value = ''; // Clear search input
            if(popupVideoSuggestions) popupVideoSuggestions.style.display = 'none'; // Hide suggestions
            if(popupSceneSuggestions) popupSceneSuggestions.style.display = 'none'; // Hide suggestions


            switch (selectedType) {
                case 'video':
                    videoForm.style.display = 'block';
                    // No need to explicitly load actors anymore, suggestions use allActresses
                    saveContentButton.disabled = false;
                    break;
                case 'scene':
                    sceneForm.style.display = 'block';
                    loadMoviesForSelect(); // Load movies needed for scene select
                    // No need to explicitly load actors anymore
                    saveContentButton.disabled = false;
                    break;
                case 'movie':
                    movieForm.style.display = 'block';
                    saveContentButton.disabled = false;
                    break;
                default: break;
            }
        }

        // Reset form fields (UPDATED to handle new actress inputs/state)
        function resetFormFields(formElement) {
            if (!formElement) return;
            formElement.querySelectorAll('input[type="text"], input[type="number"], input[type="url"]').forEach(input => {
                // Don't clear the actress search inputs here, handled by showCorrectForm/opening popup
                if (!input.classList.contains('popup-search-input')) {
                    input.value = '';
                }
            });
            formElement.querySelectorAll('select').forEach(select => {
                 if (select.multiple) { Array.from(select.options).forEach(option => option.selected = false); }
                 else { select.selectedIndex = 0; }
            });

            // Specifically clear the actress state arrays and pills for the form being reset
            if (formElement.id === 'video-form') {
                popupSelectedVideoActresses = [];
                if (popupVideoSelectedContainer) renderPopupActressPills(popupSelectedVideoActresses, popupVideoSelectedContainer);
                if (popupVideoSearchInput) popupVideoSearchInput.value = '';
                if (popupVideoSuggestions) popupVideoSuggestions.style.display = 'none';
            } else if (formElement.id === 'scene-form') {
                popupSelectedSceneActresses = [];
                if (popupSceneSelectedContainer) renderPopupActressPills(popupSelectedSceneActresses, popupSceneSelectedContainer);
                if (popupSceneSearchInput) popupSceneSearchInput.value = '';
                if (popupSceneSuggestions) popupSceneSuggestions.style.display = 'none';
            }
        }

        // Handle saving (UPDATED to get actress IDs from state arrays)
        async function handleSaveContent(event) {
            event.preventDefault();
            const selectedType = contentTypeSelector.value;
            if (!selectedType) { alert("Por favor, selecione um tipo de conteúdo."); return; }

            saveContentButton.disabled = true;
            createStatusMessage.textContent = 'Salvando...'; createStatusMessage.className = '';
            let dataToSave = { createdAt: serverTimestamp() };
            let targetCollection = ''; let currentForm;

            try {
                switch (selectedType) {
                    case 'video':
                        targetCollection = 'videos'; currentForm = videoForm;
                        dataToSave.nome = document.getElementById('video-nome').value.trim();
                        dataToSave.ano = parseInt(document.getElementById('video-ano').value) || null;
                        dataToSave.imagem = document.getElementById('video-imagem').value.trim() || null;
                        dataToSave.pagina = document.getElementById('video-pagina').value.trim() || null;
                        // *** UPDATED: Get IDs from the popup's state array ***
                        dataToSave.atores = popupSelectedVideoActresses.map(actress => actress.id);
                        if (!dataToSave.nome) throw new Error("O campo 'Nome' é obrigatório para Vídeo.");
                        // Ensure atores is an array, even if empty
                        if (!Array.isArray(dataToSave.atores)) dataToSave.atores = [];
                        break;
                    case 'scene':
                        targetCollection = 'cenas'; currentForm = sceneForm;
                        dataToSave.nome = document.getElementById('scene-nome').value.trim();
                        dataToSave.filmeId = document.getElementById('scene-filme').value || null;
                        dataToSave.numeroCena = parseInt(document.getElementById('scene-numero').value) || null;
                        dataToSave.ano = parseInt(document.getElementById('scene-ano').value) || null;
                        dataToSave.imagem = document.getElementById('scene-imagem').value.trim() || null;
                        dataToSave.pagina = document.getElementById('scene-pagina').value.trim() || null;
                         // *** UPDATED: Get IDs from the popup's state array ***
                        dataToSave.atores = popupSelectedSceneActresses.map(actress => actress.id);
                        if (!dataToSave.nome) throw new Error("O campo 'Nome da Cena' é obrigatório.");
                        if (!dataToSave.filmeId) throw new Error("O campo 'Filme' é obrigatório para Cena.");
                        if (dataToSave.numeroCena === null) throw new Error("O campo 'Número da Cena' é obrigatório."); // Check for null explicitly after parseInt
                         // Ensure atores is an array, even if empty
                        if (!Array.isArray(dataToSave.atores)) dataToSave.atores = [];
                        break;
                    case 'movie':
                        targetCollection = 'filmes'; currentForm = movieForm;
                        dataToSave.nome = document.getElementById('movie-nome').value.trim();
                        dataToSave.ano = parseInt(document.getElementById('movie-ano').value) || null;
                        dataToSave.imagem = document.getElementById('movie-imagem').value.trim() || null;
                        dataToSave.pagina = document.getElementById('movie-pagina').value.trim() || null;
                        // Movies don't have actress list directly on them in this structure
                        if (!dataToSave.nome) throw new Error("O campo 'Nome do Filme' é obrigatório.");
                        break;
                    default: throw new Error("Tipo de conteúdo inválido selecionado.");
                }

                // Clean up empty/null fields (excluding potentially empty 'atores' array)
                Object.keys(dataToSave).forEach(key => {
                    if ((dataToSave[key] === null || dataToSave[key] === '') && key !== 'atores') {
                        delete dataToSave[key];
                    }
                    // Remove NaN 'ano' or 'numeroCena' if parseInt failed
                    if ((key === 'ano' || key === 'numeroCena') && isNaN(dataToSave[key])) {
                        delete dataToSave[key];
                    }
                });


                console.log(`Saving to ${targetCollection}:`, dataToSave);
                const docRef = await addDoc(collection(db, targetCollection), dataToSave);
                console.log("Document written with ID: ", docRef.id);

                createStatusMessage.textContent = `${selectedType.charAt(0).toUpperCase() + selectedType.slice(1)} criado com sucesso!`;
                createStatusMessage.className = 'success';
                if (currentForm) resetFormFields(currentForm); // Reset fields including clearing actress state
                contentTypeSelector.selectedIndex = 0; showCorrectForm(); // Reset selector, hide forms

                // ADD SCENES TO ALLCONTENT IF NEEDED AFTER SAVE? Or rely on full reload?
                // For now, relying on full reload via loadInitialData()

                await loadInitialData(); // Reload main page data

                setTimeout(() => {
                    if(createPopupOverlay) createPopupOverlay.style.display = 'none';
                    if(createStatusMessage) { createStatusMessage.textContent = ''; createStatusMessage.className = ''; }
                }, 2000);

            } catch (error) {
                console.error("Erro ao salvar conteúdo:", error);
                if(createStatusMessage) { createStatusMessage.textContent = `Erro: ${error.message}`; createStatusMessage.className = 'error'; }
                if(saveContentButton) saveContentButton.disabled = false; // Re-enable on error
            }
        }

        // Load initial data (UPDATED to include scenes)
        async function loadInitialData() {
            if(contentContainer) contentContainer.innerHTML = '<p class="message">Carregando...</p>';
            // Reset popup loaded flags if they existed (like moviesLoaded)
            moviesLoaded = false;
            // No need for actorsLoaded flag anymore
            try {
                const videosCol = collection(db, "videos");
                const filmesCol = collection(db, "filmes");
                const cenasCol = collection(db, "cenas"); // ADDED: Fetch Cenas
                const atoresCol = collection(db, "atores");

                const [videosSnapshot, filmesSnapshot, cenasSnapshot, atoresSnapshot] = await Promise.all([
                    getDocs(videosCol),
                    getDocs(filmesCol),
                    getDocs(cenasCol), // ADDED
                    getDocs(atoresCol)
                ]);

                allContent = [];
                videosSnapshot.forEach(doc => allContent.push({ id: doc.id, type: 'video', ...doc.data() }));
                filmesSnapshot.forEach(doc => allContent.push({ id: doc.id, type: 'film', ...doc.data() }));
                cenasSnapshot.forEach(doc => allContent.push({ id: doc.id, type: 'scene', ...doc.data() })); // ADDED

                allActresses = []; // Reset and repopulate
                atoresSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nome) { // Ensure actress has a name
                        allActresses.push({ id: doc.id, nome: data.nome, foto: data.foto });
                    } else {
                        console.warn(`Actress document ${doc.id} is missing 'nome' field.`);
                    }
                });
                 allActresses.sort((a, b) => a.nome.localeCompare(b.nome)); // Sort actresses alphabetically

                 renderSelectedActressesPills(); // Render main page pills based on current state
                 renderContent(); // Render main content grid including any newly added items
                 console.log(`Loaded ${allActresses.length} actresses and ${allContent.length} content items.`);
            } catch (error) {
                 console.error("Erro ao buscar dados iniciais:", error);
                if(contentContainer) contentContainer.innerHTML = '<p class="message">Erro ao carregar.</p>';
            }
        }


        // --- EVENT LISTENERS (Combined & UPDATED) ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- Listeners for Existing Page Functionality ---
            filterButtons.forEach(button => {
                 button.addEventListener('click', () => {
                     filterButtons.forEach(btn => btn.classList.remove('active'));
                     button.classList.add('active');
                     activeTypeFilter = button.getAttribute('data-filter');
                     // Decide which content types to show based on filter
                     // This logic might need adjustment if you add 'scene' as a filter button
                     if (activeTypeFilter === 'video') {
                         // You might want to adjust renderContent if 'Só Vídeos' should ONLY show videos
                         // Currently 'video' type will be shown if filter is 'video' or 'all'
                     } else if (activeTypeFilter === 'film') {
                         // Similarly adjust if 'Só Filmes' should ONLY show films
                     }
                     // Hide suggestions when changing filter
                     if (suggestionsList) suggestionsList.style.display = 'none';
                     renderContent(); // Re-render based on the new filter
                 });
             });
            if(searchInput) searchInput.addEventListener('input', () => { displayStandardSuggestions(searchInput.value); });
            if(searchInput) searchInput.addEventListener('focus', () => {
                 // Show suggestions on focus only if there's text OR if actresses are already selected (to show co-stars)
                 if (searchInput.value) {
                     displayStandardSuggestions(searchInput.value);
                 } else if (selectedActresses.length > 0) {
                     updateCoStarsList();
                 }
             });
            // Global click listener (needs adjustment to handle popup lists)
            document.addEventListener('click', (event) => {
                // Hide main suggestions list
                if (searchInputWrapper && !searchInputWrapper.contains(event.target) && suggestionsList && !suggestionsList.contains(event.target)) {
                    suggestionsList.style.display = 'none';
                }
                // Hide popup video suggestions list
                const videoSearchArea = document.getElementById('popup-video-actress-search');
                if (videoSearchArea && !videoSearchArea.contains(event.target) && popupVideoSuggestions && popupVideoSuggestions.style.display !== 'none') {
                    popupVideoSuggestions.style.display = 'none';
                }
                 // Hide popup scene suggestions list
                const sceneSearchArea = document.getElementById('popup-scene-actress-search');
                if (sceneSearchArea && !sceneSearchArea.contains(event.target) && popupSceneSuggestions && popupSceneSuggestions.style.display !== 'none') {
                    popupSceneSuggestions.style.display = 'none';
                }
            });
            // Listener for adding co-stars from the main suggestion list
             if(suggestionsList) {
                suggestionsList.addEventListener('click', function(event) {
                    if (event.target.classList.contains('add-costar-btn')) {
                        handleAddCoStarClick(event);
                    }
                    // Note: Standard suggestions selection is handled by 'handleSelectActressClick' attached directly to items
                });
             }

            // --- Listeners for Popup Functionality (UPDATED) ---
            if (openCreatePopupBtn) {
                openCreatePopupBtn.addEventListener('click', () => {
                    if (createPopupOverlay) createPopupOverlay.style.display = 'flex';
                    // Reset popup state completely on open
                    moviesLoaded = false;
                    popupSelectedVideoActresses = [];
                    popupSelectedSceneActresses = [];
                    if (contentTypeSelector) contentTypeSelector.selectedIndex = 0;
                    showCorrectForm(); // This will also clear pills/inputs
                    if (createStatusMessage) { createStatusMessage.textContent = ''; createStatusMessage.className = ''; }
                    if (saveContentButton) saveContentButton.disabled = true;
                    // Ensure allActresses is available before enabling search inputs? (Usually loaded by now)
                    if (allActresses.length === 0) {
                        console.warn("Popup opened, but 'allActresses' is empty. Actress search might not work until data loads.");
                        // Optionally, disable search inputs until loaded?
                    }
                });
            }
            if (closeCreatePopupBtn) { closeCreatePopupBtn.addEventListener('click', () => { if (createPopupOverlay) createPopupOverlay.style.display = 'none'; }); }
            if (createPopupOverlay) {
                createPopupOverlay.addEventListener('click', (event) => { if (event.target === createPopupOverlay) { createPopupOverlay.style.display = 'none'; } });
            }
            if (contentTypeSelector) { contentTypeSelector.addEventListener('change', showCorrectForm); }
            if (saveContentButton) { saveContentButton.addEventListener('click', handleSaveContent); }

            // ADDED: Listeners for the NEW popup actress search inputs
            if (popupVideoSearchInput && popupVideoSuggestions && popupVideoSelectedContainer) {
                popupVideoSearchInput.addEventListener('input', () => displayPopupSuggestions(popupVideoSearchInput.value, popupVideoSuggestions, popupSelectedVideoActresses, popupVideoSearchInput, popupVideoSelectedContainer));
                popupVideoSearchInput.addEventListener('focus', () => displayPopupSuggestions(popupVideoSearchInput.value, popupVideoSuggestions, popupSelectedVideoActresses, popupVideoSearchInput, popupVideoSelectedContainer)); // Show suggestions on focus too if there's text
            }
            if (popupSceneSearchInput && popupSceneSuggestions && popupSceneSelectedContainer) {
                popupSceneSearchInput.addEventListener('input', () => displayPopupSuggestions(popupSceneSearchInput.value, popupSceneSuggestions, popupSelectedSceneActresses, popupSceneSearchInput, popupSceneSelectedContainer));
                popupSceneSearchInput.addEventListener('focus', () => displayPopupSuggestions(popupSceneSearchInput.value, popupSceneSuggestions, popupSelectedSceneActresses, popupSceneSearchInput, popupSceneSelectedContainer)); // Show suggestions on focus too
            }
            // Note: Selection and removal listeners are added dynamically in render/display functions.

            // --- Validation Checks (UPDATED) ---
             const criticalMainElements = [contentContainer, searchInput, suggestionsList, selectedActressesContainer, searchInputWrapper];
             if (criticalMainElements.some(el => !el) || filterButtons.length === 0) {
                 console.error("ERRO CRÍTICO: Um ou mais elementos da página principal não foram encontrados!");
             }
             const criticalPopupElements = [
                 openCreatePopupBtn, createPopupOverlay, closeCreatePopupBtn, contentTypeSelector, formContainer,
                 videoForm, sceneForm, movieForm, saveContentButton, createStatusMessage, sceneFilmeSelect,
                 popupVideoSearchInput, popupVideoSuggestions, popupVideoSelectedContainer,
                 popupSceneSearchInput, popupSceneSuggestions, popupSceneSelectedContainer
             ];
             if (criticalPopupElements.some(el => !el)) {
                 console.error("ERRO CRÍTICO: Um ou mais elementos do Popup de Criação (incluindo busca de atriz) não foram encontrados! Funcionalidade pode falhar.");
                 if(openCreatePopupBtn) openCreatePopupBtn.style.display = 'none'; // Hide button if popup is broken
             }

             // --- INITIALIZATION ---
             loadInitialData(); // Load data including allActresses and all content types

        }); // End DOMContentLoaded
    </script>
</body>
</html>
