<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Atrizes</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex; /* Use flexbox for overall layout */
            min-height: 100vh;
        }

        .container {
            display: flex;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
        }

        .column {
            background-color: #fff;
            margin: 0 5px;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-y: auto; /* Add scroll if content overflows */
            height: calc(100vh - 30px); /* Adjust height based on body padding */
            box-sizing: border-box;
        }

        /* Initial State: Only Left Column Visible */
        #actress-list-col {
            flex: 1; /* Take full width initially */
        }

        #actress-detail-col,
        #content-col {
            display: none; /* Hide middle and right columns initially */
        }

        /* State when an actress is selected */
        .container.details-visible #actress-list-col {
            flex: 0 0 25%; /* Fixed width for actress list */
            max-width: 300px; /* Optional max width */
        }

        .container.details-visible #actress-detail-col {
            display: block;
            flex: 0 0 30%; /* Fixed width for details */
            max-width: 400px; /* Optional max width */
        }

        .container.details-visible #content-col {
            display: block;
            flex: 1; /* Takes remaining space */
        }

        /* Actress List Styling */
        #actress-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .actress-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .actress-item:hover {
            background-color: #f0f0f0;
        }

         .actress-item.selected {
            background-color: #e0e0e0;
            font-weight: bold;
        }

        .actress-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 10px;
        }

        .actress-info span {
            display: block;
            font-size: 0.9em;
        }
         .actress-info .name {
            font-weight: bold;
            font-size: 1em;
         }
         .actress-info .age,
         .actress-info .rating {
            color: #555;
         }


        /* Actress Detail Styling */
        #actress-details h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
         #actress-details div {
             margin-bottom: 8px;
             word-wrap: break-word; /* Prevent long strings from overflowing */
         }
         #actress-details strong {
            display: inline-block;
            min-width: 100px; /* Align keys */
            color: #333;
         }
         #actress-details img.detail-photo {
             max-width: 200px; /* Limit width */
             max-height: 250px; /* Optional: Limit height */
             width: auto; /* Maintain aspect ratio */
             height: auto; /* Maintain aspect ratio */
             border-radius: 4px;
             margin-top: 10px;
             display: block; /* Ensure it takes block layout */
         }


        /* Content Card Styling */
        #content-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Responsive grid */
            gap: 15px;
        }

        .content-card {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer; /* Indicate clickable */
        }

        .content-card img {
            width: 100%;
            height: 180px; /* Fixed height for consistency */
            object-fit: cover;
            display: block;
        }

        .content-card .title {
            padding: 8px;
            font-size: 0.9em;
            min-height: 40px; /* Ensure space for title */
            display: flex;
            align-items: center;
            justify-content: center;
        }

         /* Loading/Error indicators */
         .loading, .error {
             text-align: center;
             padding: 20px;
             color: #888;
         }

        /* --- Modal Styling --- */
        .modal-overlay {
            position: fixed; /* Stay in place */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Black background with opacity */
            z-index: 1000; /* Sit on top */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 700px; /* Adjusted max width */
            width: 90%;
            position: relative;
            max-height: 85vh; /* Limit modal height */
            overflow-y: auto; /* Add scroll if content is tall */
        }

        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close-button:hover {
            color: #333;
        }

        #modal-body div {
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        #modal-body strong {
           display: inline-block;
           min-width: 80px; /* Align keys in modal */
           color: #333;
        }
        #modal-link-container button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        #modal-link-container button:hover {
            background-color: #0056b3;
        }

        /* Image Styling in Modal */
        #modal-body img.modal-detail-image {
            max-width: 100%; /* Default max width */
            height: auto;
            max-height: 300px; /* Limit height */
            margin-top: 10px;
            border-radius: 4px;
            display: block; /* Center if needed */
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 15px;
        }
         /* Specific style for smaller movie images in modal */
        #modal-body img.modal-detail-image.movie-image {
            max-width: 250px; /* Smaller max width for movies */
             max-height: 250px;
        }

        /* Year Display */
        #modal-body .modal-year {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 15px;
        }

        /* Actresses List in Modal */
        .modal-actress-list-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .modal-actress-list-container h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
         .modal-actress-list {
             display: flex;
             flex-wrap: wrap;
             gap: 15px; /* Spacing between actresses */
             padding: 0;
             list-style: none;
         }
         .modal-actress-item {
             display: flex;
             flex-direction: column; /* Stack image and name */
             align-items: center;
             text-align: center;
             cursor: pointer;
             padding: 5px;
             border-radius: 4px;
             transition: background-color 0.2s ease;
             max-width: 80px; /* Control width */
         }
          .modal-actress-item:hover {
              background-color: #f0f0f0;
          }
         .modal-actress-item img {
             width: 60px; /* Size of actress image */
             height: 60px;
             object-fit: cover;
             border-radius: 50%;
             margin-bottom: 5px;
         }
         .modal-actress-item span {
             font-size: 0.85em;
             word-wrap: break-word; /* Allow name wrapping */
             line-height: 1.2;
             max-width: 100%;
         }

        /* Movie Scenes List in Modal */
        .modal-scenes-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .modal-scenes-container h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        .modal-scene-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Responsive grid */
            gap: 10px;
        }
        .modal-scene-card {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
            text-align: center;
            font-size: 0.8em;
        }
         .modal-scene-card img {
             width: 100%;
             height: 80px; /* Smaller height for scene thumbs */
             object-fit: cover;
             display: block;
         }
         .modal-scene-card .title {
             padding: 5px;
             min-height: 25px;
             display: flex;
             align-items: center;
             justify-content: center;
         }

         /* Back Button Styling */
         #modal-back-button-container button {
             padding: 8px 12px;
             background-color: #6c757d; /* Grey color */
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             font-size: 0.9em;
             margin-right: 10px; /* Space between back and external link */
         }
         #modal-back-button-container button:hover {
             background-color: #5a6268;
         }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div class="column" id="actress-list-col">
            <h2>Atrizes</h2>
            <ul id="actress-list">
                <li class="loading">Carregando atrizes...</li>
            </ul>
        </div>
        <div class="column" id="actress-detail-col">
            <div id="actress-details">
                <!-- Details will be loaded here -->
            </div>
        </div>
        <div class="column" id="content-col">
            <h2>Conteúdo Relacionado</h2>
            <div id="content-cards">
                <!-- Content cards will be loaded here -->
            </div>
             <div id="content-message" class="loading" style="display: none;"></div>
        </div>
    </div>

     <!-- Modal Structure (Initially Hidden) -->
    <div id="content-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeModal()">×</span>
            <h3 id="modal-title">Detalhes do Conteúdo</h3>
            <div id="modal-body">
                <!-- Content details will be loaded here -->
            </div>
            <!-- Button Container at the bottom -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px;">
                <div id="modal-back-button-container">
                     <!-- Back button will be added here -->
                </div>
                <div id="modal-link-container">
                    <!-- External link button will be added here -->
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- SINGLE DECLARATION of Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBZEffPMXgbSHYUUrNdIS5duAVGlKlmSq0",
            authDomain: "babes-392fd.firebaseapp.com",
            projectId: "babes-392fd",
            storageBucket: "babes-392fd.appspot.com",
            messagingSenderId: "376795361631",
            appId: "1:376795361631:web:d662f2b2f2cd23b115c6ea"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const mainContainer = document.getElementById('main-container');
        const actressList = document.getElementById('actress-list');
        const actressDetailsContainer = document.getElementById('actress-details');
        const contentCardsContainer = document.getElementById('content-cards');
        const contentMessage = document.getElementById('content-message');
        const modal = document.getElementById('content-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalLinkContainer = document.getElementById('modal-link-container');
        const modalBackButtonContainer = document.getElementById('modal-back-button-container');

        let selectedActressElement = null;
        let previousModalState = null; // To store { type, id } for back button

        // --- Helper Functions ---
        function calculateAge(birthDateString) {
            if (!birthDateString) return '?';
            try {
                const birthDate = new Date(birthDateString);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            } catch (e) { console.error("Error parsing date:", birthDateString, e); return '?'; }
        }

        function displayMessage(element, message, isError = false) {
             element.innerHTML = `<div class="${isError ? 'error' : 'loading'}">${message}</div>`;
             element.style.display = 'block';
        }

        function clearMessage(element) {
            element.innerHTML = '';
            element.style.display = 'none';
        }

        // --- Core Logic ---

        // 1. Load Actresses List (Sorted)
        async function loadActresses() {
            actressList.innerHTML = '<li class="loading">Carregando atrizes...</li>';
            try {
                const querySnapshot = await getDocs(collection(db, "atores"));
                actressList.innerHTML = '';
                if (querySnapshot.empty) { actressList.innerHTML = '<li class="error">Nenhuma atriz encontrada.</li>'; return; }

                const actresses = [];
                querySnapshot.forEach((doc) => actresses.push({ id: doc.id, ...doc.data() }));
                actresses.sort((a, b) => (a.nome || '').localeCompare(b.nome || '')); // Sort

                actresses.forEach(actress => {
                    const li = document.createElement('li');
                    li.classList.add('actress-item');
                    li.dataset.id = actress.id;
                    const age = calculateAge(actress.dataNascimento);
                    const imageUrl = actress.foto || 'placeholder.png';
                    const rating = actress.nota !== undefined ? actress.nota : 'N/A';
                    li.innerHTML = `
                        <img src="${imageUrl}" alt="${actress.nome}" onerror="this.src='placeholder.png'; this.onerror=null;">
                        <div class="actress-info">
                            <span class="name">${actress.nome || 'Nome Indisponível'}</span>
                            <span class="age">Idade: ${age}</span>
                            <span class="rating">Nota: ${rating}</span>
                        </div>`;
                    li.addEventListener('click', () => handleActressClick(actress.id, li));
                    actressList.appendChild(li);
                });
            } catch (error) {
                console.error("Erro ao buscar atrizes: ", error);
                actressList.innerHTML = '<li class="error">Erro ao carregar atrizes.</li>';
            }
        }

        // 2. Handle Actress Click (Main List)
        async function handleActressClick(actressId, listItemElement) {
            if (selectedActressElement) selectedActressElement.classList.remove('selected');
            listItemElement.classList.add('selected');
            selectedActressElement = listItemElement;
            mainContainer.classList.add('details-visible');
            actressDetailsContainer.innerHTML = '<div class="loading">Carregando detalhes...</div>';
            contentCardsContainer.innerHTML = '';
            displayMessage(contentMessage, 'Carregando conteúdo...');

            try {
                const actressDoc = await getDoc(doc(db, "atores", actressId));
                if (actressDoc.exists()) displayActressDetails(actressDoc.data());
                else actressDetailsContainer.innerHTML = '<div class="error">Detalhes da atriz não encontrados.</div>';
                await loadRelatedContent(actressId);
            } catch (error) {
                console.error(`Erro ao carregar dados para atriz ${actressId}: `, error);
                actressDetailsContainer.innerHTML = '<div class="error">Erro ao carregar detalhes.</div>';
                displayMessage(contentMessage,'Erro ao carregar conteúdo.', true);
            }
        }

        // 3. Display Actress Details (Main Column)
        function displayActressDetails(data) {
            actressDetailsContainer.innerHTML = '';
            const detailsTitle = document.createElement('h3');
            detailsTitle.textContent = data.nome || 'Detalhes';
            actressDetailsContainer.appendChild(detailsTitle);

            if (data.foto) { /* ... Add image ... */
                const img = document.createElement('img');
                img.src = data.foto; img.alt = data.nome; img.classList.add('detail-photo');
                img.onerror = () => { img.style.display = 'none'; };
                actressDetailsContainer.appendChild(img);
            }

            const skipFields = ['foto', 'nome', 'cenas', 'filmes', 'videos', 'timestamp'];
            let detailsAdded = false;
            for (const key in data) {
                if (data.hasOwnProperty(key) && !skipFields.includes(key)) {
                    detailsAdded = true;
                    const detailDiv = document.createElement('div');
                    let value = data[key]; let label = key;

                    if (key === 'dataNascimento') {
                        detailDiv.innerHTML = `<strong>${label}:</strong> ${value || 'N/A'}`;
                        actressDetailsContainer.appendChild(detailDiv);
                        const ageDiv = document.createElement('div');
                        ageDiv.innerHTML = `<strong>Idade:</strong> ${calculateAge(value)}`;
                        actressDetailsContainer.appendChild(ageDiv);
                        continue;
                    }
                    else if (key === 'peso' && value !== undefined && value !== null) { value = `${value} kg`; }
                    else if (key === 'altura' && value !== undefined && value !== null) { value = `${value} cm`; }
                    detailDiv.innerHTML = `<strong>${label}:</strong> ${value}`;
                    actressDetailsContainer.appendChild(detailDiv);
                }
            }
             if (!detailsAdded) {
                 const noDetailsDiv = document.createElement('div');
                 noDetailsDiv.textContent = 'Nenhum detalhe adicional disponível.';
                 actressDetailsContainer.appendChild(noDetailsDiv);
            }
        }

        // 4. Load Related Content (Right Column)
        async function loadRelatedContent(actressId) {
            contentCardsContainer.innerHTML = '';
            let contentFound = false;
            try {
                const collectionsToSearch = ['cenas', 'videos'];
                const movieCheckPromises = [];

                // Search Cenas and Videos
                for (const collName of collectionsToSearch) {
                    const snapshot = await getDocs(collection(db, collName));
                    snapshot.forEach(docSnap => {
                        const itemData = docSnap.data();
                        if (itemData.atores && Array.isArray(itemData.atores) && itemData.atores.includes(actressId)) {
                            createContentCard(itemData.imagem, itemData.nome, collName === 'cenas' ? 'Cena' : 'Vídeo', docSnap.id);
                            contentFound = true;
                        }
                    });
                }

                // Prepare Movie Checks
                const filmesSnapshot = await getDocs(collection(db, "filmes"));
                filmesSnapshot.forEach(filmeDoc => {
                    const filmeData = filmeDoc.data();
                    if (filmeData.cenas && Array.isArray(filmeData.cenas) && filmeData.cenas.length > 0) {
                        const checkMoviePromise = async () => {
                            for (const cenaRef of filmeData.cenas) {
                                if (typeof cenaRef === 'string' && cenaRef.trim() !== '') {
                                     try {
                                        const cenaDocSnap = await getDoc(doc(db, "cenas", cenaRef));
                                        if (cenaDocSnap.exists()) {
                                            const cenaData = cenaDocSnap.data();
                                             if (cenaData.atores && Array.isArray(cenaData.atores) && cenaData.atores.includes(actressId)) {
                                                 return { found: true, data: filmeData, id: filmeDoc.id };
                                             }
                                        }
                                     } catch(sceneError) { console.error(`Error checking scene ${cenaRef} for movie ${filmeDoc.id}:`, sceneError); }
                                }
                            } return { found: false };
                        };
                        movieCheckPromises.push(checkMoviePromise());
                    }
                });

                // Execute Movie Checks
                const movieResults = await Promise.all(movieCheckPromises);
                movieResults.forEach(result => {
                    if (result.found) {
                        createContentCard(result.data.imagem, result.data.nome, 'Filme', result.id);
                        contentFound = true;
                    }
                });

                if (!contentFound) displayMessage(contentMessage,'Nenhum conteúdo encontrado para esta atriz.');
                else clearMessage(contentMessage);

            } catch (error) {
                console.error("Erro geral ao buscar conteúdo relacionado: ", error);
                displayMessage(contentMessage,'Erro ao carregar conteúdo relacionado.', true);
            }
        }

        // 5. Create Content Card HTML (Right Column)
        function createContentCard(imageUrl, title, type, id) {
            const card = document.createElement('div');
            card.classList.add('content-card');
            card.dataset.type = type; card.dataset.id = id;

            const img = document.createElement('img');
            let finalImageUrl = imageUrl;
            if (typeof imageUrl === 'object' && imageUrl !== null && imageUrl.width) { /* Extract URL */
                const urlKey = Object.keys(imageUrl).find(k => typeof imageUrl[k] === 'string' && imageUrl[k].startsWith('http'));
                finalImageUrl = urlKey ? imageUrl[urlKey] : 'placeholder.png';
            } else if (typeof imageUrl !== 'string' || !imageUrl) { finalImageUrl = 'placeholder.png'; }
            img.src = finalImageUrl; img.alt = title || type;
            img.onerror = () => { img.src = 'placeholder.png'; img.onerror=null; }

            const titleDiv = document.createElement('div');
            titleDiv.classList.add('title');
            titleDiv.textContent = `${title || 'Sem Título'}`; // Display only title on card

            card.appendChild(img); card.appendChild(titleDiv);
            card.addEventListener('click', () => showContentDetails(type, id));
            contentCardsContainer.appendChild(card);
        }

        // --- MODAL Functions ---

        // 6. Show Content Details in Modal
        async function showContentDetails(type, id) {
            previousModalState = null; modalBackButtonContainer.innerHTML = '';
            modalBody.innerHTML = '<div class="loading">Carregando...</div>';
            modalLinkContainer.innerHTML = ''; modal.style.display = 'flex';

            // Store current content type/id on modal for back navigation reference
            const modalContentElement = modal.querySelector('.modal-content');
            if(modalContentElement) {
                modalContentElement.dataset.contentType = type;
                modalContentElement.dataset.contentId = id;
            }

            let collectionName = '';
            switch (type) {
                case 'Cena': collectionName = 'cenas'; break;
                case 'Vídeo': collectionName = 'videos'; break;
                case 'Filme': collectionName = 'filmes'; break;
                default: modalBody.innerHTML = '<div class="error">Tipo inválido.</div>'; return;
            }

            try {
                const docSnap = await getDoc(doc(db, collectionName, id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    modalTitle.textContent = data.nome || `Detalhes de ${type}`;
                    modalBody.innerHTML = '';

                    // Display Image (Conditional Size)
                    if (data.imagem) { /* ... Add modal image ... */
                        let finalImageUrl = data.imagem;
                        if (typeof finalImageUrl === 'object' && finalImageUrl !== null && finalImageUrl.width) {
                            const urlKey = Object.keys(finalImageUrl).find(k => typeof finalImageUrl[k] === 'string' && finalImageUrl[k].startsWith('http'));
                            finalImageUrl = urlKey ? finalImageUrl[urlKey] : null;
                        } else if (typeof finalImageUrl !== 'string') { finalImageUrl = null; }
                        if (finalImageUrl) {
                           const img = document.createElement('img');
                           img.src = finalImageUrl; img.alt = data.nome || type;
                           img.classList.add('modal-detail-image');
                           if (type === 'Filme') img.classList.add('movie-image'); // Smaller movie image
                           img.onerror = () => { img.style.display = 'none'; };
                           modalBody.appendChild(img);
                        }
                    }

                    // Display Year
                    if (data.ano) { /* ... Add year ... */
                        const yearDiv = document.createElement('div');
                        yearDiv.classList.add('modal-year');
                        yearDiv.textContent = `Ano: ${data.ano}`;
                        modalBody.appendChild(yearDiv);
                    }

                    // Placeholders for Actresses & Scenes (to be filled async)
                    const actressesContainer = document.createElement('div');
                    actressesContainer.classList.add('modal-actress-list-container');
                    actressesContainer.innerHTML = `<h4>Atrizes</h4><div class="loading">Carregando...</div>`;
                    modalBody.appendChild(actressesContainer);

                    let scenesContainer = null;
                    if (type === 'Filme') {
                        scenesContainer = document.createElement('div');
                        scenesContainer.classList.add('modal-scenes-container');
                        scenesContainer.innerHTML = `<h4>Cenas do Filme</h4><div class="loading">Carregando...</div>`;
                        modalBody.appendChild(scenesContainer);
                    }

                    // External Link Button
                    if (data.pagina && typeof data.pagina === 'string' && data.pagina.trim() !== '') { /* ... Add link button ... */
                         const linkButton = document.createElement('button');
                         linkButton.textContent = 'Abrir Página Externa';
                         linkButton.onclick = () => window.open(data.pagina, '_blank');
                         modalLinkContainer.appendChild(linkButton);
                    } else { modalLinkContainer.innerHTML = '<i>(Nenhuma página externa)</i>'; }

                    // Load Actresses & Scenes Async
                    loadActressesForModal(data.atores || [], actressesContainer);
                    if (type === 'Filme') loadScenesForModal(data.cenas || [], scenesContainer);

                } else { modalBody.innerHTML = '<div class="error">Conteúdo não encontrado.</div>'; }
            } catch (error) { console.error(`Erro ao buscar ${type} ${id}: `, error); modalBody.innerHTML = '<div class="error">Erro ao carregar.</div>'; }
        }

        // 7. Load Actresses into Modal
        async function loadActressesForModal(actressIds, containerElement) {
            const modalContentElement = containerElement.closest('.modal-content'); // Get modal content element
            const currentContent = { // Get current content info from modal dataset
                type: modalContentElement?.dataset.contentType,
                id: modalContentElement?.dataset.contentId
            };

            if (!actressIds || actressIds.length === 0) { containerElement.innerHTML = '<h4>Atrizes</h4><i>Nenhuma atriz associada.</i>'; return; }

            const listElement = document.createElement('ul'); listElement.classList.add('modal-actress-list');
            containerElement.innerHTML = '<h4>Atrizes</h4>'; containerElement.appendChild(listElement);
            let foundCount = 0;

            const fetchPromises = actressIds.map(async (actressId) => {
                try {
                    const actressDoc = await getDoc(doc(db, "atores", actressId));
                    if (actressDoc.exists()) {
                        foundCount++; const actressData = actressDoc.data();
                        const li = document.createElement('li'); li.classList.add('modal-actress-item');
                        // Pass the current content state when setting up the click
                        li.onclick = () => showActressDetailsInModal(actressId, currentContent);

                        const img = document.createElement('img'); /* ... set src, alt, onerror ... */
                        img.src = actressData.foto || 'placeholder.png'; img.alt = actressData.nome;
                        img.onerror = () => { img.src = 'placeholder.png'; img.onerror=null; }

                        const nameSpan = document.createElement('span'); nameSpan.textContent = actressData.nome || 'Nome';
                        li.appendChild(img); li.appendChild(nameSpan); listElement.appendChild(li);
                    }
                } catch (error) { console.error(`Error fetching actress ${actressId}:`, error); }
            });
            await Promise.all(fetchPromises);
            if (foundCount === 0) containerElement.innerHTML = '<h4>Atrizes</h4><i>Erro ao carregar atrizes.</i>';
        }

        // 8. Load Scene Cards into Modal (for Movies)
        async function loadScenesForModal(sceneIds, containerElement) {
            if (!sceneIds || sceneIds.length === 0) { containerElement.innerHTML = '<h4>Cenas</h4><i>Nenhuma cena associada.</i>'; return; }

            const cardsContainer = document.createElement('div'); cardsContainer.classList.add('modal-scene-cards');
            containerElement.innerHTML = '<h4>Cenas do Filme</h4>'; containerElement.appendChild(cardsContainer);
            let foundCount = 0;

            const fetchPromises = sceneIds.map(async (sceneId) => {
                try {
                    const sceneDoc = await getDoc(doc(db, "cenas", sceneId));
                    if (sceneDoc.exists()) {
                        foundCount++; const sceneData = sceneDoc.data();
                        const card = document.createElement('div'); card.classList.add('modal-scene-card');

                        const img = document.createElement('img'); /* ... set scene img src, alt, onerror ... */
                        let finalImageUrl = sceneData.imagem;
                        if (typeof finalImageUrl === 'object' && finalImageUrl !== null && finalImageUrl.width) {
                            const urlKey = Object.keys(finalImageUrl).find(k => typeof finalImageUrl[k] === 'string' && finalImageUrl[k].startsWith('http'));
                            finalImageUrl = urlKey ? finalImageUrl[urlKey] : 'placeholder.png';
                        } else if (typeof finalImageUrl !== 'string' || !finalImageUrl) { finalImageUrl = 'placeholder.png'; }
                        img.src = finalImageUrl; img.alt = sceneData.nome;
                        img.onerror = () => { img.src = 'placeholder.png'; img.onerror=null; }

                        const titleDiv = document.createElement('div'); titleDiv.classList.add('title'); titleDiv.textContent = sceneData.nome || 'Sem Título';
                        card.appendChild(img); card.appendChild(titleDiv); cardsContainer.appendChild(card);
                    }
                } catch (error) { console.error(`Error fetching scene ${sceneId}:`, error); }
            });
            await Promise.all(fetchPromises);
            if (foundCount === 0) containerElement.innerHTML = '<h4>Cenas</h4><i>Erro ao carregar cenas.</i>';
        }

        // 9. Show Actress Details IN Modal
        async function showActressDetailsInModal(actressId, currentContentState) {
            previousModalState = currentContentState; // Store where we came from
            modalBody.innerHTML = '<div class="loading">Carregando...</div>';
            modalLinkContainer.innerHTML = ''; modalBackButtonContainer.innerHTML = ''; // Clear buttons

            try {
                const actressDoc = await getDoc(doc(db, "atores", actressId));
                if (actressDoc.exists()) {
                    const data = actressDoc.data();
                    modalTitle.textContent = data.nome || 'Detalhes da Atriz';
                    modalBody.innerHTML = '';

                    if (data.foto) { /* ... Add actress image ... */
                        const img = document.createElement('img'); img.src = data.foto; img.alt = data.nome;
                        img.classList.add('modal-detail-image'); img.onerror = () => { img.style.display = 'none'; };
                        modalBody.appendChild(img);
                    }

                    const skipActressFields = ['foto', 'nome', 'timestamp'];
                    for (const key in data) { /* ... Display details similar to main column ... */
                        if (data.hasOwnProperty(key) && !skipActressFields.includes(key)) {
                           const detailDiv = document.createElement('div');
                           let value = data[key]; let label = key;
                           if (key === 'dataNascimento') {
                               detailDiv.innerHTML = `<strong>${label}:</strong> ${value || 'N/A'}`;
                               modalBody.appendChild(detailDiv);
                               const ageDiv = document.createElement('div'); ageDiv.innerHTML = `<strong>Idade:</strong> ${calculateAge(value)}`;
                               modalBody.appendChild(ageDiv); continue;
                           }
                           else if (key === 'peso' && value !== undefined && value !== null) { value = `${value} kg`; }
                           else if (key === 'altura' && value !== undefined && value !== null) { value = `${value} cm`; }
                           detailDiv.innerHTML = `<strong>${label}:</strong> ${value}`;
                           modalBody.appendChild(detailDiv);
                       }
                    }

                    // Add Back Button
                    const backButton = document.createElement('button'); backButton.textContent = '← Voltar';
                    backButton.onclick = () => restoreContentDetailsModal();
                    modalBackButtonContainer.appendChild(backButton);

                } else { modalBody.innerHTML = '<div class="error">Atriz não encontrada.</div>'; }
            } catch (error) { console.error(`Error fetching actress ${actressId}:`, error); modalBody.innerHTML = '<div class="error">Erro ao carregar.</div>'; }
        }

        // 10. Restore Previous Content View in Modal
        function restoreContentDetailsModal() {
            if (previousModalState && previousModalState.type && previousModalState.id) {
                showContentDetails(previousModalState.type, previousModalState.id); // Re-run showContentDetails
            } else { closeModal(); } // Fallback: just close if state is lost
        }

        // 11. Close Modal Function
        function closeModal() {
            modal.style.display = 'none';
            modalBody.innerHTML = ''; modalLinkContainer.innerHTML = '';
            modalBackButtonContainer.innerHTML = ''; previousModalState = null;
        }

        // Close modal on overlay click
        window.addEventListener('click', (event) => {
            if (event.target == modal) closeModal();
        });

        // --- Initial Load ---
        loadActresses();

    </script>

</body>
</html>
