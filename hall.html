<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Atrizes</title>
    <style>
        /* === Google Fonts (Optional but used in form) === */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        /* --- Base & Layout --- */
        body { font-family: 'Roboto', sans-serif; /* Changed default font */ margin: 0; padding: 0; background-color: #f4f4f4; display: flex; min-height: 100vh; font-size: 14px; }
        .container { display: flex; width: 100%; padding: 15px; box-sizing: border-box; gap: 10px; }
        .column { background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); overflow: hidden; height: calc(100vh - 30px); box-sizing: border-box; display: flex; flex-direction: column; }
        #actress-list-col { flex: 1; }
        #actress-detail-col, #content-col { display: none; }
        .container.details-visible #actress-list-col { flex: 0 0 25%; max-width: 300px; }
        .container.details-visible #actress-detail-col { display: flex; flex: 0 0 30%; max-width: 400px; }
        .container.details-visible #content-col { display: flex; flex: 1; }
        .column h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.3em; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-shrink: 0; }
        .column h2.related-title { margin-top: 0; }

        /* --- Actress List (Left Column) --- */
        #actress-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Make the list take available space */
            overflow-y: auto;
            /* Removed min-height if it was there */
        }
        .actress-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s ease; }
        .actress-item:hover { background-color: #f0f0f0; }
        .actress-item.selected { background-color: #e0e0e0; font-weight: bold; }
        .actress-item img { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .actress-info span { display: block; font-size: 0.9em; line-height: 1.3; }
        .actress-info .name { font-weight: bold; font-size: 1em; }
        .actress-info .age, .actress-info .rating { color: #555; font-size: 0.85em; }
        #actress-list .no-results-message { /* Style for no results message */
            padding: 15px;
            text-align: center;
            color: #888;
            font-style: italic;
        }

        /* --- NEW: Styles for the controls container and elements --- */
        #actress-list-controls {
            flex-shrink: 0; /* Prevent shrinking */
            padding: 8px 10px;
            border-top: 1px solid #eee;
            background-color: #f8f8f8; /* Slight background distinction */
            display: flex;
            align-items: center;
            gap: 8px; /* Spacing between elements */
        }
        #actress-search-input {
            flex-grow: 1; /* Take most space */
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #actress-filter-btn,
        #actress-stats-btn {
            flex-shrink: 0;
            padding: 5px;
            border: none;
            background: none;
            cursor: pointer;
            color: #555;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
         #actress-filter-btn svg,
         #actress-stats-btn svg { /* Style icons */
            width: 16px;
            height: 16px;
            display: block; /* Prevents extra space */
         }
        #actress-filter-btn:hover,
        #actress-stats-btn:hover {
            opacity: 1;
            color: #000;
        }


        /* --- Actress Details (Middle Column) --- */
        #actress-details { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        #actress-details h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #actress-details div { margin-bottom: 7px; word-wrap: break-word; font-size: 0.9em; }
        #actress-details strong { display: inline-block; min-width: 90px; color: #333; font-weight: bold; margin-right: 5px; }
        #actress-details img.detail-photo { max-width: 180px; max-height: 230px; width: auto; height: auto; border-radius: 4px; margin-top: 8px; display: block; }

        /* --- Related Content (Right Column) --- */
         #content-col-header { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-shrink: 0; }
        .related-filter-buttons { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .related-filter-btn { padding: 5px 10px; border: 1px solid #ccc; background-color: #eee; color: #333; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .related-filter-btn:hover { background-color: #ddd; }
        .related-filter-btn.active { background-color: #007bff; color: white; border-color: #007bff; font-weight: bold; }
        .related-actress-search-area { position: relative; width: 100%; }
        .related-search-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: text; min-height: 32px; }
        .related-search-input-wrapper:focus-within { border-color: #80bdff; box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); }
        #related-selected-actresses { display: contents; }
        .related-actress-pill { display: inline-flex; align-items: center; background-color: #007bff; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin: 1px; white-space: nowrap; }
        .related-actress-pill span { margin-right: 4px; }
        .related-remove-actress-btn { background: none; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 1em; padding: 0 2px; line-height: 1; opacity: 0.8; }
        .related-remove-actress-btn:hover { opacity: 1; }
        .related-search-input { flex-grow: 1; padding: 4px 5px; border: none; background-color: transparent; color: #333; font-size: 0.9em; min-width: 100px; outline: none; }
        #related-suggestions-list { display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; }
        #related-suggestions-list .suggestion-item { display: flex; padding: 5px 10px; color: #333; cursor: pointer; align-items: center; gap: 8px; font-size: 0.9em; }
        #related-suggestions-list .suggestion-item:hover { background-color: #f0f0f0; }
        #related-suggestions-list .suggestion-item.no-results { cursor: default; color: #888; justify-content: center; padding: 8px; }
        #related-suggestions-list .suggestion-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }

        #content-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; flex-grow: 1; overflow-y: auto; padding-top: 5px; align-content: start; }
        .content-card { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; overflow: hidden; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: box-shadow 0.2s ease; position: relative; display: flex; flex-direction: column;}
        .content-card:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .content-card .image-container { position: relative; width: 100%; height: 160px; flex-shrink: 0; }
        .content-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .content-type-badge { position: absolute; top: 4px; left: 4px; background-color: rgba(0, 0, 0, 0.75); color: white; padding: 2px 5px; font-size: 0.7em; font-weight: bold; border-radius: 3px; z-index: 1; }
        .content-card .title { padding: 6px; font-size: 0.85em; min-height: 35px; display: flex; align-items: center; justify-content: center; line-height: 1.2; flex-grow: 1; }
        #content-message { grid-column: 1 / -1; font-size: 0.9em; }

        /* --- Modal Styling (Shared) --- */
        .modal-overlay { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1000; display: none; /* Hidden initially */ justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: #fff; padding: 20px 25px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 650px; width: 90%; position: relative; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-close-button { position: absolute; top: 8px; right: 12px; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; background: none; border: none; padding: 0;}
        .modal-close-button:hover { color: #333; }
        .modal-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .modal-body-content { /* Renamed from #modal-body to avoid ID conflict */ flex-grow: 1; overflow-y: auto; padding-right: 5px; font-size: 0.9em; }

        /* --- Content Detail Modal Specific --- */
        #content-modal .modal-body-content div:not(.modal-actress-list-container):not(.modal-scenes-container) { margin-bottom: 7px; word-wrap: break-word; }
        #content-modal .modal-body-content strong { display: inline-block; min-width: 70px; color: #333; font-weight: bold;}
        #modal-link-container button { padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        #modal-link-container button:hover { background-color: #0056b3; }
        #content-modal .modal-body-content img.modal-detail-image { max-width: 90%; height: auto; max-height: 280px; margin-top: 5px; border-radius: 4px; display: block; margin-left: auto; margin-right: auto; margin-bottom: 12px; }
        #content-modal .modal-body-content img.modal-detail-image.movie-image { max-width: 220px; max-height: 220px; }
        #content-modal .modal-body-content .modal-year { font-size: 1em; color: #555; margin-bottom: 12px; }
        .modal-actress-list-container, .modal-scenes-container { margin-top: 15px; padding-top: 12px; border-top: 1px solid #eee; }
        .modal-actress-list-container h4, .modal-scenes-container h4 { margin-top: 0; margin-bottom: 10px; color: #333; font-size: 1em; }
        .modal-actress-list { display: flex; flex-wrap: wrap; gap: 12px; padding: 0; list-style: none; }
        .modal-actress-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s ease; max-width: 70px; }
        .modal-actress-item:hover { background-color: #f0f0f0; }
        .modal-actress-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; margin-bottom: 4px; }
        .modal-actress-item span { font-size: 0.8em; word-wrap: break-word; line-height: 1.1; max-width: 100%;}
        .modal-scene-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; }
        .modal-scene-card { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; overflow: hidden; text-align: center; font-size: 0.75em; }
        .modal-scene-card img { width: 100%; height: 70px; object-fit: cover; display: block; }
        .modal-scene-card .title { padding: 4px; min-height: 20px; display: flex; align-items: center; justify-content: center; line-height: 1.1; }

        /* --- Movable Actress Popup Styling --- */
        .actress-popup { position: fixed; background-color: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 1050; width: 200px; max-height: 300px; overflow: hidden; display: flex; flex-direction: column; cursor: grab; user-select: none; }
        .actress-popup.dragging { cursor: grabbing; opacity: 0.9; }
        .actress-popup-header { background-color: #f0f0f0; padding: 5px 8px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
        .actress-popup-header:active { cursor: grabbing; }
        .actress-popup-header h5 { margin: 0; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; padding-right: 5px; }
        .actress-popup-close, .actress-popup-compare-btn { font-weight: bold; color: #888; cursor: pointer; border: none; background: none; padding: 0 4px; line-height: 1; flex-shrink: 0; }
        .actress-popup-close { font-size: 1.1em; }
        .actress-popup-compare-btn { font-size: 0.9em; margin-right: 5px; }
        .actress-popup-close:hover, .actress-popup-compare-btn:hover { color: #333; }
        .actress-popup-body { padding: 8px; overflow-y: auto; font-size: 0.8em; flex-grow: 1; }
        .actress-popup-body img { width: 65px; height: 65px; object-fit: cover; border-radius: 50%; display: block; margin: 0 auto 8px auto; }
        .actress-popup-body div { margin-bottom: 4px; }
        .actress-popup-body strong { display: inline-block; min-width: 55px; color: #444; font-weight: bold; margin-right: 3px;}

        /* --- Comparison Modal --- */
        #comparison-modal .modal-content { max-width: 80vw; width: auto; }
        #comparison-modal-body { display: flex; gap: 10px; align-items: flex-start; overflow-x: auto; padding-bottom: 10px; min-height: 200px; flex-grow: 1; }
        .comparison-column { flex: 1; min-width: 180px; max-width: 220px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; display: flex; flex-direction: column; box-sizing: border-box; height: min-content; }
        .comparison-column .remove-compare-btn { position: absolute; top: 3px; right: 3px; background: rgba(255, 255, 255, 0.7); border: none; border-radius: 50%; color: #888; cursor: pointer; font-weight: bold; font-size: 14px; line-height: 16px; width: 18px; height: 18px; text-align: center; padding: 0; z-index: 1; }
        .comparison-column .remove-compare-btn:hover { color: #333; background: rgba(230, 230, 230, 0.9); }
        .comparison-column img { width: 100%; height: auto; max-height: 180px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; display: block; }
        .comparison-column h4 { font-size: 1em; margin: 0 0 8px 0; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; padding-right: 20px; word-wrap: break-word; }
        .comparison-column div { font-size: 0.85em; margin-bottom: 4px; word-wrap: break-word; }
        .comparison-column strong { display: inline-block; min-width: 50px; color: #333; font-weight: bold; margin-right: 3px; }
        #comparison-suggestions-list { display: none; position: absolute; width: 100%; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; max-height: 150px; overflow-y: auto; z-index: 1100; box-sizing: border-box; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        /* Reuse suggestion-item styles */
        #comparison-suggestions-list .suggestion-item { display: flex; padding: 5px 10px; color: #333; cursor: pointer; align-items: center; gap: 8px; font-size: 0.9em; }
        #comparison-suggestions-list .suggestion-item:hover { background-color: #f0f0f0; }
        #comparison-suggestions-list .suggestion-item.no-results { cursor: default; color: #888; justify-content: center; padding: 8px; }
        #comparison-suggestions-list .suggestion-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        #comparison-suggestions-list .suggestion-item.context-actress span { font-weight: bold; color: #0056b3; }

        /* --- Floating Action Button (FAB) & Menu --- */
        #fab-create { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background-color: #007bff; color: white; border: none; border-radius: 50%; font-size: 28px; line-height: 55px; text-align: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 1060; transition: background-color 0.2s ease, transform 0.1s ease; }
        #fab-create:hover { background-color: #0056b3; }
        #fab-create:active { transform: scale(0.95); }
        #create-menu-popup { position: fixed; bottom: 90px; right: 25px; background-color: #fff; border-radius: 6px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); padding: 8px 0; z-index: 1070; display: none; min-width: 160px; }
        .create-menu-button { display: block; background: none; border: none; color: #333; padding: 10px 15px; text-align: left; width: 100%; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
        .create-menu-button:hover { background-color: #f0f0f0; }

        /* --- Create Actress Modal Specific Styles --- */
        #create-actress-modal .modal-content { max-width: 1000px; background-color: #242424; color: #e0e0e0; }
        #create-actress-modal .modal-content h3 { color: #fff; border-bottom-color: #444; }
        #create-actress-modal .modal-close-button { color: #aaa; }
        #create-actress-modal .modal-close-button:hover { color: #fff; }
        #create-actress-modal .modal-body-content { padding: 5px; }
        #create-actress-modal #create-actress-form { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 30px; }
        #create-actress-modal .form-card { background-color: #333; padding: 18px; border-radius: 8px; border: 1px solid #444; flex-basis: calc(50% - 8px); flex-grow: 1; box-sizing: border-box; min-width: 250px; }
        #create-actress-modal .form-card.full-width { flex-basis: 100%; }
        #create-actress-modal label { display: block; margin-bottom: 10px; color: #b0b0b0; font-size: 0.9em; font-weight: bold; }
        #create-actress-modal input[type="text"], #create-actress-modal input[type="url"], #create-actress-modal input[type="number"], #create-actress-modal textarea { width: 100%; padding: 10px 12px; background-color: #404040; border: 1px solid #555; border-radius: 5px; color: #e0e0e0; box-sizing: border-box; font-size: 1em; transition: border-color 0.2s ease, box-shadow 0.2s ease; margin-bottom: 0; }
        #create-actress-modal textarea { min-height: 120px; resize: vertical; }
        #create-actress-modal input:focus, #create-actress-modal textarea:focus { outline: none; border-color: #bb86fc; box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.3); }
        #create-actress-modal .error-message { color: #f44336; font-size: 0.85em; display: block; margin-top: 5px; font-weight: bold; }
        #create-actress-modal .submit-button-container { text-align: center; }
        #create-actress-modal button[type="submit"] { min-width: 200px; margin-top: 10px; background-color: #bb86fc; color: #121212; padding: 14px 35px; border: none; border-radius: 6px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; }
        #create-actress-modal button[type="submit"]:hover { background-color: #a772e3; }
        #create-actress-modal button[type="submit"]:active { transform: scale(0.98); }
        #create-actress-modal button[type="submit"]:disabled { background-color: #555; color: #999; cursor: not-allowed; transform: none; }

        /* --- NEW: Paste Text Modal Styles --- */
        #paste-text-modal .modal-content { max-width: 700px; }
        #paste-text-area { width: 100%; min-height: 250px; resize: vertical; font-family: monospace; font-size: 0.9em; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 15px; }
        #paste-analysis-result { font-size: 0.9em; margin-top: 10px; min-height: 1.5em; }
        #paste-analysis-result.error { color: #a00; font-weight: bold; }
        #paste-analysis-result.info { color: #333; } /* Style for confirmation message */
        #analyze-paste-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        #analyze-paste-button:hover { background-color: #0056b3; }
        #analyze-paste-button:disabled { background-color: #aaa; cursor: not-allowed; }

        /* --- NEW: Create Scene/Movie Modal Styles --- */
        #create-scene-modal .modal-content,
        #create-movie-modal .modal-content { max-width: 850px; /* Wider for forms */ }
        #create-scene-modal .modal-body-content,
        #create-movie-modal .modal-body-content { font-size: 1em; } /* Slightly larger base font */
        .create-form { display: flex; flex-wrap: wrap; gap: 15px 20px; /* Row and column gap */ }
        .form-group { margin-bottom: 10px; flex: 1 1 calc(50% - 10px); /* Two columns */ box-sizing: border-box; min-width: 200px; }
        .form-group.full-width { flex-basis: 100%; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 0.9em; }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="number"],
        .form-group input[type="date"] /* Added date type */
        { width: 100%; padding: 9px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.95em; }
        .form-group input:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); }
        .form-group .info-display { font-size: 0.9em; color: #555; margin-top: 5px; min-height: 1.5em; }
        .form-group .info-display.loading { font-style: italic; color: #888; }
        .form-group .info-display.not-found { color: #a00; }
        .form-group .info-display.found { color: #007bff; font-weight: bold; }
        .submit-button-container { flex-basis: 100%; text-align: right; margin-top: 20px; }
        .submit-button-container button[type="submit"] { padding: 12px 25px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease; }
        .submit-button-container button[type="submit"]:hover { background-color: #218838; }
        .submit-button-container button[type="submit"]:disabled { background-color: #aaa; cursor: not-allowed; }
        .form-group .error-message { color: #dc3545; font-size: 0.8em; margin-top: 4px; }

        /* --- NEW: Actor Selector for Create Scene Modal --- */
        #scene-actors-selector { position: relative; }
        #scene-actors-search-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: text; min-height: 32px; }
        #scene-actors-search-input-wrapper:focus-within { border-color: #80bdff; box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); }
        #scene-selected-actors { display: contents; }
        .scene-actor-pill { /* Reuse related-actress-pill style */ display: inline-flex; align-items: center; background-color: #007bff; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin: 1px; white-space: nowrap; }
        .scene-actor-pill span { margin-right: 4px; }
        .scene-remove-actor-btn { /* Reuse related style */ background: none; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 1em; padding: 0 2px; line-height: 1; opacity: 0.8; }
        .scene-remove-actor-btn:hover { opacity: 1; }
        #scene-actors-search-input { flex-grow: 1; padding: 4px 5px; border: none; background-color: transparent; color: #333; font-size: 0.9em; min-width: 100px; outline: none; }
        #scene-actors-suggestions-list { /* Reuse related style */ display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; }
        #scene-actors-suggestions-list .suggestion-item { /* Reuse related style */ display: flex; padding: 5px 10px; color: #333; cursor: pointer; align-items: center; gap: 8px; font-size: 0.9em; }
        #scene-actors-suggestions-list .suggestion-item:hover { background-color: #f0f0f0; }
        #scene-actors-suggestions-list .suggestion-item.no-results { cursor: default; color: #888; justify-content: center; padding: 8px; }
        #scene-actors-suggestions-list .suggestion-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }

        /* --- NEW: Statistics Modal Styles --- */
        #stats-modal .modal-content {
            max-width: 90vw; /* Allow wider modal for tables */
            max-height: 85vh;
        }
        #stats-options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .stats-option-btn {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background-color: #eee;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .stats-option-btn:hover {
            background-color: #ddd;
        }
        #stats-results-container {
            margin-top: 10px;
             /* Make results scrollable */
            max-height: calc(85vh - 200px); /* Adjust as needed */
            overflow-y: auto;
            font-size: 0.9em; /* Smaller font for potentially large tables */
        }
        #stats-results-container h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        /* Styles for generated tables */
        #stats-results-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: auto; /* Or fixed if preferred */
        }
        #stats-results-container th,
        #stats-results-container td {
            border: 1px solid #ddd;
            padding: 6px 8px; /* Adjust padding */
            text-align: left;
            vertical-align: middle; /* Align content vertically */
            font-size: 0.85em; /* Smaller font in table cells */
            word-wrap: break-word; /* Allow long text to wrap */
        }
        #stats-results-container th {
            background-color: #f2f2f2;
            font-weight: bold;
            white-space: nowrap; /* Keep headers on one line */
        }
        #stats-results-container td img {
            max-width: 40px;
            max-height: 40px;
            height: auto;
            border-radius: 50%;
            object-fit: cover;
            display: block; /* Prevents extra space below image */
            margin: 0 auto; /* Center image */
        }
        #stats-results-container .loading-stats {
            text-align: center;
            padding: 20px;
            color: #555;
            font-style: italic;
        }
        /* Sortable Header Styles */
        #stats-results-container th.sortable {
            cursor: pointer;
            position: relative;
            padding-right: 20px; /* Space for indicator */
        }
        #stats-results-container th.sortable::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            margin-top: -6px; /* Center vertically */
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 5px solid #aaa; /* Default: pointing down slightly */
            opacity: 0.4;
        }
         #stats-results-container th.sortable.sort-asc::after {
             border-bottom: none;
             border-top: 5px solid #333; /* Pointing up */
             opacity: 1;
        }
         #stats-results-container th.sortable.sort-desc::after {
            border-top: none;
            border-bottom: 5px solid #333; /* Pointing down */
            opacity: 1;
        }
        /* Styles for non-table results */
        #stats-results-container ul {
            list-style: disc;
            padding-left: 25px;
        }
         #stats-results-container li {
             margin-bottom: 5px;
         }

        /* --- NEW: Filter Modal Styles --- */
        #filter-modal .modal-content {
            max-width: 650px; /* Adjust width as needed */
        }
        #filter-modal-body {
             max-height: calc(85vh - 150px); /* Adjust based on header/footer */
             overflow-y: auto;
             padding: 5px 15px; /* Adjust padding */
        }
        #actress-filter-form .filter-section {
            margin-bottom: 18px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        #actress-filter-form .filter-section:last-of-type {
            border-bottom: none;
            margin-bottom: 5px;
        }
        #actress-filter-form h4 {
            font-size: 1em;
            color: #333;
            margin-top: 0;
            margin-bottom: 12px;
        }
        #actress-filter-form .form-group {
            margin-bottom: 10px;
        }
        #actress-filter-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
            color: #555;
        }
        #actress-filter-form select,
        #actress-filter-form input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.95em;
            -moz-appearance: textfield; /* Hide spinners in Firefox */
        }
         #actress-filter-form input[type="number"]::-webkit-outer-spin-button,
         #actress-filter-form input[type="number"]::-webkit-inner-spin-button {
             -webkit-appearance: none; /* Hide spinners in Chrome, Safari, Edge */
             margin: 0;
         }
        #actress-filter-form .range-group label {
            margin-bottom: 8px;
        }
        #actress-filter-form .range-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #actress-filter-form .range-inputs input[type="number"] {
            flex: 1; /* Make inputs share space */
            text-align: center;
        }
         #actress-filter-form .range-inputs span {
             font-weight: bold;
             color: #555;
         }
        .filter-actions {
            margin-top: 20px;
            text-align: right;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .filter-actions button {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            margin-left: 10px;
        }
        #apply-filters-btn {
            background-color: #007bff;
            color: white;
        }
         #apply-filters-btn:hover {
             background-color: #0056b3;
         }
        #clear-filters-btn {
            background-color: #6c757d;
            color: white;
        }
        #clear-filters-btn:hover {
             background-color: #5a6268;
         }


        /* General Loading/Error Styles */
        .loading, .error { padding: 10px; text-align: center; color: #555; font-style: italic; }
        .error { color: #a00; font-weight: bold; }

        #create-video-modal .modal-content {
            max-width: 850px; /* Consistent width */
        }
        #create-video-modal .modal-body-content {
             font-size: 1em;
        }

        /* --- NEW: Actor Selector for Create Video Modal --- */
        /* Reuse styles by adding video IDs to existing selectors */
        #video-actors-selector { position: relative; }
        #video-actors-search-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: text; min-height: 32px; }
        #video-actors-search-input-wrapper:focus-within { border-color: #80bdff; box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); }
        #video-selected-actors { display: contents; }
        .video-actor-pill { /* New class, but copy style from scene-actor-pill */
             display: inline-flex; align-items: center; background-color: #007bff; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin: 1px; white-space: nowrap;
        }
        .video-actor-pill span { margin-right: 4px; }
        .video-remove-actor-btn { /* New class, but copy style */
             background: none; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 1em; padding: 0 2px; line-height: 1; opacity: 0.8;
        }
        .video-remove-actor-btn:hover { opacity: 1; }
        #video-actors-search-input { flex-grow: 1; padding: 4px 5px; border: none; background-color: transparent; color: #333; font-size: 0.9em; min-width: 100px; outline: none; }
        #video-actors-suggestions-list { /* Reuse related style */ display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; }
        #video-actors-suggestions-list .suggestion-item { /* Reuse related style */ display: flex; padding: 5px 10px; color: #333; cursor: pointer; align-items: center; gap: 8px; font-size: 0.9em; }
        #video-actors-suggestions-list .suggestion-item:hover { background-color: #f0f0f0; }
        #video-actors-suggestions-list .suggestion-item.no-results { cursor: default; color: #888; justify-content: center; padding: 8px; }
        #video-actors-suggestions-list .suggestion-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }

    </style>
</head>
<body>
    <div class="container" id="main-container">
        <!-- Left Column: Actress List -->
        <div class="column" id="actress-list-col">
            <h2>Atrizes</h2>
            <ul id="actress-list">
                <li class="loading">Carregando...</li>
            </ul>

             <!-- NEW: Controls Container -->
            <div id="actress-list-controls">
                <input type="text" id="actress-search-input" placeholder="Buscar na lista...">
                <button id="actress-filter-btn" title="Filtrar lista">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel-fill" viewBox="0 0 16 16">
                        <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.74.439L7 12.439V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5z"/>
                    </svg>
                </button>
                <button id="actress-stats-btn" title="Estatísticas da lista">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-line-fill" viewBox="0 0 16 16">
                        <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1z"/>
                    </svg>
                </button>
            </div>
            <!-- END: Controls Container -->

        </div>
        <!-- Middle Column: Actress Details -->
        <div class="column" id="actress-detail-col">
            <h2>Detalhes da Atriz</h2>
            <div id="actress-details"></div>
        </div>
        <!-- Right Column: Related Content -->
        <div class="column" id="content-col">
            <div id="content-col-header">
                <div class="related-filter-buttons">
                    <button class="related-filter-btn active" data-filter="all">Todos</button>
                    <button class="related-filter-btn" data-filter="video">Vídeos</button>
                    <button class="related-filter-btn" data-filter="film">Filmes</button>
                    <button class="related-filter-btn" data-filter="scene">Cenas</button>
                </div>
                <div class="related-actress-search-area">
                    <div class="related-search-input-wrapper">
                        <div id="related-selected-actresses"></div>
                        <input type="text" id="related-search-input" class="related-search-input" placeholder="Filtrar por co-atriz...">
                    </div>
                    <div id="related-suggestions-list"></div>
                </div>
            </div>
            <h2 class="related-title">Conteúdo Relacionado</h2>
            <div id="content-cards"></div>
            <div id="content-message" style="display: none;"></div>
        </div>
    </div>

     <!-- Main Modal Structure (for Content Details) -->
    <div id="content-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal()">×</button>
            <h3 id="modal-title">Detalhes</h3>
            <div class="modal-body-content"></div> <!-- Changed ID -->
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 15px;"> <div id="modal-link-container"></div> </div>
        </div>
    </div>



    <!-- *** NEW: Create Video Modal Structure *** -->
    <div id="create-video-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeCreateVideoModal()">×</button>
            <h3>Criar Novo Vídeo</h3>
            <div class="modal-body-content">
                 <form id="create-video-form" class="create-form" novalidate>
                    <!-- Hidden field if needed for context, maybe not necessary here -->
                    <!-- <input type="hidden" id="video-context-id" name="video-context-id"> -->

                    <div class="form-group full-width">
                        <label for="video-nome">Nome do Vídeo:</label>
                        <input type="text" id="video-nome" name="video-nome" required>
                        <span class="error-message" id="video-nome-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="video-estudio">Estúdio:</label>
                        <input type="text" id="video-estudio" name="video-estudio">
                    </div>
                    <div class="form-group">
                        <label for="video-data">Data (YYYY/MM/DD):</label>
                        <input type="text" id="video-data" name="video-data" placeholder="YYYY/MM/DD">
                         <span class="error-message" id="video-data-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="video-imagem">Imagem (URL):</label>
                        <input type="url" id="video-imagem" name="video-imagem" placeholder="https://exemplo.com/imagem_video.jpg">
                        <span class="error-message" id="video-imagem-error"></span>
                    </div>
                     <div class="form-group">
                        <label for="video-pagina">Página Externa (URL):</label>
                        <input type="url" id="video-pagina" name="video-pagina" placeholder="https://link_externo.com/video">
                         <span class="error-message" id="video-pagina-error"></span>
                    </div>

                    <div class="form-group full-width">
                        <label>Atores:</label>
                        <!-- Reusing structure similar to Scene Actor Selector -->
                        <div id="video-actors-selector">
                            <div id="video-actors-search-input-wrapper">
                                <div id="video-selected-actors"></div>
                                <input type="text" id="video-actors-search-input" placeholder="Buscar atriz para adicionar...">
                            </div>
                            <div id="video-actors-suggestions-list"></div>
                        </div>
                        <span class="error-message" id="video-atores-error"></span>
                    </div>

                    <div class="submit-button-container">
                         <div id="create-video-form-message" class="error-message" style="text-align: left; margin-bottom: 10px;"></div>
                         <button type="submit" id="create-video-submit-button">Salvar Vídeo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>





    <!-- Comparison Modal Structure -->
    <div id="comparison-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeComparisonModal()">×</button>
            <h3 id="comparison-modal-title">Comparar Atrizes</h3>
            <div class="comparison-search-area" style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; position: relative;">
                 <input type="text" id="comparison-search-input" placeholder="Buscar atriz para comparar..." style="width: 100%; padding: 8px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                 <div id="comparison-suggestions-list"></div>
            </div>
            <div id="comparison-modal-body"> <div id="comparison-placeholder" style="width: 100%; text-align: center; color: #888; padding-top: 20px;">Selecione atrizes na busca acima para comparar.</div> </div>
        </div>
    </div>

    <!-- Create Actress Modal Structure -->
    <div id="create-actress-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeCreateActressModal()">×</button>
            <h3>Criar Nova Atriz</h3>
            <div class="modal-body-content" id="create-actress-modal-body"> <div class="loading">Carregando formulário...</div> </div>
        </div>
    </div>

    <!-- *** NEW: Paste Text Modal Structure *** -->
    <div id="paste-text-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closePasteTextModal()">×</button>
            <h3>Analisar Texto para Criar Multimídia</h3>
            <div class="modal-body-content">
                <p style="font-size: 0.9em; color: #555; margin-top: 0;">Cole o texto abaixo. O sistema tentará identificar se é uma Cena ou Filme e extrair os dados iniciais.</p>
                <textarea id="paste-text-area" placeholder="Cole aqui o texto começando com 'Scene:' ou 'Movie:'..."></textarea>
                <div id="paste-analysis-result"></div>
            </div>
            <div style="text-align: right; margin-top: 15px;">
                <button id="analyze-paste-button">Analisar e Criar</button>
            </div>
        </div>
    </div>

    <!-- *** NEW: Create Scene Modal Structure *** -->
    <div id="create-scene-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeCreateSceneModal()">×</button>
            <h3>Criar Nova Cena</h3>
            <div class="modal-body-content">
                <form id="create-scene-form" class="create-form" novalidate>
                    <input type="hidden" id="scene-filme-id" name="scene-filme-id">
                    <div class="form-group full-width">
                        <label for="scene-nome">Nome da Cena:</label>
                        <input type="text" id="scene-nome" name="scene-nome" required>
                        <span class="error-message" id="scene-nome-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="scene-data">Data (YYYY/MM/DD):</label>
                        <input type="text" id="scene-data" name="scene-data" placeholder="YYYY/MM/DD">
                         <span class="error-message" id="scene-data-error"></span>
                    </div>
                     <div class="form-group">
                        <label for="scene-numero">Número da Cena:</label>
                        <input type="number" id="scene-numero" name="scene-numero" min="1">
                    </div>
                     <div class="form-group">
                        <label>Filme Associado:</label>
                        <div id="scene-movie-display" class="info-display loading">Procurando filme...</div>
                         <span class="error-message" id="scene-filme-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="scene-imagem">Imagem (URL):</label>
                        <input type="url" id="scene-imagem" name="scene-imagem" placeholder="https://exemplo.com/imagem_cena.jpg">
                    </div>
                     <div class="form-group">
                        <label for="scene-pagina">Página Externa (URL):</label>
                        <input type="url" id="scene-pagina" name="scene-pagina" placeholder="https://link_externo.com/cena">
                    </div>
                    <div class="form-group full-width">
                        <label>Atores:</label>
                        <div id="scene-actors-selector">
                            <div id="scene-actors-search-input-wrapper">
                                <div id="scene-selected-actors"></div>
                                <input type="text" id="scene-actors-search-input" placeholder="Buscar atriz para adicionar...">
                            </div>
                            <div id="scene-actors-suggestions-list"></div>
                        </div>
                        <span class="error-message" id="scene-atores-error"></span>
                    </div>
                    <div class="submit-button-container">
                         <div id="create-scene-form-message" class="error-message" style="text-align: left; margin-bottom: 10px;"></div>
                         <button type="submit" id="create-scene-submit-button">Salvar Cena</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- *** NEW: Create Movie Modal Structure *** -->
    <div id="create-movie-modal" class="modal-overlay">
         <div class="modal-content">
            <button class="modal-close-button" onclick="closeCreateMovieModal()">×</button>
            <h3>Criar Novo Filme</h3>
            <div class="modal-body-content">
                 <form id="create-movie-form" class="create-form" novalidate>
                    <div class="form-group full-width">
                        <label for="movie-nome">Nome do Filme:</label>
                        <input type="text" id="movie-nome" name="movie-nome" required>
                        <span class="error-message" id="movie-nome-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movie-ano">Ano de Lançamento:</label>
                        <input type="number" id="movie-ano" name="movie-ano" placeholder="YYYY">
                        <span class="error-message" id="movie-ano-error"></span>
                    </div>
                     <div class="form-group">
                        <label for="movie-estudio">Estúdio:</label>
                        <input type="text" id="movie-estudio" name="movie-estudio">
                    </div>
                     <div class="form-group">
                        <label for="movie-duracao">Duração:</label>
                        <input type="text" id="movie-duracao" name="movie-duracao" placeholder="HH:MM:SS">
                    </div>
                    <div class="form-group">
                        <label for="movie-imagem">Imagem (URL):</label>
                        <input type="url" id="movie-imagem" name="movie-imagem" placeholder="https://exemplo.com/imagem_filme.jpg">
                    </div>
                     <div class="form-group">
                        <label for="movie-pagina">Página Externa (URL):</label>
                        <input type="url" id="movie-pagina" name="movie-pagina" placeholder="https://link_externo.com/filme">
                    </div>
                    <div class="form-group full-width">
                         <label>Cenas:</label>
                         <div class="info-display">Cenas serão associadas posteriormente ou automaticamente se já existirem.</div>
                    </div>
                    <div class="submit-button-container">
                         <div id="create-movie-form-message" class="error-message" style="text-align: left; margin-bottom: 10px;"></div>
                        <button type="submit" id="create-movie-submit-button">Salvar Filme</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

     <!-- *** NEW: Statistics Modal Structure *** -->
    <div id="stats-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeStatsModal()">×</button>
            <h3>Estatísticas das Atrizes</h3>
            <div class="modal-body-content">
                <div id="stats-options-container">
                    <button class="stats-option-btn" data-stat="full-list">Lista Completa</button>
                    <button class="stats-option-btn" data-stat="shortest">Mais Baixas</button>
                    <button class="stats-option-btn" data-stat="youngest">Mais Novas</button>
                    <button class="stats-option-btn" data-stat="rating">Por Nota</button>
                    <button class="stats-option-btn" data-stat="hair-color">Cores de Cabelo (Únicas)</button>
                    <button class="stats-option-btn" data-stat="eye-color">Cores de Olhos (Únicas)</button>
                    <button class="stats-option-btn" data-stat="height-avg">Média de Alturas</button>
                    <button class="stats-option-btn" data-stat="age-avg">Média de Idades</button>
                    <button class="stats-option-btn" data-stat="countries">Contagem por País</button>
                    <button class="stats-option-btn" data-stat="country-rating-avg">Nota Média por País</button>
                    <!-- Add more buttons as needed -->
                </div>
                <div id="stats-results-container">
                    <p>Selecione uma opção acima para ver as estatísticas.</p>
                </div>
            </div>
        </div>
    </div>

     <!-- *** NEW: Filter Modal Structure *** -->
    <div id="filter-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeFilterModal()">×</button>
            <h3>Filtrar Atrizes</h3>
            <div class="modal-body-content" id="filter-modal-body">
                <!-- Filters will be dynamically added here or use a static structure -->
                <form id="actress-filter-form">
                    <div class="filter-section">
                        <h4>Localização</h4>
                        <div class="form-group">
                            <label for="filter-nationality">Nacionalidade:</label>
                            <select id="filter-nationality" name="nationality">
                                <option value="">Todas</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h4>Características</h4>
                        <div class="form-group">
                            <label for="filter-ethnicity">Etnia:</label>
                            <select id="filter-ethnicity" name="ethnicity">
                                <option value="">Todas</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h4>Físico</h4>
                        <div class="form-group range-group">
                            <label>Altura (cm):</label>
                            <div class="range-inputs">
                                <input type="number" id="filter-height-min" name="height_min" placeholder="Min">
                                <span>-</span>
                                <input type="number" id="filter-height-max" name="height_max" placeholder="Max">
                            </div>
                        </div>
                        <div class="form-group range-group">
                            <label>Peso (kg):</label>
                             <div class="range-inputs">
                                <input type="number" id="filter-weight-min" name="weight_min" placeholder="Min">
                                <span>-</span>
                                <input type="number" id="filter-weight-max" name="weight_max" placeholder="Max">
                            </div>
                        </div>
                    </div>

                     <div class="filter-section">
                        <h4>Outros</h4>
                         <div class="form-group range-group">
                            <label>Idade:</label>
                            <div class="range-inputs">
                                <input type="number" id="filter-age-min" name="age_min" placeholder="Min">
                                <span>-</span>
                                <input type="number" id="filter-age-max" name="age_max" placeholder="Max">
                            </div>
                        </div>
                        <div class="form-group range-group">
                            <label>Nota:</label>
                            <div class="range-inputs">
                                <input type="number" step="0.1" id="filter-rating-min" name="rating_min" placeholder="Min (0.0)">
                                <span>-</span>
                                <input type="number" step="0.1" id="filter-rating-max" name="rating_max" placeholder="Max (10.0)">
                            </div>
                        </div>
                    </div>

                    <div class="filter-actions">
                        <button type="button" id="apply-filters-btn">Aplicar Filtros</button>
                        <button type="button" id="clear-filters-btn">Limpar Filtros</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Template for Movable Actress Popups -->
    <div id="actress-popup-template" class="actress-popup" style="display: none;">
        <div class="actress-popup-header"> <h5>Nome Atriz</h5> <button class="actress-popup-compare-btn" title="Comparar Atrizes">🧪</button> <button class="actress-popup-close">×</button> </div>
        <div class="actress-popup-body"></div>
    </div>

    <!-- Floating Action Button -->
    <button id="fab-create" title="Criar Novo Item">+</button>

    <!-- Create Menu Popup -->
    <div id="create-menu-popup">
        <button class="create-menu-button" id="menu-create-actress">Criar Atriz</button>
        <button class="create-menu-button" id="menu-create-multimedia">Criar Multimídia</button>
    </div>


    <!-- Firebase SDK -->


    <script type="module">
        // --- Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";

        // Importa TODAS as funções do Firestore necessárias UMA VEZ
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            getDoc,
            addDoc,
            query,
            where,
            limit,
            serverTimestamp,
            updateDoc,  // <- Incluído aqui
            arrayUnion  // <- Incluído aqui
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- Firebase Config --- (Vem depois dos imports)
        const firebaseConfig = {
            apiKey: "AIzaSyBZEffPMXgbSHYUUrNdIS5duAVGlKlmSq0", // Replace with your actual API key if needed
            authDomain: "babes-392fd.firebaseapp.com",
            projectId: "babes-392fd",
            storageBucket: "babes-392fd.appspot.com",
            messagingSenderId: "376795361631",
            appId: "1:376795361631:web:d662f2b2f2cd23b115c6ea"
        };

        // A inicialização ocorre aqui:
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const mainContainer = document.getElementById('main-container');
        const actressListUl = document.getElementById('actress-list');
        const actressDetailsContainer = document.getElementById('actress-details');
        const contentCardsContainer = document.getElementById('content-cards');
        const contentMessage = document.getElementById('content-message');
        const contentModal = document.getElementById('content-modal');
        const contentModalBody = contentModal?.querySelector('.modal-body-content');
        const contentModalTitle = document.getElementById('modal-title');
        const modalLinkContainer = document.getElementById('modal-link-container');
        const comparisonModal = document.getElementById('comparison-modal');
        const comparisonModalBody = document.getElementById('comparison-modal-body');
        const comparisonSearchInput = document.getElementById('comparison-search-input');
        const comparisonSuggestionsList = document.getElementById('comparison-suggestions-list');
        const comparisonPlaceholder = document.getElementById('comparison-placeholder');
        const createActressModal = document.getElementById('create-actress-modal');
        const createActressModalBody = document.getElementById('create-actress-modal-body');
        const relatedFilterButtons = document.querySelectorAll('.related-filter-btn');
        const relatedSearchInput = document.getElementById('related-search-input');
        const relatedSuggestionsList = document.getElementById('related-suggestions-list');
        const relatedSelectedActressesContainer = document.getElementById('related-selected-actresses');
        const relatedSearchInputWrapper = document.querySelector('.related-search-input-wrapper');
        const fabCreate = document.getElementById('fab-create');
        const createMenuPopup = document.getElementById('create-menu-popup');
        const menuCreateActressBtn = document.getElementById('menu-create-actress');
        const menuCreateMultimediaBtn = document.getElementById('menu-create-multimedia');
        const actressSearchInput = document.getElementById('actress-search-input');
        const actressFilterBtn = document.getElementById('actress-filter-btn');
        const actressStatsBtn = document.getElementById('actress-stats-btn');
        const pasteTextModal = document.getElementById('paste-text-modal');
        const pasteTextArea = document.getElementById('paste-text-area');
        const pasteAnalysisResult = document.getElementById('paste-analysis-result');
        const analyzePasteButton = document.getElementById('analyze-paste-button');
        const createSceneModal = document.getElementById('create-scene-modal');
        const createSceneForm = document.getElementById('create-scene-form');
        const sceneNomeInput = document.getElementById('scene-nome');
        const sceneDataInput = document.getElementById('scene-data');
        const sceneNumeroInput = document.getElementById('scene-numero');
        const sceneMovieDisplay = document.getElementById('scene-movie-display');
        const sceneFilmeIdInput = document.getElementById('scene-filme-id');
        const sceneImagemInput = document.getElementById('scene-imagem');
        const scenePaginaInput = document.getElementById('scene-pagina');
        const sceneActorsSelector = document.getElementById('scene-actors-selector');
        const sceneSelectedActorsContainer = document.getElementById('scene-selected-actors');
        const sceneActorsSearchInput = document.getElementById('scene-actors-search-input');
        const sceneActorsSuggestionsList = document.getElementById('scene-actors-suggestions-list');
        const createSceneSubmitButton = document.getElementById('create-scene-submit-button');
        const createSceneFormMessage = document.getElementById('create-scene-form-message');
        const createMovieModal = document.getElementById('create-movie-modal');
        const createMovieForm = document.getElementById('create-movie-form');
        const movieNomeInput = document.getElementById('movie-nome');
        const movieAnoInput = document.getElementById('movie-ano');
        const movieEstudioInput = document.getElementById('movie-estudio');
        const movieDuracaoInput = document.getElementById('movie-duracao');
        const movieImagemInput = document.getElementById('movie-imagem');
        const moviePaginaInput = document.getElementById('movie-pagina');
        const createMovieSubmitButton = document.getElementById('create-movie-submit-button');
        const createMovieFormMessage = document.getElementById('create-movie-form-message');
        const statsModal = document.getElementById('stats-modal');
        const statsOptionsContainer = document.getElementById('stats-options-container');
        const statsResultsContainer = document.getElementById('stats-results-container');
        const filterModal = document.getElementById('filter-modal');
        const filterForm = document.getElementById('actress-filter-form');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const filterNationalitySelect = document.getElementById('filter-nationality');
        const filterEthnicitySelect = document.getElementById('filter-ethnicity');
        const createVideoModal = document.getElementById('create-video-modal');
        const createVideoForm = document.getElementById('create-video-form');
        const videoNomeInput = document.getElementById('video-nome');
        const videoEstudioInput = document.getElementById('video-estudio');
        const videoDataInput = document.getElementById('video-data');
        const videoImagemInput = document.getElementById('video-imagem');
        const videoPaginaInput = document.getElementById('video-pagina');
        const videoActorsSelector = document.getElementById('video-actors-selector');
        const videoSelectedActorsContainer = document.getElementById('video-selected-actors');
        const videoActorsSearchInput = document.getElementById('video-actors-search-input');
        const videoActorsSuggestionsList = document.getElementById('video-actors-suggestions-list');
        const createVideoSubmitButton = document.getElementById('create-video-submit-button');
        const createVideoFormMessage = document.getElementById('create-video-form-message');


        // --- State Variables ---
        let selectedMainActressElement = null;
        let currentMainActressId = null;
        let allActressesData = [];
        let allRelatedContent = [];
        let filteredRelatedContent = [];
        let selectedRelatedActresses = [];
        let activeRelatedFilter = 'all';
        let allScenesCache = new Map();
        let popupsOpen = 0;
        let actressesToCompare = [];
        let comparisonContextActressIds = [];
        let createFormInitialized = false;
        let selectedSceneActors = [];
        let selectedVideoActors = []; // State for actors in video creation modal
        let activeActressFilters = {}; // Object to hold current filter values


        // --- Helper Functions ---
        function calculateAge(birthDateString) { if (!birthDateString) return '?'; try { const birthDate = new Date(birthDateString); const today = new Date(); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; } return age > 0 ? age : '?'; } catch (e) { return '?'; } }
        function displayMessage(element, message, isError = false) { if (!element) return; element.innerHTML = `<div class="${isError ? 'error' : 'loading'}">${message}</div>`; element.style.display = 'block'; }
        function clearMessage(element) { if (!element) return; element.innerHTML = ''; element.style.display = 'none'; }
        function capitalizeFirstLetter(string) { return string ? string.charAt(0).toUpperCase() + string.slice(1) : ''; }
        function debounce(func, delay) { let timeoutId; return function(...args) { clearTimeout(timeoutId); timeoutId = setTimeout(() => { func.apply(this, args); }, delay); }; }

        function formatDateString(dateString) {
            if (!dateString) return '';
            try {
                 const dateParts = dateString.replace(',', '').split(' ').filter(part => part.length > 0);
                 const monthNames = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
                 const monthIndex = monthNames.indexOf(dateParts[0]?.toLowerCase());
                 if (monthIndex === -1) throw new Error(`Invalid month name: ${dateParts[0]}`);
                 const month = (monthIndex + 1).toString().padStart(2, '0');
                 let day = '01'; let year = '';
                 if (dateParts.length === 3) { year = dateParts[2]; day = parseInt(dateParts[1]).toString().padStart(2, '0'); }
                 else if (dateParts.length === 2) { year = dateParts[1]; }
                 else { throw new Error(`Unexpected date format parts count: ${dateParts.length} (${dateString})`); }
                 if (!/^\d{4}$/.test(year) || !/^\d{2}$/.test(day)) { throw new Error(`Invalid day or year format: Day=${day}, Year=${year}`); }
                 const testDate = new Date(`${year}-${month}-${day}T00:00:00`);
                 if (isNaN(testDate.getTime()) || testDate.getFullYear() !== parseInt(year) || testDate.getMonth() !== monthIndex || testDate.getDate() !== parseInt(day)) { console.warn("Constructed date is invalid or differs from parts:", `${year}-${month}-${day}`); }
                 return `${year}/${month}/${day}`;
            } catch (e) { console.error("Erro ao formatar data:", dateString, e); return dateString; }
        }

        function clearFormMessages(messageElements) {
            if (!Array.isArray(messageElements)) return;
            messageElements.forEach(el => { if (el && typeof el.textContent !== 'undefined') { el.textContent = ''; } });
        }

        function parseDateStringForSort(dateInput) {
            if (dateInput == null || dateInput === '') return null;
            try {
                 if (typeof dateInput === 'number' && /^\d{4}$/.test(String(dateInput))) { if (dateInput > 1000 && dateInput < 3000) { return new Date(dateInput, 0, 1).getTime(); } else { return null; } }
                 if (typeof dateInput !== 'string') return null;
                 const dateString = dateInput.trim();
                 const yyyy_mm_dd = dateString.match(/^(\d{4})[/-](\d{1,2})[/-](\d{1,2})$/);
                 if (yyyy_mm_dd) {
                     const year = parseInt(yyyy_mm_dd[1]); const month = parseInt(yyyy_mm_dd[2]) - 1; const day = parseInt(yyyy_mm_dd[3]);
                     if (year > 1000 && year < 3000 && month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                          const d = new Date(year, month, day);
                          if (d.getFullYear() === year && d.getMonth() === month && d.getDate() === day) { return d.getTime(); }
                     } return null;
                 }
                 const monthDayYear = dateString.replace(',', '').match(/^([a-zA-Z]+)\s+(?:(\d{1,2})\s+)?(\d{4})$/i);
                 if (monthDayYear) {
                     const monthName = monthDayYear[1]; const day = parseInt(monthDayYear[2] || '1', 10); const year = parseInt(monthDayYear[3]);
                     const monthIndex = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"].indexOf(monthName.toLowerCase());
                     if (monthIndex !== -1 && year > 1000 && year < 3000 && day >= 1 && day <= 31) {
                          const d = new Date(year, monthIndex, day);
                           if (d.getFullYear() === year && d.getMonth() === monthIndex && d.getDate() === day) { return d.getTime(); }
                     } return null;
                 }
                 return null;
            } catch (e) { console.error("Error parsing date for sorting:", dateInput, e); return null; }
        }

         function getItemTimestampForSort(item) {
             if (!item) return null;
             const dataTimestamp = parseDateStringForSort(item.data); if (dataTimestamp !== null) { return dataTimestamp; }
             const anoTimestamp = parseDateStringForSort(item.ano); if (anoTimestamp !== null) { return anoTimestamp; }
             return null;
         }


        // --- Core Logic: Main Page Display ---
        async function loadInitialData() {
            if (!actressListUl) { console.error("Actress list UL not found."); return; }
            displayMessage(actressListUl, 'Carregando atrizes...');
            allScenesCache.clear();
            try {
                 const [actoresSnapshot, cenasSnapshot] = await Promise.all([ getDocs(collection(db, "atores")), getDocs(collection(db, "cenas")) ]);
                 actressListUl.innerHTML = '';
                 if (actoresSnapshot.empty) { /* Handled by renderActressList */ }
                 else {
                     allActressesData = [];
                     actoresSnapshot.forEach((doc) => allActressesData.push({ id: doc.id, ...doc.data() }));
                     allActressesData.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                     console.log(`Loaded ${allActressesData.length} actresses.`);
                 }
                 filterAndRenderActressList(); // Initial render
                 cenasSnapshot.forEach(docSnap => allScenesCache.set(docSnap.id, docSnap.data()));
                 console.log(`Cached ${allScenesCache.size} scenes.`);
            } catch (error) {
                 console.error("Erro ao carregar dados iniciais: ", error);
                 displayMessage(actressListUl, 'Erro ao carregar dados.', true);
            }
        }

        function renderActressList(actressesToRender) {
            if (!actressListUl) return;
            actressListUl.innerHTML = '';
            if (actressesToRender.length === 0) {
                 const li = document.createElement('li'); li.classList.add('no-results-message'); li.textContent = 'Nenhuma atriz encontrada.'; actressListUl.appendChild(li);
            } else {
                 actressesToRender.forEach(actress => { renderActressListItem(actress); });
                 if (selectedMainActressElement) {
                     const selectedId = selectedMainActressElement.dataset.id;
                     const isSelectedVisible = actressesToRender.some(a => a.id === selectedId);
                      if (!isSelectedVisible) { selectedMainActressElement.classList.remove('selected'); selectedMainActressElement = null; }
                      else { const newListItem = actressListUl.querySelector(`.actress-item[data-id="${selectedId}"]`); if (newListItem) { newListItem.classList.add('selected'); selectedMainActressElement = newListItem; } }
                 }
            }
        }

        function renderActressListItem(actress) {
             if (!actressListUl) return;
             const li = document.createElement('li'); li.classList.add('actress-item'); li.dataset.id = actress.id;
             const age = calculateAge(actress.dataNascimento); const imageUrl = actress.foto || 'placeholder.png'; const rating = actress.nota !== undefined && actress.nota !== null ? actress.nota : 'N/A';
             li.innerHTML = `<img src="${imageUrl}" alt="${actress.nome || ''}" onerror="this.src='placeholder.png'; this.onerror=null;"><div class="actress-info"><span class="name">${actress.nome || 'Nome Indisponível'}</span><span class="age">Idade: ${age}</span><span class="rating">Nota: ${rating}</span></div>`;
             li.addEventListener('click', () => handleMainActressClick(actress.id, li));
             actressListUl.appendChild(li);
        }

        async function handleMainActressClick(actressId, listItemElement) {
             try { const getCircularReplacer = () => { const seen = new WeakSet(); return (key, value) => { if (typeof value === "object" && value !== null) { if (seen.has(value)) { return "[Circular]"; } seen.add(value); } return value; }; }; console.log(`DEBUG: BEFORE Load (Actress Click ${actressId}) - Current allRelatedContent:`, JSON.stringify(allRelatedContent, getCircularReplacer())); } catch (e) { console.error("DEBUG: Error stringifying allRelatedContent before load:", e); console.log("DEBUG: BEFORE Load - allRelatedContent (raw):", allRelatedContent); }
             if (selectedMainActressElement === listItemElement || !mainContainer || !actressDetailsContainer || !contentCardsContainer || !contentMessage) return;
             if (selectedMainActressElement) selectedMainActressElement.classList.remove('selected');
             listItemElement.classList.add('selected'); selectedMainActressElement = listItemElement; currentMainActressId = actressId;
             mainContainer.classList.add('details-visible');
             actressDetailsContainer.innerHTML = '<div class="loading">Carregando detalhes...</div>'; contentCardsContainer.innerHTML = ''; displayMessage(contentMessage, 'Carregando conteúdo...');
             selectedRelatedActresses = []; activeRelatedFilter = 'all'; if(relatedSearchInput) relatedSearchInput.value = ''; renderRelatedActressPills();
             relatedFilterButtons.forEach(btn => btn.classList.remove('active')); document.querySelector('.related-filter-btn[data-filter="all"]')?.classList.add('active');
             try {
                 let actressData = allActressesData.find(a => a.id === actressId);
                 if (!actressData) { const actressDoc = await getDoc(doc(db, "atores", actressId)); if (actressDoc.exists()) { actressData = { id: actressId, ...actressDoc.data() }; allActressesData.push(actressData); allActressesData.sort((a, b) => (a.nome || '').localeCompare(b.nome || '')); filterAndRenderActressList(); } } // Update list if loaded dynamically
                 if (actressData) { displayMainActressDetails(actressData); } else { actressDetailsContainer.innerHTML = '<div class="error">Detalhes não encontrados.</div>'; }
                 await loadAndDisplayRelatedContent(actressId);
             } catch (error) { console.error(`Erro ao carregar dados da atriz ${actressId}: `, error); actressDetailsContainer.innerHTML = '<div class="error">Erro ao carregar detalhes.</div>'; displayMessage(contentMessage,'Erro ao carregar conteúdo.', true); }
        }

        function displayMainActressDetails(data) {
            if (!actressDetailsContainer) return;
             actressDetailsContainer.innerHTML = '';
             const detailsTitle = document.createElement('h3'); detailsTitle.textContent = data.nome || 'Detalhes'; actressDetailsContainer.appendChild(detailsTitle);
             if (data.foto) { const img = document.createElement('img'); img.src = data.foto; img.alt = data.nome || 'Foto'; img.classList.add('detail-photo'); img.onerror = () => { img.style.display = 'none'; }; actressDetailsContainer.appendChild(img); }
             let detailsAdded = false;
             const detailFieldsContainer = document.createElement('div');
             const addDetailRow = (label, value) => { if (value != null && value !== '') { const div = document.createElement('div'); div.innerHTML = `<strong>${label}:</strong> ${value}`; detailFieldsContainer.appendChild(div); detailsAdded = true; } };
             addDetailRow('Nascimento', data.dataNascimento); if (data.dataNascimento) { addDetailRow('Idade', calculateAge(data.dataNascimento)); } if (data.altura != null) { addDetailRow('Altura', `${data.altura} cm`); } if (data.peso != null) { addDetailRow('Peso', `${data.peso} kg`); } if (Array.isArray(data.filmes)) { addDetailRow('Filmes Participados', data.filmes.length); } if (Array.isArray(data.videos)) { addDetailRow('Vídeos Participados', data.videos.length); } if (Array.isArray(data.cenas)) { addDetailRow('Cenas Participadas', data.cenas.length); }
             const skipFields = ['foto', 'nome', 'timestamp', 'id', 'filmes', 'videos', 'cenas', 'dataNascimento', 'altura', 'peso', 'createdAt', 'texto']; // 'texto' is skipped
             for (const key in data) { if (data.hasOwnProperty(key) && !skipFields.includes(key)) { addDetailRow(capitalizeFirstLetter(key), data[key]); } }
             actressDetailsContainer.appendChild(detailFieldsContainer);
             if (!detailsAdded && !data.foto) { const noDetailsDiv = document.createElement('div'); noDetailsDiv.classList.add('error'); noDetailsDiv.textContent = 'Sem detalhes adicionais disponíveis.'; actressDetailsContainer.appendChild(noDetailsDiv); }
        }

        function filterAndRenderActressList() {
            if (!actressListUl) return;
            const searchTerm = actressSearchInput?.value.toLowerCase().trim() || '';
            let filteredActresses = [...allActressesData];
            if (searchTerm) { filteredActresses = filteredActresses.filter(actress => (actress.nome || '').toLowerCase().includes(searchTerm) ); }
            const filters = activeActressFilters;
            if (Object.keys(filters).length > 0) {
                filteredActresses = filteredActresses.filter(actress => {
                    let keep = true;
                    for (const key in filters) {
                        const filterValue = filters[key]; let actressValue = actress[key];
                        switch (key) {
                            case 'nationality': if (String(actress.pais || '').trim() !== filterValue) keep = false; break;
                            case 'ethnicity': if (String(actress.etnia || '').trim() !== filterValue) keep = false; break;
                            case 'height_min': if (actress.altura == null || actress.altura < filterValue) keep = false; break;
                            case 'height_max': if (actress.altura == null || actress.altura > filterValue) keep = false; break;
                            case 'weight_min': if (actress.peso == null || actress.peso < filterValue) keep = false; break;
                            case 'weight_max': if (actress.peso == null || actress.peso > filterValue) keep = false; break;
                            case 'age_min': const ageMin = calculateAge(actress.dataNascimento); if (typeof ageMin === 'number' && ageMin < filterValue) keep = false; if (typeof ageMin !== 'number' && filterValue > 0) keep = false; break;
                            case 'age_max': const ageMax = calculateAge(actress.dataNascimento); if (typeof ageMax === 'number' && ageMax > filterValue) keep = false; break;
                            case 'rating_min': if (actress.nota == null || actress.nota < filterValue) keep = false; break;
                            case 'rating_max': if (actress.nota == null || actress.nota > filterValue) keep = false; break;
                        }
                        if (!keep) break;
                    }
                    return keep;
                });
            }
            renderActressList(filteredActresses);
        }


        // --- Related Content Logic ---
        async function loadAndDisplayRelatedContent(mainActressId) {
            console.log(`>>> Iniciando loadAndDisplayRelatedContent para Atriz ID: ${mainActressId}`);
            if (!contentCardsContainer || !contentMessage) { console.error("Content elements not found!"); return; }
             allRelatedContent = []; filteredRelatedContent = []; contentCardsContainer.innerHTML = ''; displayMessage(contentMessage, 'Buscando conteúdo relacionado...');
             console.log(`   Cache de Cenas Atual: ${allScenesCache.size} cenas.`);
             try {
                 const [videosSnapshot, filmesSnapshot] = await Promise.all([ getDocs(collection(db, "videos")), getDocs(collection(db, "filmes")) ]);
                 console.log(`   Encontrados ${videosSnapshot.size} vídeos e ${filmesSnapshot.size} filmes no total.`);
                 videosSnapshot.forEach(docSnap => { const videoId = docSnap.id; const itemData = docSnap.data(); const videoActors = itemData.atores || []; if (Array.isArray(videoActors) && videoActors.includes(mainActressId)) { console.log(`      >> VÍDEO ADICIONADO: ${videoId}`); allRelatedContent.push({ id: videoId, type: 'video', ...itemData }); } });
                 filmesSnapshot.forEach(docSnap => {
                     const movieId = docSnap.id; const movieData = docSnap.data(); const movieSceneIds = movieData.cenas || []; let movieIsRelated = false; const relatedScenesFromMovie = [];
                     if (movieSceneIds.length > 0) { for (const sceneId of movieSceneIds) { const sceneData = allScenesCache.get(sceneId); if (sceneData) { const sceneActors = sceneData.atores || []; const sceneFullData = { id: sceneId, type: 'scene', ...sceneData }; if (Array.isArray(sceneActors) && sceneActors.includes(mainActressId)) { movieIsRelated = true; relatedScenesFromMovie.push(sceneFullData); } } else { console.warn(`      - Cena ID: ${sceneId} NÃO encontrada no Cache para o filme ${movieId}.`); } } }
                     if (movieIsRelated) { console.log(`      >> FILME ADICIONADO: ${movieId}`); allRelatedContent.push({ id: movieId, type: 'film', ...movieData }); relatedScenesFromMovie.forEach(scene => { if (!allRelatedContent.some(item => item.id === scene.id && item.type === 'scene')) { console.log(`         >> CENA (do filme ${movieId}) ADICIONADA: ${scene.id}`); allRelatedContent.push(scene); } }); }
                 });
                 allScenesCache.forEach((sceneData, sceneId) => { const sceneActors = sceneData.atores || []; if (Array.isArray(sceneActors) && sceneActors.includes(mainActressId)) { if (!allRelatedContent.some(item => item.id === sceneId && item.type === 'scene')) { console.log(`      >> CENA (do cache) ADICIONADA: ${sceneId}`); allRelatedContent.push({ id: sceneId, type: 'scene', ...sceneData }); } } });
                 console.log(`   Total de itens (${allRelatedContent.length}) coletados ANTES de aplicar filtros:`, allRelatedContent.map(item => `${item.type}:${item.id}`));
                 applyRelatedContentFilters();
             } catch (error) { console.error("Erro detalhado ao buscar conteúdo relacionado: ", error); displayMessage(contentMessage, 'Erro ao carregar conteúdo relacionado.', true); }
             console.log(`<<< Finalizando loadAndDisplayRelatedContent para Atriz ID: ${mainActressId}`);
        }

        function applyRelatedContentFilters() {
            if (!contentCardsContainer || !contentMessage) return;
             contentCardsContainer.innerHTML = ''; clearMessage(contentMessage);
             const relatedActressIds = selectedRelatedActresses.map(a => a.id);
             filteredRelatedContent = allRelatedContent.filter(item => { if (activeRelatedFilter !== 'all' && item.type !== activeRelatedFilter) return false; if (relatedActressIds.length > 0) { if (!item.atores || !Array.isArray(item.atores)) return false; if (!relatedActressIds.every(relId => item.atores.includes(relId))) return false; } return true; });

             filteredRelatedContent.sort((a, b) => {
                 const timestampA = getItemTimestampForSort(a); const timestampB = getItemTimestampForSort(b);
                 if (timestampA === null && timestampB === null) { return (a.nome || '').localeCompare(b.nome || ''); }
                 else if (timestampA === null) { return 1; } else if (timestampB === null) { return -1; }
                 const dateDifference = timestampB - timestampA; if (dateDifference !== 0) { return dateDifference; }
                 return (a.nome || '').localeCompare(b.nome || '');
             });

             if (filteredRelatedContent.length > 0) { filteredRelatedContent.forEach(item => createContentCard(item.imagem, item.nome, item.type, item.id)); }
             else { displayMessage(contentMessage, 'Nenhum conteúdo encontrado com os filtros aplicados.'); }
        }

        function createContentCard(imageUrl, title, type, id) {
            if (!contentCardsContainer) return;
             const card = document.createElement('div'); card.classList.add('content-card'); card.dataset.type = type; card.dataset.id = id;
             const imageContainer = document.createElement('div'); imageContainer.classList.add('image-container'); const img = document.createElement('img'); let finalImageUrl = imageUrl;
             if (typeof imageUrl === 'object' && imageUrl !== null && imageUrl.width) { const urlKey = Object.keys(imageUrl).find(k=>typeof imageUrl[k]==='string'&&imageUrl[k].startsWith('http')); finalImageUrl = urlKey ? imageUrl[urlKey] : 'placeholder.png'; } else if (typeof imageUrl !== 'string' || !imageUrl) { finalImageUrl = 'placeholder.png'; }
             img.src = finalImageUrl; img.alt = title || type; img.onerror = () => { img.src = 'placeholder.png'; img.onerror=null; };
             const badge = document.createElement('div'); badge.classList.add('content-type-badge'); let badgeText = capitalizeFirstLetter(type); if(type === 'film') badgeText = 'Filme'; else if(type === 'scene') badgeText = 'Cena'; else if(type === 'video') badgeText = 'Vídeo'; badge.textContent = badgeText;
             imageContainer.appendChild(badge); imageContainer.appendChild(img);
             const titleDiv = document.createElement('div'); titleDiv.classList.add('title'); titleDiv.textContent = `${title || 'Sem Título'}`;
             card.appendChild(imageContainer); card.appendChild(titleDiv);
             card.addEventListener('click', () => showContentDetails(type, id)); contentCardsContainer.appendChild(card);
        }

        // --- Right Column Search Functions ---
        function displayRelatedSuggestions(searchTerm) { /* ... (implementação original) ... */ }
        function handleSelectRelatedActress(event) { /* ... (implementação original) ... */ }
        function renderRelatedActressPills() { /* ... (implementação original) ... */ }
        function handleRemoveRelatedActress(event) { /* ... (implementação original) ... */ }

        // --- Content Detail Modal Functions ---
        async function showContentDetails(type, id) { /* ... (implementação original) ... */ }
        async function loadActressesForModal(actressIds, containerElement, contextActressIds = []) { /* ... (implementação original) ... */ }
        async function loadScenesForModal(sceneIds, containerElement) { /* ... (implementação original) ... */ }
        window.closeModal = function() { /* ... (implementação original) ... */ };

        // --- Movable Actress Popup Functions ---
        function createActressPopup(actressId, contextActressIds = []) { /* ... (implementação original) ... */ }
        function populateActressPopup(popupElement, data) { /* ... (implementação original) ... */ }
        function makeDraggable(element) { /* ... (implementação original) ... */ }

        // --- Comparison Modal Functions ---
        function openComparisonModal(contextIds = []) { /* ... (implementação original) ... */ }
        window.closeComparisonModal = function() { /* ... (implementação original) ... */ };
        function displayComparisonSuggestions(searchTerm) { /* ... (implementação original) ... */ }
        function handleSelectActressForComparison(actressId) { /* ... (implementação original) ... */ }
        function removeActressFromComparison(actressId) { /* ... (implementação original) ... */ }
        function renderComparisonView() { /* ... (implementação original) ... */ }

        // --- FAB and Create Menu/Modal Functions ---
        function toggleCreateMenu() {
            if (!createMenuPopup) return;
            const isVisible = createMenuPopup.style.display === 'block';
            createMenuPopup.style.display = isVisible ? 'none' : 'block';
        }
        function closeCreateMenu() {
            if (createMenuPopup) createMenuPopup.style.display = 'none';
        }
        function openCreateActressModal() {
            closeCreateMenu();
            if (!createActressModal || !createActressModalBody) return;
            createActressModalBody.innerHTML = '<div class="loading">Carregando formulário...</div>';
            createActressModal.style.display = 'flex';
            // Dynamically load or display the form
            if (!createFormInitialized) {
                createActressModalBody.innerHTML = getCreateActressFormHTML();
                initializeCreateActressForm();
                createFormInitialized = true;
            } else {
                // Reset form if needed, or simply show it
                const form = document.getElementById('create-actress-form');
                if(form) form.reset();
                clearFormMessages([document.getElementById('create-actress-form-message')]); // Clear global message if exists
                // Clear individual field errors if needed by selecting them
            }
            createActressModalBody.querySelector('input[name="nome"]')?.focus(); // Focus first field
        }
        window.closeCreateActressModal = function() {
            if (createActressModal) createActressModal.style.display = 'none';
            // Optional: Reset form state if needed when closing
        };
        function getCreateActressFormHTML() {
             // Returns the static HTML string for the actress form
             // (Same HTML as before, just encapsulated here)
             return `
                <form id="create-actress-form" novalidate>
                    <div class="form-card">
                        <label for="actress-nome">Nome Completo:</label>
                        <input type="text" id="actress-nome" name="nome" required>
                        <span class="error-message" id="actress-nome-error"></span>

                        <label for="actress-dataNascimento">Data de Nascimento:</label>
                        <input type="text" id="actress-dataNascimento" name="dataNascimento" placeholder="YYYY/MM/DD">
                        <span class="error-message" id="actress-dataNascimento-error"></span>

                        <label for="actress-pais">País:</label>
                        <input type="text" id="actress-pais" name="pais">

                        <label for="actress-cidade">Cidade:</label>
                        <input type="text" id="actress-cidade" name="cidade">
                    </div>
                    <div class="form-card">
                         <label for="actress-etnia">Etnia:</label>
                        <input type="text" id="actress-etnia" name="etnia">

                        <label for="actress-altura">Altura (cm):</label>
                        <input type="number" id="actress-altura" name="altura">

                        <label for="actress-peso">Peso (kg):</label>
                        <input type="number" id="actress-peso" name="peso">

                        <label for="actress-corCabelo">Cor do Cabelo:</label>
                        <input type="text" id="actress-corCabelo" name="corCabelo">

                        <label for="actress-corOlhos">Cor dos Olhos:</label>
                        <input type="text" id="actress-corOlhos" name="corOlhos">
                    </div>
                    <div class="form-card full-width">
                        <label for="actress-foto">Foto (URL):</label>
                        <input type="url" id="actress-foto" name="foto" placeholder="https://exemplo.com/foto.jpg">
                        <span class="error-message" id="actress-foto-error"></span>

                        <label for="actress-nota">Nota (0.0 - 10.0):</label>
                        <input type="number" step="0.1" min="0" max="10" id="actress-nota" name="nota">
                        <span class="error-message" id="actress-nota-error"></span>

                        <label for="actress-tags">Tags (separadas por vírgula):</label>
                        <input type="text" id="actress-tags" name="tags" placeholder="Ex: tag1, tag2, outra tag">
                    </div>
                     <div class="form-card full-width">
                         <label for="actress-texto">Texto Adicional / Biografia:</label>
                        <textarea id="actress-texto" name="texto"></textarea>
                    </div>
                    <div class="form-card full-width submit-button-container">
                         <div id="create-actress-form-message" class="error-message" style="text-align: left; margin-bottom: 10px;"></div>
                        <button type="submit" id="create-actress-submit-button">Salvar Atriz</button>
                    </div>
                </form>`;
        }
        async function handleCreateActressSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('#create-actress-submit-button');
            const formMessage = form.querySelector('#create-actress-form-message');
            if (!form || !submitButton || !formMessage) return;

            // --- Basic Validation ---
            let isValid = true;
            clearFormMessages(form.querySelectorAll('.error-message')); // Clear previous errors

            const nomeInput = form.querySelector('#actress-nome');
            const dataNascimentoInput = form.querySelector('#actress-dataNascimento');
            const fotoInput = form.querySelector('#actress-foto');
            const notaInput = form.querySelector('#actress-nota');

            if (!nomeInput?.value.trim()) {
                form.querySelector('#actress-nome-error').textContent = 'Nome é obrigatório.';
                isValid = false;
            }
            if (dataNascimentoInput?.value.trim() && !/^\d{4}\/\d{2}\/\d{2}$/.test(dataNascimentoInput.value.trim())) {
                form.querySelector('#actress-dataNascimento-error').textContent = 'Formato de data inválido (use YYYY/MM/DD).';
                isValid = false;
            }
             const urlPattern = /^https?:\/\/.+/;
             if (fotoInput?.value.trim() && !urlPattern.test(fotoInput.value.trim())) {
                 form.querySelector('#actress-foto-error').textContent = 'URL da foto inválida.';
                 isValid = false;
            }
             const notaValue = parseFloat(notaInput?.value);
             if (notaInput?.value.trim() && (isNaN(notaValue) || notaValue < 0 || notaValue > 10)) {
                 form.querySelector('#actress-nota-error').textContent = 'Nota deve ser um número entre 0.0 e 10.0.';
                 isValid = false;
             }

            if (!isValid) {
                formMessage.textContent = 'Por favor, corrija os erros no formulário.';
                return;
            }

            // --- Prepare Data ---
            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';
            formMessage.textContent = '';

            const formData = new FormData(form);
            const actressData = {};
            formData.forEach((value, key) => {
                const trimmedValue = typeof value === 'string' ? value.trim() : value;
                if (trimmedValue !== '' && trimmedValue !== null) {
                     // Convert numeric fields explicitly
                     if (key === 'altura' || key === 'peso') {
                         actressData[key] = parseInt(trimmedValue, 10);
                     } else if (key === 'nota') {
                         actressData[key] = parseFloat(trimmedValue);
                     } else if (key === 'tags') {
                         // Split tags string into an array, trimming whitespace
                         actressData[key] = trimmedValue.split(',').map(tag => tag.trim()).filter(tag => tag);
                     }
                      else {
                         actressData[key] = trimmedValue;
                     }
                }
            });
            actressData.timestamp = serverTimestamp(); // Add timestamp

            // --- Save to Firestore ---
            try {
                // Optional: Check for duplicates before adding
                const duplicateQuery = query(collection(db, "atores"), where("nome", "==", actressData.nome), limit(1));
                const duplicateSnapshot = await getDocs(duplicateQuery);
                if (!duplicateSnapshot.empty) {
                    throw new Error(`Atriz "${actressData.nome}" já existe.`);
                }

                const docRef = await addDoc(collection(db, "atores"), actressData);
                console.log("Atriz criada com ID: ", docRef.id);

                // Add to local cache and re-render list
                allActressesData.push({ id: docRef.id, ...actressData });
                allActressesData.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                filterAndRenderActressList(); // Update the main list

                alert('Atriz criada com sucesso!');
                closeCreateActressModal();

            } catch (error) {
                console.error("Erro ao salvar atriz: ", error);
                formMessage.textContent = `Erro: ${error.message}`;
                 alert(`Erro ao salvar: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Salvar Atriz';
            }
        }
        function initializeCreateActressForm() {
             const form = document.getElementById('create-actress-form');
             if (form) {
                 form.removeEventListener('submit', handleCreateActressSubmit); // Remove previous listener if any
                 form.addEventListener('submit', handleCreateActressSubmit);
             }
        }

        // --- Multimedia Creation Functions ---
        function openPasteTextModal() {
            closeCreateMenu();
            if (!pasteTextModal || !pasteTextArea || !pasteAnalysisResult || !analyzePasteButton) {
                 console.error("!!! ERRO: Um ou mais elementos do modal 'Paste Text' NÃO foram encontrados.");
                 return;
            }
            pasteTextArea.value = '';
            pasteAnalysisResult.textContent = '';
            pasteAnalysisResult.className = '';
            analyzePasteButton.disabled = false;
            analyzePasteButton.onclick = analyzePastedText; // Ensure this points to the correct function
            analyzePasteButton.textContent = 'Analisar e Criar';
            pasteTextModal.style.display = 'flex';
            pasteTextArea.focus();
        }
        window.closePasteTextModal = function() {
            if (pasteTextModal) pasteTextModal.style.display = 'none';
        }

        async function analyzePastedText() { // Function name must match the one used in onclick
            if (!pasteTextArea || !pasteAnalysisResult || !analyzePasteButton) return;
            const text = pasteTextArea.value.trim();
            pasteAnalysisResult.textContent = '';
            pasteAnalysisResult.className = '';
            analyzePasteButton.disabled = true;
            analyzePasteButton.textContent = 'Analisando...'; // Change text while processing

            if (!text) {
                pasteAnalysisResult.textContent = 'Por favor, cole algum texto.';
                pasteAnalysisResult.className = 'error';
                analyzePasteButton.disabled = false;
                analyzePasteButton.textContent = 'Analisar e Criar'; // Reset button text
                return;
            }
            const firstWord = text.split(/\s+/)[0].toLowerCase().replace(':', '');
            const containsMovieTag = /Movie:/i.test(text);

            if (firstWord === 'scene') {
                if (containsMovieTag) {
                    pasteAnalysisResult.textContent = 'Detectado: Cena (com filme). Extraindo dados...';
                    const sceneData = extractSceneDataFromText(text);
                    if (sceneData) {
                        console.log("Extracted Scene Data:", sceneData);
                        closePasteTextModal();
                        try {
                            await openCreateSceneModal(sceneData);
                            console.log("Opened Create Scene Modal successfully.");
                        } catch (error) {
                            console.error("Error opening Create Scene Modal:", error);
                            alert("Erro ao tentar abrir o formulário de Cena."); // User feedback
                        }
                    } else {
                        pasteAnalysisResult.textContent = 'Erro ao extrair dados da Cena.';
                        pasteAnalysisResult.className = 'error';
                        analyzePasteButton.disabled = false;
                        analyzePasteButton.textContent = 'Analisar e Criar';
                    }
                } else {
                    pasteAnalysisResult.textContent = 'Detectado: Vídeo (sem filme). Extraindo dados...';
                    const videoData = extractVideoDataFromText(text);
                    if (videoData && videoData.nome) {
                        console.log("Extracted Video Data:", videoData);
                        closePasteTextModal();
                        try {
                            await openCreateVideoModal(videoData);
                            console.log("Opened Create Video Modal successfully.");
                        } catch (error) {
                            console.error("Error opening Create Video Modal:", error);
                             alert("Erro ao tentar abrir o formulário de Vídeo."); // User feedback
                        }
                    } else {
                        pasteAnalysisResult.textContent = 'Erro ao extrair dados do Vídeo.';
                        pasteAnalysisResult.className = 'error';
                        analyzePasteButton.disabled = false;
                        analyzePasteButton.textContent = 'Analisar e Criar';
                    }
                }
            } else if (firstWord === 'movie') {
                pasteAnalysisResult.textContent = 'Detectado: Filme. Extraindo dados...';
                const movieData = extractMovieDataFromText(text);
                if (movieData) {
                    console.log("Extracted Movie Data:", movieData);
                    closePasteTextModal();
                    try {
                        openCreateMovieModal(movieData); // Assuming this is synchronous or doesn't need await
                        console.log("Opened Create Movie Modal successfully.");
                    } catch (error) {
                        console.error("Error opening Create Movie Modal:", error);
                         alert("Erro ao tentar abrir o formulário de Filme."); // User feedback
                    }
                } else {
                    pasteAnalysisResult.textContent = 'Erro ao extrair dados do Filme.';
                    pasteAnalysisResult.className = 'error';
                    analyzePasteButton.disabled = false;
                    analyzePasteButton.textContent = 'Analisar e Criar';
                }
            } else {
                pasteAnalysisResult.textContent = "Formato não reconhecido. O texto deve começar com 'Scene:', 'Movie:' ou 'Video:'.";
                pasteAnalysisResult.className = 'error';
                analyzePasteButton.disabled = false;
                analyzePasteButton.textContent = 'Analisar e Criar';
            }
            // Ensure button is re-enabled if the modal didn't close
             if (pasteTextModal && pasteTextModal.style.display === 'flex') {
                 analyzePasteButton.disabled = false;
                 analyzePasteButton.textContent = 'Analisar e Criar';
             }
        }

        function extractSceneDataFromText(text) {
            const data = { potentialActorNames: [], dataRaw: null, movieName: null };
            const lines = text.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('Scene:')) data.nome = trimmedLine.substring(6).trim();
                else if (trimmedLine.startsWith('Date:')) data.dataRaw = trimmedLine.substring(5).trim();
                else if (trimmedLine.startsWith('Movie:')) data.movieName = trimmedLine.substring(6).trim();
                else if (trimmedLine.startsWith('Actor:') || trimmedLine.startsWith('Actors:')) {
                    const actorsString = trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim();
                    data.potentialActorNames = actorsString.split(',').map(name => name.trim()).filter(name => name);
                }
                 // Simple heuristic: if a line has only names (often comma-separated), treat as actors
                 else if (data.nome && !data.dataRaw && !data.movieName && /^[a-zA-Z\s,]+$/.test(trimmedLine) && trimmedLine.includes(',')) {
                     data.potentialActorNames = trimmedLine.split(',').map(name => name.trim()).filter(name => name);
                 }
            });
            return data;
        }
        function extractMovieDataFromText(text) {
             const data = {}; const lines = text.split('\n');
             lines.forEach(line => {
                 const trimmedLine = line.trim();
                 if (trimmedLine.startsWith('Movie:')) data.nome = trimmedLine.substring(6).trim();
                 else if (trimmedLine.startsWith('Year:')) data.ano = trimmedLine.substring(5).trim();
                 else if (trimmedLine.startsWith('Studio:')) data.estudio = trimmedLine.substring(7).trim();
                 else if (trimmedLine.startsWith('Duration:')) data.duracao = trimmedLine.substring(9).trim();
             });
             return data;
        }
        function extractVideoDataFromText(text) { // Similar to Scene, but without Movie
            const data = { potentialActorNames: [], dataRaw: null }; const lines = text.split('\n');
             lines.forEach(line => {
                 const trimmedLine = line.trim();
                 // Allow 'Scene:' or 'Video:' to define the name for flexibility
                 if (trimmedLine.startsWith('Scene:') || trimmedLine.startsWith('Video:')) {
                      data.nome = trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim();
                 }
                 else if (trimmedLine.startsWith('Date:')) data.dataRaw = trimmedLine.substring(5).trim();
                 else if (trimmedLine.startsWith('Studio:')) data.estudio = trimmedLine.substring(7).trim(); // Added Studio for Video
                 else if (trimmedLine.startsWith('Actor:') || trimmedLine.startsWith('Actors:')) {
                     const actorsString = trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim();
                     data.potentialActorNames = actorsString.split(',').map(name => name.trim()).filter(name => name);
                 }
                 // Simple heuristic for actors
                 else if (data.nome && !data.dataRaw && /^[a-zA-Z\s,]+$/.test(trimmedLine) && trimmedLine.includes(',')) {
                      data.potentialActorNames = trimmedLine.split(',').map(name => name.trim()).filter(name => name);
                 }
             });
             return data;
        }
        function generateMovieNameVariations(name) {
            if (!name) return [];
            const variations = new Set([name, name.toLowerCase()]);
            // Add variations without punctuation if applicable
            const noPunctuation = name.replace(/[.,!?;:]/g, '').trim();
            if (noPunctuation !== name) variations.add(noPunctuation);
             // Simple title case variation
             const titleCase = name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
             variations.add(titleCase);
             return Array.from(variations);
        }
        async function findMovieIdByName(movieName) {
            if (!movieName) return null;
            const nameVariations = generateMovieNameVariations(movieName);
            console.log(`Searching for movie with variations: ${nameVariations.join(', ')}`);
            try {
                // Create multiple 'where' clauses for variations (Firestore 'in' query is limited)
                // This might be slow for many variations. A better approach might involve
                // pre-processing movie names or using a dedicated search service.
                for (const variation of nameVariations) {
                    const movieQuery = query(collection(db, "filmes"), where("nome", "==", variation), limit(1));
                    const querySnapshot = await getDocs(movieQuery);
                    if (!querySnapshot.empty) {
                        const foundDoc = querySnapshot.docs[0];
                        console.log(`Movie found: ${foundDoc.data().nome} (ID: ${foundDoc.id}) using variation: ${variation}`);
                        return { id: foundDoc.id, nome: foundDoc.data().nome };
                    }
                }
                console.log(`Movie "${movieName}" not found with any variation.`);
                return null;
            } catch (error) {
                console.error("Error searching for movie:", error);
                return null;
            }
        }
        async function findActorByName(actorName) {
             if (!actorName) return null;
             const trimmedName = actorName.trim();
             // Try direct match first (case-sensitive might be needed depending on data entry)
             let actorQuery = query(collection(db, "atores"), where("nome", "==", trimmedName), limit(1));
             try {
                 let querySnapshot = await getDocs(actorQuery);
                 if (!querySnapshot.empty) {
                     const doc = querySnapshot.docs[0];
                     return { id: doc.id, nome: doc.data().nome, foto: doc.data().foto };
                 }

                 // If no exact match, try case-insensitive search simulation (less efficient)
                 // This requires fetching more data and filtering client-side or using a different data structure/search service
                 console.warn(`Actor "${trimmedName}" not found with exact match. Case-insensitive search not implemented efficiently here.`);
                 // For now, just return null if exact match fails
                 return null;

             } catch (error) {
                 console.error(`Error searching for actor "${trimmedName}":`, error);
                 return null;
             }
        }

        // --- Create Scene Modal ---
        window.closeCreateSceneModal = function() {
            if (createSceneModal) createSceneModal.style.display = 'none';
            if (createSceneForm) createSceneForm.reset(); // Reset form fields
            selectedSceneActors = []; // Clear selected actors
            renderSceneActorPills(); // Update UI
             // Clear specific error messages
            clearFormMessages([
                createSceneFormMessage,
                document.getElementById('scene-nome-error'),
                document.getElementById('scene-data-error'),
                document.getElementById('scene-filme-error'),
                document.getElementById('scene-atores-error')
            ].filter(el => el)); // Filter out nulls before clearing
        }
        async function openCreateSceneModal(sceneData) {
             console.log(">>> START openCreateSceneModal");
             if (!createSceneModal) { console.error("Create Scene Modal element not found!"); return; }
             if (!sceneData) { console.error("Scene Data is missing!"); return; }

             // Reset form and state
             if (createSceneForm) createSceneForm.reset();
             selectedSceneActors = [];
             renderSceneActorPills();
             clearFormMessages([ createSceneFormMessage, document.getElementById('scene-nome-error'), document.getElementById('scene-data-error'), document.getElementById('scene-filme-error'), document.getElementById('scene-atores-error') ].filter(el => el));
             if(sceneMovieDisplay) sceneMovieDisplay.textContent = '';
             if(sceneFilmeIdInput) sceneFilmeIdInput.value = '';


             // Populate known fields
             if (sceneNomeInput) sceneNomeInput.value = sceneData.nome || '';
             if (sceneDataInput) sceneDataInput.value = formatDateString(sceneData.dataRaw || ''); // Format date if available
             // Clear other fields explicitly
             if (sceneNumeroInput) sceneNumeroInput.value = '';
             if (sceneImagemInput) sceneImagemInput.value = '';
             if (scenePaginaInput) scenePaginaInput.value = '';


             // --- Async Operations: Find Movie and Actors ---
             createSceneModal.style.display = 'flex'; // Show modal early
             let movieLookupPromise = Promise.resolve(null); // Default to no movie found
             let actorLookupPromises = [];

             // Find Movie
             if (sceneData.movieName && sceneMovieDisplay && sceneFilmeIdInput) {
                 sceneMovieDisplay.textContent = `Procurando filme "${sceneData.movieName}"...`;
                 sceneMovieDisplay.className = 'info-display loading';
                 movieLookupPromise = findMovieIdByName(sceneData.movieName).then(movieInfo => {
                     if (movieInfo) {
                         sceneMovieDisplay.textContent = `Filme: ${movieInfo.nome}`;
                         sceneMovieDisplay.className = 'info-display found';
                         sceneFilmeIdInput.value = movieInfo.id;
                          document.getElementById('scene-filme-error').textContent = ''; // Clear error if found
                     } else {
                         sceneMovieDisplay.textContent = `Filme "${sceneData.movieName}" não encontrado.`;
                         sceneMovieDisplay.className = 'info-display not-found';
                         sceneFilmeIdInput.value = '';
                         document.getElementById('scene-filme-error').textContent = 'Filme associado não encontrado.'; // Set error
                     }
                     return movieInfo; // Pass movie info along if needed
                 }).catch(err => {
                      console.error("Error looking up movie:", err);
                      sceneMovieDisplay.textContent = `Erro ao procurar filme.`;
                      sceneMovieDisplay.className = 'info-display error'; // Use error class
                      sceneFilmeIdInput.value = '';
                       document.getElementById('scene-filme-error').textContent = 'Erro ao procurar filme.';
                       return null;
                 });
             } else if (sceneMovieDisplay) {
                  sceneMovieDisplay.textContent = 'Nenhum filme especificado no texto.';
                  sceneMovieDisplay.className = 'info-display'; // Neutral display
                  if (sceneFilmeIdInput) sceneFilmeIdInput.value = '';
             }


             // Find Actors
             if (sceneData.potentialActorNames && sceneData.potentialActorNames.length > 0) {
                 console.log("Looking up actors:", sceneData.potentialActorNames);
                 sceneData.potentialActorNames.forEach(actorName => {
                     if (typeof actorName === 'string' && actorName.trim()) {
                         actorLookupPromises.push(
                             findActorByName(actorName).then(actorInfo => {
                                 if (actorInfo) {
                                      // Avoid duplicates
                                     if (!selectedSceneActors.some(a => a.id === actorInfo.id)) {
                                         selectedSceneActors.push(actorInfo);
                                         console.log(`Pre-selected actor: ${actorInfo.nome}`);
                                     }
                                 } else {
                                     console.log(`Actor "${actorName}" not found.`);
                                      // Optionally add to an "unfound actors" list in the UI
                                 }
                             }).catch(err => console.error(`Error looking up actor ${actorName}:`, err))
                         );
                     } else {
                          console.warn("Skipping empty actor name:", actorName);
                     }
                 });
             } else {
                  console.log("No actor names extracted.");
             }


             // --- Wait for lookups and finalize UI ---
             try {
                 // Wait for both movie and all actor lookups to complete
                 await Promise.all([movieLookupPromise, ...actorLookupPromises]);
                 console.log("Finished movie and actor lookups.");
                 renderSceneActorPills(); // Update pills after lookups
                 if (selectedSceneActors.length > 0) {
                      document.getElementById('scene-atores-error').textContent = ''; // Clear actor error if some found
                 }

             } catch (error) {
                 console.error("Error waiting for lookups:", error);
                 // Still render pills with any actors found so far
                 renderSceneActorPills();
             }

             // Focus the first relevant field
             if (sceneNomeInput) sceneNomeInput.focus();

             console.log("<<< END openCreateSceneModal");
        }
        async function handleCreateSceneSubmit(event) {
             event.preventDefault();
             if (!createSceneForm || !createSceneSubmitButton) return;

             let isValid = true;
             // Clear previous global and specific errors
            clearFormMessages([ createSceneFormMessage, document.getElementById('scene-nome-error'), document.getElementById('scene-data-error'), document.getElementById('scene-filme-error'), document.getElementById('scene-atores-error') ].filter(el => el));


             // --- Get and Validate Data ---
             const nome = sceneNomeInput?.value.trim();
             const data = sceneDataInput?.value.trim();
             const filmeId = sceneFilmeIdInput?.value.trim(); // Movie ID is crucial now
             const numero = sceneNumeroInput?.value.trim();
             const imagemUrl = sceneImagemInput?.value.trim();
             const paginaUrl = scenePaginaInput?.value.trim();


             const nomeError = document.getElementById('scene-nome-error');
             const dataError = document.getElementById('scene-data-error');
             const filmeError = document.getElementById('scene-filme-error');
             const atoresError = document.getElementById('scene-atores-error');


             if (!nome && nomeError) { nomeError.textContent = 'Nome da cena é obrigatório.'; isValid = false; }
             if (data && !/^\d{4}\/\d{2}\/\d{2}$/.test(data) && dataError) { dataError.textContent = 'Formato de data inválido (YYYY/MM/DD).'; isValid = false; }
             // Movie ID is now required if a movie was initially searched for or expected
             if (!filmeId && sceneMovieDisplay && (sceneMovieDisplay.classList.contains('loading') || sceneMovieDisplay.classList.contains('not-found')) && filmeError) {
                // Check if we were looking for a movie and didn't find it
                 filmeError.textContent = 'Filme associado não foi encontrado ou selecionado.';
                 // Decide if this should block submission. Maybe allow creating scenes without movies?
                 // For now, let's consider it an error if a movie was expected but not found.
                 // isValid = false; // Uncomment this line if a movie is strictly required when searched for
             } else if (!filmeId && filmeError && sceneData.movieName) {
                 // If movieName was present in original data but ID is missing now
                 filmeError.textContent = 'Filme associado não encontrado.';
                // isValid = false; // Make it required if movieName existed
             }

             if (selectedSceneActors.length === 0 && atoresError) { atoresError.textContent = 'Pelo menos um ator deve ser selecionado.'; isValid = false; }
             const urlPattern = /^https?:\/\/.+/;
              if (imagemUrl && !urlPattern.test(imagemUrl) && document.getElementById('scene-imagem-error')) {
                 document.getElementById('scene-imagem-error').textContent = 'URL da imagem inválida.'; isValid = false;
             }
             if (paginaUrl && !urlPattern.test(paginaUrl) && document.getElementById('scene-pagina-error')) {
                  document.getElementById('scene-pagina-error').textContent = 'URL da página inválida.'; isValid = false;
              }


             if (!isValid && createSceneFormMessage) { createSceneFormMessage.textContent = 'Corrija os erros indicados.'; return; }

             // --- Prepare Firestore Data ---
             createSceneSubmitButton.disabled = true;
             createSceneSubmitButton.textContent = 'Salvando...';

             const firestoreData = {
                 nome: nome,
                 data: data || null,
                 numero: numero ? parseInt(numero, 10) : null,
                 filme: filmeId || null, // Store the Movie ID (or null)
                 atores: selectedSceneActors.map(a => a.id), // Array of actor IDs
                 imagem: imagemUrl || null,
                 pagina: paginaUrl || null,
                 timestamp: serverTimestamp()
             };
             // Remove null values if Firestore rules require fields to exist
             Object.keys(firestoreData).forEach(key => { if (firestoreData[key] === null) { delete firestoreData[key]; } });

             console.log("Saving Scene Data:", firestoreData);

             // --- Save to Firestore ---
             try {
                 // Optional: Duplicate check (e.g., same name within the same movie)
                 // const duplicateQuery = query(collection(db, "cenas"), where("nome", "==", firestoreData.nome), where("filme", "==", firestoreData.filme), limit(1));
                 // const duplicateSnapshot = await getDocs(duplicateQuery);
                 // if (!duplicateSnapshot.empty) {
                 //    throw new Error(`Cena "${firestoreData.nome}" já existe neste filme.`);
                 // }

                 const docRef = await addDoc(collection(db, "cenas"), firestoreData);
                 console.log("Scene created successfully with ID:", docRef.id);

                 // --- Update Movie (if applicable) ---
                 if (firestoreData.filme) {
                     console.log(`Attempting to add scene ${docRef.id} to movie ${firestoreData.filme}`);
                     const movieRef = doc(db, "filmes", firestoreData.filme);
                     try {
                         await updateDoc(movieRef, {
                             cenas: arrayUnion(docRef.id) // Add scene ID to the movie's 'cenas' array
                         });
                         console.log(`Successfully updated movie ${firestoreData.filme} with scene ${docRef.id}`);
                     } catch (updateError) {
                         console.error(`Failed to update movie ${firestoreData.filme} with scene ${docRef.id}:`, updateError);
                         // Decide how to handle this: alert user? Log only?
                          alert(`Cena criada (ID: ${docRef.id}), mas falha ao atualizar o filme associado. Verifique o console.`);
                     }
                 }

                  // --- Update Local Cache and UI ---
                  allScenesCache.set(docRef.id, firestoreData); // Add to scene cache
                  if (currentMainActressId && firestoreData.atores.includes(currentMainActressId)) {
                      console.log("New scene involves the currently selected actress. Refreshing content...");
                      // Re-fetch might be complex, easier to just add manually if feasible
                      const newContentItem = { id: docRef.id, type: 'scene', ...firestoreData };
                      allRelatedContent.push(newContentItem);
                      // Re-apply filters to potentially show the new card
                      applyRelatedContentFilters();
                  }


                 alert('Cena criada com sucesso!');
                 closeCreateSceneModal();

             } catch (error) {
                 console.error("Error creating scene:", error);
                 if(createSceneFormMessage) createSceneFormMessage.textContent = `Erro: ${error.message}`;
                 alert(`Erro ao criar cena: ${error.message}`);
             } finally {
                 if (createSceneSubmitButton) {
                     createSceneSubmitButton.disabled = false;
                     createSceneSubmitButton.textContent = 'Salvar Cena';
                 }
             }
        }
        function displaySceneActorSuggestions(searchTerm) {
            if (!sceneActorsSuggestionsList || !sceneActorsSearchInput) return;
            const term = searchTerm.trim().toLowerCase();
            sceneActorsSuggestionsList.innerHTML = ''; // Clear previous suggestions

            if (!term) {
                sceneActorsSuggestionsList.style.display = 'none';
                return;
            }

            const filteredActresses = allActressesData.filter(actress =>
                (actress.nome || '').toLowerCase().includes(term) &&
                !selectedSceneActors.some(selected => selected.id === actress.id) // Exclude already selected
            ).slice(0, 10); // Limit suggestions

            if (filteredActresses.length > 0) {
                filteredActresses.forEach(actress => {
                    const item = document.createElement('div');
                    item.classList.add('suggestion-item');
                    item.innerHTML = `
                        <img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';">
                        <span>${actress.nome}</span>
                    `;
                    item.addEventListener('click', () => handleSelectSceneActor(actress));
                    sceneActorsSuggestionsList.appendChild(item);
                });
                sceneActorsSuggestionsList.style.display = 'block';
            } else {
                 const noResults = document.createElement('div');
                 noResults.classList.add('suggestion-item', 'no-results');
                 noResults.textContent = 'Nenhuma atriz encontrada';
                 sceneActorsSuggestionsList.appendChild(noResults);
                 sceneActorsSuggestionsList.style.display = 'block';
            }
        }
        function handleSelectSceneActor(actress) {
             if (!actress || !actress.id) return;
             // Add if not already selected
             if (!selectedSceneActors.some(a => a.id === actress.id)) {
                 selectedSceneActors.push(actress);
                 renderSceneActorPills();
                 if (sceneActorsSearchInput) sceneActorsSearchInput.value = ''; // Clear input
                 if (sceneActorsSuggestionsList) sceneActorsSuggestionsList.style.display = 'none'; // Hide suggestions
                 if (sceneActorsSearchInput) sceneActorsSearchInput.focus(); // Keep focus
                 // Clear potential "at least one actor" error
                 const atoresError = document.getElementById('scene-atores-error');
                 if (atoresError) atoresError.textContent = '';
             }
        }
        function renderSceneActorPills() {
            if (!sceneSelectedActorsContainer) return;
            sceneSelectedActorsContainer.innerHTML = ''; // Clear existing pills
            selectedSceneActors.forEach(actress => {
                const pill = document.createElement('div');
                pill.classList.add('scene-actor-pill'); // Use specific class
                pill.dataset.id = actress.id;
                pill.innerHTML = `
                    <span>${actress.nome}</span>
                    <button type="button" class="scene-remove-actor-btn" title="Remover ${actress.nome}">×</button>
                `;
                pill.querySelector('.scene-remove-actor-btn').addEventListener('click', handleRemoveSceneActor);
                sceneSelectedActorsContainer.appendChild(pill);
            });
        }
        function handleRemoveSceneActor(event) {
            const button = event.target;
            const pill = button.closest('.scene-actor-pill');
            if (pill && pill.dataset.id) {
                const actressIdToRemove = pill.dataset.id;
                selectedSceneActors = selectedSceneActors.filter(a => a.id !== actressIdToRemove);
                renderSceneActorPills(); // Re-render the pills
            }
        }

        // --- Create Movie Modal ---
        window.closeCreateMovieModal = function() {
            if (createMovieModal) createMovieModal.style.display = 'none';
             if (createMovieForm) createMovieForm.reset();
             clearFormMessages([ createMovieFormMessage, document.getElementById('movie-nome-error'), document.getElementById('movie-ano-error') ].filter(el => el));
        }
        function openCreateMovieModal(movieData) {
            if (!createMovieModal) return;
            if (createMovieForm) createMovieForm.reset();
            clearFormMessages([ createMovieFormMessage, document.getElementById('movie-nome-error'), document.getElementById('movie-ano-error') ].filter(el => el));

            // Pre-fill form from extracted data
            if (movieNomeInput && movieData?.nome) movieNomeInput.value = movieData.nome;
            if (movieAnoInput && movieData?.ano) movieAnoInput.value = movieData.ano;
            if (movieEstudioInput && movieData?.estudio) movieEstudioInput.value = movieData.estudio;
            if (movieDuracaoInput && movieData?.duracao) movieDuracaoInput.value = movieData.duracao;
            // Clear image/page fields as they weren't in the text format
            if (movieImagemInput) movieImagemInput.value = '';
            if (moviePaginaInput) moviePaginaInput.value = '';


            createMovieModal.style.display = 'flex';
            if (movieNomeInput) movieNomeInput.focus();
        }
        async function handleCreateMovieSubmit(event) {
             event.preventDefault();
             if (!createMovieForm || !createMovieSubmitButton) return;

             let isValid = true;
             clearFormMessages([ createMovieFormMessage, document.getElementById('movie-nome-error'), document.getElementById('movie-ano-error') ].filter(el => el));


             const nome = movieNomeInput?.value.trim();
             const ano = movieAnoInput?.value.trim();
             const imagemUrl = movieImagemInput?.value.trim();
             const paginaUrl = moviePaginaInput?.value.trim();

             const nomeError = document.getElementById('movie-nome-error');
             const anoError = document.getElementById('movie-ano-error');
              const imagemError = document.getElementById('movie-imagem-error'); // Assuming this ID exists
             const paginaError = document.getElementById('movie-pagina-error'); // Assuming this ID exists


             if (!nome && nomeError) { nomeError.textContent = 'Nome do filme é obrigatório.'; isValid = false; }
             if (ano && !/^\d{4}$/.test(ano) && anoError) { anoError.textContent = 'Ano inválido (use YYYY).'; isValid = false; }

             const urlPattern = /^https?:\/\/.+/;
             if (imagemUrl && !urlPattern.test(imagemUrl) && imagemError) { imagemError.textContent = 'URL da imagem inválida.'; isValid = false; }
             if (paginaUrl && !urlPattern.test(paginaUrl) && paginaError) { paginaError.textContent = 'URL da página inválida.'; isValid = false; }


             if (!isValid && createMovieFormMessage) { createMovieFormMessage.textContent = 'Corrija os erros indicados.'; return; }

             // --- Prepare Firestore Data ---
             createMovieSubmitButton.disabled = true;
             createMovieSubmitButton.textContent = 'Salvando...';

             const firestoreData = {
                 nome: nome,
                 ano: ano ? parseInt(ano, 10) : null,
                 estudio: movieEstudioInput?.value.trim() || null,
                 duracao: movieDuracaoInput?.value.trim() || null,
                 imagem: imagemUrl || null,
                 pagina: paginaUrl || null,
                 cenas: [], // Initialize scenes array as empty
                 timestamp: serverTimestamp()
             };
             Object.keys(firestoreData).forEach(key => { if (firestoreData[key] === null) { delete firestoreData[key]; } });

             console.log("Saving Movie Data:", firestoreData);

             // --- Save to Firestore ---
             try {
                 // Optional: Duplicate check
                 const duplicateQuery = query(collection(db, "filmes"), where("nome", "==", firestoreData.nome), where("ano", "==", firestoreData.ano || null), limit(1));
                 const duplicateSnapshot = await getDocs(duplicateQuery);
                 if (!duplicateSnapshot.empty) {
                     throw new Error(`Filme "${firestoreData.nome}" (${firestoreData.ano || 'Sem ano'}) já existe.`);
                 }

                 const docRef = await addDoc(collection(db, "filmes"), firestoreData);
                 console.log("Movie created successfully with ID:", docRef.id);

                 // No immediate UI update needed unless displaying movies directly

                 alert('Filme criado com sucesso!');
                 closeCreateMovieModal();

             } catch (error) {
                 console.error("Error creating movie:", error);
                  if(createMovieFormMessage) createMovieFormMessage.textContent = `Erro: ${error.message}`;
                 alert(`Erro ao criar filme: ${error.message}`);
             } finally {
                 if (createMovieSubmitButton) {
                     createMovieSubmitButton.disabled = false;
                     createMovieSubmitButton.textContent = 'Salvar Filme';
                 }
             }
        }

        // --- Create Video Modal ---
        window.closeCreateVideoModal = function() {
             if(createVideoModal) createVideoModal.style.display = 'none';
             if(createVideoForm) createVideoForm.reset();
             selectedVideoActors = []; // Clear selected actors for video
             renderVideoActorPills(); // Update UI
             clearFormMessages([ createVideoFormMessage, document.getElementById('video-nome-error'), document.getElementById('video-data-error'), document.getElementById('video-atores-error'), document.getElementById('video-imagem-error'), document.getElementById('video-pagina-error') ].filter(el => el));
        }
        async function openCreateVideoModal(videoData) {
            console.log(">>> START openCreateVideoModal");
            if (!createVideoModal) { console.error("Create Video Modal element not found!"); return; }
            if (!videoData) { console.error("Video Data is missing!"); return; }

            // Reset form and state
            if (createVideoForm) createVideoForm.reset();
            selectedVideoActors = [];
            renderVideoActorPills();
             clearFormMessages([ createVideoFormMessage, document.getElementById('video-nome-error'), document.getElementById('video-data-error'), document.getElementById('video-atores-error'), document.getElementById('video-imagem-error'), document.getElementById('video-pagina-error') ].filter(el => el));

            // Populate known fields
            if (videoNomeInput) videoNomeInput.value = videoData.nome || '';
            if (videoEstudioInput) videoEstudioInput.value = videoData.estudio || ''; // Populate studio if available
            if (videoDataInput) videoDataInput.value = formatDateString(videoData.dataRaw || ''); // Format date
            // Clear other fields explicitly
            if (videoImagemInput) videoImagemInput.value = '';
            if (videoPaginaInput) videoPaginaInput.value = '';

            // --- Async Operations: Find Actors ---
            createVideoModal.style.display = 'flex'; // Show modal
            let actorLookupPromises = [];

            if (videoData.potentialActorNames && videoData.potentialActorNames.length > 0) {
                console.log("Looking up actors for video:", videoData.potentialActorNames);
                videoData.potentialActorNames.forEach(actorName => {
                    if (typeof actorName === 'string' && actorName.trim()) {
                        actorLookupPromises.push(
                            findActorByName(actorName).then(actorInfo => {
                                if (actorInfo) {
                                    if (!selectedVideoActors.some(a => a.id === actorInfo.id)) {
                                        selectedVideoActors.push(actorInfo);
                                        console.log(`Pre-selected video actor: ${actorInfo.nome}`);
                                    }
                                } else {
                                    console.log(`Actor "${actorName}" not found.`);
                                }
                            }).catch(err => console.error(`Error looking up actor ${actorName}:`, err))
                        );
                    } else {
                        console.warn("Skipping empty actor name for video:", actorName);
                    }
                });
            } else {
                console.log("No actor names extracted for video.");
            }

            // --- Wait for lookups and finalize UI ---
            try {
                await Promise.all(actorLookupPromises);
                console.log("Finished actor lookups for video.");
                renderVideoActorPills(); // Update pills
                 if (selectedVideoActors.length > 0) {
                     const atoresError = document.getElementById('video-atores-error');
                      if (atoresError) atoresError.textContent = ''; // Clear error if actors found
                 }
            } catch (error) {
                console.error("Error waiting for video actor lookups:", error);
                renderVideoActorPills(); // Render any found actors anyway
            }

            if (videoNomeInput) { videoNomeInput.focus(); } // Focus name field

            console.log("<<< END openCreateVideoModal");
        }
        async function handleCreateVideoSubmit(event) {
            event.preventDefault();
            if (!createVideoForm || !createVideoSubmitButton) return;
            let isValid = true;
            clearFormMessages([ createVideoFormMessage, document.getElementById('video-nome-error'), document.getElementById('video-data-error'), document.getElementById('video-atores-error'), document.getElementById('video-imagem-error'), document.getElementById('video-pagina-error') ].filter(el => el));

            const nome = videoNomeInput?.value.trim();
            const data = videoDataInput?.value.trim();
            const imagemUrl = videoImagemInput?.value.trim();
            const paginaUrl = videoPaginaInput?.value.trim();

            const nomeError = document.getElementById('video-nome-error');
            const dataError = document.getElementById('video-data-error');
            const atoresError = document.getElementById('video-atores-error');
            const imagemError = document.getElementById('video-imagem-error');
            const paginaError = document.getElementById('video-pagina-error');

            if (!nome && nomeError) { nomeError.textContent = 'Nome do vídeo é obrigatório.'; isValid = false; }
            if (data && !/^\d{4}\/\d{2}\/\d{2}$/.test(data) && dataError) { dataError.textContent = 'Formato de data inválido (YYYY/MM/DD).'; isValid = false; }
            if (selectedVideoActors.length === 0 && atoresError) { atoresError.textContent = 'Selecione pelo menos um ator.'; isValid = false; }

            const urlPattern = /^https?:\/\/.+/;
            if (imagemUrl && !urlPattern.test(imagemUrl) && imagemError) { imagemError.textContent = 'URL da imagem inválida.'; isValid = false; }
            if (paginaUrl && !urlPattern.test(paginaUrl) && paginaError) { paginaError.textContent = 'URL da página inválida.'; isValid = false; }

            if (!isValid && createVideoFormMessage) { createVideoFormMessage.textContent = 'Corrija os erros indicados.'; return; }

            // --- Prepare Firestore Data ---
            createVideoSubmitButton.disabled = true;
            createVideoSubmitButton.textContent = 'Verificando...';

            const firestoreData = {
                nome: nome,
                estudio: videoEstudioInput?.value.trim() || null,
                data: data || null,
                imagem: imagemUrl || null,
                pagina: paginaUrl || null,
                atores: selectedVideoActors.map(a => a.id), // Array of actor IDs
                timestamp: serverTimestamp()
            };
             Object.keys(firestoreData).forEach(key => { if (firestoreData[key] === null) { delete firestoreData[key]; } });


            console.log(`Checking for duplicate video: Name="${firestoreData.nome}"`);
            try {
                const duplicateQuery = query( collection(db, "videos"), where("nome", "==", firestoreData.nome), limit(1) );
                const duplicateSnapshot = await getDocs(duplicateQuery);
                if (!duplicateSnapshot.empty) {
                    const existingDocId = duplicateSnapshot.docs[0].id;
                    console.warn(`Duplicate video found: ID=${existingDocId}`);
                    const errorMsg = `Vídeo "${firestoreData.nome}" já existe.`;
                    alert(errorMsg);
                    if (createVideoFormMessage) createVideoFormMessage.textContent = errorMsg;
                    createVideoSubmitButton.disabled = false;
                    createVideoSubmitButton.textContent = 'Salvar Vídeo';
                    return;
                } else {
                    console.log("No duplicate video found.");
                }
            } catch (error) {
                console.error("Error checking duplicate video:", error);
                alert(`Erro ao verificar duplicados: ${error.message}`);
                if (createVideoFormMessage) createVideoFormMessage.textContent = `Erro: ${error.message}`;
                createVideoSubmitButton.disabled = false;
                createVideoSubmitButton.textContent = 'Salvar Vídeo';
                return;
            }

             // --- Save to Firestore ---
            createVideoSubmitButton.textContent = 'Salvando Vídeo...';
            console.log("Saving Video Data:", firestoreData);

            try {
                const docRef = await addDoc(collection(db, "videos"), firestoreData);
                console.log("Video created successfully with ID:", docRef.id);

                 // --- Update Local UI ---
                if (currentMainActressId && firestoreData.atores.includes(currentMainActressId)) {
                    console.log("New video involves the currently selected actress. Refreshing content...");
                    const newContentItem = { id: docRef.id, type: 'video', ...firestoreData };
                    allRelatedContent.push(newContentItem);
                    applyRelatedContentFilters(); // Re-filter and render
                }

                alert('Vídeo criado com sucesso!');
                closeCreateVideoModal();

            } catch (error) {
                console.error("Error creating video:", error);
                if(createVideoFormMessage) createVideoFormMessage.textContent = `Erro: ${error.message}`;
                alert(`Erro ao criar vídeo: ${error.message}`);
            } finally {
                if (createVideoSubmitButton) {
                    createVideoSubmitButton.disabled = false;
                    createVideoSubmitButton.textContent = 'Salvar Vídeo';
                }
            }
        }
        function displayVideoActorSuggestions(searchTerm) {
            // Adapted from displaySceneActorSuggestions
            if (!videoActorsSuggestionsList || !videoActorsSearchInput) return;
            const term = searchTerm.trim().toLowerCase();
            videoActorsSuggestionsList.innerHTML = '';

            if (!term) {
                videoActorsSuggestionsList.style.display = 'none';
                return;
            }

            const filteredActresses = allActressesData.filter(actress =>
                (actress.nome || '').toLowerCase().includes(term) &&
                !selectedVideoActors.some(selected => selected.id === actress.id) // Check against selectedVideoActors
            ).slice(0, 10);

            if (filteredActresses.length > 0) {
                filteredActresses.forEach(actress => {
                    const item = document.createElement('div');
                    item.classList.add('suggestion-item');
                    item.innerHTML = `
                        <img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';">
                        <span>${actress.nome}</span>
                    `;
                    item.addEventListener('click', () => handleSelectVideoActor(actress)); // Call video handler
                    videoActorsSuggestionsList.appendChild(item);
                });
                videoActorsSuggestionsList.style.display = 'block';
            } else {
                 const noResults = document.createElement('div');
                 noResults.classList.add('suggestion-item', 'no-results');
                 noResults.textContent = 'Nenhuma atriz encontrada';
                 videoActorsSuggestionsList.appendChild(noResults);
                 videoActorsSuggestionsList.style.display = 'block';
            }
        }
        function handleSelectVideoActor(actress) {
            // Adapted from handleSelectSceneActor
             if (!actress || !actress.id) return;
             if (!selectedVideoActors.some(a => a.id === actress.id)) {
                 selectedVideoActors.push(actress);
                 renderVideoActorPills(); // Call video renderer
                 if (videoActorsSearchInput) videoActorsSearchInput.value = '';
                 if (videoActorsSuggestionsList) videoActorsSuggestionsList.style.display = 'none';
                 if (videoActorsSearchInput) videoActorsSearchInput.focus();
                 const atoresError = document.getElementById('video-atores-error');
                 if (atoresError) atoresError.textContent = '';
             }
        }
        function renderVideoActorPills() {
            // Adapted from renderSceneActorPills
            if (!videoSelectedActorsContainer) return;
            videoSelectedActorsContainer.innerHTML = '';
            selectedVideoActors.forEach(actress => {
                const pill = document.createElement('div');
                pill.classList.add('video-actor-pill'); // Use video class
                pill.dataset.id = actress.id;
                pill.innerHTML = `
                    <span>${actress.nome}</span>
                    <button type="button" class="video-remove-actor-btn" title="Remover ${actress.nome}">×</button>
                `;
                pill.querySelector('.video-remove-actor-btn').addEventListener('click', handleRemoveVideoActor); // Call video handler
                videoSelectedActorsContainer.appendChild(pill);
            });
        }
        function handleRemoveVideoActor(event) {
            // Adapted from handleRemoveSceneActor
            const button = event.target;
            const pill = button.closest('.video-actor-pill');
            if (pill && pill.dataset.id) {
                const actressIdToRemove = pill.dataset.id;
                selectedVideoActors = selectedVideoActors.filter(a => a.id !== actressIdToRemove);
                renderVideoActorPills(); // Call video renderer
            }
        }

        // --- Statistics Modal Functions ---
        function openStatsModal() { /* ... (implementação original) ... */ }
        window.closeStatsModal = function() { /* ... (implementação original) ... */ };
        async function displayStatistic(statType) { /* ... (implementação original) ... */ }
        function generateStatsTable(statType) { /* ... (implementação original) ... */ }
        function generateUniqueCountList(fieldKey, title) { /* ... (implementação original) ... */ }
        function calculateAverageStat(fieldKey, title) { /* ... (implementação original) ... */ }
        function calculateGroupAverage(groupKey, valueKey, title) { /* ... (implementação original) ... */ }
        function addTableSorting(table) { /* ... (implementação original) ... */ }

        // --- Filter Modal Functions ---
        function openFilterModal() { /* ... (implementação original) ... */ }
        window.closeFilterModal = function() { /* ... (implementação original) ... */ };
        function populateFilterOptions() { /* ... (implementação original) ... */ }
        function getUniqueValues(key) { /* ... (implementação original) ... */ }
        function populateSelect(selectElement, optionsArray, defaultOptionText) { /* ... (implementação original) ... */ }
        function setFilterFormValues() { /* ... (implementação original) ... */ }
        function updateActiveFiltersFromForm() { /* ... (implementação original) ... */ }
        function handleApplyFilters() { /* ... (implementação original) ... */ }
        function handleClearFilters() { /* ... (implementação original) ... */ }


        // --- Event Listeners (Global Page) ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();

            // Modal Closes on Overlay Click
            [contentModal, comparisonModal, createActressModal, pasteTextModal, createSceneModal, createMovieModal, statsModal, filterModal, createVideoModal].forEach(modal => {
                if (modal) {
                     modal.addEventListener('click', (event) => {
                         if (event.target === modal) {
                             switch(modal.id) {
                                 case 'content-modal': closeModal(); break;
                                 case 'comparison-modal': closeComparisonModal(); break;
                                 case 'create-actress-modal': closeCreateActressModal(); break;
                                 case 'paste-text-modal': closePasteTextModal(); break;
                                 case 'create-scene-modal': closeCreateSceneModal(); break;
                                 case 'create-movie-modal': closeCreateMovieModal(); break;
                                 case 'stats-modal': closeStatsModal(); break;
                                 case 'filter-modal': closeFilterModal(); break;
                                 case 'create-video-modal': closeCreateVideoModal(); break;
                             }
                         }
                     });
                }
            });

            // Related Content Filter Buttons
            relatedFilterButtons.forEach(button => { button.addEventListener('click', () => { relatedFilterButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); activeRelatedFilter = button.dataset.filter || 'all'; applyRelatedContentFilters(); }); });
             // Related Search
             if(relatedSearchInput) { const debouncedRelatedSearch = debounce(() => displayRelatedSuggestions(relatedSearchInput.value), 300); relatedSearchInput.addEventListener('input', debouncedRelatedSearch); relatedSearchInput.addEventListener('focus', () => displayRelatedSuggestions(relatedSearchInput.value)); }
             if(relatedSearchInputWrapper) { relatedSearchInputWrapper.addEventListener('click', (e) => { if (!e.target.closest('.related-remove-actress-btn')) { relatedSearchInput?.focus(); } }); }
             // Comparison Search
             if (comparisonSearchInput) { const debouncedComparisonSearch = debounce(() => displayComparisonSuggestions(comparisonSearchInput.value), 300); comparisonSearchInput.addEventListener('input', debouncedComparisonSearch); comparisonSearchInput.addEventListener('focus', () => displayComparisonSuggestions(comparisonSearchInput.value)); }

             // --- FAB & Menu ---
             if (fabCreate) {
                 fabCreate.addEventListener('click', toggleCreateMenu); // Calls toggle function
             }
             if (menuCreateActressBtn) {
                 menuCreateActressBtn.addEventListener('click', openCreateActressModal); // Opens Actress modal
             }
             if (menuCreateMultimediaBtn) {
                 menuCreateMultimediaBtn.addEventListener('click', openPasteTextModal); // Opens Paste Text modal
             }

             // --- Paste Text Analyze Button ---
             // The onclick is now set dynamically inside openPasteTextModal function
             // No listener needed here if analyzePasteButton.onclick is being set

             // Create Scene Listeners
             if (createSceneForm) { createSceneForm.addEventListener('submit', handleCreateSceneSubmit); }
             if (sceneActorsSearchInput) { const debouncedSceneActorSearch = debounce(() => displaySceneActorSuggestions(sceneActorsSearchInput.value), 300); sceneActorsSearchInput.addEventListener('input', debouncedSceneActorSearch); sceneActorsSearchInput.addEventListener('focus', () => displaySceneActorSuggestions(sceneActorsSearchInput.value)); }
             if (sceneActorsSelector) { sceneActorsSelector.addEventListener('click', (e) => { if (!e.target.closest('.scene-remove-actor-btn') && !e.target.closest('#scene-actors-suggestions-list')) { sceneActorsSearchInput?.focus(); } }); }

             // Create Movie Listener
             if (createMovieForm) { createMovieForm.addEventListener('submit', handleCreateMovieSubmit); }

             // Create Video Listeners
             if (createVideoForm) { createVideoForm.addEventListener('submit', handleCreateVideoSubmit); }
             if (videoActorsSearchInput) { const debouncedVideoActorSearch = debounce(() => displayVideoActorSuggestions(videoActorsSearchInput.value), 300); videoActorsSearchInput.addEventListener('input', debouncedVideoActorSearch); videoActorsSearchInput.addEventListener('focus', () => displayVideoActorSuggestions(videoActorsSearchInput.value)); }
             if (videoActorsSelector) { videoActorsSelector.addEventListener('click', (e) => { if (!e.target.closest('.video-remove-actor-btn') && !e.target.closest('#video-actors-suggestions-list')) { videoActorsSearchInput?.focus(); } }); }

             // Actress List Search Listener
             if (actressSearchInput && actressListUl) { const debouncedActressFilterRender = debounce(() => { filterAndRenderActressList(); }, 250); actressSearchInput.addEventListener('input', debouncedActressFilterRender); }

             // Actress List Filter/Stats Buttons
             if (actressFilterBtn) { actressFilterBtn.addEventListener('click', openFilterModal); }
             if (actressStatsBtn) { actressStatsBtn.addEventListener('click', openStatsModal); }

             // Stats Modal Options Listener
            if (statsOptionsContainer) { statsOptionsContainer.addEventListener('click', (event) => { const button = event.target.closest('.stats-option-btn'); if (button && button.dataset.stat) { displayStatistic(button.dataset.stat); } }); }

            // Filter Modal Actions Listener
            if (applyFiltersBtn) { applyFiltersBtn.addEventListener('click', handleApplyFilters); }
            if (clearFiltersBtn) { clearFiltersBtn.addEventListener('click', handleClearFilters); }

            // Global Click Listener (for closing popups/suggestions)
            document.addEventListener('click', (event) => {
                 const isClickInsideRelatedSearchArea = relatedSearchInputWrapper?.contains(event.target); const isClickInsideRelatedSuggestions = relatedSuggestionsList?.contains(event.target); if (relatedSuggestionsList && !isClickInsideRelatedSearchArea && !isClickInsideRelatedSuggestions) { relatedSuggestionsList.style.display = 'none'; }
                 const comparisonSearchArea = comparisonSearchInput?.closest('.comparison-search-area'); const isClickInsideComparisonSearchArea = comparisonSearchArea?.contains(event.target); const isClickInsideComparisonSuggestions = comparisonSuggestionsList?.contains(event.target); if (comparisonSuggestionsList && !isClickInsideComparisonSearchArea && !isClickInsideComparisonSuggestions) { comparisonSuggestionsList.style.display = 'none'; }
                 const isClickInsideFab = fabCreate?.contains(event.target); const isClickInsideCreateMenu = createMenuPopup?.contains(event.target); if (createMenuPopup && createMenuPopup.style.display === 'block' && !isClickInsideFab && !isClickInsideCreateMenu) { closeCreateMenu(); } // Close menu on outside click
                 const isClickInsideSceneActorSearchArea = sceneActorsSelector?.contains(event.target); const isClickInsideSceneActorSuggestions = sceneActorsSuggestionsList?.contains(event.target); if (sceneActorsSuggestionsList && !isClickInsideSceneActorSearchArea && !isClickInsideSceneActorSuggestions) { sceneActorsSuggestionsList.style.display = 'none'; }
                 const isClickInsideVideoActorSearchArea = videoActorsSelector?.contains(event.target); const isClickInsideVideoActorSuggestions = videoActorsSuggestionsList?.contains(event.target); if (videoActorsSuggestionsList && !isClickInsideVideoActorSearchArea && !isClickInsideVideoActorSuggestions) { videoActorsSuggestionsList.style.display = 'none'; }
             });
        }); // End DOMContentLoaded

    </script>
    

  </body>
  </html>
```
