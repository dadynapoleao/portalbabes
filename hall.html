<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Atrizes</title>
    <style>
        /* === Google Fonts (Optional but used in form) === */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        /* --- Base & Layout --- */
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; min-height: 100vh; font-size: 14px; }
        .container { display: flex; width: 100%; padding: 15px; box-sizing: border-box; gap: 10px; }
        .column { background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); overflow: hidden; height: calc(100vh - 30px); box-sizing: border-box; display: flex; flex-direction: column; }
        #actress-list-col { flex: 1; }
        #actress-detail-col, #content-col { display: none; }
        .container.details-visible #actress-list-col { flex: 0 0 25%; max-width: 300px; }
        .container.details-visible #actress-detail-col { display: flex; flex: 0 0 30%; max-width: 400px; }
        .container.details-visible #content-col { display: flex; flex: 1; }
        .column h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.3em; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-shrink: 0; }
        .column h2.related-title { margin-top: 0; }

        /* --- Actress List (Left Column) --- */
        #actress-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .actress-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s ease; }
        .actress-item:hover { background-color: #f0f0f0; }
        .actress-item.selected { background-color: #e0e0e0; font-weight: bold; }
        .actress-item img { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .actress-info span { display: block; font-size: 0.9em; line-height: 1.3; }
        .actress-info .name { font-weight: bold; font-size: 1em; }
        .actress-info .age, .actress-info .rating { color: #555; font-size: 0.85em; }
        #actress-list .no-results-message { padding: 15px; text-align: center; color: #888; font-style: italic; }

        /* --- Actress List Controls --- */
        #actress-list-controls { flex-shrink: 0; padding: 8px 10px; border-top: 1px solid #eee; background-color: #f8f8f8; display: flex; align-items: center; gap: 8px; }
        #actress-search-input { flex-grow: 1; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; }
        #actress-filter-btn, #actress-stats-btn { flex-shrink: 0; padding: 5px; border: none; background: none; cursor: pointer; color: #555; opacity: 0.8; transition: opacity 0.2s; }
        #actress-filter-btn svg, #actress-stats-btn svg { width: 16px; height: 16px; display: block; }
        #actress-filter-btn:hover, #actress-stats-btn:hover { opacity: 1; color: #000; }

        /* --- Actress Details (Middle Column) --- */
        #actress-details { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        #actress-details h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #actress-details div { margin-bottom: 7px; word-wrap: break-word; font-size: 0.9em; }
        #actress-details strong { display: inline-block; min-width: 90px; color: #333; font-weight: bold; margin-right: 5px; }
        #actress-details img.detail-photo { max-width: 180px; max-height: 230px; width: auto; height: auto; border-radius: 4px; margin-top: 8px; display: block; }

        /* --- Related Content (Right Column) --- */
        #content-col-header { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-shrink: 0; }
        .related-filter-buttons { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .related-filter-btn { padding: 5px 10px; border: 1px solid #ccc; background-color: #eee; color: #333; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .related-filter-btn:hover { background-color: #ddd; }
        .related-filter-btn.active { background-color: #007bff; color: white; border-color: #007bff; font-weight: bold; }
        .related-actress-search-area { position: relative; width: 100%; }
        .related-search-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: text; min-height: 32px; }
        .related-search-input-wrapper:focus-within { border-color: #80bdff; box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); }
        #related-selected-actresses { display: contents; }
        .related-actress-pill { display: inline-flex; align-items: center; background-color: #007bff; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin: 1px; white-space: nowrap; }
        .related-actress-pill span { margin-right: 4px; }
        .related-remove-actress-btn { background: none; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 1em; padding: 0 2px; line-height: 1; opacity: 0.8; }
        .related-remove-actress-btn:hover { opacity: 1; }
        .related-search-input { flex-grow: 1; padding: 4px 5px; border: none; background-color: transparent; color: #333; font-size: 0.9em; min-width: 100px; outline: none; }
        #related-suggestions-list { display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; }
        #related-suggestions-list .suggestion-item { display: flex; padding: 5px 10px; color: #333; cursor: pointer; align-items: center; gap: 8px; font-size: 0.9em; }
        #related-suggestions-list .suggestion-item:hover { background-color: #f0f0f0; }
        #related-suggestions-list .suggestion-item.no-results { cursor: default; color: #888; justify-content: center; padding: 8px; }
        #related-suggestions-list .suggestion-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }

        #content-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; flex-grow: 1; overflow-y: auto; padding-top: 5px; align-content: start; }
        .content-card { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; overflow: hidden; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: box-shadow 0.2s ease; position: relative; display: flex; flex-direction: column;}
        .content-card:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .content-card .image-container { position: relative; width: 100%; height: 160px; flex-shrink: 0; }
        .content-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .content-type-badge { position: absolute; top: 4px; left: 4px; background-color: rgba(0, 0, 0, 0.75); color: white; padding: 2px 5px; font-size: 0.7em; font-weight: bold; border-radius: 3px; z-index: 1; }
        .content-card .title { padding: 6px; font-size: 0.85em; min-height: 35px; display: flex; align-items: center; justify-content: center; line-height: 1.2; flex-grow: 1; }
        #content-message { grid-column: 1 / -1; font-size: 0.9em; padding: 10px; text-align: center; color: #555; font-style: italic; }
         #content-message.error { color: #a00; font-weight: bold; }

        /* --- Similar Actresses Table Styles --- */
        #similar-actresses-table-container { flex-grow: 1; overflow-y: auto; display: none; } /* NEW CONTAINER */
        #similar-actresses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
        }
        #similar-actresses-table th,
        #similar-actresses-table td {
            border-bottom: 1px solid #eee;
            padding: 8px 5px;
            text-align: left;
            vertical-align: middle;
            font-size: 0.9em;
        }
        #similar-actresses-table th { background-color: #f8f8f8; font-weight: bold; white-space: nowrap; }
        #similar-actresses-table th.rank-col { width: 50px; text-align: center; }
        #similar-actresses-table th.score-col { width: 65px; text-align: center;}
        #similar-actresses-table td.rank-col { text-align: center; font-weight: bold; font-size: 1.1em; color: #555; }
        #similar-actresses-table td.score-col { text-align: center; font-weight: bold; color: #007bff; }
        .similar-actress-table-card { display: flex; align-items: center; gap: 10px; padding: 5px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease; min-height: 45px; }
        .similar-actress-table-card:hover { background-color: #f0f0f0; }
        .similar-actress-table-card img { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; flex-shrink: 0; border: 1px solid #ddd; }
        .similar-actress-table-card .name { font-weight: bold; font-size: 0.95em; line-height: 1.2; word-break: break-word; }


        /* --- Rank Display Styles (NEW) --- */
        #rank-display-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: none; /* Hidden by default */
            flex-direction: column; /* Stack rank cards vertically */
            gap: 15px; /* Space between rank cards */
        }
        .rank-card {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.07);
        }
        .rank-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.1em;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .rank-card .rank-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #007bff;
            margin: 5px 0 10px 0;
            display: block;
        }
        .rank-card .rank-value.not-available {
            font-size: 1em;
            color: #777;
            font-style: italic;
        }
        .rank-card .rank-details-link {
            display: inline-block;
            font-size: 0.85em;
            color: #0056b3;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 5px;
        }
        .rank-card .rank-details-link:hover {
            color: #003f7f;
        }
        /* --- END: Rank Display Styles --- */


        /* --- Ranking Detail Modal Table Styles (NEW) --- */
        #ranking-detail-modal .modal-body-content { padding-right: 0; /* Remove padding if table is full width */ }
        #ranking-detail-modal table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        #ranking-detail-modal th,
        #ranking-detail-modal td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: middle;
        }
        #ranking-detail-modal th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        #ranking-detail-modal td img.rank-detail-photo {
            width: 35px;
            height: 35px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        #ranking-detail-modal tr.highlighted-actress td {
            background-color: #e6f2ff; /* Light blue highlight */
            font-weight: bold;
        }
        #ranking-detail-modal th.col-rank { width: 50px; text-align: center; }
        #ranking-detail-modal th.col-foto { width: 60px; text-align: center; }
        #ranking-detail-modal th.col-overall { width: 80px; text-align: center; }
        #ranking-detail-modal td.col-rank, #ranking-detail-modal td.col-overall { text-align: center; }
        /* --- END: Ranking Detail Modal Table Styles --- */


        /* --- Modal Styling (Shared) --- */
        .modal-overlay { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: #fff; padding: 20px 25px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 650px; width: 90%; position: relative; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-close-button { position: absolute; top: 8px; right: 12px; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; background: none; border: none; padding: 0;}
        .modal-close-button:hover { color: #333; }
        .modal-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .modal-body-content { flex-grow: 1; overflow-y: auto; padding-right: 5px; font-size: 0.9em; }

        /* --- Content Detail Modal Specific --- */
        #content-modal .modal-body-content div:not(.modal-actress-list-container):not(.modal-scenes-container) { margin-bottom: 7px; word-wrap: break-word; }
        #content-modal .modal-body-content strong { display: inline-block; min-width: 70px; color: #333; font-weight: bold;}
        #modal-link-container button { padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        #modal-link-container button:hover { background-color: #0056b3; }
        #content-modal .modal-body-content img.modal-detail-image { max-width: 90%; height: auto; max-height: 280px; margin-top: 5px; border-radius: 4px; display: block; margin-left: auto; margin-right: auto; margin-bottom: 12px; }
        #content-modal .modal-body-content img.modal-detail-image.movie-image { max-width: 220px; max-height: 220px; }
        #content-modal .modal-body-content .modal-year { font-size: 1em; color: #555; margin-bottom: 12px; }
        .modal-actress-list-container, .modal-scenes-container { margin-top: 15px; padding-top: 12px; border-top: 1px solid #eee; }
        .modal-actress-list-container h4, .modal-scenes-container h4 { margin-top: 0; margin-bottom: 10px; color: #333; font-size: 1em; }
        .modal-actress-list { display: flex; flex-wrap: wrap; gap: 12px; padding: 0; list-style: none; }
        .modal-actress-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s ease; max-width: 70px; }
        .modal-actress-item:hover { background-color: #f0f0f0; }
        .modal-actress-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; margin-bottom: 4px; }
        .modal-actress-item span { font-size: 0.8em; word-wrap: break-word; line-height: 1.1; max-width: 100%;}
        .modal-scene-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; }
        .modal-scene-card { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; overflow: hidden; text-align: center; font-size: 0.75em; }
        .modal-scene-card img { width: 100%; height: 70px; object-fit: cover; display: block; }
        .modal-scene-card .title { padding: 4px; min-height: 20px; display: flex; align-items: center; justify-content: center; line-height: 1.1; }

        /* --- Movable Actress Popup Styling --- */
        .actress-popup { position: fixed; background-color: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 1050; width: 200px; max-height: 300px; overflow: hidden; display: flex; flex-direction: column; cursor: grab; user-select: none; }
        .actress-popup.dragging { cursor: grabbing; opacity: 0.9; }
        .actress-popup-header { background-color: #f0f0f0; padding: 5px 8px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
        .actress-popup-header:active { cursor: grabbing; }
        .actress-popup-header h5 { margin: 0; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; padding-right: 5px; }
        .actress-popup-close, .actress-popup-compare-btn { font-weight: bold; color: #888; cursor: pointer; border: none; background: none; padding: 0 4px; line-height: 1; flex-shrink: 0; }
        .actress-popup-close { font-size: 1.1em; }
        .actress-popup-compare-btn { font-size: 0.9em; margin-right: 5px; }
        .actress-popup-close:hover, .actress-popup-compare-btn:hover { color: #333; }
        .actress-popup-body { padding: 8px; overflow-y: auto; font-size: 0.8em; flex-grow: 1; }
        .actress-popup-body img { width: 65px; height: 65px; object-fit: cover; border-radius: 50%; display: block; margin: 0 auto 8px auto; }
        .actress-popup-body div { margin-bottom: 4px; }
        .actress-popup-body strong { display: inline-block; min-width: 55px; color: #444; font-weight: bold; margin-right: 3px;}

        /* --- Comparison Modal --- */
        #comparison-modal .modal-content { max-width: 80vw; width: auto; }
        #comparison-modal-body { display: flex; gap: 10px; align-items: flex-start; overflow-x: auto; padding-bottom: 10px; min-height: 200px; flex-grow: 1; }
        .comparison-column { flex: 1; min-width: 180px; max-width: 220px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; display: flex; flex-direction: column; box-sizing: border-box; height: min-content; }
        .comparison-column .remove-compare-btn { position: absolute; top: 3px; right: 3px; background: rgba(255, 255, 255, 0.7); border: none; border-radius: 50%; color: #888; cursor: pointer; font-weight: bold; font-size: 14px; line-height: 16px; width: 18px; height: 18px; text-align: center; padding: 0; z-index: 1; }
        .comparison-column .remove-compare-btn:hover { color: #333; background: rgba(230, 230, 230, 0.9); }
        .comparison-column img { width: 100%; height: auto; max-height: 180px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; display: block; }
        .comparison-column h4 { font-size: 1em; margin: 0 0 8px 0; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; padding-right: 20px; word-wrap: break-word; }
        .comparison-column div { font-size: 0.85em; margin-bottom: 4px; word-wrap: break-word; }
        .comparison-column strong { display: inline-block; min-width: 50px; color: #333; font-weight: bold; margin-right: 3px; }
        #comparison-suggestions-list { display: none; position: absolute; width: 100%; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; max-height: 150px; overflow-y: auto; z-index: 1100; box-sizing: border-box; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #comparison-suggestions-list .suggestion-item { display: flex; padding: 5px 10px; color: #333; cursor: pointer; align-items: center; gap: 8px; font-size: 0.9em; }
        #comparison-suggestions-list .suggestion-item:hover { background-color: #f0f0f0; }
        #comparison-suggestions-list .suggestion-item.no-results { cursor: default; color: #888; justify-content: center; padding: 8px; }
        #comparison-suggestions-list .suggestion-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        #comparison-suggestions-list .suggestion-item.context-actress span { font-weight: bold; color: #0056b3; }

        /* --- Floating Action Button (FAB) & Menu --- */
        #fab-create { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background-color: #007bff; color: white; border: none; border-radius: 50%; font-size: 28px; line-height: 55px; text-align: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 1060; transition: background-color 0.2s ease, transform 0.1s ease; }
        #fab-create:hover { background-color: #0056b3; }
        #fab-create:active { transform: scale(0.95); }
        #create-menu-popup { position: fixed; bottom: 90px; right: 25px; background-color: #fff; border-radius: 6px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); padding: 8px 0; z-index: 1070; display: none; min-width: 160px; }
        .create-menu-button { display: block; background: none; border: none; color: #333; padding: 10px 15px; text-align: left; width: 100%; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
        .create-menu-button:hover { background-color: #f0f0f0; }

        /* --- Create Actress Modal Specific Styles (Copied & Scoped) --- */
        #create-actress-modal .modal-content {
            max-width: 1000px; /* Allow wider modal for the form */
            background-color: #242424; /* Dark background for the modal content area */
            color: #e0e0e0; /* Light text color */
        }
        #create-actress-modal .modal-content h3 {
            color: #fff; /* Header text color */
            border-bottom-color: #444; /* Darker border */
            text-align: center; /* Center header */
            margin-bottom: 30px; /* More space below header */
            font-weight: normal;
        }
        #create-actress-modal .modal-close-button {
            color: #aaa; /* Adjust close button color */
        }
        #create-actress-modal .modal-close-button:hover {
            color: #fff;
        }
        #create-actress-modal .modal-body-content {
            padding: 15px 25px; /* Restore some padding for the overall body */
            /* Ensure it can scroll if content overflows */
            max-height: calc(85vh - 100px); /* Adjust based on header/footer height */
            overflow-y: auto;
        }

        /* Form styles scoped to the modal */
        #create-actress-modal #create-actress-form {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 30px; /* Space before submit button container */
        }

        #create-actress-modal .form-card {
            background-color: #333;
            padding: 18px;
            border-radius: 8px;
            border: 1px solid #444;
            flex-basis: calc(50% - 8px); /* Default for two columns */
            flex-grow: 1;
            box-sizing: border-box;
            min-width: 250px; /* Minimum width for a card */
        }
        /* NEW: For Nota and Casta to be side-by-side */
        #create-actress-modal .form-row-flex {
            display: flex;
            flex-basis: 100%; /* Takes full width of the row */
            gap: 16px; /* Same gap as between form-cards */
        }
        #create-actress-modal .form-row-flex .form-card {
            flex-basis: calc(50% - 8px); /* Each card takes half of the row space minus gap */
            margin-bottom: 0; /* Remove bottom margin if they are part of a flex row */
        }


        #create-actress-modal .form-card.full-width {
            flex-basis: 100%;
        }

        #create-actress-modal label {
            display: block;
            margin-bottom: 10px;
            color: #b0b0b0;
            font-size: 0.9em;
            font-weight: bold;
        }

        #create-actress-modal input[type="text"],
        #create-actress-modal input[type="url"],
        #create-actress-modal input[type="number"],
        #create-actress-modal select, /* Added select */
        #create-actress-modal textarea {
            width: 100%;
            padding: 10px 12px;
            background-color: #404040;
            border: 1px solid #555;
            border-radius: 5px;
            color: #e0e0e0;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 0; /* Remove default margin if any */
        }
        #create-actress-modal select { /* Specific for select to make text readable */
             color: #e0e0e0;
        }
        #create-actress-modal select option {
            background-color: #404040;
            color: #e0e0e0;
        }


        #create-actress-modal textarea {
            min-height: 120px;
            resize: vertical;
        }

        #create-actress-modal input:focus,
        #create-actress-modal select:focus, /* Added select */
        #create-actress-modal textarea:focus {
           outline: none;
           border-color: #bb86fc; /* Highlight color */
           box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.3); /* Subtle glow */
        }

        /* Style for error messages inside the modal form */
        #create-actress-modal .error-message {
           color: #f44336; /* Material Design Red */
           font-size: 0.85em;
           display: block; /* Ensure it appears on its own line */
           margin-top: 5px; /* Add a little space above */
           min-height: 1.1em; /* Reserve space to prevent layout shifts */
           font-weight: bold;
        }
        #create-actress-modal .error-message.api-feedback { /* For API loading/error messages specifically */
            color: #b0b0b0; /* Lighter color for info */
            font-style: italic;
        }
        #create-actress-modal .error-message.api-feedback.error { /* If API feedback is an error */
            color: #f44336;
            font-style: normal;
        }

        #create-actress-modal .error-message:empty {
            min-height: 0; /* Collapse space if empty */
            margin-top: 0;
             display: none; /* Hide empty error messages */
        }


        /* Submit Button Container and Button Styles scoped to modal */
        #create-actress-modal .submit-button-container {
            text-align: center;
            margin-top: 10px; /* Add space above the button container */
            width: 100%; /* Ensure it spans the width */
        }
        #create-actress-modal button[type="submit"] {
            min-width: 200px;
            background-color: #bb86fc; /* Purple accent */
            color: #121212; /* Dark text on light button */
            padding: 14px 35px;
            border: none;
            border-radius: 6px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        #create-actress-modal button[type="submit"]:hover {
            background-color: #a772e3; /* Darker purple on hover */
        }
        #create-actress-modal button[type="submit"]:active {
            transform: scale(0.98);
        }
        #create-actress-modal button[type="submit"]:disabled {
           background-color: #555; /* Darker, less prominent background */
           color: #999; /* Greyed-out text */
           cursor: not-allowed; /* Indicate it's not clickable */
           transform: none; /* Prevent active state transform */
        }
        /* --- END: Create Actress Modal Specific Styles --- */


        /* --- Paste Text Modal Styles --- */
        #paste-text-modal .modal-content { max-width: 700px; }
        #paste-text-area { width: 100%; min-height: 250px; resize: vertical; font-family: monospace; font-size: 0.9em; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 15px; }
        #paste-analysis-result { font-size: 0.9em; margin-top: 10px; min-height: 1.5em; }
        #paste-analysis-result.error { color: #a00; font-weight: bold; }
        #paste-analysis-result.info { color: #333; }
        #analyze-paste-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        #analyze-paste-button:hover { background-color: #0056b3; }
        #analyze-paste-button:disabled { background-color: #aaa; cursor: not-allowed; }

        /* --- Create Scene/Movie/Video Modal Styles --- */
        #create-scene-modal .modal-content,
        #create-movie-modal .modal-content,
        #create-video-modal .modal-content { max-width: 850px; }
        #create-scene-modal .modal-body-content,
        #create-movie-modal .modal-body-content,
        #create-video-modal .modal-body-content { font-size: 1em; }
        .create-form { display: flex; flex-wrap: wrap; gap: 15px 20px; }
        .form-group { margin-bottom: 10px; flex: 1 1 calc(50% - 10px); box-sizing: border-box; min-width: 200px; }
        .form-group.full-width { flex-basis: 100%; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 0.9em; }
        .form-group input[type="text"], .form-group input[type="url"], .form-group input[type="number"], .form-group input[type="date"] { width: 100%; padding: 9px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.95em; }
        .form-group input:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); }
        .form-group .info-display { font-size: 0.9em; color: #555; margin-top: 5px; min-height: 1.5em; }
        .form-group .info-display.loading { font-style: italic; color: #888; }
        .form-group .info-display.not-found { color: #a00; }
        .form-group .info-display.found { color: #007bff; font-weight: bold; }
        .submit-button-container { flex-basis: 100%; text-align: right; margin-top: 20px; }
        .submit-button-container button[type="submit"] { padding: 12px 25px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease; }
        .submit-button-container button[type="submit"]:hover { background-color: #218838; }
        .submit-button-container button[type="submit"]:disabled { background-color: #aaa; cursor: not-allowed; }
        .form-group .error-message { color: #dc3545; font-size: 0.8em; margin-top: 4px; min-height: 1em; }
        .form-group .error-message:empty { min-height: 0; margin-top: 0; }


        /* --- Actor Selectors (Scene & Video) --- */
        #scene-actors-selector, #video-actors-selector { position: relative; }
        #scene-actors-search-input-wrapper, #video-actors-search-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: text; min-height: 32px; }
        #scene-actors-search-input-wrapper:focus-within, #video-actors-search-input-wrapper:focus-within { border-color: #80bdff; box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); }
        #scene-selected-actors, #video-selected-actors { display: contents; }
        .scene-actor-pill, .video-actor-pill { display: inline-flex; align-items: center; background-color: #007bff; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin: 1px; white-space: nowrap; }
        .scene-actor-pill span, .video-actor-pill span { margin-right: 4px; }
        .scene-remove-actor-btn, .video-remove-actor-btn { background: none; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 1em; padding: 0 2px; line-height: 1; opacity: 0.8; }
        .scene-remove-actor-btn:hover, .video-remove-actor-btn:hover { opacity: 1; }
        #scene-actors-search-input, #video-actors-search-input { flex-grow: 1; padding: 4px 5px; border: none; background-color: transparent; color: #333; font-size: 0.9em; min-width: 100px; outline: none; }
        #scene-actors-suggestions-list, #video-actors-suggestions-list { display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; }
        #scene-actors-suggestions-list .suggestion-item, #video-actors-suggestions-list .suggestion-item { display: flex; padding: 5px 10px; color: #333; cursor: pointer; align-items: center; gap: 8px; font-size: 0.9em; }
        #scene-actors-suggestions-list .suggestion-item:hover, #video-actors-suggestions-list .suggestion-item:hover { background-color: #f0f0f0; }
        #scene-actors-suggestions-list .suggestion-item.no-results, #video-actors-suggestions-list .suggestion-item.no-results { cursor: default; color: #888; justify-content: center; padding: 8px; }
        #scene-actors-suggestions-list .suggestion-item img, #video-actors-suggestions-list .suggestion-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }

        /* --- Statistics Modal Styles --- */
        #stats-modal .modal-content { max-width: 90vw; max-height: 85vh; }
        #stats-options-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .stats-option-btn { padding: 6px 12px; border: 1px solid #ccc; background-color: #eee; color: #333; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .stats-option-btn:hover { background-color: #ddd; }
        #stats-results-container { margin-top: 10px; max-height: calc(85vh - 200px); overflow-y: auto; font-size: 0.9em; }
        #stats-results-container h4 { margin-top: 0; margin-bottom: 10px; }
        #stats-results-container table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: auto; }
        #stats-results-container th, #stats-results-container td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; vertical-align: middle; font-size: 0.85em; word-wrap: break-word; }
        #stats-results-container th { background-color: #f2f2f2; font-weight: bold; white-space: nowrap; }
        #stats-results-container td img { max-width: 40px; max-height: 40px; height: auto; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto; }
        #stats-results-container .loading-stats { text-align: center; padding: 20px; color: #555; font-style: italic; }
        #stats-results-container th.sortable { cursor: pointer; position: relative; padding-right: 20px; }
        #stats-results-container th.sortable::after { content: ''; position: absolute; right: 8px; top: 50%; margin-top: -6px; border-left: 4px solid transparent; border-right: 4px solid transparent; border-bottom: 5px solid #aaa; opacity: 0.4; }
        #stats-results-container th.sortable.sort-asc::after { border-bottom: none; border-top: 5px solid #333; opacity: 1; }
        #stats-results-container th.sortable.sort-desc::after { border-top: none; border-bottom: 5px solid #333; opacity: 1; }
        #stats-results-container ul { list-style: disc; padding-left: 25px; }
        #stats-results-container li { margin-bottom: 5px; }

        /* --- Filter Modal Styles --- */
        #filter-modal .modal-content { max-width: 650px; }
        #filter-modal-body { max-height: calc(85vh - 150px); overflow-y: auto; padding: 5px 15px; }
        #actress-filter-form .filter-section { margin-bottom: 18px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        #actress-filter-form .filter-section:last-of-type { border-bottom: none; margin-bottom: 5px; }
        #actress-filter-form h4 { font-size: 1em; color: #333; margin-top: 0; margin-bottom: 12px; }
        #actress-filter-form .form-group { margin-bottom: 10px; } /* Reusing form-group from other modals */
        #actress-filter-form label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #555; }
        #actress-filter-form select, #actress-filter-form input[type="number"] { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.95em; -moz-appearance: textfield; }
        #actress-filter-form input[type="number"]::-webkit-outer-spin-button, #actress-filter-form input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #actress-filter-form .range-group label { margin-bottom: 8px; }
        #actress-filter-form .range-inputs { display: flex; align-items: center; gap: 8px; }
        #actress-filter-form .range-inputs input[type="number"] { flex: 1; text-align: center; }
        #actress-filter-form .range-inputs span { font-weight: bold; color: #555; }
        .filter-actions { margin-top: 20px; text-align: right; padding-top: 15px; border-top: 1px solid #eee; }
        .filter-actions button { padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95em; margin-left: 10px; }
        #apply-filters-btn { background-color: #007bff; color: white; }
        #apply-filters-btn:hover { background-color: #0056b3; }
        #clear-filters-btn { background-color: #6c757d; color: white; }
        #clear-filters-btn:hover { background-color: #5a6268; }


        /* General Loading/Error Styles */
        .loading { padding: 10px; text-align: center; color: #555; font-style: italic; }
        .error { padding: 10px; text-align: center; color: #a00; font-weight: bold; }


                /* --- Measurement Cards Styling (Middle Column) --- */
                .measurement-cards-container {
            display: flex;
            justify-content: space-around; /* Distribute space */
            gap: 8px; /* Space between cards */
            margin: 15px 0; /* Space above and below the card row */
            width: 100%; /* Take full width */
        }

        .measurement-card {
            background-color: #f0f8ff; /* Light blue background */
            border: 1px solid #cce0ff; /* Lighter blue border */
            border-radius: 6px;
            padding: 10px 8px;
            text-align: center;
            flex: 1; /* Allow cards to grow and shrink */
            min-width: 60px; /* Prevent cards from becoming too narrow */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .measurement-card .label {
            display: block;
            font-size: 0.8em;
            color: #555;
            margin-bottom: 4px;
            font-weight: bold;
            text-transform: uppercase; /* Optional: Make labels uppercase */
        }

        .measurement-card .value {
            display: block;
            font-size: 1.2em; /* Larger font for the value */
            font-weight: bold;
            color: #0056b3; /* Darker blue for value */
            line-height: 1.1;
        }
        /* --- END: Measurement Cards Styling --- */

    </style>
</head>
<body>
    <div class="container" id="main-container">
        <!-- Left Column: Actress List -->
        <div class="column" id="actress-list-col">
            <h2>Atrizes</h2>
            <ul id="actress-list">
                <li class="loading">Carregando...</li>
            </ul>
            <!-- Controls Container -->
            <div id="actress-list-controls">
                <input type="text" id="actress-search-input" placeholder="Buscar na lista...">
                <button id="actress-filter-btn" title="Filtrar lista">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel-fill" viewBox="0 0 16 16">
                        <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.74.439L7 12.439V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5z"/>
                    </svg>
                </button>
                <button id="actress-stats-btn" title="Estatísticas da lista">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-line-fill" viewBox="0 0 16 16">
                        <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1z"/>
                    </svg>
                </button>
            </div>
        </div>
        <!-- Middle Column: Actress Details -->
        <div class="column" id="actress-detail-col">
            <h2>Detalhes da Atriz</h2>
            <div id="actress-details"></div>
        </div>
        <!-- Right Column: Related Content -->
        <div class="column" id="content-col">
            <div id="content-col-header">
                <div class="related-filter-buttons">
                    <button class="related-filter-btn active" data-filter="all">Todos</button>
                    <button class="related-filter-btn" data-filter="video">Vídeos</button>
                    <button class="related-filter-btn" data-filter="film">Filmes</button>
                    <button class="related-filter-btn" data-filter="scene">Cenas</button>
                    <button class="related-filter-btn" data-filter="similar">Semelhantes</button>
                    <button class="related-filter-btn" data-filter="rank">Rank</button> <!-- NEW BUTTON -->
                </div>
                <div class="related-actress-search-area">
                    <div class="related-search-input-wrapper">
                        <div id="related-selected-actresses"></div>
                        <input type="text" id="related-search-input" class="related-search-input" placeholder="Filtrar por co-atriz...">
                    </div>
                    <div id="related-suggestions-list"></div>
                </div>
            </div>
            <h2 class="related-title">Conteúdo Relacionado</h2>
            <!-- Container for Cards OR Table OR Rank Display -->
            <div id="content-cards" style="overflow-y: auto; flex-grow: 1;"></div>
            <div id="similar-actresses-table-container" style="display: none; overflow-y: auto; flex-grow: 1;">
                 <!-- Table for similar actresses will be built here by JS -->
            </div>
            <div id="rank-display-area" style="display: none; flex-direction: column; gap: 15px; overflow-y: auto; flex-grow: 1; padding: 10px;">
                <!-- Rank summary cards will be built here by JS -->
            </div>
            <div id="content-message" style="display: none; grid-column: 1 / -1;"></div>
        </div>
    </div>

     <!-- Main Modal Structure (for Content Details) -->
    <div id="content-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal()">×</button>
            <h3 id="modal-title">Detalhes</h3>
            <div class="modal-body-content"></div>
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 15px;"> <div id="modal-link-container"></div> </div>
        </div>
    </div>

    <!-- Create Video Modal Structure -->
    <div id="create-video-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeCreateVideoModal()">×</button>
            <h3>Criar Novo Vídeo</h3>
            <div class="modal-body-content">
                 <form id="create-video-form" class="create-form" novalidate>
                    <div class="form-group full-width">
                        <label for="video-nome">Nome do Vídeo:</label>
                        <input type="text" id="video-nome" name="video-nome" required>
                        <span class="error-message" id="video-nome-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="video-estudio">Estúdio:</label>
                        <input type="text" id="video-estudio" name="video-estudio">
                    </div>
                    <div class="form-group">
                        <label for="video-data">Data (YYYY/MM/DD):</label>
                        <input type="text" id="video-data" name="video-data" placeholder="YYYY/MM/DD">
                         <span class="error-message" id="video-data-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="video-imagem">Imagem (URL):</label>
                        <input type="url" id="video-imagem" name="video-imagem" placeholder="https://exemplo.com/imagem_video.jpg">
                        <span class="error-message" id="video-imagem-error"></span>
                    </div>
                     <div class="form-group">
                        <label for="video-pagina">Página Externa (URL):</label>
                        <input type="url" id="video-pagina" name="video-pagina" placeholder="https://link_externo.com/video">
                         <span class="error-message" id="video-pagina-error"></span>
                    </div>
                    <div class="form-group full-width">
                        <label>Atores:</label>
                        <div id="video-actors-selector">
                            <div id="video-actors-search-input-wrapper">
                                <div id="video-selected-actors"></div>
                                <input type="text" id="video-actors-search-input" placeholder="Buscar atriz para adicionar...">
                            </div>
                            <div id="video-actors-suggestions-list"></div>
                        </div>
                        <span class="error-message" id="video-atores-error"></span>
                    </div>
                    <div class="submit-button-container">
                         <div id="create-video-form-message" class="error-message" style="text-align: left; margin-bottom: 10px;"></div>
                         <button type="submit" id="create-video-submit-button">Salvar Vídeo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Comparison Modal Structure -->
    <div id="comparison-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeComparisonModal()">×</button>
            <h3 id="comparison-modal-title">Comparar Atrizes</h3>
            <div class="comparison-search-area" style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; position: relative;">
                 <input type="text" id="comparison-search-input" placeholder="Buscar atriz para comparar..." style="width: 100%; padding: 8px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                 <div id="comparison-suggestions-list"></div>
            </div>
            <div id="comparison-modal-body"> <div id="comparison-placeholder" style="width: 100%; text-align: center; color: #888; padding-top: 20px;">Selecione atrizes na busca acima para comparar.</div> </div>
        </div>
    </div>

    <!-- Create Actress Modal Structure -->
    <div id="create-actress-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeCreateActressModal()">×</button>
            <h3>Criar Nova Atriz</h3>
             <!-- Body content will be filled by JS -->
            <div class="modal-body-content" id="create-actress-modal-body">
                <div class="loading">Carregando formulário...</div>
            </div>
        </div>
    </div>

    <!-- Paste Text Modal Structure -->
    <div id="paste-text-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closePasteTextModal()">×</button>
            <h3>Analisar Texto para Criar Multimídia</h3>
            <div class="modal-body-content">
                <p style="font-size: 0.9em; color: #555; margin-top: 0;">Cole o texto abaixo. O sistema tentará identificar se é uma Cena ou Filme e extrair os dados iniciais.</p>
                <textarea id="paste-text-area" placeholder="Cole aqui o texto começando com 'Scene:' ou 'Movie:'..."></textarea>
                <div id="paste-analysis-result"></div>
            </div>
            <div style="text-align: right; margin-top: 15px;">
                <button id="analyze-paste-button">Analisar e Criar</button>
            </div>
        </div>
    </div>

    <!-- Create Scene Modal Structure -->
    <div id="create-scene-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeCreateSceneModal()">×</button>
            <h3>Criar Nova Cena</h3>
            <div class="modal-body-content">
                <form id="create-scene-form" class="create-form" novalidate>
                    <input type="hidden" id="scene-filme-id" name="scene-filme-id">
                    <div class="form-group full-width">
                        <label for="scene-nome">Nome da Cena:</label>
                        <input type="text" id="scene-nome" name="scene-nome" required>
                        <span class="error-message" id="scene-nome-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="scene-data">Data (YYYY/MM/DD):</label>
                        <input type="text" id="scene-data" name="scene-data" placeholder="YYYY/MM/DD">
                         <span class="error-message" id="scene-data-error"></span>
                    </div>
                     <div class="form-group">
                        <label for="scene-numero">Número da Cena:</label>
                        <input type="number" id="scene-numero" name="scene-numero" min="1">
                    </div>
                     <div class="form-group">
                        <label>Filme Associado:</label>
                        <div id="scene-movie-display" class="info-display loading">Procurando filme...</div>
                         <span class="error-message" id="scene-filme-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="scene-imagem">Imagem (URL):</label>
                        <input type="url" id="scene-imagem" name="scene-imagem" placeholder="https://exemplo.com/imagem_cena.jpg">
                         <span class="error-message" id="scene-imagem-error"></span>
                    </div>
                     <div class="form-group">
                        <label for="scene-pagina">Página Externa (URL):</label>
                        <input type="url" id="scene-pagina" name="scene-pagina" placeholder="https://link_externo.com/cena">
                         <span class="error-message" id="scene-pagina-error"></span>
                    </div>
                    <div class="form-group full-width">
                        <label>Atores:</label>
                        <div id="scene-actors-selector">
                            <div id="scene-actors-search-input-wrapper">
                                <div id="scene-selected-actors"></div>
                                <input type="text" id="scene-actors-search-input" placeholder="Buscar atriz para adicionar...">
                            </div>
                            <div id="scene-actors-suggestions-list"></div>
                        </div>
                        <span class="error-message" id="scene-atores-error"></span>
                    </div>
                    <div class="submit-button-container">
                         <div id="create-scene-form-message" class="error-message" style="text-align: left; margin-bottom: 10px;"></div>
                         <button type="submit" id="create-scene-submit-button">Salvar Cena</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Movie Modal Structure -->
    <div id="create-movie-modal" class="modal-overlay">
         <div class="modal-content">
            <button class="modal-close-button" onclick="closeCreateMovieModal()">×</button>
            <h3>Criar Novo Filme</h3>
            <div class="modal-body-content">
                 <form id="create-movie-form" class="create-form" novalidate>
                    <div class="form-group full-width">
                        <label for="movie-nome">Nome do Filme:</label>
                        <input type="text" id="movie-nome" name="movie-nome" required>
                        <span class="error-message" id="movie-nome-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movie-ano">Ano de Lançamento:</label>
                        <input type="number" id="movie-ano" name="movie-ano" placeholder="YYYY">
                        <span class="error-message" id="movie-ano-error"></span>
                    </div>
                     <div class="form-group">
                        <label for="movie-estudio">Estúdio:</label>
                        <input type="text" id="movie-estudio" name="movie-estudio">
                    </div>
                     <div class="form-group">
                        <label for="movie-duracao">Duração:</label>
                        <input type="text" id="movie-duracao" name="movie-duracao" placeholder="HH:MM:SS">
                    </div>
                    <div class="form-group">
                        <label for="movie-imagem">Imagem (URL):</label>
                        <input type="url" id="movie-imagem" name="movie-imagem" placeholder="https://exemplo.com/imagem_filme.jpg">
                         <span class="error-message" id="movie-imagem-error"></span>
                    </div>
                     <div class="form-group">
                        <label for="movie-pagina">Página Externa (URL):</label>
                        <input type="url" id="movie-pagina" name="movie-pagina" placeholder="https://link_externo.com/filme">
                         <span class="error-message" id="movie-pagina-error"></span>
                    </div>
                    <div class="form-group full-width">
                         <label>Cenas:</label>
                         <div class="info-display">Cenas serão associadas posteriormente ou automaticamente se já existirem.</div>
                    </div>
                    <div class="submit-button-container">
                         <div id="create-movie-form-message" class="error-message" style="text-align: left; margin-bottom: 10px;"></div>
                        <button type="submit" id="create-movie-submit-button">Salvar Filme</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

     <!-- Statistics Modal Structure -->
    <div id="stats-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeStatsModal()">×</button>
            <h3>Estatísticas das Atrizes</h3>
            <div class="modal-body-content">
                <div id="stats-options-container">
                    <button class="stats-option-btn" data-stat="full-list">Lista Completa</button>
                    <button class="stats-option-btn" data-stat="shortest">Mais Baixas</button>
                    <button class="stats-option-btn" data-stat="youngest">Mais Novas</button>
                    <button class="stats-option-btn" data-stat="rating">Por Nota</button>
                    <button class="stats-option-btn" data-stat="hair-color">Cores de Cabelo (Únicas)</button>
                    <button class="stats-option-btn" data-stat="eye-color">Cores de Olhos (Únicas)</button>
                    <button class="stats-option-btn" data-stat="height-avg">Média de Alturas</button>
                    <button class="stats-option-btn" data-stat="age-avg">Média de Idades</button>
                    <button class="stats-option-btn" data-stat="countries">Contagem por País</button>
                    <button class="stats-option-btn" data-stat="country-rating-avg">Nota Média por País</button>
                </div>
                <div id="stats-results-container">
                    <p>Selecione uma opção acima para ver as estatísticas.</p>
                </div>
            </div>
        </div>
    </div>

     <!-- Filter Modal Structure -->
    <div id="filter-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeFilterModal()">×</button>
            <h3>Filtrar Atrizes</h3>
            <div class="modal-body-content" id="filter-modal-body">
                <form id="actress-filter-form">
                    <div class="filter-section">
                        <h4>Localização</h4>
                        <div class="form-group">
                            <label for="filter-nationality">Nacionalidade:</label>
                            <select id="filter-nationality" name="nationality">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-section">
                        <h4>Características</h4>
                        <div class="form-group">
                            <label for="filter-ethnicity">Etnia:</label>
                            <select id="filter-ethnicity" name="ethnicity">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-section">
                        <h4>Físico</h4>
                        <div class="form-group range-group">
                            <label>Altura (cm):</label>
                            <div class="range-inputs">
                                <input type="number" id="filter-height-min" name="height_min" placeholder="Min">
                                <span>-</span>
                                <input type="number" id="filter-height-max" name="height_max" placeholder="Max">
                            </div>
                        </div>
                        <div class="form-group range-group">
                            <label>Peso (kg):</label>
                             <div class="range-inputs">
                                <input type="number" id="filter-weight-min" name="weight_min" placeholder="Min">
                                <span>-</span>
                                <input type="number" id="filter-weight-max" name="weight_max" placeholder="Max">
                            </div>
                        </div>
                    </div>
                     <div class="filter-section">
                        <h4>Outros</h4>
                         <div class="form-group range-group">
                            <label>Idade:</label>
                            <div class="range-inputs">
                                <input type="number" id="filter-age-min" name="age_min" placeholder="Min">
                                <span>-</span>
                                <input type="number" id="filter-age-max" name="age_max" placeholder="Max">
                            </div>
                        </div>
                        <div class="form-group range-group">
                            <label>Nota:</label>
                            <div class="range-inputs">
                                <input type="number" step="0.1" id="filter-rating-min" name="rating_min" placeholder="Min (0.0)">
                                <span>-</span>
                                <input type="number" step="0.1" id="filter-rating-max" name="rating_max" placeholder="Max (10.0)">
                            </div>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button type="button" id="apply-filters-btn">Aplicar Filtros</button>
                        <button type="button" id="clear-filters-btn">Limpar Filtros</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Template for Movable Actress Popups -->
    <div id="actress-popup-template" class="actress-popup" style="display: none;">
        <div class="actress-popup-header"> <h5>Nome Atriz</h5> <button class="actress-popup-compare-btn" title="Comparar Atrizes">🧪</button> <button class="actress-popup-close">×</button> </div>
        <div class="actress-popup-body"></div>
    </div>

    <!-- Floating Action Button -->
    <button id="fab-create" title="Criar Novo Item">+</button>

    <!-- Create Menu Popup -->
    <div id="create-menu-popup">
        <button class="create-menu-button" id="menu-create-actress">Criar Atriz</button>
        <button class="create-menu-button" id="menu-create-multimedia">Criar Multimídia</button>
    </div>

    <!-- Ranking Detail Modal (NEW) -->
    <div id="ranking-detail-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 750px;"> <!-- Wider for table -->
            <button class="modal-close-button" onclick="closeRankingDetailModal()">×</button>
            <h3 id="ranking-modal-title">Detalhes do Ranking</h3>
            <div class="modal-body-content" id="ranking-modal-table-container">
                <div class="loading">Carregando ranking...</div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->

    <script type="module">
        // --- Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import {
            getFirestore, collection, getDocs, doc, getDoc, addDoc, documentId,
            query, where, limit, serverTimestamp, updateDoc, arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
           apiKey: "AIzaSyBZEffPMXgbSHYUUrNdIS5duAVGlKlmSq0", // Replace with your actual API key if needed, but this seems to be public example data
           authDomain: "babes-392fd.firebaseapp.com",
           projectId: "babes-392fd",
           storageBucket: "babes-392fd.appspot.com",
           messagingSenderId: "376795361631",
           appId: "1:376795361631:web:d662f2b2f2cd23b115c6ea"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const mainContainer = document.getElementById('main-container');
        const actressListUl = document.getElementById('actress-list');
        const actressDetailsContainer = document.getElementById('actress-details');
        const contentCardsContainer = document.getElementById('content-cards');
        const similarActressesTableContainer = document.getElementById('similar-actresses-table-container'); // NEW
        const rankDisplayArea = document.getElementById('rank-display-area'); // NEW
        const relatedTitleElement = document.querySelector('#content-col h2.related-title'); // NEW
        const contentMessage = document.getElementById('content-message');
        const contentModal = document.getElementById('content-modal');
        const contentModalBody = contentModal?.querySelector('.modal-body-content');
        const contentModalTitle = document.getElementById('modal-title');
        const modalLinkContainer = document.getElementById('modal-link-container');
        const comparisonModal = document.getElementById('comparison-modal');
        const comparisonModalBody = document.getElementById('comparison-modal-body');
        const comparisonSearchInput = document.getElementById('comparison-search-input');
        const comparisonSuggestionsList = document.getElementById('comparison-suggestions-list');
        const comparisonPlaceholder = document.getElementById('comparison-placeholder');
        const createActressModal = document.getElementById('create-actress-modal');
        const createActressModalBody = document.getElementById('create-actress-modal-body');
        const relatedFilterButtonsContainer = document.querySelector('.related-filter-buttons');
        const relatedSearchInput = document.getElementById('related-search-input');
        const relatedSuggestionsList = document.getElementById('related-suggestions-list');
        const relatedSelectedActressesContainer = document.getElementById('related-selected-actresses');
        const relatedSearchInputWrapper = document.querySelector('.related-search-input-wrapper');
        const fabCreate = document.getElementById('fab-create');
        const createMenuPopup = document.getElementById('create-menu-popup');
        const menuCreateActressBtn = document.getElementById('menu-create-actress');
        const menuCreateMultimediaBtn = document.getElementById('menu-create-multimedia');
        const actressSearchInput = document.getElementById('actress-search-input');
        const actressFilterBtn = document.getElementById('actress-filter-btn');
        const actressStatsBtn = document.getElementById('actress-stats-btn');
        const pasteTextModal = document.getElementById('paste-text-modal');
        const pasteTextArea = document.getElementById('paste-text-area');
        const pasteAnalysisResult = document.getElementById('paste-analysis-result');
        const analyzePasteButton = document.getElementById('analyze-paste-button');
        const createSceneModal = document.getElementById('create-scene-modal');
        const createSceneForm = document.getElementById('create-scene-form');
        const sceneNomeInput = document.getElementById('scene-nome');
        const sceneDataInput = document.getElementById('scene-data');
        const sceneNumeroInput = document.getElementById('scene-numero');
        const sceneMovieDisplay = document.getElementById('scene-movie-display');
        const sceneFilmeIdInput = document.getElementById('scene-filme-id');
        const sceneImagemInput = document.getElementById('scene-imagem');
        const scenePaginaInput = document.getElementById('scene-pagina');
        const sceneActorsSelector = document.getElementById('scene-actors-selector');
        const sceneSelectedActorsContainer = document.getElementById('scene-selected-actors');
        const sceneActorsSearchInput = document.getElementById('scene-actors-search-input');
        const sceneActorsSuggestionsList = document.getElementById('scene-actors-suggestions-list');
        const createSceneSubmitButton = document.getElementById('create-scene-submit-button');
        const createSceneFormMessage = document.getElementById('create-scene-form-message');
        const createMovieModal = document.getElementById('create-movie-modal');
        const createMovieForm = document.getElementById('create-movie-form');
        const movieNomeInput = document.getElementById('movie-nome');
        const movieAnoInput = document.getElementById('movie-ano');
        const movieEstudioInput = document.getElementById('movie-estudio');
        const movieDuracaoInput = document.getElementById('movie-duracao');
        const movieImagemInput = document.getElementById('movie-imagem');
        const moviePaginaInput = document.getElementById('movie-pagina');
        const createMovieSubmitButton = document.getElementById('create-movie-submit-button');
        const createMovieFormMessage = document.getElementById('create-movie-form-message');
        const statsModal = document.getElementById('stats-modal');
        const statsOptionsContainer = document.getElementById('stats-options-container');
        const statsResultsContainer = document.getElementById('stats-results-container');
        const filterModal = document.getElementById('filter-modal');
        const filterForm = document.getElementById('actress-filter-form');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const filterNationalitySelect = document.getElementById('filter-nationality');
        const filterEthnicitySelect = document.getElementById('filter-ethnicity');
        const createVideoModal = document.getElementById('create-video-modal');
        const createVideoForm = document.getElementById('create-video-form');
        const videoNomeInput = document.getElementById('video-nome');
        const videoEstudioInput = document.getElementById('video-estudio');
        const videoDataInput = document.getElementById('video-data');
        const videoImagemInput = document.getElementById('video-imagem');
        const videoPaginaInput = document.getElementById('video-pagina');
        const videoActorsSelector = document.getElementById('video-actors-selector');
        const videoSelectedActorsContainer = document.getElementById('video-selected-actors');
        const videoActorsSearchInput = document.getElementById('video-actors-search-input');
        const videoActorsSuggestionsList = document.getElementById('video-actors-suggestions-list');
        const createVideoSubmitButton = document.getElementById('create-video-submit-button');
        const createVideoFormMessage = document.getElementById('create-video-form-message');
        const rankingDetailModal = document.getElementById('ranking-detail-modal'); // NEW
        const rankingModalTitle = document.getElementById('ranking-modal-title'); // NEW
        const rankingModalTableContainer = document.getElementById('ranking-modal-table-container'); // NEW


       // --- State Variables ---
       let selectedMainActressElement = null;
        let currentMainActressId = null;
        let allActressesData = [];
        let allRelatedContent = [];
        let filteredRelatedContent = [];
        let selectedRelatedActresses = [];
        let activeRelatedFilter = 'all';
        let allScenesCache = new Map();
        let popupsOpen = 0;
        let actressesToCompare = [];
        let comparisonContextActressIds = [];
        let selectedSceneActors = [];
        let selectedVideoActors = [];
        let activeActressFilters = {};

        // --- Create Actress Modal Element Variables (initialized in openCreateActressModal) ---
        let createActressForm = null;
        let actressNameInput = null;
        let actressNameErrorMessage = null;
        let actressSubmitButton = null;
        let debouncedActressNameCheck = null;
        let debouncedFetchApiData = null;

        // --- Firestore Field Mapping for Create Actress ---
        const firestoreFieldMap = {
            'name': 'nome', 'foto': 'foto', 'born': 'dataNascimento',
            'birthplace': 'pais', 'ethnicity': 'etnia', 'hair_color': 'corCabelo',
            'eye_color': 'corOlhos', 'height': 'altura', 'weight': 'peso',
            'body_type': 'tipoCorpo', 'measurements': 'medidas',
            'years_active': 'AnosAtiva', 'nota': 'nota', 'casta': 'casta',
            'overall': 'overall'
        };

         // --- Helper Functions ---
         function calculateAge(birthDateString) { if (!birthDateString) return '?'; try { const birthDate = new Date(birthDateString); const today = new Date(); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; } return age > 0 ? age : '?'; } catch (e) { return '?'; } }
        function displayMessage(element, message, isError = false) { if (!element) return; element.innerHTML = `<div class="${isError ? 'error' : 'loading'}">${message}</div>`; element.style.display = 'block'; }
        function clearMessage(element) { if (!element) return; element.innerHTML = ''; element.style.display = 'none'; }
        function capitalizeFirstLetter(string) { return string ? string.charAt(0).toUpperCase() + string.slice(1) : ''; }
        function debounce(func, delay) { let timeoutId; return function(...args) { clearTimeout(timeoutId); timeoutId = setTimeout(() => { func.apply(this, args); }, delay); }; }


        function formatDateString(dateString) {
            if (!dateString) return '';
            try {
                 const simpleDateRegex = /^(\d{4})[/-](\d{1,2})[/-](\d{1,2})$/;
                 const simpleMatch = dateString.match(simpleDateRegex);
                 if (simpleMatch) {
                    const year = parseInt(simpleMatch[1]); const month = parseInt(simpleMatch[2]); const day = parseInt(simpleMatch[3]);
                    if (year > 1000 && month >= 1 && month <= 12 && day >= 1 && day <= 31) { return `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`; }
                 }
                 const dateRegex = /(\d{1,2})(?:st|nd|rd|th)?\s+(?:of\s+)?([a-zA-Z]+)\s+(\d{4})/;
                 const match = dateString.match(dateRegex);
                 if (match) {
                     const day = match[1].padStart(2, '0'); const monthName = match[2]; const year = match[3];
                     const monthMap = {'january': '01', 'february': '02', 'march': '03', 'april': '04', 'may': '05', 'june': '06', 'july': '07', 'august': '08', 'september': '09', 'october': '10', 'november': '11', 'december': '12'};
                     const monthNumber = monthMap[monthName.toLowerCase()];
                     if (monthNumber && parseInt(year) > 1000) return `${year}/${monthNumber}/${day}`;
                 }
                 const monthDayYearRegex = /([a-zA-Z]+)\s+(\d{1,2})(?:st|nd|rd|th)?,\s+(\d{4})/;
                 const mdYMatch = dateString.match(monthDayYearRegex);
                 if (mdYMatch) {
                     const monthName = mdYMatch[1]; const day = mdYMatch[2].padStart(2, '0'); const year = mdYMatch[3];
                     const monthMap = {'january': '01', 'february': '02', 'march': '03', 'april': '04', 'may': '05', 'june': '06', 'july': '07', 'august': '08', 'september': '09', 'october': '10', 'november': '11', 'december': '12'};
                     const monthNumber = monthMap[monthName.toLowerCase()];
                     if (monthNumber && parseInt(year) > 1000) return `${year}/${monthNumber}/${day}`;
                 }
                 const monthYearRegex = /([a-zA-Z]+)\s+(\d{4})/;
                 const monthYearMatch = dateString.match(monthYearRegex);
                 if (monthYearMatch) {
                     const monthName = monthYearMatch[1]; const year = monthYearMatch[2];
                     const monthMap = {'january': '01', 'february': '02', 'march': '03', 'april': '04', 'may': '05', 'june': '06', 'july': '07', 'august': '08', 'september': '09', 'october': '10', 'november': '11', 'december': '12'};
                     const monthNumber = monthMap[monthName.toLowerCase()];
                     if (monthNumber && parseInt(year) > 1000) return `${year}/${monthNumber}/01`;
                 }
            } catch (e) { console.error("Erro ao formatar data:", dateString, e); }
            return dateString;
        }

        function clearFormMessages(messageElements) {
            if (!Array.isArray(messageElements)) return;
            messageElements.forEach(el => { if (el && typeof el.textContent !== 'undefined') { el.textContent = ''; el.style.display='none'; } });
        }
        function parseDateStringForSort(dateInput) { /* ... (no change) ... */ return null;}
        function getItemTimestampForSort(item) { /* ... (no change) ... */ return null;}
        function safeParseInt(value) {
            if (value === null || value === undefined || String(value).trim() === '') return null;
            const parsed = parseInt(value, 10);
            return isNaN(parsed) ? null : parsed;
        }
        function safeParseFloat(value) {
            if (value === null || value === undefined || String(value).trim() === '') return null;
            const parsed = parseFloat(value);
            return isNaN(parsed) ? null : parsed;
        }
        function safeStringCompare(strA, strB) { /* ... (no change) ... */ return false;}


        // --- Create Actress Specific Helper Functions (from criar.html logic) ---
            // --- Create Actress Specific Helper Functions ---
            async function checkNameExists() {
            if (!actressNameInput || !actressNameErrorMessage || !db) { console.warn("checkNameExists: Required elements/DB missing."); return; }
            const enteredName = actressNameInput.value.trim();
            if (!actressNameErrorMessage.classList.contains('api-feedback')) { // Don't clear API messages
                actressNameErrorMessage.textContent = '';
                actressNameErrorMessage.style.display = 'none';
                actressNameErrorMessage.classList.remove('error');
            }
            let shouldBeDisabled = false;
            if (enteredName === '') {
                 if (actressSubmitButton) actressSubmitButton.disabled = false; // Enable if cleared
                return;
            }

            try {
                const checkQuery = query(collection(db, "atores"), where("nome", "==", enteredName), limit(1));
                const querySnapshot = await getDocs(checkQuery);
                if (!querySnapshot.empty) {
                    actressNameErrorMessage.textContent = `O nome "${enteredName}" já existe no Firebase.`;
                    actressNameErrorMessage.className = 'error-message error'; // Ensure it's error styled
                    actressNameErrorMessage.style.display = 'block';
                    shouldBeDisabled = true;
                } else { shouldBeDisabled = false; }
            } catch (error) {
                console.error("Firestore name check failed:", error);
                actressNameErrorMessage.textContent = 'Erro ao verificar o nome no Firebase.';
                actressNameErrorMessage.className = 'error-message error';
                actressNameErrorMessage.style.display = 'block';
                shouldBeDisabled = true;
            } finally { if (actressSubmitButton) { actressSubmitButton.disabled = shouldBeDisabled; } }
        }

        async function fetchActressDataFromAPI() { // UPDATED for measurements conversion
            if (!actressNameInput || !createActressForm || !actressNameErrorMessage) { console.warn("fetchActressDataFromAPI: Required elements missing."); return; }
            const actressName = actressNameInput.value.trim();
            if (!actressName) {
                if (actressNameErrorMessage.classList.contains('api-feedback')) {
                    actressNameErrorMessage.textContent = ''; actressNameErrorMessage.style.display = 'none'; actressNameErrorMessage.className = 'error-message';
                } return;
            }
            actressNameErrorMessage.textContent = 'Buscando dados na API...';
            actressNameErrorMessage.className = 'error-message api-feedback';
            actressNameErrorMessage.style.display = 'block';
            try {
                const response = await fetch(`https://portalbabes.onrender.com/scrape_babe?name=${encodeURIComponent(actressName)}`);
                const data = await response.json();
                if (!response.ok) { throw new Error(data.error || `Erro ${response.status} da API.`); }

                actressNameErrorMessage.textContent = 'Dados da API recebidos. Preenchendo campos...';
                actressNameErrorMessage.classList.remove('error');

                const fieldMappingsFromApi = { // Fields from API to map to form IDs
                    born: data.born, birthplace: data.birthplace, ethnicity: data.ethnicity,
                    hair_color: data.hair_color, eye_color: data.eye_color, height: data.height,
                    weight: data.weight, body_type: data.body_type, years_active: data.years_active
                };

                for (const formId in fieldMappingsFromApi) {
                    const inputElement = createActressForm.querySelector(`#${formId}`);
                    const apiValue = fieldMappingsFromApi[formId];
                    if (inputElement && (inputElement.value === null || inputElement.value.trim() === '') && apiValue != null) {
                        inputElement.value = apiValue;
                    }
                }

                if (data.measurements && typeof data.measurements === 'string') {
                    const parts = data.measurements.split('-');
                    if (parts.length === 3) {
                        const b = parseFloat(parts[0]);
                        const w = parseFloat(parts[1]);
                        const a = parseFloat(parts[2]);
                        if (!isNaN(b) && !isNaN(w) && !isNaN(a)) {
                            const b_cm = (b * 2.54).toFixed(2);
                            const w_cm = (w * 2.54).toFixed(2);
                            const a_cm = (a * 2.54).toFixed(2);
                            const convertedMeasurementsString = `${b_cm}-${w_cm}-${a_cm}`;
                            const measurementsInput = createActressForm.querySelector('#measurements');
                            if (measurementsInput && (measurementsInput.value === null || measurementsInput.value.trim() === '')) {
                                measurementsInput.value = convertedMeasurementsString;
                            }
                        } else {
                             const measurementsInput = createActressForm.querySelector('#measurements');
                             if (measurementsInput && (measurementsInput.value === null || measurementsInput.value.trim() === '')) {
                                 measurementsInput.value = data.measurements;
                             }
                        }
                    } else {
                         const measurementsInput = createActressForm.querySelector('#measurements');
                         if (measurementsInput && (measurementsInput.value === null || measurementsInput.value.trim() === '')) {
                            measurementsInput.value = data.measurements;
                         }
                    }
                }


                setTimeout(() => {
                    if (actressNameErrorMessage.classList.contains('api-feedback') && !actressNameErrorMessage.classList.contains('error')) {
                         actressNameErrorMessage.textContent = ''; actressNameErrorMessage.style.display = 'none'; actressNameErrorMessage.className = 'error-message';
                    }
                }, 2000);



            } catch (error) {
                console.error("Erro ao buscar dados da API:", error);
                actressNameErrorMessage.textContent = `API: ${error.message}`;
                actressNameErrorMessage.className = 'error-message api-feedback error';
                actressNameErrorMessage.style.display = 'block';
            }
        }


        function formDataToObject(formData) {
            const obj = {};
            for (const [formId, firestoreKey] of Object.entries(firestoreFieldMap)) {
                if (['overall', 'Boobs', 'Waist', 'Ass', 'medidas'].includes(firestoreKey)) continue;

                const rawValue = formData.get(formId);
                if (rawValue !== null && rawValue !== undefined) {
                    const trimmedValue = typeof rawValue === 'string' ? rawValue.trim() : rawValue;
                    if (trimmedValue === '' && firestoreKey !== 'nota' && firestoreKey !== 'casta') continue;

                    if (formId === 'nota') {
                        const numValue = safeParseFloat(trimmedValue);
                        if (numValue !== null) obj[firestoreKey] = numValue;
                    } else if (formId === 'height' || formId === 'weight') {
                        const numValue = safeParseInt(trimmedValue);
                        if (numValue !== null) obj[firestoreKey] = numValue;
                        else if (trimmedValue) obj[firestoreKey] = trimmedValue; // Keep as string if not parsable but not empty
                    } else if (formId === 'casta') {
                        if (trimmedValue) obj[firestoreKey] = trimmedValue;
                    } else {
                        obj[firestoreKey] = trimmedValue;
                    }
                }
            }

            const measurementsFromForm = formData.get('measurements')?.trim();
            let boobsCmNum = null, waistCmNum = null, assCmNum = null;

            if (measurementsFromForm) {
                obj.medidas = measurementsFromForm;
                const parts = measurementsFromForm.split('-');
                if (parts.length === 3) {
                    obj.Boobs = parts[0].trim();
                    obj.Waist = parts[1].trim();
                    obj.Ass = parts[2].trim();
                    boobsCmNum = safeParseFloat(obj.Boobs);
                    waistCmNum = safeParseFloat(obj.Waist);
                    assCmNum = safeParseFloat(obj.Ass);
                }
            }

            const notaValue = obj.nota !== undefined ? obj.nota : (safeParseFloat(formData.get('nota')) || 0);
            obj.nota = notaValue; // Ensure nota is in the object

            let overallScore = notaValue;
            if (boobsCmNum !== null && waistCmNum !== null && assCmNum !== null) {
                const sumCm = boobsCmNum + waistCmNum + assCmNum;
                overallScore = (sumCm / 2) + notaValue; // As per original logic
            }
            obj.overall = safeParseFloat(overallScore.toFixed(1));
            if (obj.overall === null) obj.overall = notaValue; // Fallback if overall calc fails

            return obj;
        }




        // --- Core Logic: Main Page Display ---
        async function loadInitialData() {
            if (!actressListUl) { console.error("Actress list UL not found."); return; }
            displayMessage(actressListUl, 'Carregando atrizes...');
            allScenesCache.clear();
            try {
                 const [actoresSnapshot, cenasSnapshot] = await Promise.all([ getDocs(collection(db, "atores")), getDocs(collection(db, "cenas")) ]);
                 actressListUl.innerHTML = '';
                 if (actoresSnapshot.empty) { /* Handled by renderActressList */ }
                 else {
                     allActressesData = [];
                     actoresSnapshot.forEach((doc) => {
                        const data = doc.data();
                        // Ensure overall is a number
                        if (data.overall !== undefined && data.overall !== null) {
                            data.overall = safeParseFloat(data.overall);
                        } else {
                            // If overall is missing, try to calculate it or set a default
                            // This part depends on whether 'nota', 'Boobs', 'Waist', 'Ass' are consistently in Firestore
                            // For now, let's assume if overall is missing, it's 0 or needs on-the-fly calc based on other fields
                            data.overall = 0; // Placeholder if missing
                        }
                        allActressesData.push({ id: doc.id, ...data });
                     });
                     allActressesData.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                 }
                 filterAndRenderActressList();
                 cenasSnapshot.forEach(docSnap => allScenesCache.set(docSnap.id, docSnap.data()));
            } catch (error) {
                 console.error("Erro ao carregar dados iniciais: ", error);
                 displayMessage(actressListUl, 'Erro ao carregar dados.', true);
            }
        }
        function renderActressList(actressesToRender) {
            if (!actressListUl) return;
            actressListUl.innerHTML = '';
            if (actressesToRender.length === 0) {
                 const li = document.createElement('li'); li.classList.add('no-results-message'); li.textContent = 'Nenhuma atriz encontrada.'; actressListUl.appendChild(li);
            } else {
                 actressesToRender.forEach(actress => { renderActressListItem(actress); });
                 if (selectedMainActressElement) {
                     const selectedId = selectedMainActressElement.dataset.id;
                     const isSelectedVisible = actressesToRender.some(a => a.id === selectedId);
                      if (!isSelectedVisible) { selectedMainActressElement.classList.remove('selected'); selectedMainActressElement = null; }
                      else { const newListItem = actressListUl.querySelector(`.actress-item[data-id="${selectedId}"]`); if (newListItem) { newListItem.classList.add('selected'); selectedMainActressElement = newListItem; } }
                 }
            }
        }
        function renderActressListItem(actress) {
             if (!actressListUl) return;
             const li = document.createElement('li'); li.classList.add('actress-item'); li.dataset.id = actress.id;
             const age = calculateAge(actress.dataNascimento); const imageUrl = actress.foto || 'placeholder.png'; const rating = actress.nota !== undefined && actress.nota !== null ? Number(actress.nota).toFixed(1) : 'N/A';
             li.innerHTML = `<img src="${imageUrl}" alt="${actress.nome || ''}" onerror="this.src='placeholder.png'; this.onerror=null;"><div class="actress-info"><span class="name">${actress.nome || 'Nome Indisponível'}</span><span class="age">Idade: ${age}</span><span class="rating">Nota: ${rating}</span></div>`;
             li.addEventListener('click', () => handleMainActressClick(actress.id, li));
             actressListUl.appendChild(li);
        }
        async function handleMainActressClick(actressId, listItemElement) {
             if (selectedMainActressElement === listItemElement || !mainContainer || !actressDetailsContainer || !contentCardsContainer || !contentMessage) return;
             if (selectedMainActressElement) selectedMainActressElement.classList.remove('selected');
             listItemElement.classList.add('selected'); selectedMainActressElement = listItemElement; currentMainActressId = actressId;
             mainContainer.classList.add('details-visible');
             actressDetailsContainer.innerHTML = '<div class="loading">Carregando detalhes...</div>';
             // Clear all content areas
             if(contentCardsContainer) contentCardsContainer.innerHTML = ''; contentCardsContainer.style.display = 'none';
             if(similarActressesTableContainer) similarActressesTableContainer.innerHTML = ''; similarActressesTableContainer.style.display = 'none';
             if(rankDisplayArea) rankDisplayArea.innerHTML = ''; rankDisplayArea.style.display = 'none';
             displayMessage(contentMessage, 'Carregando conteúdo...');


             selectedRelatedActresses = []; activeRelatedFilter = 'all'; if(relatedSearchInput) relatedSearchInput.value = ''; renderRelatedActressPills();

             const allFilterButtons = relatedFilterButtonsContainer?.querySelectorAll('.related-filter-btn');
             if(allFilterButtons) {
                allFilterButtons.forEach(btn => btn.classList.remove('active'));
                relatedFilterButtonsContainer.querySelector('.related-filter-btn[data-filter="all"]')?.classList.add('active');
             }
             if (relatedTitleElement) relatedTitleElement.textContent = 'Conteúdo Relacionado';


             try {
                 let actressData = allActressesData.find(a => a.id === actressId);
                 if (!actressData) { const actressDoc = await getDoc(doc(db, "atores", actressId)); if (actressDoc.exists()) { actressData = { id: actressId, ...actressDoc.data() }; allActressesData.push(actressData); allActressesData.sort((a, b) => (a.nome || '').localeCompare(b.nome || '')); filterAndRenderActressList(); } }
                 if (actressData) { displayMainActressDetails(actressData); } else { actressDetailsContainer.innerHTML = '<div class="error">Detalhes não encontrados.</div>'; }
                 await loadAndDisplayRelatedContent(actressId); // This will call applyRelatedContentFilters for 'all'
             } catch (error) { console.error(`Erro ao carregar dados da atriz ${actressId}: `, error); actressDetailsContainer.innerHTML = '<div class="error">Erro ao carregar detalhes.</div>'; displayMessage(contentMessage,'Erro ao carregar conteúdo.', true); }
        }

        function displayMainActressDetails(data) {
            if (!actressDetailsContainer) return;
             actressDetailsContainer.innerHTML = ''; // Clear previous details

             const detailsHeaderContainer = document.createElement('div');
             detailsHeaderContainer.style.display = 'flex';
             detailsHeaderContainer.style.justifyContent = 'space-between';
             detailsHeaderContainer.style.alignItems = 'center';
             detailsHeaderContainer.style.borderBottom = '1px solid #eee';
             detailsHeaderContainer.style.marginBottom = '15px';

             const detailsTitle = document.createElement('h2');
             detailsTitle.textContent = data.nome || 'Detalhes';
             detailsTitle.style.margin = '0';
             detailsTitle.style.borderBottom = 'none';
             detailsTitle.style.paddingBottom = '0';

             const compareIconButton = document.createElement('button');
             compareIconButton.id = 'details-compare-icon';
             compareIconButton.title = 'Comparar esta atriz';
             compareIconButton.style.background = 'none';
             compareIconButton.style.border = 'none';
             compareIconButton.style.fontSize = '1.5em';
             compareIconButton.style.cursor = 'pointer';
             compareIconButton.style.padding = '0 5px';
             compareIconButton.textContent = '⚖️';
             compareIconButton.addEventListener('click', () => {
                if (currentMainActressId) {
                    openComparisonModal([currentMainActressId]);
                }
             });

             detailsHeaderContainer.appendChild(detailsTitle);
             detailsHeaderContainer.appendChild(compareIconButton);
             actressDetailsContainer.appendChild(detailsHeaderContainer);

             if (data.foto) {
                 const img = document.createElement('img');
                 img.src = data.foto;
                 img.alt = data.nome || 'Foto';
                 img.classList.add('detail-photo');
                 img.onerror = () => { img.style.display = 'none'; };
                 actressDetailsContainer.appendChild(img);
             }

             const measurementContainer = document.createElement('div');
             measurementContainer.classList.add('measurement-cards-container');
             let cardsAdded = 0;

             const createMeasurementCard = (label, value) => {
                 if (value != null && String(value).trim() !== '') {
                     const card = document.createElement('div');
                     card.classList.add('measurement-card');
                     card.innerHTML = `<span class="label">${label}</span><span class="value">${value}</span>`;
                     measurementContainer.appendChild(card);
                     cardsAdded++;
                 }
             };

             createMeasurementCard('Boobs', data.Boobs);
             createMeasurementCard('Waist', data.Waist);
             createMeasurementCard('Ass', data.Ass);

             if (cardsAdded > 0) {
                 actressDetailsContainer.appendChild(measurementContainer);
             }

             let detailsAdded = false;
             const detailFieldsContainer = document.createElement('div');
             const addDetailRow = (label, value) => {
                 if (value != null && String(value).trim() !== '') {
                     const div = document.createElement('div');
                     div.innerHTML = `<strong>${label}:</strong> ${value}`;
                     detailFieldsContainer.appendChild(div);
                     detailsAdded = true;
                 }
             };

             addDetailRow('Nome', data.nome);
             addDetailRow('Nascimento', data.dataNascimento);
             if (data.dataNascimento) { addDetailRow('Idade', calculateAge(data.dataNascimento)); }
             if (data.altura != null) { addDetailRow('Altura', `${data.altura} cm`); }
             if (data.peso != null) { addDetailRow('Peso', `${data.peso} kg`); }
             addDetailRow('Nacionalidade', data.pais);
             addDetailRow('Etnia', data.etnia);
             addDetailRow('Cor Cabelo', data.corCabelo);
             addDetailRow('Cor Olhos', data.corOlhos);
             addDetailRow('Medidas', data.medidas);
             addDetailRow('Tipo Corpo', data.tipoCorpo);
             addDetailRow('Casta', data.casta);
             addDetailRow('Anos Ativa', data.AnosAtiva);
             if (data.nota != null) { addDetailRow('Nota', Number(data.nota).toFixed(1)); }
             if (data.overall != null) { addDetailRow('Overall', Number(data.overall).toFixed(1)); } // Display Overall

             if(detailsAdded) {
                actressDetailsContainer.appendChild(detailFieldsContainer);
             }

             if (!data.foto && cardsAdded === 0 && !detailsAdded) {
                 const noDetailsDiv = document.createElement('div');
                 noDetailsDiv.classList.add('error');
                 noDetailsDiv.style.textAlign = 'center';
                 noDetailsDiv.style.marginTop = '20px';
                 noDetailsDiv.textContent = 'Sem detalhes disponíveis para esta atriz.';
                 actressDetailsContainer.appendChild(noDetailsDiv);
             }
        }

        function filterAndRenderActressList() {
            if (!actressListUl) return;
            const searchTerm = actressSearchInput?.value.toLowerCase().trim() || '';
            let filteredActresses = [...allActressesData];
            if (searchTerm) { filteredActresses = filteredActresses.filter(actress => (actress.nome || '').toLowerCase().includes(searchTerm) ); }
            const filters = activeActressFilters;
            if (Object.keys(filters).length > 0) {
                filteredActresses = filteredActresses.filter(actress => {
                    let keep = true;
                    for (const key in filters) {
                        const filterValue = filters[key]; let actressValue = actress[key];
                        switch (key) {
                            case 'nationality': if (String(actress.pais || '').toLowerCase().trim() !== String(filterValue).toLowerCase().trim()) keep = false; break;
                            case 'ethnicity': if (String(actress.etnia || '').toLowerCase().trim() !== String(filterValue).toLowerCase().trim()) keep = false; break;
                            case 'height_min': if (actress.altura == null || actress.altura < filterValue) keep = false; break;
                            case 'height_max': if (actress.altura == null || actress.altura > filterValue) keep = false; break;
                            case 'weight_min': if (actress.peso == null || actress.peso < filterValue) keep = false; break;
                            case 'weight_max': if (actress.peso == null || actress.peso > filterValue) keep = false; break;
                            case 'age_min': const ageMin = calculateAge(actress.dataNascimento); if (typeof ageMin === 'number' && ageMin < filterValue) keep = false; if (typeof ageMin !== 'number' && filterValue > 0) keep = false; break;
                            case 'age_max': const ageMax = calculateAge(actress.dataNascimento); if (typeof ageMax === 'number' && ageMax > filterValue) keep = false; break;
                            case 'rating_min': if (actress.nota == null || actress.nota < filterValue) keep = false; break;
                            case 'rating_max': if (actress.nota == null || actress.nota > filterValue) keep = false; break;
                        }
                        if (!keep) break;
                    }
                    return keep;
                });
            }
            renderActressList(filteredActresses);
        }


        // --- Related Content Logic ---
        async function loadAndDisplayRelatedContent(mainActressId) {
            if (!contentCardsContainer || !contentMessage) { console.error("Content elements not found!"); return; }
             allRelatedContent = []; filteredRelatedContent = [];

             // Clear all dynamic content areas first
             if(contentCardsContainer) contentCardsContainer.innerHTML = '';
             if(similarActressesTableContainer) similarActressesTableContainer.innerHTML = '';
             if(rankDisplayArea) rankDisplayArea.innerHTML = '';
             displayMessage(contentMessage, 'Buscando conteúdo relacionado...');

             try {
                 const [videosSnapshot, filmesSnapshot] = await Promise.all([ getDocs(collection(db, "videos")), getDocs(collection(db, "filmes")) ]);
                 videosSnapshot.forEach(docSnap => { const videoId = docSnap.id; const itemData = docSnap.data(); const videoActors = itemData.atores || []; if (Array.isArray(videoActors) && videoActors.includes(mainActressId)) { allRelatedContent.push({ id: videoId, type: 'video', ...itemData }); } });
                 filmesSnapshot.forEach(docSnap => {
                     const movieId = docSnap.id; const movieData = docSnap.data(); const movieSceneIds = movieData.cenas || []; let movieIsRelated = false; const relatedScenesFromMovie = [];
                     if (movieSceneIds.length > 0) { for (const sceneId of movieSceneIds) { const sceneData = allScenesCache.get(sceneId); if (sceneData) { const sceneActors = sceneData.atores || []; const sceneFullData = { id: sceneId, type: 'scene', ...sceneData }; if (Array.isArray(sceneActors) && sceneActors.includes(mainActressId)) { movieIsRelated = true; relatedScenesFromMovie.push(sceneFullData); } } } }
                     if (movieIsRelated) { allRelatedContent.push({ id: movieId, type: 'film', ...movieData }); relatedScenesFromMovie.forEach(scene => { if (!allRelatedContent.some(item => item.id === scene.id && item.type === 'scene')) { allRelatedContent.push(scene); } }); }
                 });
                 allScenesCache.forEach((sceneData, sceneId) => { const sceneActors = sceneData.atores || []; if (Array.isArray(sceneActors) && sceneActors.includes(mainActressId)) { if (!allRelatedContent.some(item => item.id === sceneId && item.type === 'scene')) { allRelatedContent.push({ id: sceneId, type: 'scene', ...sceneData }); } } });
                 
                 // This will show the 'all' content by default after loading.
                 // The activeRelatedFilter is set to 'all' in handleMainActressClick
                 updateRightColumnView();
             } catch (error) { console.error("Erro detalhado ao buscar conteúdo relacionado: ", error); displayMessage(contentMessage, 'Erro ao carregar conteúdo relacionado.', true); }
        }

        function updateRightColumnView() {
            if (!contentCardsContainer || !similarActressesTableContainer || !rankDisplayArea || !contentMessage || !relatedTitleElement) return;

            // Hide all content areas initially
            contentCardsContainer.style.display = 'none'; contentCardsContainer.innerHTML = '';
            similarActressesTableContainer.style.display = 'none'; similarActressesTableContainer.innerHTML = '';
            rankDisplayArea.style.display = 'none'; rankDisplayArea.innerHTML = '';
            clearMessage(contentMessage);

            if (relatedSearchInput) { // Enable/disable co-actress search based on tab
                const isSearchDisabled = activeRelatedFilter === 'similar' || activeRelatedFilter === 'rank';
                relatedSearchInput.disabled = isSearchDisabled;
                relatedSearchInput.placeholder = isSearchDisabled ? 'Não aplicável' : 'Filtrar por co-atriz...';
                if (isSearchDisabled) {
                    selectedRelatedActresses = []; // Clear selected co-actresses if search is disabled
                    renderRelatedActressPills();
                    if(relatedSuggestionsList) relatedSuggestionsList.style.display = 'none';
                }
            }


            switch (activeRelatedFilter) {
                case 'all':
                case 'video':
                case 'film':
                case 'scene':
                    relatedTitleElement.textContent = 'Conteúdo Relacionado';
                    contentCardsContainer.style.display = 'grid'; // Use grid for cards
                    applyRelatedContentFilters();
                    break;
                case 'similar':
                    relatedTitleElement.textContent = 'Atrizes Semelhantes';
                    similarActressesTableContainer.style.display = 'block';
                    displaySimilarActresses(similarActressesTableContainer); // Pass container
                    break;
                case 'rank':
                    relatedTitleElement.textContent = 'Rankings da Atriz';
                    rankDisplayArea.style.display = 'flex'; // Use flex for rank cards
                    calculateAndDisplayRanks(currentMainActressId, rankDisplayArea);
                    break;
                default:
                    relatedTitleElement.textContent = 'Conteúdo Relacionado';
                    contentCardsContainer.style.display = 'grid';
                    displayMessage(contentMessage, 'Filtro desconhecido.');
            }
        }


        function applyRelatedContentFilters() {
            if (!contentCardsContainer || !contentMessage) return;
             contentCardsContainer.innerHTML = ''; clearMessage(contentMessage); // Clear before filtering

             const relatedActressIds = selectedRelatedActresses.map(a => a.id);
             filteredRelatedContent = allRelatedContent.filter(item => {
                 if (activeRelatedFilter !== 'all' && item.type !== activeRelatedFilter) return false;
                 if (relatedActressIds.length > 0) {
                     if (!item.atores || !Array.isArray(item.atores)) return false;
                     if (!relatedActressIds.every(relId => item.atores.includes(relId))) return false;
                 }
                 return true;
             });

             filteredRelatedContent.sort((a, b) => { const timestampA = getItemTimestampForSort(a); const timestampB = getItemTimestampForSort(b); if (timestampA === null && timestampB === null) { return (a.nome || '').localeCompare(b.nome || ''); } else if (timestampA === null) { return 1; } else if (timestampB === null) { return -1; } const dateDifference = timestampB - timestampA; if (dateDifference !== 0) { return dateDifference; } return (a.nome || '').localeCompare(b.nome || ''); });

             if (filteredRelatedContent.length > 0) {
                 filteredRelatedContent.forEach(item => createContentCard(item.imagem, item.nome, item.type, item.id));
             }
             else {
                 displayMessage(contentMessage, 'Nenhum conteúdo encontrado com os filtros aplicados.');
             }
        }

        function createContentCard(imageUrl, title, type, id) {
            if (!contentCardsContainer) return;
             const card = document.createElement('div'); card.classList.add('content-card'); card.dataset.type = type; card.dataset.id = id;
             const imageContainer = document.createElement('div'); imageContainer.classList.add('image-container'); const img = document.createElement('img'); let finalImageUrl = imageUrl;
             if (typeof imageUrl === 'object' && imageUrl !== null && imageUrl.width) { const urlKey = Object.keys(imageUrl).find(k=>typeof imageUrl[k]==='string'&&imageUrl[k].startsWith('http')); finalImageUrl = urlKey ? imageUrl[urlKey] : 'placeholder.png'; } else if (typeof imageUrl !== 'string' || !imageUrl) { finalImageUrl = 'placeholder.png'; }
             img.src = finalImageUrl; img.alt = title || type; img.onerror = () => { img.src = 'placeholder.png'; img.onerror=null; };
             const badge = document.createElement('div'); badge.classList.add('content-type-badge'); let badgeText = capitalizeFirstLetter(type); if(type === 'film') badgeText = 'Filme'; else if(type === 'scene') badgeText = 'Cena'; else if(type === 'video') badgeText = 'Vídeo'; badge.textContent = badgeText;
             imageContainer.appendChild(badge); imageContainer.appendChild(img);
             const titleDiv = document.createElement('div'); titleDiv.classList.add('title'); titleDiv.textContent = `${title || 'Sem Título'}`;
             card.appendChild(imageContainer); card.appendChild(titleDiv);
             card.addEventListener('click', () => { showContentDetails(type, id); });
             contentCardsContainer.appendChild(card);
        }

        // --- Right Column Search Functions ---
        function displayRelatedSuggestions(searchTerm) {
            if (!relatedSuggestionsList || !relatedSearchInput) return;
            const term = searchTerm.trim().toLowerCase();
            relatedSuggestionsList.innerHTML = '';

            if (!term) { relatedSuggestionsList.style.display = 'none'; return; }

            const currentActressIdForSuggestion = currentMainActressId;
            const alreadySelectedIds = selectedRelatedActresses.map(a => a.id);

            const filteredActresses = allActressesData.filter(actress =>
                actress.id !== currentActressIdForSuggestion &&
                !alreadySelectedIds.includes(actress.id) &&
                (actress.nome || '').toLowerCase().includes(term)
            ).slice(0, 10);

            if (filteredActresses.length > 0) {
                filteredActresses.forEach(actress => {
                    const item = document.createElement('div'); item.classList.add('suggestion-item');
                    item.innerHTML = `<img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';"> <span>${actress.nome}</span>`;
                    item.addEventListener('click', () => handleSelectRelatedActress(actress));
                    relatedSuggestionsList.appendChild(item);
                });
            } else {
                 const noResults = document.createElement('div'); noResults.classList.add('suggestion-item', 'no-results'); noResults.textContent = 'Nenhuma co-atriz encontrada'; relatedSuggestionsList.appendChild(noResults);
            }
             relatedSuggestionsList.style.display = 'block';
        }
        function displayInitialRelatedSuggestionsOnClick() {
            if (!relatedSuggestionsList || !relatedSearchInput || !currentMainActressId) {
                if (relatedSuggestionsList) relatedSuggestionsList.style.display = 'none';
                return;
            }
            if (activeRelatedFilter === 'similar' || activeRelatedFilter === 'rank') { // Disable for similar/rank
                 const noResults = document.createElement('div');
                 noResults.classList.add('suggestion-item', 'no-results');
                 noResults.textContent = 'Filtro por co-atriz não aplicável';
                 relatedSuggestionsList.innerHTML = '';
                 relatedSuggestionsList.appendChild(noResults);
                 relatedSuggestionsList.style.display = 'block';
                 return;
            }

            const allCoActressIds = new Set();
            filteredRelatedContent.forEach(item => {
                if (item.atores && Array.isArray(item.atores)) {
                    item.atores.forEach(actorId => { if (actorId !== currentMainActressId) { allCoActressIds.add(actorId); } });
                }
            });

            const alreadySelectedIds = selectedRelatedActresses.map(a => a.id);
            const coActressesToShow = [];
            allCoActressIds.forEach(actressId => { if (!alreadySelectedIds.includes(actressId)) { const actressData = allActressesData.find(a => a.id === actressId); if (actressData) { coActressesToShow.push(actressData); } } });
            coActressesToShow.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
            relatedSuggestionsList.innerHTML = '';

            if (coActressesToShow.length > 0) {
                coActressesToShow.forEach(actress => {
                    const item = document.createElement('div'); item.classList.add('suggestion-item');
                    item.innerHTML = `<img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';"> <span>${actress.nome}</span>`;
                    item.addEventListener('click', () => handleSelectRelatedActress(actress));
                    relatedSuggestionsList.appendChild(item);
                });
            } else { const noResults = document.createElement('div'); noResults.classList.add('suggestion-item', 'no-results'); noResults.textContent = 'Nenhuma co-atriz encontrada neste conteúdo'; relatedSuggestionsList.appendChild(noResults); }
            relatedSuggestionsList.style.display = 'block';
        }
        function handleSelectRelatedActress(actress) {
             if (!actress || !actress.id || activeRelatedFilter === 'similar' || activeRelatedFilter === 'rank') return;
             if (!selectedRelatedActresses.some(a => a.id === actress.id)) {
                 selectedRelatedActresses.push(actress); renderRelatedActressPills();
                 updateRightColumnView(); // Re-filter content based on new co-actress
                 if (relatedSearchInput) relatedSearchInput.value = '';
                 if (relatedSuggestionsList) relatedSuggestionsList.style.display = 'none';
                 if (relatedSearchInput) relatedSearchInput.focus();
             }
        }
        function renderRelatedActressPills() {
            if (!relatedSelectedActressesContainer) return;
            relatedSelectedActressesContainer.innerHTML = '';
            selectedRelatedActresses.forEach(actress => {
                const pill = document.createElement('div'); pill.classList.add('related-actress-pill'); pill.dataset.id = actress.id;
                pill.innerHTML = `<span>${actress.nome}</span><button type="button" class="related-remove-actress-btn" title="Remover ${actress.nome}">×</button>`;
                pill.querySelector('.related-remove-actress-btn').addEventListener('click', handleRemoveRelatedActress);
                relatedSelectedActressesContainer.appendChild(pill);
            });
        }
        function handleRemoveRelatedActress(event) {
            const button = event.target;
            const pill = button.closest('.related-actress-pill');
            if (pill && pill.dataset.id) {
                const actressIdToRemove = pill.dataset.id;
                selectedRelatedActresses = selectedRelatedActresses.filter(a => a.id !== actressIdToRemove);
                renderRelatedActressPills();
                updateRightColumnView(); // Re-filter content after removal
            }
        }

        // --- Similarity Calculation ---
        const SIMILARITY_WEIGHTS = { altura: 15, peso: 15, age: 10, corCabelo: 10, corOlhos: 10, etnia: 15, pais: 5, tipoCorpo: 10, measurements: 10, };
        const MAX_SIMILARITY_SCORE = Object.values(SIMILARITY_WEIGHTS).reduce((sum, w) => sum + w, 0);

        function calculateSimilarity(actressA, actressB) {
            if (!actressA || !actressB || actressA.id === actressB.id) { return 0; }
            let currentScore = 0;
            const calculateNumericSimilarity = (key, weight, maxDifferencePenalty) => {
                const valA = key === 'age' ? calculateAge(actressA.dataNascimento) : safeParseInt(actressA[key]);
                const valB = key === 'age' ? calculateAge(actressB.dataNascimento) : safeParseInt(actressB[key]);
                if (valA === null || valB === null || valA === '?' || valB === '?') return 0;
                const diff = Math.abs(valA - valB); let score = weight - (diff / maxDifferencePenalty) * weight;
                return Math.max(0, score);
            };
            currentScore += calculateNumericSimilarity('altura', SIMILARITY_WEIGHTS.altura, 20);
            currentScore += calculateNumericSimilarity('peso', SIMILARITY_WEIGHTS.peso, 15);
            currentScore += calculateNumericSimilarity('age', SIMILARITY_WEIGHTS.age, 10);
            const calculateCategoricalSimilarity = (key, weight) => { if (safeStringCompare(actressA[key], actressB[key])) { return weight; } return 0; };
            currentScore += calculateCategoricalSimilarity('corCabelo', SIMILARITY_WEIGHTS.corCabelo);
            currentScore += calculateCategoricalSimilarity('corOlhos', SIMILARITY_WEIGHTS.corOlhos);
            currentScore += calculateCategoricalSimilarity('etnia', SIMILARITY_WEIGHTS.etnia);
            currentScore += calculateCategoricalSimilarity('pais', SIMILARITY_WEIGHTS.pais);
            currentScore += calculateCategoricalSimilarity('tipoCorpo', SIMILARITY_WEIGHTS.tipoCorpo);
            const calculateMeasurementSimilarity = (weight) => {
                const parseMeasure = (act) => ({ b: safeParseInt(act.Boobs), w: safeParseInt(act.Waist), a: safeParseInt(act.Ass) });
                const mA = parseMeasure(actressA); const mB = parseMeasure(actressB);
                let measureScore = 0; let comparableParts = 0; const maxDiffPerPart = 5;
                if (mA.b !== null && mB.b !== null) { comparableParts++; measureScore += Math.max(0, (weight/3) - (Math.abs(mA.b - mB.b) / maxDiffPerPart) * (weight/3)); }
                if (mA.w !== null && mB.w !== null) { comparableParts++; measureScore += Math.max(0, (weight/3) - (Math.abs(mA.w - mB.w) / maxDiffPerPart) * (weight/3)); }
                if (mA.a !== null && mB.a !== null) { comparableParts++; measureScore += Math.max(0, (weight/3) - (Math.abs(mA.a - mB.a) / maxDiffPerPart) * (weight/3)); }
                if (comparableParts > 0 && safeStringCompare(actressA.medidas, actressB.medidas)) { measureScore = weight; }
                else if (comparableParts < 3 && comparableParts > 0) { measureScore = measureScore * (3 / comparableParts); }
                else if (comparableParts === 0) { return 0; }
                return Math.max(0, Math.min(weight, measureScore));
            };
            currentScore += calculateMeasurementSimilarity(SIMILARITY_WEIGHTS.measurements);
            return Math.max(0, Math.min(100, currentScore));
        }

        async function displaySimilarActresses(container) { // MODIFIED to accept container
            if (!currentMainActressId || !container || !contentMessage) { console.error("Cannot display similar: Missing elements or actress."); return; }
            const mainActress = allActressesData.find(a => a.id === currentMainActressId);
            if (!mainActress) { container.innerHTML = ''; displayMessage(contentMessage, 'Atriz principal não encontrada.', true); return; }
            container.innerHTML = ''; displayMessage(contentMessage, 'Calculando similaridade...');
            await new Promise(resolve => setTimeout(resolve, 50));
            const similarActresses = [];
            allActressesData.forEach(otherActress => { if (otherActress.id !== currentMainActressId) { const score = calculateSimilarity(mainActress, otherActress); if (score > 0) { similarActresses.push({ actress: otherActress, score: score }); } } });
            similarActresses.sort((a, b) => b.score - a.score);
            const topSimilar = similarActresses.slice(0, 10);
            clearMessage(contentMessage);
            if (topSimilar.length > 0) {
                const table = document.createElement('table'); table.id = 'similar-actresses-table';
                const thead = table.createTHead(); const headerRow = thead.insertRow();
                headerRow.innerHTML = `<th class="rank-col">#</th><th class="actress-col">Atriz</th><th class="score-col">Score</th>`;
                const tbody = table.createTBody();
                topSimilar.forEach((item, index) => { const rank = index + 1; const tableRow = createSimilarActressTableRow(item.actress, item.score, rank); tbody.appendChild(tableRow); });
                container.appendChild(table);
            } else { displayMessage(contentMessage, 'Nenhuma atriz semelhante encontrada.'); }
        }

        function createSimilarActressTableRow(actress, score, rank) {
            const row = document.createElement('tr');
            const rankCell = row.insertCell(); rankCell.classList.add('rank-col'); rankCell.textContent = rank;
            const actressCell = row.insertCell(); actressCell.classList.add('actress-col');
            const cardDiv = document.createElement('div'); cardDiv.classList.add('similar-actress-table-card'); cardDiv.dataset.id = actress.id;
            const img = document.createElement('img'); img.src = actress.foto || 'placeholder.png'; img.alt = actress.nome || 'Atriz'; img.onerror = () => { img.src = 'placeholder.png'; img.onerror = null; };
            const nameSpan = document.createElement('span'); nameSpan.classList.add('name'); nameSpan.textContent = actress.nome || 'Nome Indisponível';
            cardDiv.appendChild(img); cardDiv.appendChild(nameSpan);
            cardDiv.addEventListener('click', () => { const mainListItem = actressListUl.querySelector(`.actress-item[data-id="${actress.id}"]`); if (mainListItem) { mainListItem.click(); mainListItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); } });
            actressCell.appendChild(cardDiv);
            const scoreCell = row.insertCell(); scoreCell.classList.add('score-col'); scoreCell.textContent = `${score.toFixed(0)}%`;
            return row;
        }


        // --- NEW RANKING FUNCTIONS ---
        async function calculateAndDisplayRanks(actressId, container) {
            if (!actressId || !container) {
                if(container) container.innerHTML = '<p class="error">Erro ao carregar rankings.</p>';
                return;
            }
            container.innerHTML = '<div class="loading">Calculando rankings...</div>';

            const selectedActress = allActressesData.find(a => a.id === actressId);
            if (!selectedActress) {
                container.innerHTML = '<p class="error">Atriz selecionada não encontrada.</p>';
                return;
            }
            if (selectedActress.overall === null || selectedActress.overall === undefined) {
                 container.innerHTML = '<p class="error">Atriz selecionada não possui pontuação "overall" para ranking.</p>';
                return;
            }


            // Ensure all actresses have numeric overall for ranking
            const actressesWithNumericOverall = allActressesData.map(a => ({
                ...a,
                overall: safeParseFloat(a.overall) // Ensure 'overall' is a number for comparison
            })).filter(a => a.overall !== null && a.overall !== undefined);


            const mundialData = getRankAndList(actressesWithNumericOverall, selectedActress, 'overall', null, null);
            const nacionalData = selectedActress.pais ? getRankAndList(actressesWithNumericOverall, selectedActress, 'overall', 'pais', selectedActress.pais) : { rank: null, total: 0, list: [] };
            const castaData = selectedActress.casta ? getRankAndList(actressesWithNumericOverall, selectedActress, 'overall', 'casta', selectedActress.casta) : { rank: null, total: 0, list: [] };

            container.innerHTML = `
                <div class="rank-card" id="mundial-rank-card" data-rank-type="mundial">
                    <h3>Ranking Mundial (Overall)</h3>
                    <p class="rank-value">${mundialData.rank ? `${mundialData.rank}º de ${mundialData.total}` : 'N/A'}</p>
                    ${mundialData.list.length > 0 ? '<span class="rank-details-link">Ver Detalhes</span>' : ''}
                </div>
                <div class="rank-card" id="nacional-rank-card" data-rank-type="nacional">
                    <h3>Ranking Nacional (${selectedActress.pais || 'N/A'})</h3>
                    <p class="rank-value">${nacionalData.rank ? `${nacionalData.rank}º de ${nacionalData.total}` : (selectedActress.pais ? 'N/A' : 'País não definido')}</p>
                    ${nacionalData.list.length > 0 ? '<span class="rank-details-link">Ver Detalhes</span>' : ''}
                </div>
                <div class="rank-card" id="casta-rank-card" data-rank-type="casta">
                    <h3>Ranking por Casta (${selectedActress.casta || 'N/A'})</h3>
                    <p class="rank-value">${castaData.rank ? `${castaData.rank}º de ${castaData.total}` : (selectedActress.casta ? 'N/A' : 'Casta não definida')}</p>
                    ${castaData.list.length > 0 ? '<span class="rank-details-link">Ver Detalhes</span>' : ''}
                </div>
            `;

            container.querySelector('#mundial-rank-card .rank-details-link')?.addEventListener('click', () => openRankingDetailModal('Ranking Mundial (Overall)', mundialData.list, selectedActress.id));
            container.querySelector('#nacional-rank-card .rank-details-link')?.addEventListener('click', () => openRankingDetailModal(`Ranking Nacional (${selectedActress.pais || 'N/A'})`, nacionalData.list, selectedActress.id));
            container.querySelector('#casta-rank-card .rank-details-link')?.addEventListener('click', () => openRankingDetailModal(`Ranking por Casta (${selectedActress.casta || 'N/A'})`, castaData.list, selectedActress.id));
        }

        function getRankAndList(dataSource, targetActress, scoreField, filterKey, filterValue) {
            let filteredList = dataSource.filter(actress => actress[scoreField] !== null && actress[scoreField] !== undefined);

            if (filterKey && filterValue) {
                filteredList = filteredList.filter(actress => String(actress[filterKey] || '').toLowerCase() === String(filterValue).toLowerCase());
            }

            // Create copies for sorting to not affect original data, ensure scoreField is numeric
            let sortableList = filteredList.map(actress => ({
                ...actress,
                [scoreField]: safeParseFloat(actress[scoreField]) // Ensure numeric for sort
            }));

            // Sort: Higher score is better. Handle nulls by pushing them to the end.
            sortableList.sort((a, b) => {
                const scoreA = a[scoreField];
                const scoreB = b[scoreField];
                if (scoreA === null && scoreB === null) return 0;
                if (scoreA === null) return 1; // a is worse
                if (scoreB === null) return -1; // b is worse
                return scoreB - scoreA; // Descending
            });

            // Assign ranks, handling ties
            let rank = 0;
            let lastScore = -Infinity;
            const listWithRanks = sortableList.map((actress, index) => {
                if (actress[scoreField] !== lastScore) {
                    rank = index + 1;
                    lastScore = actress[scoreField];
                }
                return { ...actress, rankDisplay: rank }; // Use rankDisplay to avoid conflict if actress has 'rank' field
            });

            const targetActressInList = listWithRanks.find(a => a.id === targetActress.id);
            const targetRank = targetActressInList ? targetActressInList.rankDisplay : null;

            return { rank: targetRank, total: listWithRanks.length, list: listWithRanks };
        }

        function openRankingDetailModal(title, rankedList, highlightActressId) {
            if (!rankingDetailModal || !rankingModalTitle || !rankingModalTableContainer) return;

            rankingModalTitle.textContent = title;
            rankingModalTableContainer.innerHTML = ''; // Clear previous

            if (!rankedList || rankedList.length === 0) {
                rankingModalTableContainer.innerHTML = '<p>Nenhuma atriz para exibir neste ranking.</p>';
                rankingDetailModal.style.display = 'flex';
                return;
            }

            const table = document.createElement('table');
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headerRow.innerHTML = `
                <th class="col-rank">#</th>
                <th class="col-foto">Foto</th>
                <th>Nome</th>
                <th>País</th>
                <th class="col-overall">Overall</th>
            `;
            const tbody = table.createTBody();
            rankedList.forEach(actress => {
                const row = tbody.insertRow();
                if (actress.id === highlightActressId) {
                    row.classList.add('highlighted-actress');
                }
                row.innerHTML = `
                    <td class="col-rank">${actress.rankDisplay || '-'}</td>
                    <td class="col-foto"><img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" class="rank-detail-photo" onerror="this.src='placeholder.png';"></td>
                    <td>${actress.nome || 'N/A'}</td>
                    <td>${actress.pais || 'N/A'}</td>
                    <td class="col-overall">${actress.overall !== null && actress.overall !== undefined ? Number(actress.overall).toFixed(1) : '-'}</td>
                `;
            });

            rankingModalTableContainer.appendChild(table);
            rankingDetailModal.style.display = 'flex';
        }
        window.closeRankingDetailModal = function() {
            if (rankingDetailModal) rankingDetailModal.style.display = 'none';
        }
        // --- END NEW RANKING FUNCTIONS ---


        // --- Content Detail Modal Functions ---
        async function showContentDetails(type, id) {
             if (!contentModal || !contentModalBody || !contentModalTitle) { console.error("Content modal elements not found!"); return; }
             contentModalBody.innerHTML = '<div class="loading">Carregando detalhes...</div>'; contentModalTitle.textContent = 'Detalhes'; modalLinkContainer.innerHTML = ''; contentModal.style.display = 'flex';
             try {
                 let docRef; let collectionName = ''; let data = null;
                 switch (type) { case 'video': collectionName = 'videos'; break; case 'film': collectionName = 'filmes'; break; case 'scene': collectionName = 'cenas'; break; default: throw new Error(`Tipo de conteúdo desconhecido: ${type}`); }
                 docRef = doc(db, collectionName, id); const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     data = docSnap.data(); contentModalTitle.textContent = data.nome || `Detalhes ${capitalizeFirstLetter(type)}`; contentModalBody.innerHTML = '';
                     let imageUrl = data.imagem || 'placeholder.png'; if (typeof imageUrl === 'object' && imageUrl !== null && imageUrl.width) { const urlKey = Object.keys(imageUrl).find(k=>typeof imageUrl[k]==='string'&&imageUrl[k].startsWith('http')); imageUrl = urlKey ? imageUrl[urlKey] : 'placeholder.png'; } else if (typeof imageUrl !== 'string' || !imageUrl) { imageUrl = 'placeholder.png'; }
                     const img = document.createElement('img'); img.src = imageUrl; img.alt = data.nome || type; img.classList.add('modal-detail-image'); if (type === 'film') img.classList.add('movie-image'); img.onerror = () => { img.style.display = 'none'; }; contentModalBody.appendChild(img);
                     const addDetail = (label, value) => { if (value != null && value !== '') { const div = document.createElement('div'); div.innerHTML = `<strong>${label}:</strong> ${value}`; contentModalBody.appendChild(div); } };
                     if (type === 'film' && data.ano) { contentModalBody.innerHTML += `<div class="modal-year">(${data.ano})</div>`; }
                     if (type === 'scene' && data.data) { addDetail('Data', data.data); }
                     if (type === 'video' && data.data) { addDetail('Data', data.data); }
                     if (type === 'scene' && data.numero != null) { addDetail('Número', data.numero); }
                     if ((type === 'film' || type === 'video') && data.estudio) { addDetail('Estúdio', data.estudio); }
                     if (type === 'film' && data.duracao) { addDetail('Duração', data.duracao); }
                     if (data.pagina) { const linkButton = document.createElement('button'); linkButton.textContent = `Abrir Página ${capitalizeFirstLetter(type)}`; linkButton.onclick = () => window.open(data.pagina, '_blank'); modalLinkContainer.appendChild(linkButton); }
                     if (data.atores && data.atores.length > 0) { const actressContainer = document.createElement('div'); actressContainer.classList.add('modal-actress-list-container'); actressContainer.innerHTML = '<h4>Atrizes</h4><ul class="modal-actress-list"><div class="loading">Carregando...</div></ul>'; contentModalBody.appendChild(actressContainer); await loadActressesForModal(data.atores, actressContainer.querySelector('.modal-actress-list')); }
                     if (type === 'film' && data.cenas && data.cenas.length > 0) { const scenesContainer = document.createElement('div'); scenesContainer.classList.add('modal-scenes-container'); scenesContainer.innerHTML = `<h4>Cenas (${data.cenas.length})</h4><div class="modal-scene-cards"><div class="loading">Carregando...</div></div>`; contentModalBody.appendChild(scenesContainer); await loadScenesForModal(data.cenas, scenesContainer.querySelector('.modal-scene-cards')); }
                 } else { contentModalBody.innerHTML = `<div class="error">${capitalizeFirstLetter(type)} não encontrado.</div>`; }
             } catch (error) { console.error(`Erro ao carregar detalhes de ${type} ${id}:`, error); contentModalBody.innerHTML = `<div class="error">Erro ao carregar detalhes.</div>`; }
        }
        async function loadActressesForModal(actressIds, containerElement, contextActressIds = []) {
            if (!containerElement || !actressIds || actressIds.length === 0) { if(containerElement) containerElement.innerHTML = ''; return; }
            containerElement.innerHTML = '';
            try {
                const idsToFetch = actressIds.filter(id => !allActressesData.some(a => a.id === id)); let fetchedActresses = [];
                if (idsToFetch.length > 0) {
                     const MAX_IN_QUERY_SIZE = 30;
                     for (let i = 0; i < idsToFetch.length; i += MAX_IN_QUERY_SIZE) {
                         const chunkIds = idsToFetch.slice(i, i + MAX_IN_QUERY_SIZE);
                         const q = query(collection(db, "atores"), where(documentId(), 'in', chunkIds)); const querySnapshot = await getDocs(q);
                         querySnapshot.forEach(docSnap => { fetchedActresses.push({ id: docSnap.id, ...docSnap.data() }); });
                     }
                     allActressesData.push(...fetchedActresses); allActressesData.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                }
                actressIds.forEach(id => {
                    const actress = allActressesData.find(a => a.id === id);
                    if (actress) {
                        const li = document.createElement('li'); li.classList.add('modal-actress-item'); li.dataset.id = actress.id;
                        li.innerHTML = `<img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';"><span>${actress.nome}</span>`;
                        li.addEventListener('click', (e) => { e.stopPropagation(); closeModal(); const mainListItem = actressListUl.querySelector(`.actress-item[data-id="${actress.id}"]`); if(mainListItem) { mainListItem.click(); mainListItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); } });
                        containerElement.appendChild(li);
                    }
                });
            } catch (error) { console.error("Erro ao carregar atrizes para o modal:", error); containerElement.innerHTML = '<div class="error">Erro ao carregar atrizes.</div>'; }
        }
        async function loadScenesForModal(sceneIds, containerElement) {
            if (!containerElement || !sceneIds || sceneIds.length === 0) { if(containerElement) containerElement.innerHTML = ''; return; }
            containerElement.innerHTML = '';
             try {
                const idsToFetch = sceneIds.filter(id => !allScenesCache.has(id));
                if (idsToFetch.length > 0) {
                     const MAX_IN_QUERY_SIZE = 30;
                     for (let i = 0; i < idsToFetch.length; i += MAX_IN_QUERY_SIZE) {
                         const chunkIds = idsToFetch.slice(i, i + MAX_IN_QUERY_SIZE); const q = query(collection(db, "cenas"), where(documentId(), 'in', chunkIds)); const querySnapshot = await getDocs(q);
                         querySnapshot.forEach(docSnap => { allScenesCache.set(docSnap.id, docSnap.data()); });
                     }
                }
                 const scenesData = sceneIds.map(id => ({ id, ...allScenesCache.get(id) })).filter(scene => scene.nome);
                 scenesData.sort((a, b) => (a.numero || 0) - (b.numero || 0) || (a.nome || '').localeCompare(b.nome || ''));
                 scenesData.forEach(scene => {
                     const card = document.createElement('div'); card.classList.add('modal-scene-card'); card.dataset.id = scene.id; card.dataset.type = 'scene';
                     let imageUrl = scene.imagem || 'placeholder.png'; if (typeof imageUrl === 'object' && imageUrl !== null && imageUrl.width) { const urlKey = Object.keys(imageUrl).find(k=>typeof imageUrl[k]==='string'&&imageUrl[k].startsWith('http')); imageUrl = urlKey ? imageUrl[urlKey] : 'placeholder.png'; } else if (typeof imageUrl !== 'string' || !imageUrl) { imageUrl = 'placeholder.png'; }
                     card.innerHTML = `<img src="${imageUrl}" alt="${scene.nome}" onerror="this.src='placeholder.png';"><div class="title">${scene.numero ? `Cena ${scene.numero}: ` : ''}${scene.nome || 'Sem Título'}</div>`;
                     card.addEventListener('click', (e) => { e.stopPropagation(); closeModal(); showContentDetails('scene', scene.id); });
                     containerElement.appendChild(card);
                 });
             } catch (error) { console.error("Erro ao carregar cenas para o modal:", error); containerElement.innerHTML = '<div class="error">Erro ao carregar cenas.</div>'; }
        }
        window.closeModal = function() { if (contentModal) contentModal.style.display = 'none'; };

        // --- Movable Actress Popup Functions ---
        function createActressPopup(actressId, contextActressIds = []) { console.log("Placeholder: createActressPopup called for", actressId); }
        function populateActressPopup(popupElement, data) { console.log("Placeholder: populateActressPopup"); }
        function makeDraggable(element) { console.log("Placeholder: makeDraggable"); }

        // --- Comparison Modal Functions ---
        function openComparisonModal(initialActressIds = []) {
            if (!comparisonModal) return;
            const validInitialIds = new Set(actressesToCompare.map(a => a.id));
            initialActressIds.forEach(id => { if (allActressesData.some(a => a.id === id)) { validInitialIds.add(id); } });
            actressesToCompare = allActressesData.filter(a => validInitialIds.has(a.id));
            comparisonContextActressIds = [...validInitialIds];
            if(comparisonSearchInput) comparisonSearchInput.value = '';
            if(comparisonSuggestionsList) comparisonSuggestionsList.style.display = 'none';
            renderComparisonView(); comparisonModal.style.display = 'flex'; comparisonSearchInput?.focus();
        }
        window.closeComparisonModal = function() { if (comparisonModal) comparisonModal.style.display = 'none'; };

        function displayComparisonSuggestions(searchTerm) {
             if (!comparisonSuggestionsList || !comparisonSearchInput) return;
             const term = searchTerm.trim().toLowerCase(); comparisonSuggestionsList.innerHTML = '';
             if (!term) { comparisonSuggestionsList.style.display = 'none'; return; }
             const alreadyComparingIds = actressesToCompare.map(a => a.id);
             const filteredActresses = allActressesData.filter(actress => !alreadyComparingIds.includes(actress.id) && (actress.nome || '').toLowerCase().includes(term)).slice(0, 10);
             if (filteredActresses.length > 0) {
                 filteredActresses.forEach(actress => {
                     const item = document.createElement('div'); item.classList.add('suggestion-item');
                     item.innerHTML = `<img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';"><span>${actress.nome}</span>`;
                     item.addEventListener('click', () => handleSelectActressForComparison(actress.id)); comparisonSuggestionsList.appendChild(item);
                 });
             } else { const noResults = document.createElement('div'); noResults.classList.add('suggestion-item', 'no-results'); noResults.textContent = 'Nenhuma atriz encontrada'; comparisonSuggestionsList.appendChild(noResults); }
             comparisonSuggestionsList.style.display = 'block';
        }

        function handleSelectActressForComparison(actressId) {
             if (!actressId) return;
             const actressData = allActressesData.find(a => a.id === actressId);
             if (actressData && !actressesToCompare.some(a => a.id === actressId)) {
                 actressesToCompare.push(actressData); renderComparisonView();
                 if (comparisonSearchInput) comparisonSearchInput.value = ''; if (comparisonSuggestionsList) comparisonSuggestionsList.style.display = 'none'; comparisonSearchInput?.focus();
             }
        }

        function removeActressFromComparison(actressIdToRemove) { actressesToCompare = actressesToCompare.filter(a => a.id !== actressIdToRemove); renderComparisonView(); comparisonSearchInput?.focus(); }

        function renderComparisonView() {
            if (!comparisonModalBody || !comparisonPlaceholder) return;
            comparisonModalBody.innerHTML = '';
            if (actressesToCompare.length === 0) { comparisonPlaceholder.style.display = 'block'; comparisonModalBody.appendChild(comparisonPlaceholder); return; }
            comparisonPlaceholder.style.display = 'none';
            const comparedData = actressesToCompare.map(actress => ({ id: actress.id, data: actress, scores: { overall: 0 } }));
            const fieldsToCompare = [
                 { key: 'foto', label: 'Foto', type: 'image' }, { key: 'nome', label: 'Nome', type: 'string' },
                 { key: 'age', label: 'Idade', type: 'number', highlight: true, scoreWeight: 0 }, { key: 'altura', label: 'Altura (cm)', type: 'number', highlight: true, scoreWeight: 0 },
                 { key: 'peso', label: 'Peso (kg)', type: 'number', highlight: true, scoreWeight: 0 }, { key: 'Boobs', label: 'Boobs', type: 'number', highlight: true, scoreWeight: 1 },
                 { key: 'Waist', label: 'Waist', type: 'number', highlight: true, scoreWeight: 1 }, { key: 'Ass', label: 'Ass', type: 'number', highlight: true, scoreWeight: 1 },
                 { key: 'nota', label: 'Nota', type: 'number', highlight: true, scoreWeight: 2 }, { key: 'pais', label: 'País', type: 'string' }, { key: 'etnia', label: 'Etnia', type: 'string' },
             ];
             let totalScoreWeight = 0;
             fieldsToCompare.forEach(field => {
                 if (field.highlight || field.scoreWeight > 0) {
                    let values = [];
                    comparedData.forEach(item => {
                         let value = null;
                         if (field.key === 'age') { const age = calculateAge(item.data.dataNascimento); value = (age !== '?') ? age : null; }
                         else if (field.type === 'number') { value = safeParseInt(item.data[field.key]); }
                         if (value !== null) { values.push(value); }
                    });
                    field.min = values.length > 0 ? Math.min(...values) : null; field.max = values.length > 0 ? Math.max(...values) : null; field.range = (field.max !== null && field.min !== null) ? field.max - field.min : 0;
                    if (field.scoreWeight > 0 && field.range !== null) {
                         totalScoreWeight += field.scoreWeight;
                         comparedData.forEach(item => {
                             let value = null;
                              if (field.key === 'age') { const age = calculateAge(item.data.dataNascimento); value = (age !== '?') ? age : null; }
                              else if (field.type === 'number') { value = safeParseInt(item.data[field.key]); }
                             if (value !== null) { const normalized = (field.range > 0) ? (value - field.min) / field.range : (values.length === 1 ? 0.5 : 0); item.scores[field.key] = normalized * field.scoreWeight; item.scores.overall += item.scores[field.key]; }
                             else { item.scores[field.key] = 0; }
                         });
                    }
                 }
             });
             let winnerId = null; let maxOverallScore = -Infinity;
              if (totalScoreWeight > 0 && comparedData.length > 1) {
                  comparedData.forEach(item => { if (item.scores.overall > maxOverallScore) { maxOverallScore = item.scores.overall; winnerId = item.id; } });
                   const winners = comparedData.filter(item => Math.abs(item.scores.overall - maxOverallScore) < 0.001);
                   if (winners.length > 1) winnerId = null;
              }
            comparedData.forEach(item => {
                const actress = item.data; const column = document.createElement('div'); column.classList.add('comparison-column'); if (item.id === winnerId) { column.classList.add('comparison-winner'); }
                const removeBtn = document.createElement('button'); removeBtn.classList.add('remove-compare-btn'); removeBtn.title = `Remover ${actress.nome}`; removeBtn.textContent = '×'; removeBtn.onclick = () => removeActressFromComparison(actress.id); column.appendChild(removeBtn);
                const nameHeader = document.createElement('h4'); nameHeader.textContent = actress.nome || 'Nome Indisponível'; if (item.id === winnerId) { nameHeader.textContent += ' 🏆'; } column.appendChild(nameHeader);
                fieldsToCompare.forEach(field => {
                    const div = document.createElement('div'); let valueDisplay = ''; let value = null;
                    if (field.type === 'image') { valueDisplay = `<img src="${actress[field.key] || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';">`; div.innerHTML = valueDisplay; }
                    else {
                         if (field.key === 'age') { const age = calculateAge(actress.dataNascimento); value = (age !== '?') ? age : null; valueDisplay = age; }
                         else { value = actress[field.key]; valueDisplay = value != null ? String(value) : '-'; }
                         div.innerHTML = `<strong>${field.label}:</strong> `; const valueSpan = document.createElement('span'); valueSpan.textContent = valueDisplay;
                         if (comparedData.length > 1 && field.highlight && field.type === 'number' && value !== null && field.min !== null) {
                            const numericValue = (field.key === 'age') ? value : safeParseInt(value);
                            if (numericValue === field.max && field.min !== field.max) { valueSpan.classList.add('value-highest'); }
                            if (numericValue === field.min && field.min !== field.max) { valueSpan.classList.add('value-lowest'); }
                         } div.appendChild(valueSpan);
                    } column.appendChild(div);
                });
                 if (totalScoreWeight > 0) { const scoreDiv = document.createElement('div'); scoreDiv.innerHTML = `<strong>Score Geral:</strong> <span style="font-weight: bold; color: #0056b3;">${item.scores.overall.toFixed(2)}</span>`; scoreDiv.style.marginTop = '10px'; scoreDiv.style.paddingTop = '8px'; scoreDiv.style.borderTop = '1px dashed #ccc'; column.appendChild(scoreDiv); }
                comparisonModalBody.appendChild(column);
            });
        }

        // --- FAB and Create Menu/Modal Functions ---
        function toggleCreateMenu() { if (createMenuPopup) { const isVisible = createMenuPopup.style.display === 'block'; createMenuPopup.style.display = isVisible ? 'none' : 'block'; } }
        function closeCreateMenu() { if (createMenuPopup) createMenuPopup.style.display = 'none'; }

        // --- Create Actress Modal Functions (Integrated) ---
        function getCreateActressFormHTML() {
             return `
               <form id="create-actress-form" novalidate>
                    <div class="form-card full-width"> <label for="name">Name:</label> <input type="text" id="name" name="name" required> <span id="name-error-message" class="error-message" style="display: none;"></span> </div>
                    <div class="form-row-flex"> <div class="form-card"> <label for="nota">Nota (0 a 10):</label> <input type="number" id="nota" name="nota" min="0" max="10" step="0.1" placeholder="Ex: 8.5"> <span id="actress-nota-error" class="error-message"></span> </div> <div class="form-card"> <label for="casta">Casta:</label> <select id="casta" name="casta"> <option value="">Selecione...</option> <option value="Panqueca">Panqueca</option> <option value="Melancia">Melancia</option> <option value="Melao">Melão</option> <option value="Tabua">Tabua</option> </select> <span id="actress-casta-error" class="error-message"></span> </div> </div>
                    <div class="form-card"> <label for="foto">Foto (URL):</label> <input type="url" id="foto" name="foto" placeholder="https://exemplo.com/imagem.jpg"> <span id="actress-foto-error" class="error-message"></span> </div>
                    <div class="form-card"> <label for="born">Born (Ex: 1990/05/15):</label> <input type="text" id="born" name="born" placeholder="YYYY/MM/DD"> <span id="actress-dataNascimento-error" class="error-message"></span> </div>
                    <div class="form-card"> <label for="birthplace">Birthplace (País):</label> <input type="text" id="birthplace" name="birthplace"> </div>
                    <div class="form-card"> <label for="ethnicity">Ethnicity:</label> <input type="text" id="ethnicity" name="ethnicity"> </div>
                    <div class="form-card"> <label for="hair_color">Hair color:</label> <input type="text" id="hair_color" name="hair_color"> </div>
                    <div class="form-card"> <label for="eye_color">Eye color:</label> <input type="text" id="eye_color" name="eye_color"> </div>
                    <div class="form-card"> <label for="height">Height (cm):</label> <input type="text" id="height" name="height" placeholder="Ex: 170"> </div>
                    <div class="form-card"> <label for="weight">Weight (kg):</label> <input type="text" id="weight" name="weight" placeholder="Ex: 59"> </div>
                    <div class="form-card"> <label for="body_type">Body type:</label> <input type="text" id="body_type" name="body_type"> </div>
                    <div class="form-card"> <label for="measurements">Measurements (Ex: 86.36-66.04-96.52):</label> <input type="text" id="measurements" name="measurements"> </div>
                    <div class="form-card"> <label for="years_active">Years active (Start Year):</label> <input type="text" id="years_active" name="years_active" placeholder="Ex: 2010"> </div>
                     <div class="form-card full-width"> <div id="create-actress-form-message" class="error-message" style="text-align: left; margin-bottom: 10px;"></div> </div>
                </form> <div class="submit-button-container"> <button type="submit" id="create-actress-submit-button" form="create-actress-form">Criar Atriz</button> </div>`;
        }
        function openCreateActressModal() {
            closeCreateMenu(); if (!createActressModal || !createActressModalBody) return;
            createActressModalBody.innerHTML = getCreateActressFormHTML();
            createActressForm = document.getElementById('create-actress-form');
            actressNameInput = document.getElementById('name');
            actressNameErrorMessage = document.getElementById('name-error-message');
            actressSubmitButton = document.getElementById('create-actress-submit-button');
             const formMessage = document.getElementById('create-actress-form-message');
             if(formMessage) formMessage.textContent = ''; if(actressNameErrorMessage) { actressNameErrorMessage.textContent = ''; actressNameErrorMessage.style.display = 'none'; actressNameErrorMessage.className = 'error-message'; } if(actressSubmitButton) actressSubmitButton.disabled = false;
            if (createActressForm) { createActressForm.removeEventListener('submit', handleCreateActressSubmit); createActressForm.addEventListener('submit', handleCreateActressSubmit); }
            if (actressNameInput) {
                debouncedActressNameCheck = debounce(checkNameExists, 500); debouncedFetchApiData = debounce(fetchActressDataFromAPI, 700);
                actressNameInput.removeEventListener('input', debouncedActressNameCheck); actressNameInput.removeEventListener('blur', checkNameExists); actressNameInput.removeEventListener('blur', debouncedFetchApiData);
                actressNameInput.addEventListener('input', debouncedActressNameCheck); actressNameInput.addEventListener('blur', () => { checkNameExists(); debouncedFetchApiData(); });
            }
            createActressModal.style.display = 'flex'; actressNameInput?.focus();
        }
        
        async function handleCreateActressSubmit(event) {
            event.preventDefault();
            if (!createActressForm || !actressSubmitButton || !actressNameInput) return;

            const formMessage = document.getElementById('create-actress-form-message');
            if (formMessage) formMessage.textContent = '';
            if (actressNameErrorMessage && !actressNameErrorMessage.classList.contains('api-feedback')) { actressNameErrorMessage.style.display = 'none'; }
            if (actressSubmitButton.disabled) { if (actressNameErrorMessage && actressNameErrorMessage.style.display === 'block' && actressNameErrorMessage.classList.contains('error')) { alert('Não é possível criar: ' + actressNameErrorMessage.textContent); } else { alert('Aguarde a verificação ou corrija o erro.'); } return; }

            const initialButtonText = 'Criar Atriz';
            actressSubmitButton.disabled = true; actressSubmitButton.textContent = 'Verificando...';
            const formData = new FormData(createActressForm);
            const enteredName = formData.get('name')?.trim();

            if (!enteredName) {
                alert('O campo "Name" é obrigatório.'); if (actressNameErrorMessage) { actressNameErrorMessage.textContent = 'O campo "Name" é obrigatório.'; actressNameErrorMessage.className = 'error-message error'; actressNameErrorMessage.style.display = 'block'; }
                actressSubmitButton.disabled = false; actressSubmitButton.textContent = initialButtonText; return;
            }

            try {
                const finalCheckQuery = query(collection(db, "atores"), where("nome", "==", enteredName), limit(1)); const finalSnapshot = await getDocs(finalCheckQuery);
                if (!finalSnapshot.empty) { if (actressNameErrorMessage) { actressNameErrorMessage.textContent = `O nome "${enteredName}" já existe no Firebase.`; actressNameErrorMessage.className = 'error-message error'; actressNameErrorMessage.style.display = 'block'; } alert(`Já existe uma atriz com o nome "${enteredName}" no Firebase.`); actressSubmitButton.textContent = initialButtonText; return; }

                actressSubmitButton.textContent = 'Salvando...';
                const firestoreData = formDataToObject(formData); // Use corrected helper
                firestoreData.nome = firestoreData.nome || 'Nome Indisponível';
                firestoreData.timestamp = serverTimestamp(); firestoreData.createdAt = serverTimestamp();

                const docRef = await addDoc(collection(db, "atores"), firestoreData);
                const newActressForCache = { ...firestoreData, id: docRef.id, createdAt: new Date() };
                if (newActressForCache.nota !== undefined && typeof newActressForCache.nota !== 'number') { newActressForCache.nota = parseFloat(newActressForCache.nota); if(isNaN(newActressForCache.nota)) delete newActressForCache.nota; }
                if (newActressForCache.overall !== undefined && typeof newActressForCache.overall !== 'number') { newActressForCache.overall = parseFloat(newActressForCache.overall); if(isNaN(newActressForCache.overall)) newActressForCache.overall = 0; } // Ensure overall is number

                allActressesData.push(newActressForCache);
                allActressesData.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                filterAndRenderActressList();
                alert('Atriz criada com sucesso!'); closeCreateActressModal();
            } catch (error) { console.error("Erro ao salvar atriz: ", error); if (formMessage) formMessage.textContent = `Erro ao salvar: ${error.message}`; alert(`Erro ao salvar: ${error.message}`); actressSubmitButton.disabled = false; actressSubmitButton.textContent = initialButtonText; }
        }

        window.closeCreateActressModal = function() { if (createActressModal) createActressModal.style.display = 'none'; createActressForm = null; actressNameInput = null; actressNameErrorMessage = null; actressSubmitButton = null; debouncedActressNameCheck = null; debouncedFetchApiData = null; };

        // --- Multimedia Creation Functions ---
        function openPasteTextModal() {
            closeCreateMenu(); if (!pasteTextModal || !pasteTextArea || !pasteAnalysisResult || !analyzePasteButton) return;
            pasteTextArea.value = ''; pasteAnalysisResult.textContent = ''; pasteAnalysisResult.className = '';
            analyzePasteButton.disabled = false; analyzePasteButton.onclick = analyzePastedText; analyzePasteButton.textContent = 'Analisar e Criar';
            pasteTextModal.style.display = 'flex'; pasteTextArea.focus();
        }
        window.closePasteTextModal = function() { if (pasteTextModal) pasteTextModal.style.display = 'none'; }
        async function analyzePastedText() {
            if (!pasteTextArea || !pasteAnalysisResult || !analyzePasteButton) return;
            const text = pasteTextArea.value.trim(); pasteAnalysisResult.textContent = ''; pasteAnalysisResult.className = ''; analyzePasteButton.disabled = true; analyzePasteButton.textContent = 'Analisando...';
            if (!text) { pasteAnalysisResult.textContent = 'Por favor, cole algum texto.'; pasteAnalysisResult.className = 'error'; analyzePasteButton.disabled = false; analyzePasteButton.textContent = 'Analisar e Criar'; return; }
            const firstWord = text.split(/[\s:]+/)[0].toLowerCase(); const containsMovieTag = /^\s*Movie:/im.test(text);
            if (firstWord === 'scene') {
                if (containsMovieTag) {
                    pasteAnalysisResult.textContent = 'Detectado: Cena (com filme). Extraindo dados...'; const sceneData = extractSceneDataFromText(text);
                    if (sceneData?.nome) { console.log("Extracted Scene Data:", sceneData); closePasteTextModal(); try { await openCreateSceneModal(sceneData); } catch (error) { console.error("Error opening Create Scene Modal:", error); alert("Erro ao tentar abrir o formulário de Cena."); } }
                    else { pasteAnalysisResult.textContent = 'Erro ao extrair dados da Cena.'; pasteAnalysisResult.className = 'error'; analyzePasteButton.disabled = false; analyzePasteButton.textContent = 'Analisar e Criar'; }
                } else {
                    pasteAnalysisResult.textContent = 'Detectado: Vídeo (sem filme). Extraindo dados...'; const videoData = extractVideoDataFromText(text);
                    if (videoData?.nome) { console.log("Extracted Video Data:", videoData); closePasteTextModal(); try { await openCreateVideoModal(videoData); } catch (error) { console.error("Error opening Create Video Modal:", error); alert("Erro ao tentar abrir o formulário de Vídeo."); } }
                    else { pasteAnalysisResult.textContent = 'Erro ao extrair dados do Vídeo.'; pasteAnalysisResult.className = 'error'; analyzePasteButton.disabled = false; analyzePasteButton.textContent = 'Analisar e Criar'; }
                }
            } else if (firstWord === 'movie') {
                pasteAnalysisResult.textContent = 'Detectado: Filme. Extraindo dados...'; const movieData = extractMovieDataFromText(text);
                if (movieData?.nome) { console.log("Extracted Movie Data:", movieData); closePasteTextModal(); try { openCreateMovieModal(movieData); } catch (error) { console.error("Error opening Create Movie Modal:", error); alert("Erro ao tentar abrir o formulário de Filme."); } }
                else { pasteAnalysisResult.textContent = 'Erro ao extrair dados do Filme.'; pasteAnalysisResult.className = 'error'; analyzePasteButton.disabled = false; analyzePasteButton.textContent = 'Analisar e Criar'; }
            } else { pasteAnalysisResult.textContent = "Formato não reconhecido."; pasteAnalysisResult.className = 'error'; analyzePasteButton.disabled = false; analyzePasteButton.textContent = 'Analisar e Criar'; }
             if (pasteTextModal && pasteTextModal.style.display === 'flex') { analyzePasteButton.disabled = false; analyzePasteButton.textContent = 'Analisar e Criar'; }
        }
        function extractSceneDataFromText(text) { /* ... (no change, assuming correct) ... */ const data = { potentialActorNames: [], dataRaw: null, movieName: null, nome: null }; const lines = text.split('\n'); let actorsLineFound = false; lines.forEach(line => { const trimmedLine = line.trim(); if (trimmedLine.startsWith('Scene:')) data.nome = trimmedLine.substring(6).trim(); else if (trimmedLine.startsWith('Date:')) data.dataRaw = trimmedLine.substring(5).trim(); else if (trimmedLine.startsWith('Movie:')) data.movieName = trimmedLine.substring(6).trim(); else if (trimmedLine.startsWith('Actors:') || trimmedLine.startsWith('Actor:')) { const actorsString = trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim(); data.potentialActorNames = actorsString.split(',').map(name => name.trim()).filter(name => name); actorsLineFound = true; } else if (data.nome && !actorsLineFound && !data.dataRaw && !data.movieName && /^[a-zA-Z\s,-]+$/.test(trimmedLine) && trimmedLine.includes(',')) { data.potentialActorNames = trimmedLine.split(',').map(name => name.trim()).filter(name => name); } }); return data; }
        function extractMovieDataFromText(text) { /* ... (no change, assuming correct) ... */  const data = { nome: null }; const lines = text.split('\n'); lines.forEach(line => { const trimmedLine = line.trim(); if (trimmedLine.startsWith('Movie:')) data.nome = trimmedLine.substring(6).trim(); else if (trimmedLine.startsWith('Year:')) data.ano = trimmedLine.substring(5).trim(); else if (trimmedLine.startsWith('Studio:')) data.estudio = trimmedLine.substring(7).trim(); else if (trimmedLine.startsWith('Duration:')) data.duracao = trimmedLine.substring(9).trim(); }); return data; }
        function extractVideoDataFromText(text) { /* ... (no change, assuming correct) ... */ const data = { potentialActorNames: [], dataRaw: null, nome: null }; const lines = text.split('\n'); let actorsLineFound = false; lines.forEach(line => { const trimmedLine = line.trim(); if (trimmedLine.startsWith('Scene:') || trimmedLine.startsWith('Video:')) { data.nome = trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim(); } else if (trimmedLine.startsWith('Date:')) data.dataRaw = trimmedLine.substring(5).trim(); else if (trimmedLine.startsWith('Studio:')) data.estudio = trimmedLine.substring(7).trim(); else if (trimmedLine.startsWith('Actors:') || trimmedLine.startsWith('Actor:')) { const actorsString = trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim(); data.potentialActorNames = actorsString.split(',').map(name => name.trim()).filter(name => name); actorsLineFound = true; } else if (data.nome && !actorsLineFound && !data.dataRaw && /^[a-zA-Z\s,-]+$/.test(trimmedLine) && trimmedLine.includes(',')) { data.potentialActorNames = trimmedLine.split(',').map(name => name.trim()).filter(name => name); } }); return data; }
        function generateMovieNameVariations(name) { /* ... (no change) ... */  if (!name) return []; const variations = new Set([name, name.toLowerCase(), name.toUpperCase()]); const noPunctuation = name.replace(/[.,!?;:'"-]/g, '').replace(/\s+/g, ' ').trim(); if (noPunctuation !== name) { variations.add(noPunctuation); variations.add(noPunctuation.toLowerCase()); variations.add(noPunctuation.toUpperCase());} const titleCase = name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); variations.add(titleCase); return Array.from(variations).filter(v => v); }
        async function findMovieIdByName(movieName) { /* ... (no change) ... */  if (!movieName) return null; const nameVariations = generateMovieNameVariations(movieName); const priorityVariations = [movieName, movieName.toLowerCase(), movieName.toUpperCase()].filter(v => v); const otherVariations = nameVariations.filter(v => !priorityVariations.includes(v)); try { if (priorityVariations.length > 0) { const movieQuery = query(collection(db, "filmes"), where("nome", "in", priorityVariations.slice(0, 30)), limit(1)); const querySnapshot = await getDocs(movieQuery); if (!querySnapshot.empty) { const foundDoc = querySnapshot.docs[0]; return { id: foundDoc.id, nome: foundDoc.data().nome }; } } const MAX_IN_QUERY_SIZE = 30; for (let i = 0; i < otherVariations.length; i += MAX_IN_QUERY_SIZE) { const chunkVariations = otherVariations.slice(i, i + MAX_IN_QUERY_SIZE); if(chunkVariations.length === 0) continue; const movieQuery = query(collection(db, "filmes"), where("nome", "in", chunkVariations), limit(1)); const querySnapshot = await getDocs(movieQuery); if (!querySnapshot.empty) { const foundDoc = querySnapshot.docs[0]; return { id: foundDoc.id, nome: foundDoc.data().nome }; } } return null; } catch (error) { console.error("Error searching for movie:", error); return null; } }
        async function findActorByName(actorName) { /* ... (no change) ... */  if (!actorName) return null; const trimmedName = actorName.trim(); let actorQuery = query(collection(db, "atores"), where("nome", "==", trimmedName), limit(1)); try { let querySnapshot = await getDocs(actorQuery); if (!querySnapshot.empty) { const doc = querySnapshot.docs[0]; return { id: doc.id, nome: doc.data().nome, foto: doc.data().foto }; } const variations = [trimmedName.toLowerCase(), trimmedName.toUpperCase()]; if(variations[0] !== trimmedName && variations[1] !== trimmedName) { actorQuery = query(collection(db, "atores"), where("nome", "in", variations), limit(1)); querySnapshot = await getDocs(actorQuery); if (!querySnapshot.empty) { const doc = querySnapshot.docs[0]; return { id: doc.id, nome: doc.data().nome, foto: doc.data().foto }; } } return null; } catch (error) { console.error(`Error searching for actor "${trimmedName}":`, error); return null; } }

        // --- Create Scene Modal ---
        window.closeCreateSceneModal = function() { if(createSceneModal) createSceneModal.style.display = 'none'; }
        async function openCreateSceneModal(sceneData = {}) { /* ... (no change) ... */ closeCreateMenu(); if (!createSceneModal || !createSceneForm) return; createSceneForm.reset(); selectedSceneActors = []; renderSceneActorPills(); clearFormMessages([ createSceneFormMessage, createSceneForm.querySelector('#scene-nome-error'), createSceneForm.querySelector('#scene-data-error'), createSceneForm.querySelector('#scene-filme-error'), createSceneForm.querySelector('#scene-imagem-error'), createSceneForm.querySelector('#scene-pagina-error'), createSceneForm.querySelector('#scene-atores-error') ]); if(createSceneSubmitButton) createSceneSubmitButton.disabled = false; if (sceneData.nome && sceneNomeInput) sceneNomeInput.value = sceneData.nome; if (sceneData.dataRaw && sceneDataInput) sceneDataInput.value = formatDateString(sceneData.dataRaw) || sceneData.dataRaw; if (sceneMovieDisplay) sceneMovieDisplay.textContent = 'Procurando filme...'; sceneMovieDisplay.className = 'info-display loading'; if (sceneFilmeIdInput) sceneFilmeIdInput.value = ''; if (sceneData.movieName) { const movieResult = await findMovieIdByName(sceneData.movieName); if (movieResult) { if (sceneMovieDisplay) { sceneMovieDisplay.textContent = `Filme: ${movieResult.nome}`; sceneMovieDisplay.className = 'info-display found';} if (sceneFilmeIdInput) sceneFilmeIdInput.value = movieResult.id; } else { if (sceneMovieDisplay) { sceneMovieDisplay.textContent = `Filme "${sceneData.movieName}" não encontrado. Será criado se a cena for salva.`; sceneMovieDisplay.className = 'info-display not-found'; } } } else { if (sceneMovieDisplay) { sceneMovieDisplay.textContent = 'Nenhum filme associado no texto.'; sceneMovieDisplay.className = 'info-display'; } } if (sceneData.potentialActorNames && sceneData.potentialActorNames.length > 0) { for (const name of sceneData.potentialActorNames) { const actor = await findActorByName(name); if (actor && !selectedSceneActors.some(a => a.id === actor.id)) { selectedSceneActors.push(actor); } } renderSceneActorPills(); } createSceneModal.style.display = 'flex'; sceneNomeInput?.focus(); }
        async function handleCreateSceneSubmit(event) { /* ... (no change) ... */ event.preventDefault(); if (!createSceneForm || !createSceneSubmitButton) return; createSceneSubmitButton.disabled = true; createSceneSubmitButton.textContent = 'Salvando...'; if(createSceneFormMessage) createSceneFormMessage.textContent = ''; const formData = new FormData(createSceneForm); const sceneName = formData.get('scene-nome')?.trim(); const sceneDate = formData.get('scene-data')?.trim(); const sceneNumber = formData.get('scene-numero')?.trim(); const sceneImage = formData.get('scene-imagem')?.trim(); const scenePage = formData.get('scene-pagina')?.trim(); let sceneMovieId = formData.get('scene-filme-id')?.trim(); const sceneActors = selectedSceneActors.map(a => a.id); let isValid = true; const nomeError = createSceneForm.querySelector('#scene-nome-error'); const dateError = createSceneForm.querySelector('#scene-data-error'); const actorsError = createSceneForm.querySelector('#scene-atores-error'); const movieErrorEl = createSceneForm.querySelector('#scene-filme-error'); clearFormMessages([nomeError, dateError, actorsError, movieErrorEl, createSceneFormMessage]); if (!sceneName) { isValid = false; if(nomeError) nomeError.textContent = 'Nome da cena é obrigatório.'; } if (sceneDate && !/^\d{4}[/-]\d{1,2}[/-]\d{1,2}$/.test(sceneDate)) { isValid = false; if(dateError) dateError.textContent = 'Formato de data inválido (use YYYY/MM/DD).'; } if (sceneActors.length === 0) { isValid = false; if(actorsError) actorsError.textContent = 'Selecione pelo menos um ator.'; } if (!isValid) { createSceneSubmitButton.disabled = false; createSceneSubmitButton.textContent = 'Salvar Cena'; return; } const movieNotFoundDisplay = sceneMovieDisplay?.classList.contains('not-found'); const movieNameToCreate = movieNotFoundDisplay ? sceneMovieDisplay.textContent.match(/Filme "(.*?)" não encontrado/)?.[1] : null; if (movieNotFoundDisplay && movieNameToCreate && !sceneMovieId) { try { const movieData = { nome: movieNameToCreate, cenas: [] }; const movieDocRef = await addDoc(collection(db, "filmes"), movieData); sceneMovieId = movieDocRef.id; if (sceneMovieDisplay) { sceneMovieDisplay.textContent = `Filme: ${movieNameToCreate}`; sceneMovieDisplay.className = 'info-display found';} if (sceneFilmeIdInput) sceneFilmeIdInput.value = sceneMovieId; } catch (movieError) { if(movieErrorEl) movieErrorEl.textContent = `Erro ao criar filme "${movieNameToCreate}": ${movieError.message}`; createSceneSubmitButton.disabled = false; createSceneSubmitButton.textContent = 'Salvar Cena'; return; } } const sceneFirestoreData = { nome: sceneName, atores: sceneActors, timestamp: serverTimestamp() }; if (sceneDate) sceneFirestoreData.data = sceneDate; if (sceneNumber) sceneFirestoreData.numero = parseInt(sceneNumber, 10); if (sceneImage) sceneFirestoreData.imagem = sceneImage; if (scenePage) sceneFirestoreData.pagina = scenePage; if (sceneMovieId) sceneFirestoreData.filmeId = sceneMovieId; try { const sceneDocRef = await addDoc(collection(db, "cenas"), sceneFirestoreData); const newSceneId = sceneDocRef.id; allScenesCache.set(newSceneId, sceneFirestoreData); if (sceneMovieId) { try { const movieRef = doc(db, "filmes", sceneMovieId); await updateDoc(movieRef, { cenas: arrayUnion(newSceneId) }); } catch (updateError) { console.error(`Erro ao atualizar filme ${sceneMovieId} com nova cena:`, updateError); } } alert('Cena salva com sucesso!'); closeCreateSceneModal(); if (currentMainActressId && sceneActors.includes(currentMainActressId)) { handleMainActressClick(currentMainActressId, selectedMainActressElement); } } catch (sceneError) { if(createSceneFormMessage) createSceneFormMessage.textContent = `Erro ao salvar cena: ${sceneError.message}`; createSceneSubmitButton.disabled = false; createSceneSubmitButton.textContent = 'Salvar Cena'; } }
        function displaySceneActorSuggestions(searchTerm) { /* ... (no change) ... */ if (!sceneActorsSuggestionsList || !sceneActorsSearchInput) return; const term = searchTerm.trim().toLowerCase(); sceneActorsSuggestionsList.innerHTML = ''; if (!term) { sceneActorsSuggestionsList.style.display = 'none'; return; } const alreadySelectedIds = selectedSceneActors.map(a => a.id); const filteredActresses = allActressesData.filter(actress => !alreadySelectedIds.includes(actress.id) && (actress.nome || '').toLowerCase().includes(term) ).slice(0, 10); if (filteredActresses.length > 0) { filteredActresses.forEach(actress => { const item = document.createElement('div'); item.classList.add('suggestion-item'); item.innerHTML = `<img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';"> <span>${actress.nome}</span>`; item.addEventListener('click', () => handleSelectSceneActor(actress)); sceneActorsSuggestionsList.appendChild(item); }); } else { const noResults = document.createElement('div'); noResults.classList.add('suggestion-item', 'no-results'); noResults.textContent = 'Nenhuma atriz encontrada'; sceneActorsSuggestionsList.appendChild(noResults); } sceneActorsSuggestionsList.style.display = 'block'; }
        function handleSelectSceneActor(actress) { /* ... (no change) ... */ if (!actress || !actress.id) return; if (!selectedSceneActors.some(a => a.id === actress.id)) { selectedSceneActors.push(actress); renderSceneActorPills(); if (sceneActorsSearchInput) sceneActorsSearchInput.value = ''; if (sceneActorsSuggestionsList) sceneActorsSuggestionsList.style.display = 'none'; sceneActorsSearchInput?.focus(); } }
        function renderSceneActorPills() { /* ... (no change) ... */ if (!sceneSelectedActorsContainer) return; sceneSelectedActorsContainer.innerHTML = ''; selectedSceneActors.forEach(actress => { const pill = document.createElement('div'); pill.classList.add('scene-actor-pill'); pill.dataset.id = actress.id; pill.innerHTML = `<span>${actress.nome}</span> <button type="button" class="scene-remove-actor-btn" title="Remover ${actress.nome}">×</button>`; pill.querySelector('.scene-remove-actor-btn').addEventListener('click', handleRemoveSceneActor); sceneSelectedActorsContainer.appendChild(pill); }); }
        function handleRemoveSceneActor(event) { /* ... (no change) ... */ const button = event.target; const pill = button.closest('.scene-actor-pill'); if (pill && pill.dataset.id) { const actressIdToRemove = pill.dataset.id; selectedSceneActors = selectedSceneActors.filter(a => a.id !== actressIdToRemove); renderSceneActorPills(); } }

        // --- Create Movie Modal ---
        window.closeCreateMovieModal = function() { if(createMovieModal) createMovieModal.style.display = 'none'; }
        function openCreateMovieModal(movieData = {}) { /* ... (no change) ... */ closeCreateMenu(); if (!createMovieModal || !createMovieForm) return; createMovieForm.reset(); clearFormMessages([ createMovieFormMessage, createMovieForm.querySelector('#movie-nome-error'), createMovieForm.querySelector('#movie-ano-error'), createMovieForm.querySelector('#movie-imagem-error'), createMovieForm.querySelector('#movie-pagina-error') ]); if(createMovieSubmitButton) createMovieSubmitButton.disabled = false; if (movieData.nome && movieNomeInput) movieNomeInput.value = movieData.nome; if (movieData.ano && movieAnoInput) movieAnoInput.value = movieData.ano; if (movieData.estudio && movieEstudioInput) movieEstudioInput.value = movieData.estudio; if (movieData.duracao && movieDuracaoInput) movieDuracaoInput.value = movieData.duracao; createMovieModal.style.display = 'flex'; movieNomeInput?.focus(); }
        async function handleCreateMovieSubmit(event) { /* ... (no change) ... */ event.preventDefault(); if (!createMovieForm || !createMovieSubmitButton) return; createMovieSubmitButton.disabled = true; createMovieSubmitButton.textContent = 'Salvando...'; if(createMovieFormMessage) createMovieFormMessage.textContent = ''; const formData = new FormData(createMovieForm); const movieName = formData.get('movie-nome')?.trim(); const movieYear = formData.get('movie-ano')?.trim(); const movieStudio = formData.get('movie-estudio')?.trim(); const movieDuration = formData.get('movie-duracao')?.trim(); const movieImage = formData.get('movie-imagem')?.trim(); const moviePage = formData.get('movie-pagina')?.trim(); let isValid = true; const nomeError = createMovieForm.querySelector('#movie-nome-error'); const yearError = createMovieForm.querySelector('#movie-ano-error'); clearFormMessages([nomeError, yearError, createMovieFormMessage]); if (!movieName) { isValid = false; if(nomeError) nomeError.textContent = 'Nome do filme é obrigatório.'; } if (movieYear && (!/^\d{4}$/.test(movieYear) || parseInt(movieYear) < 1900 || parseInt(movieYear) > new Date().getFullYear() + 5 )) { isValid = false; if(yearError) yearError.textContent = 'Ano inválido.'; } if (!isValid) { createMovieSubmitButton.disabled = false; createMovieSubmitButton.textContent = 'Salvar Filme'; return; } const movieFirestoreData = { nome: movieName, cenas: [], timestamp: serverTimestamp() }; if (movieYear) movieFirestoreData.ano = parseInt(movieYear, 10); if (movieStudio) movieFirestoreData.estudio = movieStudio; if (movieDuration) movieFirestoreData.duracao = movieDuration; if (movieImage) movieFirestoreData.imagem = movieImage; if (moviePage) movieFirestoreData.pagina = moviePage; try { const movieDocRef = await addDoc(collection(db, "filmes"), movieFirestoreData); alert('Filme salvo com sucesso!'); closeCreateMovieModal(); } catch (movieError) { if(createMovieFormMessage) createMovieFormMessage.textContent = `Erro ao salvar filme: ${movieError.message}`; createMovieSubmitButton.disabled = false; createMovieSubmitButton.textContent = 'Salvar Filme'; } }

        // --- Create Video Modal ---
        window.closeCreateVideoModal = function() { if(createVideoModal) createVideoModal.style.display = 'none'; }
        async function openCreateVideoModal(videoData = {}) { /* ... (no change) ... */ closeCreateMenu(); if (!createVideoModal || !createVideoForm) return; createVideoForm.reset(); selectedVideoActors = []; renderVideoActorPills(); clearFormMessages([ createVideoFormMessage, createVideoForm.querySelector('#video-nome-error'), createVideoForm.querySelector('#video-data-error'), createVideoForm.querySelector('#video-imagem-error'), createVideoForm.querySelector('#video-pagina-error'), createVideoForm.querySelector('#video-atores-error') ]); if(createVideoSubmitButton) createVideoSubmitButton.disabled = false; if (videoData.nome && videoNomeInput) videoNomeInput.value = videoData.nome; if (videoData.estudio && videoEstudioInput) videoEstudioInput.value = videoData.estudio; if (videoData.dataRaw && videoDataInput) videoDataInput.value = formatDateString(videoData.dataRaw) || videoData.dataRaw; if (videoData.potentialActorNames && videoData.potentialActorNames.length > 0) { for (const name of videoData.potentialActorNames) { const actor = await findActorByName(name); if (actor && !selectedVideoActors.some(a => a.id === actor.id)) { selectedVideoActors.push(actor); } } renderVideoActorPills(); } createVideoModal.style.display = 'flex'; videoNomeInput?.focus(); }
        async function handleCreateVideoSubmit(event) { /* ... (no change) ... */ event.preventDefault(); if (!createVideoForm || !createVideoSubmitButton) return; createVideoSubmitButton.disabled = true; createVideoSubmitButton.textContent = 'Salvando...'; if(createVideoFormMessage) createVideoFormMessage.textContent = ''; const formData = new FormData(createVideoForm); const videoName = formData.get('video-nome')?.trim(); const videoStudio = formData.get('video-estudio')?.trim(); const videoDate = formData.get('video-data')?.trim(); const videoImage = formData.get('video-imagem')?.trim(); const videoPage = formData.get('video-pagina')?.trim(); const videoActors = selectedVideoActors.map(a => a.id); let isValid = true; const nomeError = createVideoForm.querySelector('#video-nome-error'); const dateError = createVideoForm.querySelector('#video-data-error'); const actorsError = createVideoForm.querySelector('#video-atores-error'); clearFormMessages([nomeError, dateError, actorsError, createVideoFormMessage]); if (!videoName) { isValid = false; if(nomeError) nomeError.textContent = 'Nome do vídeo é obrigatório.'; } if (videoDate && !/^\d{4}[/-]\d{1,2}[/-]\d{1,2}$/.test(videoDate)) { isValid = false; if(dateError) dateError.textContent = 'Formato de data inválido (use YYYY/MM/DD).'; } if (videoActors.length === 0) { isValid = false; if(actorsError) actorsError.textContent = 'Selecione pelo menos um ator.'; } if (!isValid) { createVideoSubmitButton.disabled = false; createVideoSubmitButton.textContent = 'Salvar Vídeo'; return; } const videoFirestoreData = { nome: videoName, atores: videoActors, timestamp: serverTimestamp() }; if (videoStudio) videoFirestoreData.estudio = videoStudio; if (videoDate) videoFirestoreData.data = videoDate; if (videoImage) videoFirestoreData.imagem = videoImage; if (videoPage) videoFirestoreData.pagina = videoPage; try { const videoDocRef = await addDoc(collection(db, "videos"), videoFirestoreData); alert('Vídeo salvo com sucesso!'); closeCreateVideoModal(); if (currentMainActressId && videoActors.includes(currentMainActressId)) { handleMainActressClick(currentMainActressId, selectedMainActressElement); } } catch (videoError) { if(createVideoFormMessage) createVideoFormMessage.textContent = `Erro ao salvar vídeo: ${videoError.message}`; createVideoSubmitButton.disabled = false; createVideoSubmitButton.textContent = 'Salvar Vídeo'; } }
        function displayVideoActorSuggestions(searchTerm) { /* ... (no change) ... */ if (!videoActorsSuggestionsList || !videoActorsSearchInput) return; const term = searchTerm.trim().toLowerCase(); videoActorsSuggestionsList.innerHTML = ''; if (!term) { videoActorsSuggestionsList.style.display = 'none'; return; } const alreadySelectedIds = selectedVideoActors.map(a => a.id); const filteredActresses = allActressesData.filter(actress => !alreadySelectedIds.includes(actress.id) && (actress.nome || '').toLowerCase().includes(term) ).slice(0, 10); if (filteredActresses.length > 0) { filteredActresses.forEach(actress => { const item = document.createElement('div'); item.classList.add('suggestion-item'); item.innerHTML = `<img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome}" onerror="this.src='placeholder.png';"> <span>${actress.nome}</span>`; item.addEventListener('click', () => handleSelectVideoActor(actress)); videoActorsSuggestionsList.appendChild(item); }); } else { const noResults = document.createElement('div'); noResults.classList.add('suggestion-item', 'no-results'); noResults.textContent = 'Nenhuma atriz encontrada'; videoActorsSuggestionsList.appendChild(noResults); } videoActorsSuggestionsList.style.display = 'block'; }
        function handleSelectVideoActor(actress) { /* ... (no change) ... */ if (!actress || !actress.id) return; if (!selectedVideoActors.some(a => a.id === actress.id)) { selectedVideoActors.push(actress); renderVideoActorPills(); if (videoActorsSearchInput) videoActorsSearchInput.value = ''; if (videoActorsSuggestionsList) videoActorsSuggestionsList.style.display = 'none'; videoActorsSearchInput?.focus(); } }
        function renderVideoActorPills() { /* ... (no change) ... */ if (!videoSelectedActorsContainer) return; videoSelectedActorsContainer.innerHTML = ''; selectedVideoActors.forEach(actress => { const pill = document.createElement('div'); pill.classList.add('video-actor-pill'); pill.dataset.id = actress.id; pill.innerHTML = `<span>${actress.nome}</span> <button type="button" class="video-remove-actor-btn" title="Remover ${actress.nome}">×</button>`; pill.querySelector('.video-remove-actor-btn').addEventListener('click', handleRemoveVideoActor); videoSelectedActorsContainer.appendChild(pill); }); }
        function handleRemoveVideoActor(event) { /* ... (no change) ... */ const button = event.target; const pill = button.closest('.video-actor-pill'); if (pill && pill.dataset.id) { const actressIdToRemove = pill.dataset.id; selectedVideoActors = selectedVideoActors.filter(a => a.id !== actressIdToRemove); renderVideoActorPills(); } }

        // --- Statistics Modal Functions ---
        function openStatsModal() { if (!statsModal) return; if (statsResultsContainer) { statsResultsContainer.innerHTML = '<p>Selecione uma opção acima para ver as estatísticas.</p>'; } statsModal.style.display = 'flex'; }
        window.closeStatsModal = function() { if (statsModal) statsModal.style.display = 'none'; };
        async function displayStatistic(statType) { /* ... (no change) ... */ if (!statsResultsContainer) return; statsResultsContainer.innerHTML = '<div class="loading-stats">Calculando...</div>'; if (allActressesData.length === 0) { await loadInitialData(); } if (allActressesData.length === 0) { statsResultsContainer.innerHTML = '<div class="error">Nenhuma atriz carregada para calcular estatísticas.</div>'; return; } let content = ''; switch (statType) { case 'full-list': content = generateStatsTable(statType); break; case 'shortest': content = generateStatsTable(statType); break; case 'youngest': content = generateStatsTable(statType); break; case 'rating': content = generateStatsTable(statType); break; case 'hair-color': content = generateUniqueCountList('corCabelo', 'Cores de Cabelo'); break; case 'eye-color': content = generateUniqueCountList('corOlhos', 'Cores de Olhos'); break; case 'height-avg': content = calculateAverageStat('altura', 'Altura Média'); break; case 'age-avg': content = calculateAverageStat('age', 'Idade Média'); break; case 'countries': content = generateUniqueCountList('pais', 'Contagem por País'); break; case 'country-rating-avg': content = calculateGroupAverage('pais', 'nota', 'Nota Média por País'); break; default: content = '<p>Tipo de estatística não reconhecido.</p>'; } statsResultsContainer.innerHTML = content; const table = statsResultsContainer.querySelector('table'); if (table) { addTableSorting(table); } }
        function generateStatsTable(statType) { /* ... (no change) ... */ let dataToSort = [...allActressesData]; let columns = [ { key: 'foto', label: 'Foto', type: 'image' }, { key: 'nome', label: 'Nome', type: 'string' }, { key: 'age', label: 'Idade', type: 'number', sortable: true }, { key: 'altura', label: 'Altura (cm)', type: 'number', sortable: true }, { key: 'peso', label: 'Peso (kg)', type: 'number', sortable: true }, { key: 'nota', label: 'Nota', type: 'number', sortable: true }, { key: 'casta', label: 'Casta', type: 'string', sortable: true }, { key: 'pais', label: 'País', type: 'string', sortable: true }, { key: 'etnia', label: 'Etnia', type: 'string', sortable: true }, ]; let defaultSortKey = 'nome'; let defaultSortDir = 'asc'; let limit = null; switch (statType) { case 'full-list': defaultSortKey = 'nome'; defaultSortDir = 'asc'; break; case 'shortest': defaultSortKey = 'altura'; defaultSortDir = 'asc'; limit = 10; dataToSort = dataToSort.filter(a => a.altura != null); break; case 'youngest': defaultSortKey = 'age'; defaultSortDir = 'asc'; limit = 10; dataToSort = dataToSort.filter(a => a.dataNascimento); break; case 'rating': defaultSortKey = 'nota'; defaultSortDir = 'desc'; limit = 20; dataToSort = dataToSort.filter(a => a.nota != null); break; default: defaultSortKey = 'nome'; defaultSortDir = 'asc'; } dataToSort.forEach(a => { if (a.dataNascimento) a.calculated_age = calculateAge(a.dataNascimento); else a.calculated_age = null; }); const sortKeyForInitial = (statType === 'youngest') ? 'calculated_age' : defaultSortKey; dataToSort.sort((a, b) => { let valA = a[sortKeyForInitial]; let valB = b[sortKeyForInitial]; if (sortKeyForInitial === 'nota') { valA = (valA == null) ? -Infinity : valA; valB = (valB == null) ? -Infinity : valB; } else if (sortKeyForInitial === 'altura' || sortKeyForInitial === 'peso') { valA = (valA == null) ? Infinity : valA; valB = (valB == null) ? Infinity : valB; } else if (sortKeyForInitial === 'calculated_age') { valA = (valA === '?' || valA === null) ? Infinity : valA; valB = (valB === '?' || valB === null) ? Infinity : valB; } let comparison = 0; if (typeof valA === 'string') { comparison = (valA || '').localeCompare(valB || ''); } else { comparison = (valA ?? 0) - (valB ?? 0); } return defaultSortDir === 'asc' ? comparison : -comparison; }); if (limit) { dataToSort = dataToSort.slice(0, limit); } let tableHTML = `<table><thead><tr>`; columns.forEach(col => { tableHTML += `<th data-key="${col.key}" data-type="${col.type}" class="${col.sortable ? 'sortable' : ''}">${col.label}</th>`; }); tableHTML += `</tr></thead><tbody>`; dataToSort.forEach(actress => { tableHTML += `<tr>`; columns.forEach(col => { let value = ''; if (col.key === 'age') { value = actress.calculated_age !== null && actress.calculated_age !== '?' ? actress.calculated_age : '-'; } else if (col.key === 'foto') { value = `<img src="${actress.foto || 'placeholder.png'}" alt="${actress.nome || ''}" onerror="this.src='placeholder.png';">`; } else if (col.key === 'nota') { value = (actress.nota != null) ? Number(actress.nota).toFixed(1) : '-'; } else if (col.key === 'altura' || col.key === 'peso') { value = (actress[col.key] != null) ? actress[col.key] : '-'; } else { value = actress[col.key] || '-'; } tableHTML += `<td>${value}</td>`; }); tableHTML += `</tr>`; }); tableHTML += `</tbody></table>`; if(dataToSort.length === 0) return `<p>Nenhuma atriz encontrada para esta estatística.</p>` ; return tableHTML; }
        function generateUniqueCountList(fieldKey, title) { /* ... (no change) ... */ const counts = {}; let totalCount = 0; allActressesData.forEach(actress => { const value = String(actress[fieldKey] || 'N/A').trim(); if (value) { counts[value] = (counts[value] || 0) + 1; totalCount++; } }); if (totalCount === 0) return `<h4>${title}</h4><p>Nenhum dado encontrado para ${title}.</p>`; const sortedCounts = Object.entries(counts).sort(([, countA], [, countB]) => countB - countA); let listHTML = `<h4>${title} (${totalCount} total)</h4><ul>`; sortedCounts.forEach(([value, count]) => { const percentage = ((count / totalCount) * 100).toFixed(1); listHTML += `<li>${value}: ${count} (${percentage}%)</li>`; }); listHTML += `</ul>`; return listHTML; }
        function calculateAverageStat(fieldKey, title) { /* ... (no change) ... */ let sum = 0; let count = 0; allActressesData.forEach(actress => { let value; if (fieldKey === 'age') { value = calculateAge(actress.dataNascimento); if (value === '?') value = null; } else { value = safeParseInt(actress[fieldKey]); } if (value !== null) { sum += value; count++; } }); if (count === 0) return `<h4>${title}</h4><p>Nenhum dado válido encontrado para calcular a média.</p>`; const average = (sum / count); return `<h4>${title}</h4><p>A média é: <strong>${average.toFixed(fieldKey === 'age' ? 1 : 0)}</strong> (baseado em ${count} atrizes)</p>`; }
        function calculateGroupAverage(groupKey, valueKey, title) { /* ... (no change) ... */ const groups = {}; allActressesData.forEach(actress => { const groupValue = String(actress[groupKey] || 'N/A').trim(); const numericValue = (valueKey === 'age') ? calculateAge(actress.dataNascimento) : safeParseInt(actress[valueKey]); if (groupValue !== 'N/A' && numericValue !== null && numericValue !== '?') { if (!groups[groupValue]) groups[groupValue] = { sum: 0, count: 0 }; groups[groupValue].sum += numericValue; groups[groupValue].count++; } }); const groupAverages = Object.entries(groups) .map(([group, data]) => ({ group: group, average: data.sum / data.count, count: data.count })) .filter(item => item.count > 0) .sort((a, b) => b.average - a.average); if (groupAverages.length === 0) return `<h4>${title}</h4><p>Nenhum dado válido encontrado para calcular médias por grupo.</p>`; let tableHTML = `<h4>${title}</h4><table><thead><tr><th>${capitalizeFirstLetter(groupKey)}</th><th>Média ${capitalizeFirstLetter(valueKey)}</th><th>Contagem</th></tr></thead><tbody>`; groupAverages.forEach(item => { tableHTML += `<tr><td>${item.group}</td><td>${item.average.toFixed(1)}</td><td>${item.count}</td></tr>`; }); tableHTML += `</tbody></table>`; return tableHTML; }
        function addTableSorting(table) { /* ... (no change) ... */ const headers = table.querySelectorAll('th.sortable'); headers.forEach(header => { header.addEventListener('click', () => { const tbody = table.querySelector('tbody'); if (!tbody) return; const rows = Array.from(tbody.querySelectorAll('tr')); const key = header.dataset.key; const type = header.dataset.type; const currentDir = header.classList.contains('sort-asc') ? 'asc' : (header.classList.contains('sort-desc') ? 'desc' : 'none'); const newDir = (currentDir === 'asc') ? 'desc' : 'asc'; headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc')); header.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc'); rows.sort((rowA, rowB) => { const cellA = rowA.querySelector(`td:nth-child(${header.cellIndex + 1})`); const cellB = rowB.querySelector(`td:nth-child(${header.cellIndex + 1})`); let valA = cellA?.textContent.trim() || ''; let valB = cellB?.textContent.trim() || ''; let comparison = 0; if (type === 'number' || key === 'age') { const numA = parseFloat(valA.replace('%', '')); const numB = parseFloat(valB.replace('%', '')); const finalA = isNaN(numA) ? (newDir === 'asc' ? Infinity : -Infinity) : numA; const finalB = isNaN(numB) ? (newDir === 'asc' ? Infinity : -Infinity) : numB; comparison = finalA - finalB; } else if (type === 'string') { comparison = valA.localeCompare(valB); } else if (type === 'date') { const dateA = parseDateStringForSort(valA)?.getTime() ?? (newDir === 'asc' ? Infinity : -Infinity); const dateB = parseDateStringForSort(valB)?.getTime() ?? (newDir === 'asc' ? Infinity : -Infinity); comparison = dateA - dateB; } return newDir === 'asc' ? comparison : -comparison; }); rows.forEach(row => tbody.appendChild(row)); }); }); }


        // --- Filter Modal Functions ---
        function openFilterModal() { if (!filterModal) return; populateFilterOptions(); setFilterFormValues(); filterModal.style.display = 'flex'; }
        window.closeFilterModal = function() { if (filterModal) filterModal.style.display = 'none'; };
        function populateFilterOptions() { /* ... (no change) ... */ const nationalities = getUniqueValues('pais'); populateSelect(filterNationalitySelect, nationalities, 'Todas'); const ethnicities = getUniqueValues('etnia'); populateSelect(filterEthnicitySelect, ethnicities, 'Todas'); }
        function getUniqueValues(key) { /* ... (no change) ... */ const values = new Set(); allActressesData.forEach(actress => { if (actress[key] != null && String(actress[key]).trim() !== '') { values.add(String(actress[key]).trim()); } }); return Array.from(values).sort((a, b) => a.localeCompare(b)); }
        function populateSelect(selectElement, optionsArray, defaultOptionText) { /* ... (no change) ... */ if (!selectElement) return; while (selectElement.options.length > 1) { selectElement.remove(1); } selectElement.value = ''; optionsArray.forEach(optionValue => { const option = document.createElement('option'); option.value = optionValue; option.textContent = optionValue; selectElement.appendChild(option); }); }
        function setFilterFormValues() { /* ... (no change) ... */ if (!filterForm) return; filterForm.reset(); for (const key in activeActressFilters) { const input = filterForm.elements[key]; if (input) { input.value = activeActressFilters[key]; } else { if (key === 'nationality' && filterForm.elements['pais']) { filterForm.elements['pais'].value = activeActressFilters[key]; } else if (key === 'ethnicity' && filterForm.elements['etnia']) { filterForm.elements['etnia'].value = activeActressFilters[key]; } } } if (activeActressFilters.nationality && filterNationalitySelect) { filterNationalitySelect.value = activeActressFilters.nationality; } if (activeActressFilters.ethnicity && filterEthnicitySelect) { filterEthnicitySelect.value = activeActressFilters.ethnicity; } }
        function updateActiveFiltersFromForm() { /* ... (no change) ... */ activeActressFilters = {}; if (!filterForm) return; const formData = new FormData(filterForm); formData.forEach((value, key) => { const trimmedValue = String(value).trim(); if (trimmedValue !== '') { const filterKey = key; if (key === 'nationality') { activeActressFilters.nationality = trimmedValue; return; } if (key === 'ethnicity') { activeActressFilters.ethnicity = trimmedValue; return; } if (['height_min', 'height_max', 'weight_min', 'weight_max', 'age_min', 'age_max', 'rating_min', 'rating_max'].includes(filterKey)) { const numValue = filterKey.includes('rating') ? parseFloat(trimmedValue) : parseInt(trimmedValue, 10); if (!isNaN(numValue)) { activeActressFilters[filterKey] = numValue; } } else { activeActressFilters[filterKey] = trimmedValue; } } }); }
        function handleApplyFilters() { updateActiveFiltersFromForm(); filterAndRenderActressList(); closeFilterModal(); }
        function handleClearFilters() { activeActressFilters = {}; if(filterForm) filterForm.reset(); filterAndRenderActressList(); closeFilterModal(); }


        // --- Event Listeners (Global Page) ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();

            // Modal Closes on Overlay Click
             [contentModal, comparisonModal, createActressModal, pasteTextModal, createSceneModal, createMovieModal, statsModal, filterModal, createVideoModal, rankingDetailModal].forEach(modal => { // Added rankingDetailModal
                if (modal) {
                     modal.addEventListener('click', (event) => {
                         if (event.target === modal) {
                             switch(modal.id) {
                                 case 'content-modal': closeModal(); break;
                                 case 'comparison-modal': closeComparisonModal(); break;
                                 case 'create-actress-modal': closeCreateActressModal(); break;
                                 case 'paste-text-modal': closePasteTextModal(); break;
                                 case 'create-scene-modal': closeCreateSceneModal(); break;
                                 case 'create-movie-modal': closeCreateMovieModal(); break;
                                 case 'stats-modal': closeStatsModal(); break;
                                 case 'filter-modal': closeFilterModal(); break;
                                 case 'create-video-modal': closeCreateVideoModal(); break;
                                 case 'ranking-detail-modal': closeRankingDetailModal(); break; // NEW
                             }
                         }
                     });
                }
            });
    

            // Related Content Filter Buttons
            if (relatedFilterButtonsContainer) {
                relatedFilterButtonsContainer.querySelectorAll('.related-filter-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const filterType = button.dataset.filter || 'all';
                        relatedFilterButtonsContainer.querySelectorAll('.related-filter-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        activeRelatedFilter = filterType;
                        // selectedRelatedActresses = []; // This was moved to updateRightColumnView for rank/similar
                        // renderRelatedActressPills();   // This was moved to updateRightColumnView
                        if(relatedSuggestionsList) relatedSuggestionsList.style.display = 'none';
                        updateRightColumnView(); // Centralized view update
                    });
                });
            }

            if (relatedSearchInput) { const debouncedRelatedSearch = debounce(() => displayRelatedSuggestions(relatedSearchInput.value), 300); relatedSearchInput.addEventListener('input', debouncedRelatedSearch); relatedSearchInput.addEventListener('focus', displayInitialRelatedSuggestionsOnClick); }
            if (relatedSearchInputWrapper) { relatedSearchInputWrapper.addEventListener('click', (e) => { if (!e.target.closest('.related-remove-actress-btn') && !relatedSearchInput.disabled) { displayInitialRelatedSuggestionsOnClick(); relatedSearchInput?.focus(); } }); }
            if (comparisonSearchInput) { const debouncedComparisonSearch = debounce(() => displayComparisonSuggestions(comparisonSearchInput.value), 300); comparisonSearchInput.addEventListener('input', debouncedComparisonSearch); comparisonSearchInput.addEventListener('focus', () => displayComparisonSuggestions(comparisonSearchInput.value)); }
            if (fabCreate) { fabCreate.addEventListener('click', toggleCreateMenu); }
            if (menuCreateActressBtn) { menuCreateActressBtn.addEventListener('click', openCreateActressModal); }
            if (menuCreateMultimediaBtn) { menuCreateMultimediaBtn.addEventListener('click', openPasteTextModal); }
            if (createSceneForm) { createSceneForm.addEventListener('submit', handleCreateSceneSubmit); }
            if (sceneActorsSearchInput) { const debouncedSceneActorSearch = debounce(() => displaySceneActorSuggestions(sceneActorsSearchInput.value), 300); sceneActorsSearchInput.addEventListener('input', debouncedSceneActorSearch); sceneActorsSearchInput.addEventListener('focus', () => displaySceneActorSuggestions(sceneActorsSearchInput.value)); }
            if (sceneActorsSelector) { sceneActorsSelector.addEventListener('click', (e) => { if (!e.target.closest('.scene-remove-actor-btn') && !e.target.closest('#scene-actors-suggestions-list')) { sceneActorsSearchInput?.focus(); } }); }
            if (createMovieForm) { createMovieForm.addEventListener('submit', handleCreateMovieSubmit); }
            if (createVideoForm) { createVideoForm.addEventListener('submit', handleCreateVideoSubmit); }
            if (videoActorsSearchInput) { const debouncedVideoActorSearch = debounce(() => displayVideoActorSuggestions(videoActorsSearchInput.value), 300); videoActorsSearchInput.addEventListener('input', debouncedVideoActorSearch); videoActorsSearchInput.addEventListener('focus', () => displayVideoActorSuggestions(videoActorsSearchInput.value)); }
            if (videoActorsSelector) { videoActorsSelector.addEventListener('click', (e) => { if (!e.target.closest('.video-remove-actor-btn') && !e.target.closest('#video-actors-suggestions-list')) { videoActorsSearchInput?.focus(); } }); }
            if (actressSearchInput && actressListUl) { const debouncedActressFilterRender = debounce(() => { filterAndRenderActressList(); }, 250); actressSearchInput.addEventListener('input', debouncedActressFilterRender); }
            if (actressFilterBtn) { actressFilterBtn.addEventListener('click', openFilterModal); }
            if (actressStatsBtn) { actressStatsBtn.addEventListener('click', openStatsModal); }
            if (statsOptionsContainer) { statsOptionsContainer.addEventListener('click', (event) => { const button = event.target.closest('.stats-option-btn'); if (button && button.dataset.stat) { displayStatistic(button.dataset.stat); } }); }
            if (applyFiltersBtn) { applyFiltersBtn.addEventListener('click', handleApplyFilters); }
            if (clearFiltersBtn) { clearFiltersBtn.addEventListener('click', handleClearFilters); }
            document.addEventListener('click', (event) => {
                 if (relatedSuggestionsList && relatedSuggestionsList.style.display !== 'none' && !relatedSearchInputWrapper?.contains(event.target) && !relatedSuggestionsList?.contains(event.target)) { relatedSuggestionsList.style.display = 'none'; }
                 if (comparisonSuggestionsList && comparisonSuggestionsList.style.display !== 'none' && !comparisonSearchInput?.closest('.comparison-search-area')?.contains(event.target) && !comparisonSuggestionsList?.contains(event.target)) { comparisonSuggestionsList.style.display = 'none'; }
                 if (createMenuPopup && createMenuPopup.style.display === 'block' && !fabCreate?.contains(event.target) && !createMenuPopup?.contains(event.target)) { closeCreateMenu(); }
                 if (sceneActorsSuggestionsList && sceneActorsSuggestionsList.style.display !== 'none' && !sceneActorsSelector?.contains(event.target) && !sceneActorsSuggestionsList?.contains(event.target)) { sceneActorsSuggestionsList.style.display = 'none'; }
                 if (videoActorsSuggestionsList && videoActorsSuggestionsList.style.display !== 'none' && !videoActorsSelector?.contains(event.target) && !videoActorsSuggestionsList?.contains(event.target)) { videoActorsSuggestionsList.style.display = 'none'; }
             });
        });


    </script>


  </body>
  </html>
