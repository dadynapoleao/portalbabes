<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Atrizes</title>
    <style>
        /* --- Base & Layout --- */
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; min-height: 100vh; font-size: 14px; /* Base font size */ }
        .container { display: flex; width: 100%; padding: 15px; box-sizing: border-box; gap: 10px; }
        .column { background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); overflow: hidden; /* Hide overflow, let inner content scroll */ height: calc(100vh - 30px); box-sizing: border-box; display: flex; flex-direction: column; }
        #actress-list-col { flex: 1; }
        #actress-detail-col, #content-col { display: none; }
        .container.details-visible #actress-list-col { flex: 0 0 25%; max-width: 300px; }
        .container.details-visible #actress-detail-col { display: flex; flex: 0 0 30%; max-width: 400px; }
        .container.details-visible #content-col { display: flex; flex: 1; }
        .column h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.3em; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-shrink: 0; /* Prevent shrinking */ }
        .column h2.related-title { margin-top: 0; /* Remove extra top margin */ }

        /* --- Actress List (Left Column) --- */
        #actress-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .actress-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s ease; }
        .actress-item:hover { background-color: #f0f0f0; }
        .actress-item.selected { background-color: #e0e0e0; font-weight: bold; }
        .actress-item img { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .actress-info span { display: block; font-size: 0.9em; line-height: 1.3; }
        .actress-info .name { font-weight: bold; font-size: 1em; }
        .actress-info .age, .actress-info .rating { color: #555; font-size: 0.85em; }

        /* --- Actress Details (Middle Column) --- */
        #actress-details { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        #actress-details h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #actress-details div { margin-bottom: 7px; word-wrap: break-word; font-size: 0.9em; }
        #actress-details strong { display: inline-block; min-width: 90px; color: #333; font-weight: bold; }
        #actress-details img.detail-photo { max-width: 180px; max-height: 230px; width: auto; height: auto; border-radius: 4px; margin-top: 8px; display: block; }

        /* --- Related Content (Right Column) --- */
         #content-col-header { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-shrink: 0; }
        .related-filter-buttons { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .related-filter-btn { padding: 5px 10px; border: 1px solid #ccc; background-color: #eee; color: #333; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .related-filter-btn:hover { background-color: #ddd; }
        .related-filter-btn.active { background-color: #007bff; color: white; border-color: #007bff; font-weight: bold; }
        .related-actress-search-area { position: relative; width: 100%; }
        .related-search-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: text; min-height: 32px; }
        .related-search-input-wrapper:focus-within { border-color: #80bdff; box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); }
        #related-selected-actresses { display: contents; }
        .related-actress-pill { display: inline-flex; align-items: center; background-color: #007bff; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; margin: 1px; white-space: nowrap; }
        .related-actress-pill span { margin-right: 4px; }
        .related-remove-actress-btn { background: none; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 1em; padding: 0 2px; line-height: 1; opacity: 0.8; }
        .related-remove-actress-btn:hover { opacity: 1; }
        .related-search-input { flex-grow: 1; padding: 4px 5px; border: none; background-color: transparent; color: #333; font-size: 0.9em; min-width: 100px; outline: none; }
        #related-suggestions-list { display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; }
        #related-suggestions-list .suggestion-item { display: flex; padding: 5px 10px; color: #333; cursor: pointer; align-items: center; gap: 8px; font-size: 0.9em; }
        #related-suggestions-list .suggestion-item:hover { background-color: #f0f0f0; }
        #related-suggestions-list .suggestion-item.no-results { cursor: default; color: #888; justify-content: center; padding: 8px; }
        #related-suggestions-list .suggestion-item img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }

        #content-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; flex-grow: 1; overflow-y: auto; padding-top: 5px; align-content: start; }
        .content-card { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; overflow: hidden; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: box-shadow 0.2s ease; position: relative; display: flex; flex-direction: column;}
        .content-card:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .content-card .image-container { position: relative; width: 100%; height: 160px; /* Slightly smaller height */ flex-shrink: 0; }
        .content-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .content-type-badge { position: absolute; top: 4px; left: 4px; background-color: rgba(0, 0, 0, 0.75); color: white; padding: 2px 5px; font-size: 0.7em; font-weight: bold; border-radius: 3px; z-index: 1; }
        .content-card .title { padding: 6px; font-size: 0.85em; min-height: 35px; display: flex; align-items: center; justify-content: center; line-height: 1.2; flex-grow: 1; }
        #content-message { grid-column: 1 / -1; font-size: 0.9em; }

        /* --- Main Modal Styling --- */
        .modal-overlay { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1000; display: none; /* Hidden initially */ justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: #fff; padding: 20px 25px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 650px; width: 90%; position: relative; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-close-button { position: absolute; top: 8px; right: 12px; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; background: none; border: none; padding: 0;}
        .modal-close-button:hover { color: #333; }
        .modal-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        #modal-body { flex-grow: 1; overflow-y: auto; padding-right: 5px; font-size: 0.9em; }
        #modal-body div:not(.modal-actress-list-container):not(.modal-scenes-container) { margin-bottom: 7px; word-wrap: break-word; }
        #modal-body strong { display: inline-block; min-width: 70px; color: #333; font-weight: bold;}
        #modal-link-container button { padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        #modal-link-container button:hover { background-color: #0056b3; }
        #modal-body img.modal-detail-image { max-width: 90%; height: auto; max-height: 280px; margin-top: 5px; border-radius: 4px; display: block; margin-left: auto; margin-right: auto; margin-bottom: 12px; }
        #modal-body img.modal-detail-image.movie-image { max-width: 220px; max-height: 220px; }
        #modal-body .modal-year { font-size: 1em; color: #555; margin-bottom: 12px; }
        .modal-actress-list-container, .modal-scenes-container { margin-top: 15px; padding-top: 12px; border-top: 1px solid #eee; }
        .modal-actress-list-container h4, .modal-scenes-container h4 { margin-top: 0; margin-bottom: 10px; color: #333; font-size: 1em; }
        .modal-actress-list { display: flex; flex-wrap: wrap; gap: 12px; padding: 0; list-style: none; }
        .modal-actress-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s ease; max-width: 70px; }
        .modal-actress-item:hover { background-color: #f0f0f0; }
        .modal-actress-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; margin-bottom: 4px; }
        .modal-actress-item span { font-size: 0.8em; word-wrap: break-word; line-height: 1.1; max-width: 100%;}
        .modal-scene-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; }
        .modal-scene-card { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; overflow: hidden; text-align: center; font-size: 0.75em; }
        .modal-scene-card img { width: 100%; height: 70px; object-fit: cover; display: block; }
        .modal-scene-card .title { padding: 4px; min-height: 20px; display: flex; align-items: center; justify-content: center; line-height: 1.1; }

        /* --- Movable Actress Popup Styling --- */
        .actress-popup { position: fixed; background-color: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 1050; width: 200px; max-height: 300px; overflow: hidden; display: flex; flex-direction: column; cursor: grab; user-select: none; }
        .actress-popup.dragging { cursor: grabbing; opacity: 0.9; }
        .actress-popup-header { background-color: #f0f0f0; padding: 5px 8px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .actress-popup-header h5 { margin: 0; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; padding-right: 5px; }
        .actress-popup-close { font-size: 1.1em; font-weight: bold; color: #888; cursor: pointer; border: none; background: none; padding: 0 4px; line-height: 1; }
        .actress-popup-close:hover { color: #333; }
        .actress-popup-body { padding: 8px; overflow-y: auto; font-size: 0.8em; flex-grow: 1; }
        .actress-popup-body img { width: 65px; height: 65px; object-fit: cover; border-radius: 50%; display: block; margin: 0 auto 8px auto; }
        .actress-popup-body div { margin-bottom: 4px; }
        .actress-popup-body strong { display: inline-block; min-width: 55px; color: #444; font-weight: bold;}

    </style>
</head>
<body>
    <div class="container" id="main-container">
        <!-- Left Column: Actress List -->
        <div class="column" id="actress-list-col">
            <h2>Atrizes</h2>
            <ul id="actress-list">
                <li class="loading">Carregando...</li>
            </ul>
        </div>

        <!-- Middle Column: Actress Details -->
        <div class="column" id="actress-detail-col">
            <h2>Detalhes da Atriz</h2>
            <div id="actress-details">
                <!-- Details loaded here -->
            </div>
        </div>

        <!-- Right Column: Related Content -->
        <div class="column" id="content-col">
            <div id="content-col-header">
                <div class="related-filter-buttons">
                    <button class="related-filter-btn active" data-filter="all">Todos</button>
                    <button class="related-filter-btn" data-filter="video">Vídeos</button>
                    <button class="related-filter-btn" data-filter="film">Filmes</button>
                    <button class="related-filter-btn" data-filter="scene">Cenas</button>
                </div>
                <div class="related-actress-search-area">
                    <div class="related-search-input-wrapper">
                        <div id="related-selected-actresses"></div>
                        <input type="text" id="related-search-input" class="related-search-input" placeholder="Filtrar por co-atriz...">
                    </div>
                    <div id="related-suggestions-list"></div>
                </div>
            </div>
            <h2 class="related-title">Conteúdo Relacionado</h2>
            <div id="content-cards"></div>
            <div id="content-message" class="loading" style="display: none;"></div>
        </div>
    </div>

     <!-- Main Modal Structure (for Content Details) -->
    <div id="content-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal()">×</button> <!-- Ensure onclick is correct -->
            <h3 id="modal-title">Detalhes</h3>
            <div id="modal-body"></div>
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 15px;">
                <div id="modal-link-container"></div>
            </div>
        </div>
    </div>

    <!-- Template for Movable Actress Popups (Initially Hidden) -->
    <div id="actress-popup-template" class="actress-popup" style="display: none;">
        <div class="actress-popup-header">
            <h5>Nome Atriz</h5>
            <button class="actress-popup-close">×</button>
        </div>
        <div class="actress-popup-body"></div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // --- Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
             apiKey: "AIzaSyBZEffPMXgbSHYUUrNdIS5duAVGlKlmSq0", authDomain: "babes-392fd.firebaseapp.com",
             projectId: "babes-392fd", storageBucket: "babes-392fd.appspot.com",
             messagingSenderId: "376795361631", appId: "1:376795361631:web:d662f2b2f2cd23b115c6ea"
        };
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig); // Single initialization
        const db = getFirestore(app);

        // --- DOM Elements ---
        const mainContainer = document.getElementById('main-container');
        const actressListUl = document.getElementById('actress-list');
        const actressDetailsContainer = document.getElementById('actress-details');
        const contentCardsContainer = document.getElementById('content-cards');
        const contentMessage = document.getElementById('content-message');
        const modal = document.getElementById('content-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalLinkContainer = document.getElementById('modal-link-container');
        const relatedFilterButtons = document.querySelectorAll('.related-filter-btn');
        const relatedSearchInput = document.getElementById('related-search-input');
        const relatedSuggestionsList = document.getElementById('related-suggestions-list');
        const relatedSelectedActressesContainer = document.getElementById('related-selected-actresses');
        const relatedSearchInputWrapper = document.querySelector('.related-search-input-wrapper');

        // --- State Variables ---
        let selectedMainActressElement = null;
        let currentMainActressId = null;
        let allActressesData = [];
        let allRelatedContent = [];
        let filteredRelatedContent = [];
        let selectedRelatedActresses = [];
        let activeRelatedFilter = 'all';
        let allScenesCache = new Map(); // Cache scene data for movie checks
        let popupsOpen = 0; // Count open actress popups for positioning

        // --- Helper Functions ---
        function calculateAge(birthDateString) { if (!birthDateString) return '?'; try { const birthDate = new Date(birthDateString); const today = new Date(); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; } return age; } catch (e) { console.error("Date parse error:", e); return '?'; } }
        function displayMessage(element, message, isError = false) { element.innerHTML = `<div class="${isError ? 'error' : 'loading'}">${message}</div>`; element.style.display = 'block'; }
        function clearMessage(element) { element.innerHTML = ''; element.style.display = 'none'; }

        // --- Core Logic ---

        // 1. Load ALL Actresses & Scenes (on page load)
        async function loadInitialData() {
            actressListUl.innerHTML = '<li class="loading">Carregando...</li>';
            allScenesCache.clear(); // Clear scene cache
            try {
                const [actoresSnapshot, cenasSnapshot] = await Promise.all([
                    getDocs(collection(db, "atores")),
                    getDocs(collection(db, "cenas")) // Fetch scenes upfront
                ]);

                // Process Actresses
                actressListUl.innerHTML = '';
                if (actoresSnapshot.empty) { actressListUl.innerHTML = '<li class="error">Nenhuma atriz encontrada.</li>'; }
                else {
                    allActressesData = [];
                    actoresSnapshot.forEach((doc) => allActressesData.push({ id: doc.id, ...doc.data() }));
                    allActressesData.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                    allActressesData.forEach(renderActressListItem); // Call function to render each
                    console.log(`Loaded ${allActressesData.length} actresses.`);
                }

                 // Cache Scenes
                cenasSnapshot.forEach(docSnap => allScenesCache.set(docSnap.id, docSnap.data()));
                console.log(`Cached ${allScenesCache.size} scenes.`);

            } catch (error) {
                console.error("Erro ao buscar dados iniciais: ", error);
                actressListUl.innerHTML = '<li class="error">Erro ao carregar atrizes.</li>';
            }
        }

        // Function to render a single actress item in the left list
        function renderActressListItem(actress) {
            const li = document.createElement('li'); li.classList.add('actress-item'); li.dataset.id = actress.id;
            const age = calculateAge(actress.dataNascimento); const imageUrl = actress.foto || 'placeholder.png'; const rating = actress.nota !== undefined ? actress.nota : 'N/A';
            li.innerHTML = `<img src="${imageUrl}" alt="${actress.nome || ''}" onerror="this.src='placeholder.png'; this.onerror=null;"><div class="actress-info"><span class="name">${actress.nome || 'Nome Ind.'}</span><span class="age">Idade: ${age}</span><span class="rating">Nota: ${rating}</span></div>`;
            li.addEventListener('click', () => handleMainActressClick(actress.id, li));
            actressListUl.appendChild(li);
        }

        // 2. Handle Main Actress Click (Left Column)
        async function handleMainActressClick(actressId, listItemElement) { /* ... (same as before, calls loadAndDisplayRelatedContent) ... */
             if (selectedMainActressElement === listItemElement) return; // Don't reload if clicking the same one
             if (selectedMainActressElement) selectedMainActressElement.classList.remove('selected');
             listItemElement.classList.add('selected'); selectedMainActressElement = listItemElement;
             currentMainActressId = actressId; mainContainer.classList.add('details-visible');
             actressDetailsContainer.innerHTML = '<div class="loading">Carregando...</div>';
             contentCardsContainer.innerHTML = ''; displayMessage(contentMessage, 'Carregando conteúdo...');
             selectedRelatedActresses = []; activeRelatedFilter = 'all'; if(relatedSearchInput) relatedSearchInput.value = ''; renderRelatedActressPills(); relatedFilterButtons.forEach(btn => btn.classList.remove('active')); document.querySelector('.related-filter-btn[data-filter="all"]')?.classList.add('active');
             try { const actressData = allActressesData.find(a => a.id === actressId); if (actressData) { displayMainActressDetails(actressData); } else { const actressDoc = await getDoc(doc(db, "atores", actressId)); if (actressDoc.exists()) displayMainActressDetails(actressDoc.data()); else actressDetailsContainer.innerHTML = '<div class="error">Detalhes não encontrados.</div>'; } await loadAndDisplayRelatedContent(actressId); } catch (error) { console.error(`Erro ao carregar dados atriz ${actressId}: `, error); actressDetailsContainer.innerHTML = '<div class="error">Erro detalhes.</div>'; displayMessage(contentMessage,'Erro conteúdo.', true); }
        }

        // 3. Display Main Actress Details (Middle Column)
        function displayMainActressDetails(data) { /* ... (same as before) ... */
             actressDetailsContainer.innerHTML = ''; const detailsTitle = document.createElement('h3'); detailsTitle.textContent = data.nome || 'Detalhes'; actressDetailsContainer.appendChild(detailsTitle); if (data.foto) { const img = document.createElement('img'); img.src = data.foto; img.alt = data.nome; img.classList.add('detail-photo'); img.onerror = () => { img.style.display = 'none'; }; actressDetailsContainer.appendChild(img); } const skipFields = ['foto', 'nome', 'cenas', 'filmes', 'videos', 'timestamp']; let detailsAdded = false; for (const key in data) { if (data.hasOwnProperty(key) && !skipFields.includes(key)) { detailsAdded = true; const detailDiv = document.createElement('div'); let value = data[key]; let label = key; if (key === 'dataNascimento') { detailDiv.innerHTML = `<strong>${label}:</strong> ${value || 'N/A'}`; actressDetailsContainer.appendChild(detailDiv); const ageDiv = document.createElement('div'); ageDiv.innerHTML = `<strong>Idade:</strong> ${calculateAge(value)}`; actressDetailsContainer.appendChild(ageDiv); continue; } else if (key === 'peso' && value != null) { value = `${value} kg`; } else if (key === 'altura' && value != null) { value = `${value} cm`; } detailDiv.innerHTML = `<strong>${label}:</strong> ${value}`; actressDetailsContainer.appendChild(detailDiv); } } if (!detailsAdded) { const noDetailsDiv = document.createElement('div'); noDetailsDiv.textContent = 'Sem detalhes adicionais.'; actressDetailsContainer.appendChild(noDetailsDiv); }
        }

        // --- Related Content Loading and Filtering ---

        // 4. Load Related Content
        async function loadAndDisplayRelatedContent(mainActressId) {
            allRelatedContent = []; filteredRelatedContent = []; contentCardsContainer.innerHTML = '';
            displayMessage(contentMessage, 'Buscando conteúdo...');
            try {
                const collectionsToFetch = ['videos', 'filmes']; // Fetch videos and films
                const promises = collectionsToFetch.map(collName => getDocs(collection(db, collName)));
                const [videosSnapshot, filmesSnapshot] = await Promise.all(promises);

                // Process Videos directly containing the actress
                videosSnapshot.forEach(docSnap => {
                    const itemData = docSnap.data();
                    if (itemData.atores && Array.isArray(itemData.atores) && itemData.atores.includes(mainActressId)) {
                        allRelatedContent.push({ id: docSnap.id, type: 'video', ...itemData });
                    }
                });

                // Process Films and related Scenes
                filmesSnapshot.forEach(docSnap => {
                    const movieData = docSnap.data();
                    let movieIsRelated = false;
                    const relatedScenes = [];
                    if (movieData.cenas && Array.isArray(movieData.cenas)) {
                        for (const sceneId of movieData.cenas) {
                            const sceneData = allScenesCache.get(sceneId); // Use cached scene data
                            if (sceneData) {
                                // Add scene to list regardless of actress, for now
                                relatedScenes.push({ id: sceneId, type: 'scene', ...sceneData });
                                // Check if scene contains the main actress
                                if (sceneData.atores && Array.isArray(sceneData.atores) && sceneData.atores.includes(mainActressId)) {
                                    movieIsRelated = true;
                                }
                            }
                        }
                    }
                    // If the movie itself was related OR any of its scenes were related, add the movie AND its scenes
                    if (movieIsRelated) {
                         allRelatedContent.push({ id: docSnap.id, type: 'film', ...movieData });
                         // Add all scenes found for this related movie
                         relatedScenes.forEach(scene => {
                            // Avoid adding duplicate scenes if already added some other way
                            if (!allRelatedContent.some(item => item.id === scene.id && item.type === 'scene')) {
                                allRelatedContent.push(scene);
                            }
                         });
                    } else {
                        // If movie wasn't related, check if any of its individual scenes were related
                        relatedScenes.forEach(scene => {
                             if (scene.atores && Array.isArray(scene.atores) && scene.atores.includes(mainActressId)) {
                                 if (!allRelatedContent.some(item => item.id === scene.id && item.type === 'scene')) {
                                    allRelatedContent.push(scene);
                                }
                             }
                        });
                    }
                });

                console.log(`Found ${allRelatedContent.length} related items for ${mainActressId}`);
                applyRelatedContentFilters(); // Initial display

            } catch (error) { console.error("Erro ao buscar conteúdo: ", error); displayMessage(contentMessage, 'Erro ao carregar.', true); }
        }

        // 5. Apply Filters and Render Related Content
        function applyRelatedContentFilters() { /* ... (same as before) ... */
             contentCardsContainer.innerHTML = ''; clearMessage(contentMessage);
             const relatedActressIds = selectedRelatedActresses.map(a => a.id);
             filteredRelatedContent = allRelatedContent.filter(item => {
                 if (activeRelatedFilter !== 'all' && item.type !== activeRelatedFilter) return false;
                 if (relatedActressIds.length > 0) {
                     if (!item.atores || !Array.isArray(item.atores)) return false;
                     if (!relatedActressIds.every(relId => item.atores.includes(relId))) return false;
                 } return true;
             });
             filteredRelatedContent.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
             if (filteredRelatedContent.length > 0) { filteredRelatedContent.forEach(item => createContentCard(item.imagem, item.nome, item.type, item.id)); }
             else { displayMessage(contentMessage, 'Nenhum conteúdo com os filtros aplicados.'); }
        }

        // 6. Create Content Card HTML (with Badge)
        function createContentCard(imageUrl, title, type, id) { /* ... (same as before, includes badge logic) ... */
             const card = document.createElement('div'); card.classList.add('content-card'); card.dataset.type = type; card.dataset.id = id;
             const imageContainer = document.createElement('div'); imageContainer.classList.add('image-container'); const img = document.createElement('img'); let finalImageUrl = imageUrl; if (typeof imageUrl === 'object' && imageUrl !== null && imageUrl.width) { const urlKey = Object.keys(imageUrl).find(k=>typeof imageUrl[k]==='string'&&imageUrl[k].startsWith('http')); finalImageUrl = urlKey ? imageUrl[urlKey] : 'placeholder.png';} else if (typeof imageUrl !== 'string' || !imageUrl) { finalImageUrl = 'placeholder.png'; } img.src = finalImageUrl; img.alt = title || type; img.onerror = () => { img.src = 'placeholder.png'; img.onerror=null; }
             const badge = document.createElement('div'); badge.classList.add('content-type-badge'); let badgeText = type.charAt(0).toUpperCase() + type.slice(1); if(type === 'film') badgeText = 'Filme'; else if(type === 'scene') badgeText = 'Cena'; else if(type === 'video') badgeText = 'Vídeo'; badge.textContent = badgeText; imageContainer.appendChild(badge); imageContainer.appendChild(img);
             const titleDiv = document.createElement('div'); titleDiv.classList.add('title'); titleDiv.textContent = `${title || 'Sem Título'}`;
             card.appendChild(imageContainer); card.appendChild(titleDiv); card.addEventListener('click', () => showContentDetails(type, id)); contentCardsContainer.appendChild(card);
        }

        // --- Right Column Search Functions ---
        function displayRelatedSuggestions(searchTerm) { /* ... (same as before) ... */
             if (!relatedSuggestionsList) return; relatedSuggestionsList.innerHTML = ''; if (!searchTerm) { relatedSuggestionsList.style.display = 'none'; return; } const lowerSearchTerm = searchTerm.toLowerCase(); const matchedActresses = allActressesData.filter(actress => actress.id !== currentMainActressId && actress.nome.toLowerCase().includes(lowerSearchTerm) && !selectedRelatedActresses.some(sa => sa.id === actress.id) ); if (matchedActresses.length > 0) { matchedActresses.sort((a,b)=>a.nome.localeCompare(b.nome)).slice(0, 7).forEach(actress => { const item = document.createElement('div'); item.classList.add('suggestion-item'); item.dataset.id = actress.id; item.dataset.nome = actress.nome; item.innerHTML = `<img src="${actress.foto || 'placeholder.png'}" alt=""><span>${actress.nome}</span>`; item.addEventListener('click', handleSelectRelatedActress); relatedSuggestionsList.appendChild(item); }); relatedSuggestionsList.style.display = 'block'; } else { relatedSuggestionsList.innerHTML = '<div class="suggestion-item no-results">Nenhuma atriz encontrada</div>'; relatedSuggestionsList.style.display = 'block'; }
        }
        function handleSelectRelatedActress(event) { /* ... (same as before) ... */
             const target = event.currentTarget; const actressId = target.dataset.id; const actressName = target.dataset.nome; if (!actressId || !actressName) return; if (!selectedRelatedActresses.some(a => a.id === actressId)) { selectedRelatedActresses.push({ id: actressId, nome: actressName }); renderRelatedActressPills(); applyRelatedContentFilters(); } if (relatedSearchInput) relatedSearchInput.value = ''; if (relatedSuggestionsList) relatedSuggestionsList.style.display = 'none'; if (relatedSearchInput) relatedSearchInput.focus();
        }
        function renderRelatedActressPills() { /* ... (same as before) ... */
             if (!relatedSelectedActressesContainer) return; relatedSelectedActressesContainer.innerHTML = ''; selectedRelatedActresses.forEach(actress => { const pill = document.createElement('div'); pill.classList.add('related-actress-pill'); pill.dataset.id = actress.id; pill.innerHTML = `<span>${actress.nome}</span><button class="related-remove-actress-btn" title="Remover">×</button>`; pill.querySelector('.related-remove-actress-btn').addEventListener('click', handleRemoveRelatedActress); relatedSelectedActressesContainer.appendChild(pill); });
        }
        function handleRemoveRelatedActress(event) { /* ... (same as before) ... */
              event.stopPropagation(); const pill = event.target.closest('.related-actress-pill'); if (!pill) return; const actressIdToRemove = pill.dataset.id; selectedRelatedActresses = selectedRelatedActresses.filter(a => a.id !== actressIdToRemove); renderRelatedActressPills(); applyRelatedContentFilters(); if (relatedSuggestionsList.style.display === 'block' && relatedSearchInput?.value) { displayRelatedSuggestions(relatedSearchInput.value); }
        }

        // --- Main Modal Functions ---
        async function showContentDetails(type, id) { /* ... (same as before, calls loadActressesForModal) ... */
             modalBody.innerHTML = '<div class="loading">Carregando...</div>'; modalLinkContainer.innerHTML = ''; modal.style.display = 'flex'; let collectionName = ''; switch (type) { case 'Cena': collectionName = 'cenas'; break; case 'Vídeo': collectionName = 'videos'; break; case 'Filme': collectionName = 'filmes'; break; default: modalBody.innerHTML = '<div class="error">Tipo inválido.</div>'; modal.style.display='none'; return; } try { const docSnap = await getDoc(doc(db, collectionName, id)); if (docSnap.exists()) { const data = docSnap.data(); modalTitle.textContent = data.nome || `Detalhes`; modalBody.innerHTML = ''; if (data.imagem) { let finalImageUrl = data.imagem; if (typeof finalImageUrl === 'object' && finalImageUrl !== null && finalImageUrl.width) { const urlKey = Object.keys(finalImageUrl).find(k=>typeof finalImageUrl[k]==='string'&&finalImageUrl[k].startsWith('http')); finalImageUrl = urlKey ? finalImageUrl[urlKey] : null;} else if (typeof finalImageUrl !== 'string') { finalImageUrl = null; } if(finalImageUrl){ const img = document.createElement('img'); img.src = finalImageUrl; img.alt = data.nome || type; img.classList.add('modal-detail-image'); if (type === 'film') img.classList.add('movie-image'); img.onerror = () => { img.style.display = 'none'; }; modalBody.appendChild(img); } } if (data.ano) { const yearDiv = document.createElement('div'); yearDiv.classList.add('modal-year'); yearDiv.textContent = `Ano: ${data.ano}`; modalBody.appendChild(yearDiv); } const actressesContainer = document.createElement('div'); actressesContainer.classList.add('modal-actress-list-container'); actressesContainer.innerHTML = `<h4>Atrizes</h4><div class="loading">Carregando...</div>`; modalBody.appendChild(actressesContainer); let scenesContainer = null; if (type === 'film') { scenesContainer = document.createElement('div'); scenesContainer.classList.add('modal-scenes-container'); scenesContainer.innerHTML = `<h4>Cenas do Filme</h4><div class="loading">Carregando...</div>`; modalBody.appendChild(scenesContainer); } if (data.pagina && typeof data.pagina === 'string' && data.pagina.trim() !== '') { const linkButton = document.createElement('button'); linkButton.textContent = 'Abrir Página Externa'; linkButton.onclick = () => window.open(data.pagina, '_blank'); modalLinkContainer.appendChild(linkButton); } else { modalLinkContainer.innerHTML = '<i>(Nenhuma página externa)</i>'; } loadActressesForModal(data.atores || [], actressesContainer); if (type === 'film') loadScenesForModal(data.cenas || [], scenesContainer); } else { modalBody.innerHTML = '<div class="error">Conteúdo não encontrado.</div>'; } } catch (error) { console.error(`Erro ao buscar ${type} ${id}: `, error); modalBody.innerHTML = '<div class="error">Erro ao carregar.</div>'; }
        }
        async function loadActressesForModal(actressIds, containerElement) { /* ... (Calls createActressPopup) ... */
             if (!actressIds || actressIds.length === 0) { containerElement.innerHTML = '<h4>Atrizes</h4><i>Nenhuma atriz.</i>'; return; } const listElement = document.createElement('ul'); listElement.classList.add('modal-actress-list'); containerElement.innerHTML = '<h4>Atrizes</h4>'; containerElement.appendChild(listElement); let foundCount = 0; const fetchPromises = actressIds.map(async (actressId) => { try { let actressData = allActressesData.find(a => a.id === actressId); if (!actressData) { const actressDoc = await getDoc(doc(db, "atores", actressId)); if (actressDoc.exists()) actressData = { id: actressId, ...actressDoc.data() }; } if (actressData) { foundCount++; const li = document.createElement('li'); li.classList.add('modal-actress-item'); li.onclick = () => createActressPopup(actressId); const img = document.createElement('img'); img.src = actressData.foto || 'placeholder.png'; img.alt = actressData.nome; img.onerror = () => { img.src = 'placeholder.png'; img.onerror=null; } const nameSpan = document.createElement('span'); nameSpan.textContent = actressData.nome || 'Nome'; li.appendChild(img); li.appendChild(nameSpan); listElement.appendChild(li); } } catch (error) { console.error(`Error loading actress ${actressId} for modal:`, error); } }); await Promise.all(fetchPromises); if (foundCount === 0) containerElement.innerHTML = '<h4>Atrizes</h4><i>Erro ao carregar.</i>';
        }
        async function loadScenesForModal(sceneIds, containerElement) { /* ... (Uses scene cache) ... */
            if (!sceneIds || sceneIds.length === 0) { containerElement.innerHTML = '<h4>Cenas</h4><i>Nenhuma cena.</i>'; return; } const cardsContainer = document.createElement('div'); cardsContainer.classList.add('modal-scene-cards'); containerElement.innerHTML = '<h4>Cenas do Filme</h4>'; containerElement.appendChild(cardsContainer); let foundCount = 0; sceneIds.forEach(sceneId => { const sceneData = allScenesCache.get(sceneId); if (sceneData) { foundCount++; const card = document.createElement('div'); card.classList.add('modal-scene-card'); const img = document.createElement('img'); let finalImageUrl = sceneData.imagem; if (typeof finalImageUrl === 'object' && finalImageUrl !== null && finalImageUrl.width) { const urlKey = Object.keys(finalImageUrl).find(k=>typeof finalImageUrl[k]==='string'&&finalImageUrl[k].startsWith('http')); finalImageUrl = urlKey ? finalImageUrl[urlKey] : 'placeholder.png'; } else if (typeof finalImageUrl !== 'string' || !finalImageUrl) { finalImageUrl = 'placeholder.png'; } img.src = finalImageUrl; img.alt = sceneData.nome; img.onerror = () => { img.src = 'placeholder.png'; img.onerror=null; } const titleDiv = document.createElement('div'); titleDiv.classList.add('title'); titleDiv.textContent = sceneData.nome || 'Sem Título'; card.appendChild(img); card.appendChild(titleDiv); cardsContainer.appendChild(card); } else { console.warn(`Scene ${sceneId} not found in cache for modal.`); } }); if (foundCount === 0) containerElement.innerHTML = '<h4>Cenas</h4><i>Erro ao carregar.</i>';
        }
        // Make closeModal globally accessible for the onclick attribute
        window.closeModal = function() {
             if(modal) modal.style.display = 'none';
             if(modalBody) modalBody.innerHTML = '';
             if(modalLinkContainer) modalLinkContainer.innerHTML = '';
        }

        // --- Movable Actress Popup Functions ---
        function createActressPopup(actressId) { /* ... (same as before) ... */
             const template = document.getElementById('actress-popup-template'); if (!template) return; const popup = template.cloneNode(true); popup.id = `actress-popup-${actressId}-${popupsOpen++}`; popup.style.display = 'flex'; const startTop = 50 + (popupsOpen * 20) % (window.innerHeight - 350); const startLeft = 50 + (popupsOpen * 25) % (window.innerWidth - 250); popup.style.top = `${startTop}px`; popup.style.left = `${startLeft}px`; const header = popup.querySelector('.actress-popup-header h5'); const body = popup.querySelector('.actress-popup-body'); const closeBtn = popup.querySelector('.actress-popup-close'); header.textContent = 'Carregando...'; body.innerHTML = '<div class="loading">...</div>'; closeBtn.onclick = () => popup.remove(); document.body.appendChild(popup); makeDraggable(popup); const actressData = allActressesData.find(a => a.id === actressId); if (actressData) { populateActressPopup(popup, actressData); } else { getDoc(doc(db, "atores", actressId)).then(docSnap => { if (docSnap.exists()) { populateActressPopup(popup, { id: actressId, ...docSnap.data() }); } else { header.textContent = 'Erro'; body.innerHTML = '<div class="error">Não encontrada.</div>'; } }).catch(err => { console.error("Popup fetch error:", err); header.textContent = 'Erro'; body.innerHTML = '<div class="error">Erro.</div>'; }); }
        }
        function populateActressPopup(popupElement, data) { /* ... (same as before) ... */
             const header = popupElement.querySelector('.actress-popup-header h5'); const body = popupElement.querySelector('.actress-popup-body'); header.textContent = data.nome || 'Detalhes'; body.innerHTML = ''; if (data.foto) { const img = document.createElement('img'); img.src = data.foto; img.alt = data.nome; img.onerror = () => { img.style.display = 'none'; }; body.appendChild(img); } const skipFields = ['foto', 'nome', 'timestamp', 'cenas', 'filmes', 'videos']; let detailsAdded = false; for (const key in data) { if (data.hasOwnProperty(key) && !skipFields.includes(key)) { detailsAdded = true; const detailDiv = document.createElement('div'); let value = data[key]; let label = key; if (key === 'dataNascimento') { detailDiv.innerHTML = `<strong>${label}:</strong> ${value || 'N/A'}`; body.appendChild(detailDiv); const ageDiv = document.createElement('div'); ageDiv.innerHTML = `<strong>Idade:</strong> ${calculateAge(value)}`; body.appendChild(ageDiv); continue; } else if (key === 'peso' && value != null) { value = `${value} kg`; } else if (key === 'altura' && value != null) { value = `${value} cm`; } detailDiv.innerHTML = `<strong>${label}:</strong> ${value}`; body.appendChild(detailDiv); } } if (!detailsAdded) { body.innerHTML += '<i>(Sem detalhes)</i>'; }
        }
        function makeDraggable(element) { /* ... (same as before) ... */
             let isDragging = false; let offsetX, offsetY; const header = element.querySelector('.actress-popup-header'); if (!header) return; header.onmousedown = (e) => { if (e.target.classList.contains('actress-popup-close')) return; isDragging = true; element.classList.add('dragging'); offsetX = e.clientX - element.getBoundingClientRect().left; offsetY = e.clientY - element.getBoundingClientRect().top; e.preventDefault(); }; document.onmousemove = (e) => { if (!isDragging) return; let newX = e.clientX - offsetX; let newY = e.clientY - offsetY; const vpWidth = window.innerWidth; const vpHeight = window.innerHeight; const elWidth = element.offsetWidth; const elHeight = element.offsetHeight; newX = Math.max(0, Math.min(newX, vpWidth - elWidth)); newY = Math.max(0, Math.min(newY, vpHeight - elHeight)); element.style.left = `${newX}px`; element.style.top = `${newY}px`; }; document.onmouseup = () => { if (isDragging) { isDragging = false; element.classList.remove('dragging'); } }; header.ondragstart = () => false;
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData(); // Load actresses & cache scenes

            // Main Modal Close on overlay click
             if(modal) modal.addEventListener('click', (event) => { if (event.target == modal) closeModal(); });
             // Note: 'x' button uses onclick in HTML

            // Right Column Filter Buttons
            relatedFilterButtons.forEach(button => {
                 button.addEventListener('click', () => {
                     relatedFilterButtons.forEach(btn => btn.classList.remove('active'));
                     button.classList.add('active');
                     activeRelatedFilter = button.dataset.filter;
                     applyRelatedContentFilters();
                 });
             });

             // Right Column Search Input/Suggestions
             if(relatedSearchInput) relatedSearchInput.addEventListener('input', () => displayRelatedSuggestions(relatedSearchInput.value));
             if(relatedSearchInput) relatedSearchInput.addEventListener('focus', () => displayRelatedSuggestions(relatedSearchInput.value));
             if(relatedSearchInputWrapper) relatedSearchInputWrapper.addEventListener('click', () => relatedSearchInput?.focus());

             // Global click listener to hide related suggestions
             document.addEventListener('click', (event) => {
                 if (relatedSearchInputWrapper && !relatedSearchInputWrapper.contains(event.target) && relatedSuggestionsList && !relatedSuggestionsList.contains(event.target)) {
                    if(relatedSuggestionsList) relatedSuggestionsList.style.display = 'none';
                 }
             });
        }); // End DOMContentLoaded

    </script>

</body>
</html>
